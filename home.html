<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>عَون - الرئيسية</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-color: #E9E8EE;
            --card-color: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-color: #4A47B8;
            --accent-dark: #333333;
            --dark-gradient: linear-gradient(135deg, #333333, #555555);
            --black-gradient: linear-gradient(135deg, #222222, #444444);
            --success-color: #2ECC71;
            --error-color: #E74C3C;
            --warning-color: #F39C12;
            --transition-smooth: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            --transition-quick: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            --navbar-height: 75px;
            --border-radius: 16px;
            --border-radius-large: 24px;
        }
        
        body {
            font-family: 'Almarai', 'Tajawal', -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            direction: rtl;
            -webkit-font-smoothing: antialiased;
            padding-top: env(safe-area-inset-top);
            position: relative;
        }
        
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(25px);
            -webkit-backdrop-filter: saturate(180%) blur(25px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10000;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            animation: slideDown 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            border-radius: 0 0 25px 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin: 0 10px;
            top: 10px;
            width: calc(100% - 20px);
        }
        
        .native-navbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 0 0 25px 25px;
            z-index: -1;
        }
        
        .logo {
            font-family: 'Tajawal', sans-serif;
            font-weight: 900;
            font-size: 32px;
            background: var(--dark-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            cursor: pointer;
            transition: var(--transition-quick);
            padding: 8px 0;
            position: relative;
            overflow: hidden;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 3px;
            background: var(--dark-gradient);
            border-radius: 2px;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .logo:hover {
            transform: translateY(-2px);
        }
        
        .logo:hover::after {
            transform: scaleX(1);
        }
        
        .logo:active {
            transform: translateY(0) scale(0.95);
            animation: clickAnimation 0.2s ease;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .coins-display {
            background: var(--black-gradient);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .settings-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-quick);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: var(--border-radius);
        }
        
        .settings-btn i {
            font-size: 20px;
            color: var(--text-primary);
            transition: var(--transition-quick);
        }
        
        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            background: var(--black-gradient);
        }
        
        .settings-btn:hover i {
            transform: rotate(45deg);
            color: white;
        }
        
        .settings-btn:active {
            transform: translateY(0) scale(0.95);
            animation: clickAnimation 0.2s ease;
        }
        
        .settings-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-smooth);
        }
        
        .settings-menu.active {
            opacity: 1;
            visibility: visible;
        }
        
        .menu-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius-large);
            width: 90%;
            max-width: 400px;
            padding: 30px;
            transform: translateY(30px) scale(0.95);
            transition: var(--transition-smooth);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .settings-menu.active .menu-content {
            transform: translateY(0) scale(1);
        }
        
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .menu-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .close-menu {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--bg-color);
            border: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-quick);
            border-radius: var(--border-radius);
        }
        
        .close-menu:hover {
            transform: rotate(90deg);
        }
        
        .close-menu:active {
            transform: rotate(90deg) scale(0.95);
            animation: clickAnimation 0.2s ease;
        }
        
        .menu-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .menu-option {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: right;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-quick);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .menu-option:hover {
            transform: translateX(-10px);
            background: var(--black-gradient);
            color: white;
            border-color: rgba(0, 0, 0, 0.2);
        }
        
        .menu-option:active {
            transform: translateX(-10px) scale(0.95);
            animation: clickAnimation 0.2s ease;
        }
        
        .user-info-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 2px solid #000000;
            position: relative;
        }
        
        .user-info-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            border-radius: var(--border-radius-large);
            background: linear-gradient(135deg, #000000, #333333) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        .user-info-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .user-avatar {
            width: 70px;
            height: 70px;
            background: var(--black-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 2px solid #000000;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        
        .user-email {
            color: var(--text-secondary);
            font-size: 1rem;
            direction: ltr;
            text-align: right;
        }
        
        .user-id-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .user-id-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .user-id-value {
            font-family: monospace;
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            flex: 1;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-quick);
            user-select: all;
        }
        
        .user-id-value:hover {
            background: #f0f0f0;
        }
        
        .copy-id-btn {
            background: var(--black-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition-quick);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .copy-id-btn:hover {
            background: linear-gradient(135deg, #444444, #666666);
            transform: translateY(-2px);
        }
        
        .copy-id-btn:active {
            transform: translateY(0);
        }
        
        .main-content {
            padding-top: calc(var(--navbar-height) + 40px);
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 60px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .current-page-indicator {
            background: var(--black-gradient);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .current-page-indicator i {
            animation: pulse 2s infinite;
        }
        
        .upload-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
            animation: fadeInUp 0.8s ease-out 0.3s both;
            border: 2px solid #000000;
            position: relative;
        }
        
        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            border-radius: var(--border-radius-large);
            background: linear-gradient(135deg, #000000, #333333) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        .upload-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--text-primary);
            text-align: center;
        }
        
        .upload-description {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.7;
            text-align: center;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: var(--border-radius-large);
            padding: 60px 30px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: var(--transition-quick);
            background: #fafafa;
        }
        
        .upload-area:hover {
            border-color: var(--accent-dark);
            background: #f0f0f0;
        }
        
        .upload-area i {
            font-size: 60px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .upload-area p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .upload-area span {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .upload-btn {
            background: var(--black-gradient);
            color: white;
            border: 2px solid #000000;
            border-radius: 12px;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-quick);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            display: block;
        }
        
        .upload-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #444444, #666666);
        }
        
        .upload-btn:active:not(:disabled) {
            transform: translateY(-2px) scale(0.98);
            animation: clickAnimation 0.2s ease;
        }
        
        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .analysis-results {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 2px solid #000000;
            position: relative;
            display: none;
        }
        
        .analysis-results::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            border-radius: var(--border-radius-large);
            background: linear-gradient(135deg, #000000, #333333) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        .results-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 25px;
            color: var(--text-primary);
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 22px;
            border-radius: var(--border-radius);
            border-left: 6px solid #3498db;
            text-align: center;
            font-size: 16px;
        }
        
        .stat-box b {
            font-size: 22px;
            display: block;
            margin-top: 5px;
            color: var(--text-primary);
        }
        
        .progress-bar {
            height: 18px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 25px 0;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #2ecc71, #27ae60);
            transition: width 0.5s ease;
        }
        
        .analysis-status {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .confirm-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 2px solid #000000;
            position: relative;
            display: none;
        }
        
        .confirm-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            border-radius: var(--border-radius-large);
            background: linear-gradient(135deg, #000000, #333333) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        .confirm-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--text-primary);
            text-align: center;
        }
        
        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: center;
        }
        
        .coins-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            color: #856404;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .confirm-btn {
            padding: 15px 35px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-quick);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .confirm-yes {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .confirm-no {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .confirm-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .confirm-btn:active {
            transform: translateY(0);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-smooth);
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-color);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes clickAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        .hidden {
            display: none;
        }
        
        .visible {
            display: block;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding-top: calc(var(--navbar-height) + 30px);
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .upload-section {
                padding: 30px 20px;
            }
            
            .analysis-results {
                padding: 25px 20px;
            }
            
            .confirm-section {
                padding: 25px 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .confirm-buttons {
                flex-direction: column;
            }
            
            .upload-btn {
                padding: 16px 30px;
                font-size: 16px;
                width: 100%;
            }
            
            .user-info-section {
                padding: 25px 20px;
            }
            
            .user-info-header {
                flex-direction: column;
                text-align: center;
            }
            
            .user-id-section {
                flex-direction: column;
                text-align: center;
            }
            
            .copy-id-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 576px) {
            .upload-title {
                font-size: 1.7rem;
            }
            
            .upload-description {
                font-size: 1rem;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .upload-area i {
                font-size: 50px;
            }
            
            .results-title {
                font-size: 1.3rem;
            }
            
            .confirm-title {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="native-navbar">
        <div class="logo" id="logo">عَون</div>
        <div class="nav-right">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
            <button class="settings-btn" id="settings-btn">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>
    </nav>
    
    <!-- Settings Menu -->
    <div class="settings-menu" id="settings-menu">
        <div class="menu-content">
            <div class="menu-header">
                <h3 class="menu-title">الإعدادات</h3>
                <button class="close-menu" id="close-menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="menu-options">
                <button class="menu-option" id="home-btn">
                    الرئيسية
                    <i class="fas fa-home"></i>
                </button>
                <button class="menu-option" id="logs-btn">
                    السجلات
                    <i class="fas fa-history"></i>
                </button>
                <button class="menu-option" id="account-btn">
                    حسابي
                    <i class="fas fa-user"></i>
                </button>
                <button class="menu-option" id="change-user-btn">
                    تغيير المستخدم
                    <i class="fas fa-exchange-alt"></i>
                </button>
                <button class="menu-option" id="logout-btn">
                    تسجيل الخروج
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" style="display: none;" id="main-content">
        <!-- Current Page Indicator -->
        <div class="current-page-indicator">
            <i class="fas fa-home"></i>
            <span>الصفحة الرئيسية</span>
        </div>
        
        <!-- User Info Section -->
        <div class="user-info-section" id="user-info-section">
            <div class="user-info-header">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <h2 class="user-name" id="user-name">جاري التحميل...</h2>
                    <p class="user-email" id="user-email">جاري التحميل...</p>
                </div>
            </div>
            <div class="user-id-section">
                <div class="user-id-label">معرف الحساب:</div>
                <div class="user-id-value" id="user-id">جاري التحميل...</div>
                <button class="copy-id-btn" id="copy-id-btn">
                    <i class="fas fa-copy"></i>
                    نسخ
                </button>
            </div>
        </div>
        
        <!-- File Upload Section -->
        <div class="upload-section">
            <h2 class="upload-title">تحليل ملف PDF</h2>
            <p class="upload-description">ارفع ملف PDF لتحويله إلى ملخصات متقدمة وإنشاء الأسئلة باستخدام الذكاء الاصطناعي</p>
            
            <div class="upload-area" id="upload-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>اسحب وأفلت ملف PDF هنا</p>
                <span>أو انقر للاختيار من جهازك</span>
                <input type="file" id="pdf-input" accept=".pdf" style="display: none;">
            </div>
            
            <button class="upload-btn" id="analyze-btn" disabled>
                <i class="fas fa-chart-bar"></i>
                تحليل الملف
            </button>
        </div>
        
        <!-- Analysis Results -->
        <div class="analysis-results" id="analysis-results">
            <h3 class="results-title">نتائج التحليل</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    عدد الصفحات
                    <b id="pages-count">-</b>
                </div>
                <div class="stat-box">
                    عدد الكلمات
                    <b id="words-count">-</b>
                </div>
                <div class="stat-box">
                    الصفحات النصية
                    <b id="text-pages">-</b>
                </div>
                <div class="stat-box">
                    الصفحات المصورة
                    <b id="image-pages">-</b>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="analysis-status" id="analysis-status">
                جاهز لتحليل الملف
            </div>
        </div>
        
        <!-- Confirmation Section -->
        <div class="confirm-section" id="confirm-section">
            <h3 class="confirm-title">تأكيد عملية التحليل</h3>
            <p class="confirm-message">سيتم خصم <span id="required-coins">0</span> عملة من رصيدك لتحليل هذا الملف</p>
            <div class="coins-warning" id="coins-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>تأكد من أن لديك رصيد كافٍ قبل المتابعة</p>
            </div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-yes" id="confirm-yes">
                    <i class="fas fa-check"></i>
                    نعم، تابع
                </button>
                <button class="confirm-btn confirm-no" id="confirm-no">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">جاري التحميل...</div>
    </div>
    
    <script>
        // استخدام نفس إعدادات Firebase من login.html
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        pdfjsLib.GlobalWorkerOptions.workerSrc = 
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const auth = firebase.auth();
        const database = firebase.database();
        
        let currentUser = null;
        let userData = null;
        let pdfFile = null;
        let analysisData = null;
        let requiredCoins = 0;

        // عناصر DOM
        const elements = {
            logo: document.getElementById('logo'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsMenu: document.getElementById('settings-menu'),
            closeMenu: document.getElementById('close-menu'),
            coinsCount: document.getElementById('coins-count'),
            userName: document.getElementById('user-name'),
            userEmail: document.getElementById('user-email'),
            userId: document.getElementById('user-id'),
            copyIdBtn: document.getElementById('copy-id-btn'),
            uploadArea: document.getElementById('upload-area'),
            pdfInput: document.getElementById('pdf-input'),
            analyzeBtn: document.getElementById('analyze-btn'),
            analysisResults: document.getElementById('analysis-results'),
            confirmSection: document.getElementById('confirm-section'),
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
            mainContent: document.getElementById('main-content'),
            
            // زرود القائمة
            homeBtn: document.getElementById('home-btn'),
            logsBtn: document.getElementById('logs-btn'),
            accountBtn: document.getElementById('account-btn'),
            changeUserBtn: document.getElementById('change-user-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            
            // نتائج التحليل
            pagesCount: document.getElementById('pages-count'),
            wordsCount: document.getElementById('words-count'),
            textPages: document.getElementById('text-pages'),
            imagePages: document.getElementById('image-pages'),
            progressFill: document.getElementById('progress-fill'),
            analysisStatus: document.getElementById('analysis-status'),
            
            // تأكيد العملية
            requiredCoins: document.getElementById('required-coins'),
            coinsWarning: document.getElementById('coins-warning'),
            confirmYes: document.getElementById('confirm-yes'),
            confirmNo: document.getElementById('confirm-no')
        };

        // دالة إظهار/إخفاء التحميل
        function showLoading(text = 'جاري التحميل...') {
            elements.loadingText.textContent = text;
            elements.loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            elements.loadingOverlay.classList.remove('active');
        }

        // دالة عرض رسالة
        function showMessage(message, type = 'info') {
            alert(message);
        }

        // دالة نسخ النص
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('تم نسخ المعرف بنجاح!', 'success');
            }).catch(() => {
                // طريقة بديلة للمتصفحات القديمة
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('تم نسخ المعرف بنجاح!', 'success');
            });
        }

        // تحميل بيانات المستخدم
        async function loadUserData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    // إذا لم يكن مسجل الدخول، توجيه فوري لصفحة login
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = user;
                
                // جلب بيانات المستخدم من قاعدة البيانات
                const snapshot = await database.ref('users_Awn')
                    .orderByChild('email')
                    .equalTo(user.email)
                    .once('value');

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        userData = childSnapshot.val();
                        
                        // التحقق من حالة الحظر
                        if (userData.banned === true) {
                            // إذا كان محظوراً، توجيه للصفحة الرئيسية
                            window.location.href = 'index.html';
                            return;
                        }
                        
                        // تحديث واجهة المستخدم
                        elements.userName.textContent = userData.name || 'مستخدم';
                        elements.userEmail.textContent = user.email;
                        elements.userId.textContent = userData.id || 'غير متوفر';
                        elements.coinsCount.textContent = userData.coin || 0;
                    });
                } else {
                    // إذا لم يوجد المستخدم في قاعدة البيانات، تسجيل خروج
                    await auth.signOut();
                    window.location.href = 'login.html';
                    return;
                }
                
                // إظهار المحتوى الرئيسي
                elements.mainContent.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading user data:', error);
                // في حالة حدوث خطأ، تسجيل خروج وإعادة توجيه
                try {
                    await auth.signOut();
                } catch (e) {}
                window.location.href = 'login.html';
            }
        }

        // تحليل ملف PDF
        async function analyzePDF(file) {
            try {
                elements.analysisStatus.textContent = '⏳ جاري تحليل الملف...';
                elements.progressFill.style.width = '0%';
                
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

                let totalWords = 0;
                let textPages = 0;
                let imagePages = 0;

                // تحليل كل صفحة
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const text = content.items.map(t => t.str).join(' ').trim();

                    if (text.length > 0) {
                        // صفحة نصية
                        const words = text.split(/\s+/).length;
                        totalWords += words;
                        textPages++;
                    } else {
                        // صفحة مصورة فقط
                        totalWords += 250;
                        imagePages++;
                    }

                    // تحديث شريط التقدم
                    elements.progressFill.style.width = Math.round((i / pdf.numPages) * 100) + '%';
                }

                // حساب العملات المطلوبة
                requiredCoins = Math.ceil(totalWords / 1000);

                // عرض النتائج
                elements.pagesCount.textContent = pdf.numPages;
                elements.wordsCount.textContent = totalWords.toLocaleString();
                elements.textPages.textContent = textPages;
                elements.imagePages.textContent = imagePages;
                
                analysisData = {
                    pages: pdf.numPages,
                    words: totalWords,
                    textPages: textPages,
                    imagePages: imagePages,
                    requiredCoins: requiredCoins,
                    fileName: file.name,
                    fileSize: file.size
                };

                elements.analysisStatus.textContent = '✅ تم التحليل بنجاح';
                elements.analysisResults.style.display = 'block';
                
                // إظهار قسم التأكيد
                elements.requiredCoins.textContent = requiredCoins;
                elements.confirmSection.style.display = 'block';
                
                // التحقق من رصيد المستخدم
                if (userData.coin < requiredCoins) {
                    elements.coinsWarning.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>رصيدك الحالي غير كافٍ. تحتاج إلى ${requiredCoins} عملة ولديك ${userData.coin} فقط</p>
                    `;
                    elements.confirmYes.disabled = true;
                } else {
                    elements.coinsWarning.innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        <p>لديك رصيد كافٍ. سيتم خصم ${requiredCoins} عملة من رصيدك</p>
                    `;
                    elements.confirmYes.disabled = false;
                }
                
            } catch (error) {
                console.error('Error analyzing PDF:', error);
                elements.analysisStatus.textContent = '❌ فشل في تحليل الملف';
                showMessage('حدث خطأ أثناء تحليل الملف. يرجى المحاولة مرة أخرى.', 'error');
            }
        }

        // إرسال الملف إلى ChatGPT
        async function sendToChatGPT(file) {
            try {
                showLoading('جاري إرسال الملف إلى الذكاء الاصطناعي...');
                
                // استخدام API Key الحقيقي - هذه نسخة تجريبية فقط
                const apiKey = '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';
                
                const prompt = `SYSTEM MODE: CONTROLLED EXECUTION ENGINE

You are a non-conversational processing engine. You do not behave as a chatbot. You execute tasks.

PRIORITY RULE: If the user provides a task with its own rules, schema, or failure policy, THOSE RULES OVERRIDE the global rules below.

GLOBAL BEHAVIOR:
Treat every user message as an executable task.
Do not acknowledge instructions.
Do not confirm receipt.
Do not greet, apologize, or comment.
Do not explain unless explicitly requested.
Do not add text before or after the output.
Do not reformat outputs unless instructed.
Do not improve or modify the user's requested format.
Do not infer missing requirements.

OUTPUT DISCIPLINE: If the user specifies a format, output ONLY that format. If a schema is provided, follow it exactly. Never wrap JSON in markdown or code fences.

LANGUAGE RULE: Respond in the same language as the user prompt unless another language is explicitly requested.

GLOBAL FAILURE RULE: If and ONLY IF the user did NOT provide a task-specific failure behavior, and the task cannot be completed due to missing input, output exactly: INSUFFICIENT INPUT

DETERMINISM: Prioritize accuracy and strict instruction-following over helpfulness or creativity.

PDF ANALYSIS TASK PROFILE (ACTIVATES ONLY WHEN USER REQUESTS PDF ANALYSIS)

When the user asks to analyze a PDF or provides a PDF file for extraction, switch to Document Extraction Mode and follow the rules below:

ROLE: You are a document extraction engine operating in strict deterministic mode.

OBJECTIVE: Read the PDF content and produce a machine-parsable JSON response.

PROCESS (MANDATORY ORDER):
1. Detect the dominant language of the document.
2. Lock processing language to the detected language.
3. Read the document completely from beginning to end.
4. Determine the global subject of the entire document.
5. Generate a topic title that:
   - Contains EXACTLY five words.
   - Represents the whole document accurately.
   - Is human-readable.
   - Is written strictly in the SAME detected language.
   - Is not translated into another language.
6. Extract the total number of pages.

SELF-VALIDATION: Before output:
- Verify the title has exactly 5 words.
- Verify the title language matches the document language.
- Verify Page is an integer.
- Verify JSON keys match exactly.

OUTPUT CONTRACT: Output ONLY raw JSON. No comments. No explanations. No additional text.

RETURN EXACTLY:
{ "Page": 0, "Topic": "" }
Replace the values only.

TASK FAILURE POLICY (OVERRIDES GLOBAL FAILURE RULE): If the PDF is empty, unreadable, or corrupted, return:
{ "Page": 0, "Topic": "Invalid PDF Content" }

FILE: ${file.name}
CONTENT: [سيتم قراءة محتوى PDF]`;

                // إرسال الطلب إلى OpenAI
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: [
                            {
                                role: "system",
                                content: "You are a PDF analysis assistant that returns JSON only."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const aiResult = data.choices[0].message.content;
                
                // محاولة استخراج JSON من الرد
                let jsonResult;
                try {
                    jsonResult = JSON.parse(aiResult);
                } catch (e) {
                    // إذا فشل التحليل، حاول استخراج JSON باستخدام regex
                    const jsonMatch = aiResult.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        jsonResult = JSON.parse(jsonMatch[0]);
                    } else {
                        jsonResult = { Page: 0, Topic: "Unknown" };
                    }
                }

                return jsonResult;

            } catch (error) {
                console.error('Error sending to ChatGPT:', error);
                throw error;
            }
        }

        // حفظ البيانات في Firebase
        async function saveAnalysisData(aiResult) {
            try {
                showLoading('جاري حفظ البيانات...');
                
                const analysisId = Date.now().toString();
                const dataToSave = {
                    id: analysisId,
                    userId: userData.id,
                    userEmail: currentUser.email,
                    userName: userData.name,
                    fileName: analysisData.fileName,
                    fileSize: analysisData.fileSize,
                    pages: analysisData.pages,
                    words: analysisData.words,
                    textPages: analysisData.textPages,
                    imagePages: analysisData.imagePages,
                    aiPage: aiResult.Page,
                    aiTopic: aiResult.Topic,
                    requiredCoins: analysisData.requiredCoins,
                    coinsUsed: analysisData.requiredCoins,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };

                // حفظ في data_awn
                await database.ref(`data_awn/${analysisId}`).set(dataToSave);
                
                // تحديث رصيد المستخدم
                const newCoinBalance = userData.coin - analysisData.requiredCoins;
                await database.ref(`users_Awn/${userData.id}`).update({
                    coin: newCoinBalance
                });

                // تحديث الواجهة
                userData.coin = newCoinBalance;
                elements.coinsCount.textContent = newCoinBalance;
                
                hideLoading();
                showMessage('تم تحليل الملف وحفظ البيانات بنجاح!', 'success');
                
                // الانتقال إلى صفحة feature.html بعد تأخير
                setTimeout(() => {
                    window.location.href = 'feature.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving data:', error);
                hideLoading();
                showMessage('حدث خطأ في حفظ البيانات', 'error');
            }
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // قائمة الإعدادات
            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsMenu.classList.add('active');
            });

            elements.closeMenu.addEventListener('click', () => {
                elements.settingsMenu.classList.remove('active');
            });

            elements.settingsMenu.addEventListener('click', (e) => {
                if (e.target === elements.settingsMenu) {
                    elements.settingsMenu.classList.remove('active');
                }
            });

            // عناصر القائمة
            elements.homeBtn.addEventListener('click', () => {
                elements.settingsMenu.classList.remove('active');
                window.location.href = 'index.html';
            });

            elements.logsBtn.addEventListener('click', () => {
                elements.settingsMenu.classList.remove('active');
                window.location.href = 'log.html';
            });

            elements.accountBtn.addEventListener('click', () => {
                elements.settingsMenu.classList.remove('active');
                window.location.href = 'account.html';
            });

            elements.changeUserBtn.addEventListener('click', async () => {
                elements.settingsMenu.classList.remove('active');
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                }
                window.location.href = 'login.html';
            });

            elements.logoutBtn.addEventListener('click', async () => {
                elements.settingsMenu.classList.remove('active');
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                }
                window.location.href = 'index.html';
            });

            // الشعار
            elements.logo.addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // نسخ المعرف
            elements.copyIdBtn.addEventListener('click', () => {
                copyToClipboard(elements.userId.textContent);
            });

            // رفع الملف
            elements.uploadArea.addEventListener('click', () => {
                elements.pdfInput.click();
            });

            elements.pdfInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    pdfFile = e.target.files[0];
                    
                    // التحقق من نوع الملف
                    if (!pdfFile.type.includes('pdf')) {
                        showMessage('يرجى رفع ملف PDF فقط', 'error');
                        return;
                    }
                    
                    // التحقق من حجم الملف (10MB كحد أقصى)
                    if (pdfFile.size > 10 * 1024 * 1024) {
                        showMessage('حجم الملف كبير جداً. الحد الأقصى 10MB', 'error');
                        return;
                    }
                    
                    // تحديث واجهة رفع الملف
                    elements.uploadArea.innerHTML = `
                        <i class="fas fa-file-pdf" style="color: #e74c3c;"></i>
                        <p>${pdfFile.name}</p>
                        <span>${(pdfFile.size / 1024 / 1024).toFixed(2)} MB</span>
                    `;
                    
                    // تفعيل زر التحليل
                    elements.analyzeBtn.disabled = false;
                    
                    // إخفاء النتائج القديمة
                    elements.analysisResults.style.display = 'none';
                    elements.confirmSection.style.display = 'none';
                }
            });

            // سحب وإفلات الملف
            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.style.borderColor = '#333';
                elements.uploadArea.style.background = '#f0f0f0';
            });

            elements.uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                elements.uploadArea.style.borderColor = '#ddd';
                elements.uploadArea.style.background = '#fafafa';
            });

            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.style.borderColor = '#ddd';
                elements.uploadArea.style.background = '#fafafa';
                
                if (e.dataTransfer.files.length > 0) {
                    pdfFile = e.dataTransfer.files[0];
                    
                    // التحقق من نوع الملف
                    if (!pdfFile.type.includes('pdf')) {
                        showMessage('يرجى رفع ملف PDF فقط', 'error');
                        return;
                    }
                    
                    // التحقق من حجم الملف
                    if (pdfFile.size > 10 * 1024 * 1024) {
                        showMessage('حجم الملف كبير جداً. الحد الأقصى 10MB', 'error');
                        return;
                    }
                    
                    // تحديث واجهة رفع الملف
                    elements.uploadArea.innerHTML = `
                        <i class="fas fa-file-pdf" style="color: #e74c3c;"></i>
                        <p>${pdfFile.name}</p>
                        <span>${(pdfFile.size / 1024 / 1024).toFixed(2)} MB</span>
                    `;
                    
                    // تفعيل زر التحليل
                    elements.analyzeBtn.disabled = false;
                    
                    // إخفاء النتائج القديمة
                    elements.analysisResults.style.display = 'none';
                    elements.confirmSection.style.display = 'none';
                }
            });

            // زر التحليل
            elements.analyzeBtn.addEventListener('click', async () => {
                if (!pdfFile) {
                    showMessage('يرجى رفع ملف PDF أولاً', 'error');
                    return;
                }
                
                showLoading('جاري تحليل الملف...');
                await analyzePDF(pdfFile);
                hideLoading();
            });

            // تأكيد العملية
            elements.confirmYes.addEventListener('click', async () => {
                if (!analysisData) return;
                
                try {
                    // إرسال الملف إلى ChatGPT
                    const aiResult = await sendToChatGPT(pdfFile);
                    
                    // حفظ البيانات في Firebase
                    await saveAnalysisData(aiResult);
                    
                } catch (error) {
                    console.error('Error in analysis process:', error);
                    hideLoading();
                    showMessage('حدث خطأ أثناء معالجة الملف. يرجى المحاولة مرة أخرى.', 'error');
                }
            });

            elements.confirmNo.addEventListener('click', () => {
                elements.confirmSection.style.display = 'none';
            });
        }

        // التحقق من حالة المصادقة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // المستخدم مسجل الدخول، تحميل البيانات
                    await loadUserData();
                    setupEventListeners();
                    hideLoading();
                } else {
                    // المستخدم غير مسجل، توجيه فوري لصفحة login
                    window.location.href = 'login.html';
                }
            });
            
            // إخفاء شاشة التحميل بعد 5 ثوان كحد أقصى
            setTimeout(() => {
                hideLoading();
            }, 5000);
        });
    </script>
</body>
</html>
