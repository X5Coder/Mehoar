<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عَون - تلخيص PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== الأساسيات والخطوط ===== */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            min-height: 100vh;
        }
        
        /* ===== الشريط العلوي ===== */
        .header {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        .coins-box {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 0.5rem 1.2rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .coins-box i {
            color: #FFD700;
        }
        
        /* ===== المحتوى الرئيسي ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .main-content {
            background-color: white;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            margin-top: 1.5rem;
        }
        
        .section-title {
            color: #311b92;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid #e8eaf6;
            font-size: 1.8rem;
        }
        
        /* ===== منطقة رفع الملف ===== */
        .upload-area {
            border: 3px dashed #c5cae9;
            border-radius: 16px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f9ff;
            margin-bottom: 2rem;
        }
        
        .upload-area:hover {
            border-color: #7986cb;
            background-color: #f0f2ff;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #5c6bc0;
            margin-bottom: 1rem;
        }
        
        .upload-text h3 {
            color: #1a237e;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .upload-text p {
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .browse-btn {
            background-color: #5c6bc0;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .browse-btn:hover {
            background-color: #3949ab;
            transform: translateY(-2px);
        }
        
        .file-info {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #e8eaf6;
            border-radius: 12px;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .file-name {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            color: #1a237e;
            font-weight: 600;
        }
        
        .file-name i {
            color: #5c6bc0;
        }
        
        /* ===== معلومات العملات والتحميل ===== */
        .calculation-area {
            background-color: #f3f4f9;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }
        
        .calculation-area.show {
            display: block;
        }
        
        .calc-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .calc-box {
            background-color: white;
            padding: 1.2rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .calc-title {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .calc-value {
            color: #1a237e;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .loading-steps {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }
        
        .loading-steps.show {
            display: block;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 1.2rem;
            padding: 0.8rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background-color: #e8f5e9;
            border-right: 4px solid #4caf50;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e8eaf6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 1rem;
            color: #5c6bc0;
        }
        
        .step.active .step-icon {
            background-color: #4caf50;
            color: white;
        }
        
        .step-text {
            font-weight: 600;
            color: #333;
        }
        
        .step.active .step-text {
            color: #1a237e;
        }
        
        /* ===== زر الإجراءات ===== */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            display: none;
        }
        
        .action-buttons.show {
            display: flex;
        }
        
        .btn {
            padding: 0.9rem 2.5rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            min-width: 150px;
        }
        
        .btn-continue {
            background: linear-gradient(to right, #4caf50, #2e7d32);
            color: white;
        }
        
        .btn-continue:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn-cancel {
            background-color: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
        }
        
        .btn-cancel:hover {
            background-color: #e0e0e0;
        }
        
        .confirmation-text {
            text-align: center;
            margin-top: 1.5rem;
            color: #666;
            font-size: 0.95rem;
            display: none;
        }
        
        .confirmation-text.show {
            display: block;
        }
        
        .coins-amount {
            color: #d32f2f;
            font-weight: 700;
        }
        
        /* ===== عناصر التحكم ===== */
        .controls-section {
            display: none;
            margin-top: 2rem;
        }
        
        .controls-section.show {
            display: block;
        }
        
        .control-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #f9f9ff;
            border-radius: 12px;
        }
        
        .control-title {
            color: #1a237e;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-title i {
            color: #5c6bc0;
        }
        
        /* ===== السلايدر ===== */
        .slider-container {
            padding: 1rem 0;
        }
        
        .slider-value {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 1rem;
        }
        
        .slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #5c6bc0;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* ===== خيارات الاختيار ===== */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .option-btn {
            padding: 1rem;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            border-color: #9fa8da;
            transform: translateY(-3px);
        }
        
        .option-btn.selected {
            border-color: #5c6bc0;
            background-color: #e8eaf6;
            color: #1a237e;
            font-weight: 600;
        }
        
        /* ===== حقل التعليق ===== */
        .comment-area {
            margin-top: 1rem;
        }
        
        .comment-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
        }
        
        .comment-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }
        
        .comment-input:focus {
            outline: none;
            border-color: #5c6bc0;
        }
        
        /* ===== زر معالجة الذكاء الاصطناعي ===== */
        .process-btn {
            display: block;
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(to right, #5c6bc0, #3949ab);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .process-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(92, 107, 192, 0.3);
        }
        
        /* ===== النتائج ===== */
        .results-section {
            display: none;
        }
        
        .results-section.show {
            display: block;
        }
        
        .pages-container {
            margin-top: 2rem;
        }
        
        .page-card {
            background-color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .page-number {
            background-color: #5c6bc0;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .page-tools {
            display: flex;
            gap: 10px;
        }
        
        .tool-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #f5f5f5;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
            transition: all 0.2s ease;
        }
        
        .tool-btn:hover {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .page-content {
            line-height: 1.8;
            color: #333;
            font-size: 1.05rem;
            text-align: justify;
        }
        
        .laws-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #fff8e1;
            border-radius: 10px;
            border-right: 4px solid #ffb300;
        }
        
        .laws-title {
            color: #ff8f00;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .laws-content {
            line-height: 1.7;
            color: #5d4037;
        }
        
        /* ===== شاشة التحميل النهائية ===== */
        .final-loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }
        
        .final-loading.show {
            display: block;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #e0e0e0;
            border-top: 8px solid #5c6bc0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-message {
            font-size: 1.3rem;
            color: #1a237e;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .loading-submessage {
            color: #666;
        }
        
        /* ===== رسائل التنبيه ===== */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-right: 4px solid #4caf50;
        }
        
        .alert-error {
            background-color: #ffebee;
            color: #c62828;
            border-right: 4px solid #f44336;
        }
        
        .alert-warning {
            background-color: #fff3e0;
            color: #ef6c00;
            border-right: 4px solid #ff9800;
        }
        
        /* ===== التكيف مع الشاشات الصغيرة ===== */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .main-content {
                padding: 1.5rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .options-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- الشريط العلوي -->
    <header class="header">
        <a href="home.html" class="logo">
            <i class="fas fa-hands-helping"></i>
            <span>عَون</span>
        </a>
        <div class="coins-box">
            <i class="fas fa-coins"></i>
            <span id="user-coins">150</span> عملة
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <div class="container">
        <div class="main-content">
            <h1 class="section-title">
                <i class="fas fa-file-contract"></i>
                تلخيص ملف PDF
            </h1>
            
            <!-- رسائل التنبيه -->
            <div id="alert-message" class="alert"></div>
            
            <!-- منطقة رفع الملف -->
            <div id="upload-area" class="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    <h3>ارفع ملف PDF للتحليل</h3>
                    <p>اسحب وأفلت ملف PDF هنا أو انقر لاستعراض الملفات</p>
                    <input type="file" id="pdfInput" accept=".pdf" hidden>
                    <button class="browse-btn" id="browse-btn">استعراض الملفات</button>
                </div>
            </div>
            
            <!-- معلومات الملف -->
            <div id="file-info" class="file-info">
                <div class="file-name">
                    <i class="fas fa-file-pdf"></i>
                    <span id="selected-file-name">لم يتم اختيار ملف</span>
                </div>
                <div id="file-size">جاري حساب حجم الملف...</div>
            </div>
            
            <!-- منطقة حساب العملات -->
            <div id="calculation-area" class="calculation-area">
                <h3 style="color: #1a237e; margin-bottom: 1rem;">نتيجة التحليل</h3>
                <div class="calc-info">
                    <div class="calc-box">
                        <div class="calc-title">عدد الصفحات</div>
                        <div id="pages-count" class="calc-value">0</div>
                    </div>
                    <div class="calc-box">
                        <div class="calc-title">عدد الكلمات</div>
                        <div id="words-count" class="calc-value">0</div>
                    </div>
                    <div class="calc-box">
                        <div class="calc-title">التكلفة (عملات)</div>
                        <div id="coins-cost" class="calc-value">0</div>
                    </div>
                </div>
                
                <!-- خطوات التحميل -->
                <div id="loading-steps" class="loading-steps">
                    <div class="step active" id="step1">
                        <div class="step-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-text">عَون يحلل الملف</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="step-text">عَون يحسب عدد الصفحات</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-icon">
                            <i class="fas fa-font"></i>
                        </div>
                        <div class="step-text">عَون يستخرج كل الكلمات</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="step-text">عَون يحسب التكلفة</div>
                    </div>
                </div>
                
                <!-- تأكيد المتابعة -->
                <div id="confirmation-text" class="confirmation-text">
                    سيتم خصم عدد <span id="coins-to-deduct" class="coins-amount">0</span> من نقاطك، هل تود المتابعة؟
                </div>
                
                <!-- أزرار الإجراء -->
                <div id="action-buttons" class="action-buttons">
                    <button class="btn btn-continue" id="continue-btn">
                        <i class="fas fa-check"></i> متابعة
                    </button>
                    <button class="btn btn-cancel" id="cancel-btn">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
            
            <!-- عناصر التحكم -->
            <div id="controls-section" class="controls-section">
                <h2 class="section-title">
                    <i class="fas fa-sliders-h"></i>
                    إعدادات التلخيص
                </h2>
                
                <!-- اختيار عدد الصفحات -->
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-file-alt"></i>
                        عدد الصفحات المراد تلخيصها
                    </div>
                    <div class="slider-container">
                        <div id="slider-value" class="slider-value">1</div>
                        <input type="range" min="1" max="25" value="1" class="slider" id="pages-slider">
                        <div class="slider-labels">
                            <span>1</span>
                            <span>25</span>
                        </div>
                    </div>
                </div>
                
                <!-- اختيار نوع الشرح -->
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-comment-alt"></i>
                        نوع الشرح
                    </div>
                    <div class="options-grid" id="style-options">
                        <div class="option-btn" data-value="بسيط">
                            <i class="fas fa-language"></i>
                            <div>بسيط</div>
                        </div>
                        <div class="option-btn" data-value="معقد">
                            <i class="fas fa-brain"></i>
                            <div>معقد</div>
                        </div>
                        <div class="option-btn" data-value="طفولي">
                            <i class="fas fa-child"></i>
                            <div>طفولي</div>
                        </div>
                        <div class="option-btn" data-value="عالي المستوى">
                            <i class="fas fa-chart-line"></i>
                            <div>عالي المستوى</div>
                        </div>
                    </div>
                </div>
                
                <!-- اختيار شخصية الشرح -->
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-user-tie"></i>
                        شخصية الشارح
                    </div>
                    <div class="options-grid" id="personality-options">
                        <div class="option-btn" data-value="دكتور جامعي">
                            <i class="fas fa-user-graduate"></i>
                            <div>دكتور جامعي</div>
                        </div>
                        <div class="option-btn" data-value="أستاذ مدرسي">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <div>أستاذ مدرسي</div>
                        </div>
                        <div class="option-btn" data-value="طالب">
                            <i class="fas fa-user-graduate"></i>
                            <div>طالب</div>
                        </div>
                        <div class="option-btn" data-value="عالم">
                            <i class="fas fa-atom"></i>
                            <div>عالم</div>
                        </div>
                        <div class="option-btn" data-value="صديق">
                            <i class="fas fa-user-friends"></i>
                            <div>صديق</div>
                        </div>
                        <div class="option-btn" data-value="هاوي">
                            <i class="fas fa-user"></i>
                            <div>هاوي</div>
                        </div>
                    </div>
                </div>
                
                <!-- تعليق المستخدم -->
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-comment-dots"></i>
                        تعليق إضافي (اختياري)
                    </div>
                    <div class="comment-area">
                        <label class="comment-label">أضف تعليقًا أو ملاحظات خاصة لتحسين التلخيص</label>
                        <textarea id="user-comment" class="comment-input" placeholder="اكتب تعليقك هنا..."></textarea>
                    </div>
                </div>
                
                <!-- زر المعالجة -->
                <button id="process-btn" class="process-btn">
                    <i class="fas fa-robot"></i>
                    بدء التلخيص باستخدام الذكاء الاصطناعي
                </button>
            </div>
            
            <!-- شاشة التحميل النهائية -->
            <div id="final-loading" class="final-loading">
                <div class="loading-spinner"></div>
                <div id="loading-message" class="loading-message">عَون يحلل الملف</div>
                <div id="loading-submessage" class="loading-submessage">قد تستغرق العملية بضع دقائق حسب حجم الملف</div>
            </div>
            
            <!-- عرض النتائج -->
            <div id="results-section" class="results-section">
                <h2 class="section-title">
                    <i class="fas fa-poll"></i>
                    نتائج التلخيص
                </h2>
                <div id="pages-container" class="pages-container">
                    <!-- سيتم عرض الصفحات هنا ديناميكيًا -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // تهيئة مكتبة PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // متغيرات عامة
        let pdfFile = null;
        let totalPages = 0;
        let totalWords = 0;
        let coinsCost = 0;
        let selectedStyle = "بسيط";
        let selectedPersonality = "دكتور جامعي";
        let selectedPages = 1;
        let userComment = "";
        let sessionId = generateSessionId();
        
        // DOM Elements
        const uploadArea = document.getElementById('upload-area');
        const browseBtn = document.getElementById('browse-btn');
        const pdfInput = document.getElementById('pdfInput');
        const fileInfo = document.getElementById('file-info');
        const fileNameSpan = document.getElementById('selected-file-name');
        const calculationArea = document.getElementById('calculation-area');
        const loadingSteps = document.getElementById('loading-steps');
        const confirmationText = document.getElementById('confirmation-text');
        const actionButtons = document.getElementById('action-buttons');
        const continueBtn = document.getElementById('continue-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const controlsSection = document.getElementById('controls-section');
        const processBtn = document.getElementById('process-btn');
        const finalLoading = document.getElementById('final-loading');
        const resultsSection = document.getElementById('results-section');
        const pagesContainer = document.getElementById('pages-container');
        const alertMessage = document.getElementById('alert-message');
        
        // عناصر النتائج
        const pagesCountElement = document.getElementById('pages-count');
        const wordsCountElement = document.getElementById('words-count');
        const coinsCostElement = document.getElementById('coins-cost');
        const coinsToDeductElement = document.getElementById('coins-to-deduct');
        const userCoinsElement = document.getElementById('user-coins');
        
        // إضافة مستمعي الأحداث
        document.addEventListener('DOMContentLoaded', initApp);
        
        function initApp() {
            // تفعيل زر الاستعراض
            browseBtn.addEventListener('click', () => pdfInput.click());
            uploadArea.addEventListener('click', () => pdfInput.click());
            
            // عند اختيار ملف
            pdfInput.addEventListener('change', handleFileSelect);
            
            // أزرار الإجراء
            continueBtn.addEventListener('click', handleContinue);
            cancelBtn.addEventListener('click', handleCancel);
            
            // السلايدر
            const pagesSlider = document.getElementById('pages-slider');
            const sliderValue = document.getElementById('slider-value');
            
            pagesSlider.addEventListener('input', function() {
                selectedPages = parseInt(this.value);
                sliderValue.textContent = selectedPages;
            });
            
            // خيارات النمط
            document.querySelectorAll('#style-options .option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#style-options .option-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStyle = this.getAttribute('data-value');
                });
            });
            
            // خيارات الشخصية
            document.querySelectorAll('#personality-options .option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#personality-options .option-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPersonality = this.getAttribute('data-value');
                });
            });
            
            // حقل التعليق
            const userCommentElement = document.getElementById('user-comment');
            userCommentElement.addEventListener('input', function() {
                userComment = this.value;
            });
            
            // زر المعالجة
            processBtn.addEventListener('click', processWithAI);
            
            // تحديد الخيارات الأولى
            document.querySelector('#style-options .option-btn').classList.add('selected');
            document.querySelector('#personality-options .option-btn').classList.add('selected');
        }
        
        // معالجة اختيار الملف
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            pdfFile = file;
            
            // عرض معلومات الملف
            fileNameSpan.textContent = file.name;
            fileInfo.classList.add('show');
            
            // عرض التحميل
            calculationArea.classList.add('show');
            loadingSteps.classList.add('show');
            
            // تفعيل خطوات التحميل بالتسلسل
            activateStep(1);
            
            // حساب عدد الكلمات والعملات
            await calculatePDFInfo(file);
            
            // بعد 5 ثواني (محاكاة للتحميل)
            setTimeout(() => {
                activateStep(4);
                
                // عرض تأكيد المتابعة
                confirmationText.classList.add('show');
                actionButtons.classList.add('show');
                
                // تحديث عدد العملات المطلوب خصمها
                coinsToDeductElement.textContent = coinsCost;
                
                showAlert(`تم تحليل الملف بنجاح! سيتم خصم ${coinsCost} عملة من رصيدك.`, 'success');
            }, 5000);
        }
        
        // تفعيل خطوة التحميل
        function activateStep(stepNumber) {
            // إلغاء تفعيل جميع الخطوات
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active');
            }
            
            // تفعيل الخطوة المطلوبة
            const step = document.getElementById(`step${stepNumber}`);
            step.classList.add('active');
        }
        
        // حساب معلومات PDF
        async function calculatePDFInfo(file) {
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                totalPages = pdf.numPages;
                let totalWords = 0;
                
                // حساب الكلمات لكل صفحة
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                    
                    // تحديث خطوات التحميل
                    if (i === 1) activateStep(2);
                    if (i === Math.floor(pdf.numPages / 2)) activateStep(3);
                }
                
                // حساب العملات
                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;
                
                // تحديث واجهة المستخدم
                pagesCountElement.textContent = totalPages;
                wordsCountElement.textContent = totalWords.toLocaleString();
                coinsCostElement.textContent = coins;
                
                totalWords = totalWords;
                coinsCost = coins;
                
            } catch (error) {
                console.error('Error calculating PDF info:', error);
                showAlert('حدث خطأ في قراءة الملف. يرجى التأكد من صحة ملف PDF.', 'error');
            }
        }
        
        // معالجة المتابعة
        function handleContinue() {
            calculationArea.classList.remove('show');
            controlsSection.classList.add('show');
            
            // تحديث القيمة القصوى للسلايدر بعدد الصفحات الفعلي
            const pagesSlider = document.getElementById('pages-slider');
            const maxPages = Math.min(totalPages, 25);
            pagesSlider.max = maxPages;
            pagesSlider.value = Math.min(selectedPages, maxPages);
            selectedPages = parseInt(pagesSlider.value);
            
            // تحديث قيمة السلايدر المعروضة
            document.getElementById('slider-value').textContent = selectedPages;
            
            showAlert('الآن يمكنك تحديد إعدادات التلخيص المطلوبة.', 'success');
        }
        
        // معالجة الإلغاء
        function handleCancel() {
            // إعادة تعيين كل شيء
            pdfInput.value = '';
            pdfFile = null;
            fileInfo.classList.remove('show');
            calculationArea.classList.remove('show');
            confirmationText.classList.remove('show');
            actionButtons.classList.remove('show');
            
            // إخفاء رسائل الخطأ
            hideAlert();
            
            showAlert('تم إلغاء العملية وحذف الملف.', 'warning');
        }
        
        // معالجة باستخدام الذكاء الاصطناعي
        async function processWithAI() {
            // التحقق من صحة المدخلات
            if (!selectedStyle || !selectedPersonality) {
                showAlert('يرجى اختيار نوع الشرح وشخصية الشارح.', 'error');
                return;
            }
            
            // التحقق من رصيد المستخدم
            const currentCoins = parseInt(userCoinsElement.textContent);
            if (currentCoins < coinsCost) {
                showAlert(`رصيدك غير كافٍ. تحتاج إلى ${coinsCost} عملة بينما رصيدك الحالي هو ${currentCoins}.`, 'error');
                return;
            }
            
            // إخفاء عناصر التحكم وإظهار التحميل
            controlsSection.classList.remove('show');
            finalLoading.classList.add('show');
            
            // تحديث رسائل التحميل الديناميكية
            const loadingMessages = [
                "عَون يحلل الملف",
                "عَون يقرأ المحتوى",
                "عَون يفهم النقاط الرئيسية",
                "عَون يلخص الصفحات",
                "عَون يعد النتائج النهائية"
            ];
            
            let messageIndex = 0;
            const messageElement = document.getElementById('loading-message');
            const updateMessage = () => {
                messageElement.textContent = loadingMessages[messageIndex];
                messageIndex = (messageIndex + 1) % loadingMessages.length;
            };
            
            updateMessage();
            const messageInterval = setInterval(updateMessage, 3000);
            
            try {
                // هنا سيتم إرسال الملف إلى الذكاء الاصطناعي
                // هذه محاكاة للاستجابة (في التطبيق الحقيقي سيكون هناك اتصال بالخادم)
                
                // محاكاة وقت المعالجة
                await simulateProcessing(selectedPages);
                
                // إيقاف رسائل التحميل الديناميكية
                clearInterval(messageInterval);
                
                // خصم العملات
                const newCoins = currentCoins - coinsCost;
                userCoinsElement.textContent = newCoins;
                
                // إخفاء التحميل وإظهار النتائج
                finalLoading.classList.remove('show');
                resultsSection.classList.add('show');
                
                // عرض النتائج المحاكاة
                displayResults(generateMockResults());
                
                // حفظ في قاعدة البيانات (محاكاة)
                saveToDatabase();
                
                showAlert(`تم تلخيص الملف بنجاح! تم خصم ${coinsCost} عملة من رصيدك.`, 'success');
                
            } catch (error) {
                console.error('Error processing with AI:', error);
                showAlert('حدث خطأ أثناء معالجة الملف. يرجى المحاولة مرة أخرى.', 'error');
                
                // إظهار عناصر التحكم مرة أخرى في حالة الخطأ
                finalLoading.classList.remove('show');
                controlsSection.classList.add('show');
            }
        }
        
        // محاكاة معالجة الذكاء الاصطناعي
        function simulateProcessing(pages) {
            return new Promise(resolve => {
                // محاكاة وقت المعالجة حسب عدد الصفحات
                const processingTime = pages * 2000 + 3000;
                setTimeout(resolve, processingTime);
            });
        }
        
        // إنشاء نتائج محاكاة للعرض
        function generateMockResults() {
            const results = [];
            for (let i = 1; i <= selectedPages; i++) {
                results.push({
                    page: i,
                    Dec: `هذا هو شرح الصفحة ${i} من ملف PDF. هنا يتم عرض ملخص مفصل بمقدار 300 كلمة كاملة كما هو مطلوب. يتم تكييف أسلوب الشرح مع ${selectedStyle} وشخصية ${selectedPersonality}. النص هنا يمثل نموذجًا للشرح الذي سيتم إنشاؤه بواسطة الذكاء الاصطناعي بناءً على محتوى الصفحة الفعلي من ملف PDF. يتم تضمين النقاط الرئيسية والأفكار المهمة مع شرح مبسط وسهل الفهم.`,
                    law: i % 3 === 0 ? `هنا يتم عرض القوانين واللوائح ذات الصلة بالصفحة ${i}. يتم استخراجها تلقائيًا إذا وجدت في النص الأصلي.` : ""
                });
            }
            return results;
        }
        
        // عرض النتائج
        function displayResults(results) {
            pagesContainer.innerHTML = '';
            
            results.forEach(result => {
                const pageCard = document.createElement('div');
                pageCard.className = 'page-card';
                
                pageCard.innerHTML = `
                    <div class="page-header">
                        <div class="page-number">${result.page}</div>
                        <div class="page-tools">
                            <button class="tool-btn" title="تكبير النص">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="tool-btn" title="تصغير النص">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="tool-btn" title="قلم الرسم">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="tool-btn" title="تظليل النص">
                                <i class="fas fa-highlighter"></i>
                            </button>
                            <button class="tool-btn" title="حفظ التعديلات">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                    <div class="page-content">${result.Dec}</div>
                    ${result.law ? `
                    <div class="laws-section">
                        <div class="laws-title">
                            <i class="fas fa-gavel"></i>
                            قوانين الصفحة
                        </div>
                        <div class="laws-content">${result.law}</div>
                    </div>
                    ` : ''}
                `;
                
                pagesContainer.appendChild(pageCard);
                
                // إضافة مستمعي الأحداث لأدوات الصفحة
                addPageToolListeners(pageCard, result.page);
            });
        }
        
        // إضافة مستمعي الأحداث لأدوات الصفحة
        function addPageToolListeners(pageCard, pageNumber) {
            const zoomInBtn = pageCard.querySelector('.tool-btn:nth-child(1)');
            const zoomOutBtn = pageCard.querySelector('.tool-btn:nth-child(2)');
            const penBtn = pageCard.querySelector('.tool-btn:nth-child(3)');
            const highlighterBtn = pageCard.querySelector('.tool-btn:nth-child(4)');
            const saveBtn = pageCard.querySelector('.tool-btn:nth-child(5)');
            const pageContent = pageCard.querySelector('.page-content');
            
            let fontSize = 16;
            
            zoomInBtn.addEventListener('click', () => {
                fontSize += 1;
                pageContent.style.fontSize = `${fontSize}px`;
            });
            
            zoomOutBtn.addEventListener('click', () => {
                if (fontSize > 12) {
                    fontSize -= 1;
                    pageContent.style.fontSize = `${fontSize}px`;
                }
            });
            
            penBtn.addEventListener('click', () => {
                showAlert(`تم تفعيل وضع الرسم للصفحة ${pageNumber}. ارسم مباشرة على النص.`, 'success');
                // في التطبيق الحقيقي، سيتم تفعيل مكتبة للرسم على النص
            });
            
            highlighterBtn.addEventListener('click', () => {
                showAlert(`تم تفعيل وضع التظليل للصفحة ${pageNumber}. قم بتظليل النص المطلوب.`, 'success');
                // في التطبيق الحقيقي، سيتم تفعيل مكتبة للتظليل
            });
            
            saveBtn.addEventListener('click', () => {
                showAlert(`تم حفظ التعديلات للصفحة ${pageNumber} في قاعدة البيانات.`, 'success');
                // في التطبيق الحقيقي، سيتم إرسال التعديلات إلى قاعدة البيانات
            });
        }
        
        // حفظ في قاعدة البيانات (محاكاة)
        function saveToDatabase() {
            // في التطبيق الحقيقي، سيتم هنا الاتصال بقاعدة البيانات Firebase
            // وحفظ البيانات في عقدة records
            
            const recordData = {
                userId: "user123", // سيتم الحصول على ID المستخدم من نظام المصادقة
                fileName: pdfFile.name,
                sessionId: sessionId,
                serviceType: "تلخيص",
                summaryJson: generateMockResults(), // في التطبيق الحقيقي ستكون النتائج الفعلية من الذكاء الاصطناعي
                pageCount: totalPages,
                timestamp: new Date().toISOString()
            };
            
            console.log('بيانات للحفظ في قاعدة البيانات:', recordData);
            
            // محاكاة حفظ في Firebase
            // firebase.database().ref('records/' + sessionId).set(recordData);
        }
        
        // إنشاء ID فريد للجلسة
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // عرض رسائل التنبيه
        function showAlert(message, type = 'info') {
            alertMessage.textContent = message;
            alertMessage.className = `alert alert-${type} show`;
            
            // إخفاء الرسالة تلقائيًا بعد 5 ثواني
            setTimeout(hideAlert, 5000);
        }
        
        // إخفاء رسالة التنبيه
        function hideAlert() {
            alertMessage.classList.remove('show');
        }
    </script>
</body>
</html>
