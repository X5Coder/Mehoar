<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عَون - تلخيص PDF</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Almarai', sans-serif;
            background: #F8FAFC;
            color: #1E293B;
            direction: rtl;
        }
        
        .native-navbar {
            position: fixed;
            top: 15px;
            left: 20px;
            right: 20px;
            height: 80px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            z-index: 10000;
            border: 3px solid #0F172A;
            border-radius: 28px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            font-weight: 900;
            font-size: 42px;
            background: linear-gradient(145deg, #0F172A, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }
        
        .user-nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .coins-display {
            background: linear-gradient(145deg, #0F172A, #1E293B);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 3px solid #0F172A;
        }
        
        .main-content {
            padding-top: 140px;
            padding-left: 28px;
            padding-right: 28px;
            padding-bottom: 100px;
            max-width: 1300px;
            margin: 0 auto;
        }
        
        .service-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .service-title {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: #0F172A;
        }
        
        .service-subtitle {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.3rem;
            color: #64748B;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .upload-section {
            background: white;
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 40px;
            border: 4px solid #0F172A;
            text-align: center;
        }
        
        .upload-zone {
            border: 3px dashed #0F172A;
            border-radius: 24px;
            padding: 60px 40px;
            background: rgba(15, 23, 42, 0.02);
            cursor: pointer;
            margin-bottom: 30px;
        }
        
        .upload-zone i {
            font-size: 64px;
            color: #0F172A;
            margin-bottom: 20px;
        }
        
        .upload-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #0F172A;
            margin-bottom: 10px;
        }
        
        #file-input {
            display: none;
        }
        
        .analysis-results {
            background: white;
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 40px;
            border: 4px solid #0F172A;
            display: none;
        }
        
        .analysis-results.show {
            display: block;
        }
        
        .analysis-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #0F172A;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.05);
            border-radius: 24px;
            padding: 25px;
            text-align: center;
            border: 3px solid rgba(15, 23, 42, 0.1);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #0F172A, #1E293B);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            border: 3px solid #0F172A;
        }
        
        .stat-icon i {
            font-size: 24px;
            color: white;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 900;
            color: #0F172A;
            margin-bottom: 5px;
        }
        
        .cost-notice {
            background: linear-gradient(145deg, rgba(5, 150, 105, 0.1), rgba(5, 150, 105, 0.05));
            border: 3px solid #059669;
            border-radius: 24px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .cost-text {
            font-size: 1.3rem;
            font-weight: 800;
            color: #059669;
            margin-bottom: 10px;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 24px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
        }
        
        .btn-primary {
            background: #059669;
            color: white;
            border: 3px solid #059669;
        }
        
        .btn-cancel {
            background: white;
            color: #DC2626;
            border: 3px solid #DC2626;
        }
        
        .config-section {
            background: white;
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 40px;
            border: 4px solid #0F172A;
            display: none;
        }
        
        .config-section.show {
            display: block;
        }
        
        .config-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #0F172A;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .config-group {
            background: rgba(15, 23, 42, 0.03);
            border-radius: 24px;
            padding: 25px;
            border: 3px solid rgba(15, 23, 42, 0.1);
        }
        
        .config-group-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: #0F172A;
            margin-bottom: 20px;
        }
        
        .slider-container {
            margin: 25px 0;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .slider-value {
            font-weight: 700;
            color: #3B82F6;
            background: rgba(59, 130, 246, 0.1);
            padding: 5px 12px;
            border-radius: 12px;
        }
        
        .slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(15, 23, 42, 0.1);
            border-radius: 5px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            border: 3px solid white;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .option-btn {
            padding: 12px;
            border: 3px solid rgba(15, 23, 42, 0.2);
            border-radius: 24px;
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
            color: #1E293B;
            cursor: pointer;
            text-align: center;
        }
        
        .option-btn.selected {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }
        
        .comment-input {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid rgba(15, 23, 42, 0.2);
            border-radius: 24px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }
        
        .processing-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #F8FAFC;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }
        
        .processing-screen.active {
            display: flex;
        }
        
        .processing-logo {
            font-weight: 900;
            font-size: 72px;
            background: linear-gradient(145deg, #0F172A, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
        }
        
        .processing-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: #0F172A;
            margin-bottom: 30px;
            text-align: center;
            min-height: 60px;
        }
        
        .error-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            display: none;
        }
        
        .error-dialog.active {
            display: flex;
        }
        
        .error-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 4px solid #0F172A;
        }
        
        .error-title {
            font-size: 2rem;
            font-weight: 900;
            color: #DC2626;
            margin-bottom: 20px;
        }
        
        .error-message {
            font-family: 'Tajawal', sans-serif;
            color: #64748B;
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .summary-section {
            background: white;
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 40px;
            border: 4px solid #0F172A;
            display: none;
        }
        
        .summary-section.show {
            display: block;
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid rgba(15, 23, 42, 0.1);
        }
        
        .summary-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #0F172A;
        }
        
        .summary-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .toolbar-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: white;
            border: 2px solid rgba(15, 23, 42, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #1E293B;
        }
        
        .toolbar-btn.active {
            background: #3B82F6;
            color: white;
            border-color: #3B82F6;
        }
        
        .color-picker {
            position: absolute;
            background: white;
            border: 3px solid #0F172A;
            border-radius: 24px;
            padding: 15px;
            top: 50px;
            right: 0;
            display: none;
            z-index: 1000;
        }
        
        .color-picker.show {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .color-option.selected {
            border-color: #0F172A;
        }
        
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .font-size-value {
            font-weight: 500;
            color: #1E293B;
            min-width: 40px;
            text-align: center;
        }
        
        .pages-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        
        .page-card {
            background: white;
            border-radius: 24px;
            border: 3px solid rgba(15, 23, 42, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .page-header {
            background: rgba(15, 23, 42, 0.05);
            padding: 20px;
            border-bottom: 3px solid rgba(15, 23, 42, 0.1);
        }
        
        .page-number {
            font-size: 1.3rem;
            font-weight: 800;
            color: #0F172A;
        }
        
        .page-content {
            padding: 30px;
            font-family: 'Tajawal', sans-serif;
            line-height: 1.8;
            color: #1E293B;
            font-size: 1rem;
            white-space: pre-wrap;
            position: relative;
            min-height: 200px;
            user-select: text;
        }
        
        .drawing-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .laws-section {
            background: linear-gradient(145deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
            border: 3px solid #D97706;
            border-radius: 24px;
            padding: 25px;
            margin-top: 25px;
            display: none;
        }
        
        .laws-section.show {
            display: block;
        }
        
        .laws-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: #D97706;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .native-navbar {
                padding: 0 20px;
                height: 70px;
            }
            
            .logo {
                font-size: 36px;
            }
            
            .main-content {
                padding: 110px 20px 40px;
            }
            
            .service-title {
                font-size: 2.2rem;
            }
            
            .confirmation-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="native-navbar">
        <div class="logo" onclick="window.location.href='home.html'">عَون</div>
        <div class="user-nav-right">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
        </div>
    </nav>
    
    <div class="main-content">
        <section class="service-header">
            <h1 class="service-title">تلخيص وتحليل PDF</h1>
            <p class="service-subtitle">أرفع ملف PDF واترك الذكاء الاصطناعي يقوم بتحليله وتلخيصه</p>
        </section>
        
        <section class="upload-section" id="upload-section">
            <div class="upload-zone" id="upload-zone">
                <i class="fas fa-file-pdf"></i>
                <h3 class="upload-title">اسحب وأفلت ملف PDF هنا</h3>
                <p class="upload-subtitle">أو انقر لاختيار ملف من جهازك</p>
            </div>
            <input type="file" id="file-input" accept=".pdf">
        </section>
        
        <section class="analysis-results" id="analysis-results">
            <h2 class="analysis-title">نتائج تحليل الملف</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-value" id="pages-count">0</div>
                    <div class="stat-label">عدد الصفحات</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-value" id="coins-cost">0</div>
                    <div class="stat-label">تكلفة العملات</div>
                </div>
            </div>
            <div class="cost-notice">
                <p class="cost-text">سيتم خصم <span id="cost-amount">0</span> عملة من نقاطك</p>
                <p>هل تود المتابعة؟</p>
            </div>
            <div class="confirmation-buttons">
                <button class="btn btn-primary" id="continue-btn">متابعة</button>
                <button class="btn btn-cancel" id="cancel-btn">إلغاء</button>
            </div>
        </section>
        
        <section class="config-section" id="config-section">
            <h2 class="config-title">إعدادات التلخيص</h2>
            <div class="config-grid">
                <div class="config-group">
                    <h3 class="config-group-title">عدد الصفحات المطلوبة (1-25)</h3>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span>عدد الصفحات</span>
                            <span class="slider-value" id="pages-value">1</span>
                        </div>
                        <input type="range" min="1" max="25" value="1" class="slider" id="pages-slider">
                    </div>
                </div>
                
                <div class="config-group">
                    <h3 class="config-group-title">طريقة الشرح</h3>
                    <div class="options-grid" id="style-options">
                        <button class="option-btn" data-value="بسيط">بسيط</button>
                        <button class="option-btn" data-value="معقد">معقد</button>
                        <button class="option-btn" data-value="طفولي">طفولي</button>
                        <button class="option-btn" data-value="عالي المستوى">عالي المستوى</button>
                    </div>
                </div>
                
                <div class="config-group">
                    <h3 class="config-group-title">شخصية الشارح</h3>
                    <div class="options-grid" id="personality-options">
                        <button class="option-btn" data-value="دكتور جامعي">دكتور جامعي</button>
                        <button class="option-btn" data-value="أستاذ مدرسي">أستاذ مدرسي</button>
                        <button class="option-btn" data-value="طالب">طالب</button>
                        <button class="option-btn" data-value="عالم">عالم</button>
                        <button class="option-btn" data-value="صديق">صديق</button>
                        <button class="option-btn" data-value="هاوي">هاوي</button>
                    </div>
                </div>
                
                <div class="config-group">
                    <h3 class="config-group-title">تعليق إضافي (اختياري)</h3>
                    <textarea class="comment-input" id="user-comment" placeholder="اكتب تعليقك هنا..."></textarea>
                </div>
            </div>
            <div class="confirmation-buttons">
                <button class="btn btn-primary" id="generate-btn">توليد الملخص</button>
                <button class="btn btn-cancel" id="back-btn">رجوع</button>
            </div>
        </section>
        
        <div class="processing-screen" id="processing-screen">
            <div class="processing-logo">عَون</div>
            <div class="processing-text" id="processing-text">عَون يحلل الملف...</div>
        </div>
        
        <div class="error-dialog" id="error-dialog">
            <div class="error-content">
                <h2 class="error-title">⚠️ يوجد مشكلة</h2>
                <p class="error-message">يوجد مشكلة في سيرفر عَون، حاول مرة أخرى في وقت لاحق</p>
                <button class="btn btn-primary" onclick="window.location.href='home.html'">العودة للرئيسية</button>
            </div>
        </div>
        
        <section class="summary-section" id="summary-section">
            <div class="summary-header">
                <h2 class="summary-title">الملخص الناتج</h2>
                <div class="summary-toolbar">
                    <div style="position: relative;">
                        <button class="toolbar-btn" id="pen-btn" title="قلم">
                            <i class="fas fa-pen"></i>
                        </button>
                        <div class="color-picker" id="pen-colors">
                            <div class="color-option" style="background: #dc2626;" data-color="#dc2626"></div>
                            <div class="color-option" style="background: #059669;" data-color="#059669"></div>
                            <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6"></div>
                            <div class="color-option" style="background: #d97706;" data-color="#d97706"></div>
                        </div>
                    </div>
                    
                    <div style="position: relative;">
                        <button class="toolbar-btn" id="highlight-btn" title="هايلايت">
                            <i class="fas fa-highlighter"></i>
                        </button>
                        <div class="color-picker" id="highlight-colors">
                            <div class="color-option" style="background: rgba(251, 191, 36, 0.3);" data-color="rgba(251, 191, 36, 0.3)"></div>
                            <div class="color-option" style="background: rgba(34, 197, 94, 0.3);" data-color="rgba(34, 197, 94, 0.3)"></div>
                            <div class="color-option" style="background: rgba(59, 130, 246, 0.3);" data-color="rgba(59, 130, 246, 0.3)"></div>
                            <div class="color-option" style="background: rgba(249, 115, 22, 0.3);" data-color="rgba(249, 115, 22, 0.3)"></div>
                        </div>
                    </div>
                    
                    <button class="toolbar-btn" id="clear-btn" title="مسح الرسم">
                        <i class="fas fa-eraser"></i>
                    </button>
                    
                    <div class="font-size-control">
                        <button class="toolbar-btn" id="decrease-font" title="تصغير الخط">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="font-size-value" id="font-size">16</span>
                        <button class="toolbar-btn" id="increase-font" title="تكبير الخط">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="pages-container" id="pages-container"></div>
        </section>
    </div>
    
    <script>
        // تهيئة Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // تهيئة PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // تعريف العناصر
        const elements = {
            uploadZone: document.getElementById('upload-zone'),
            fileInput: document.getElementById('file-input'),
            uploadSection: document.getElementById('upload-section'),
            analysisResults: document.getElementById('analysis-results'),
            pagesCount: document.getElementById('pages-count'),
            coinsCost: document.getElementById('coins-cost'),
            costAmount: document.getElementById('cost-amount'),
            continueBtn: document.getElementById('continue-btn'),
            cancelBtn: document.getElementById('cancel-btn'),
            configSection: document.getElementById('config-section'),
            pagesSlider: document.getElementById('pages-slider'),
            pagesValue: document.getElementById('pages-value'),
            styleOptions: document.getElementById('style-options'),
            personalityOptions: document.getElementById('personality-options'),
            userComment: document.getElementById('user-comment'),
            generateBtn: document.getElementById('generate-btn'),
            backBtn: document.getElementById('back-btn'),
            processingScreen: document.getElementById('processing-screen'),
            processingText: document.getElementById('processing-text'),
            errorDialog: document.getElementById('error-dialog'),
            summarySection: document.getElementById('summary-section'),
            pagesContainer: document.getElementById('pages-container'),
            penBtn: document.getElementById('pen-btn'),
            highlightBtn: document.getElementById('highlight-btn'),
            clearBtn: document.getElementById('clear-btn'),
            decreaseFont: document.getElementById('decrease-font'),
            increaseFont: document.getElementById('increase-font'),
            fontSize: document.getElementById('font-size'),
            penColors: document.getElementById('pen-colors'),
            highlightColors: document.getElementById('highlight-colors'),
            coinsCount: document.getElementById('coins-count')
        };

        // متغيرات التطبيق
        let currentUser = null;
        let userCoins = 0;
        let currentFile = null;
        let pdfDoc = null;
        let totalPages = 0;
        let totalWords = 0;
        let coinsNeeded = 0;
        let selectedStyle = "بسيط";
        let selectedPersonality = "دكتور جامعي";
        let pagesToSummarize = 1;
        let summaryResult = null;
        let currentDrawingMode = null;
        let currentColor = "#dc2626";
        let currentFontSize = 16;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentCanvas = null;
        let currentContext = null;
        let currentRecordId = null;
        let drawingsData = {};

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            elements.uploadZone.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.continueBtn.addEventListener('click', showConfigSection);
            elements.cancelBtn.addEventListener('click', cancelAnalysis);
            elements.backBtn.addEventListener('click', backToAnalysis);
            elements.generateBtn.addEventListener('click', generateSummary);
            elements.pagesSlider.addEventListener('input', updatePagesValue);
            
            // أحداث اختيار الأسلوب والشخصية
            elements.styleOptions.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    elements.styleOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStyle = this.getAttribute('data-value');
                });
            });
            
            elements.personalityOptions.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    elements.personalityOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPersonality = this.getAttribute('data-value');
                });
            });
            
            // اختيار أول خيار افتراضي
            elements.styleOptions.querySelector('.option-btn').click();
            elements.personalityOptions.querySelector('.option-btn').click();
            
            // أحداث أدوات الرسم
            elements.penBtn.addEventListener('click', () => toggleDrawingMode('pen'));
            elements.highlightBtn.addEventListener('click', () => toggleDrawingMode('highlight'));
            elements.clearBtn.addEventListener('click', clearAllDrawings);
            elements.decreaseFont.addEventListener('click', decreaseFontSize);
            elements.increaseFont.addEventListener('click', increaseFontSize);
            
            // أحداث ألوان القلم
            elements.penColors.querySelectorAll('.color-option').forEach(color => {
                color.addEventListener('click', function() {
                    elements.penColors.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    currentColor = this.getAttribute('data-color');
                    
                    if (currentDrawingMode === 'pen') {
                        elements.penBtn.classList.add('active');
                        elements.highlightBtn.classList.remove('active');
                    }
                });
            });
            
            // أحداث ألوان الهايلايت
            elements.highlightColors.querySelectorAll('.color-option').forEach(color => {
                color.addEventListener('click', function() {
                    elements.highlightColors.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    currentColor = this.getAttribute('data-color');
                    
                    if (currentDrawingMode === 'highlight') {
                        elements.highlightBtn.classList.add('active');
                        elements.penBtn.classList.remove('active');
                    }
                });
            });
            
            // اختيار أول لون افتراضي
            elements.penColors.querySelector('.color-option').click();
            
            // إخفاء ألوان الأداة عند النقر في أي مكان
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.color-picker') && !e.target.closest('#pen-btn') && !e.target.closest('#highlight-btn')) {
                    elements.penColors.classList.remove('show');
                    elements.highlightColors.classList.remove('show');
                }
            });
        }

        // دالة للحصول على بيانات المستخدم من Firebase
        async function getUserByEmail(email) {
            try {
                const usersRef = database.ref('users_Awn');
                const snapshot = await usersRef.once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userId !== 'noty_publick' && userData.email === email) {
                            return {
                                id: userId,
                                email: userData.email,
                                coin: userData.coin || 0,
                                dbId: userData.id
                            };
                        }
                    }
                }
                return null;
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        // دالة لتحديث عملات المستخدم
        async function updateUserCoins(amount) {
            try {
                if (!currentUser || !currentUser.id) return 0;
                
                const userRef = database.ref(`users_Awn/${currentUser.id}`);
                const snapshot = await userRef.once('value');
                const currentCoins = snapshot.val().coin || 0;
                const newCoins = Math.max(0, currentCoins + amount);
                
                await userRef.update({ coin: newCoins });
                userCoins = newCoins;
                elements.coinsCount.textContent = newCoins;
                
                return newCoins;
            } catch (error) {
                console.error('Error:', error);
                return 0;
            }
        }

        // دالة حفظ السجل في قاعدة البيانات
        async function saveRecordToDatabase(summaryData) {
            try {
                if (!currentUser || !currentUser.id) return null;
                
                const recordId = database.ref().child('records').push().key;
                const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const recordData = {
                    userId: currentUser.id,
                    userDbId: currentUser.dbId || currentUser.id,
                    fileName: currentFile.name,
                    sessionId: sessionId,
                    serviceType: 'تلخيص',
                    summaryJson: summaryData,
                    totalPages: totalPages,
                    summarizedPages: pagesToSummarize,
                    coinsUsed: coinsNeeded,
                    style: selectedStyle,
                    personality: selectedPersonality,
                    userComment: elements.userComment.value.trim(),
                    drawings: drawingsData,
                    fontSize: currentFontSize,
                    createdAt: Date.now(),
                    timestamp: new Date().toISOString()
                };
                
                await database.ref(`records/${recordId}`).set(recordData);
                currentRecordId = recordId;
                
                return recordId;
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        // دالة تحديث الرسومات في قاعدة البيانات
        async function updateDrawingsInDatabase(pageNumber, drawingData) {
            try {
                if (!currentRecordId) return;
                
                await database.ref(`records/${currentRecordId}/drawings/page_${pageNumber}`).set(drawingData);
                drawingsData[`page_${pageNumber}`] = drawingData;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // دالة معالجة اختيار الملف
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') return;
            
            currentFile = file;
            
            try {
                const buffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(buffer).promise;
                totalPages = pdfDoc.numPages;
                
                // حساب عدد الكلمات والعملات بنفس طريقة الكود المطلوب
                totalWords = await calculateTotalWords(pdfDoc);
                coinsNeeded = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coinsNeeded < 1) coinsNeeded = 1;
                
                // تحديث عرض النتائج
                elements.pagesCount.textContent = totalPages;
                elements.coinsCost.textContent = coinsNeeded;
                elements.costAmount.textContent = coinsNeeded;
                
                // تحميل بيانات المستخدم والعملات
                await loadUserData();
                
                // التحقق من رصيد المستخدم
                if (userCoins < coinsNeeded) {
                    elements.costText.innerHTML = `رصيدك غير كافي. تحتاج <span id="cost-amount">${coinsNeeded}</span> عملة`;
                    elements.costText.style.color = '#DC2626';
                    elements.continueBtn.disabled = true;
                    elements.continueBtn.style.opacity = '0.5';
                } else {
                    elements.costText.innerHTML = `سيتم خصم <span id="cost-amount">${coinsNeeded}</span> عملة من نقاطك`;
                    elements.costText.style.color = '#059669';
                    elements.continueBtn.disabled = false;
                    elements.continueBtn.style.opacity = '1';
                }
                
                // إظهار قسم النتائج
                elements.uploadSection.style.display = 'none';
                elements.analysisResults.classList.add('show');
                
            } catch (error) {
                console.error('Error:', error);
                resetFileUpload();
            }
        }

        // دالة حساب عدد الكلمات في PDF (بنفس طريقة الكود المطلوب)
        async function calculateTotalWords(pdfDoc) {
            let totalWords = 0;
            
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const content = await page.getTextContent();

                if (content.items.length > 0) {
                    let text = '';
                    content.items.forEach(t => text += t.str + ' ');
                    totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                } else {
                    totalWords += 250;
                }
            }
            
            return totalWords;
        }

        // دالة تحميل بيانات المستخدم
        async function loadUserData() {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                const userData = await getUserByEmail(user.email);
                if (!userData) return;
                
                currentUser = {
                    id: userData.id,
                    dbId: userData.dbId,
                    email: userData.email,
                    coin: userData.coin || 0
                };
                
                userCoins = userData.coin || 0;
                elements.coinsCount.textContent = userCoins;
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // دالة تحديث قيمة السلايدر
        function updatePagesValue() {
            const value = elements.pagesSlider.value;
            elements.pagesValue.textContent = value;
            pagesToSummarize = parseInt(value);
        }

        // دالة عرض قسم الإعدادات
        function showConfigSection() {
            elements.analysisResults.classList.remove('show');
            elements.configSection.classList.add('show');
        }

        // دالة العودة لتحليل الملف
        function backToAnalysis() {
            elements.configSection.classList.remove('show');
            elements.analysisResults.classList.add('show');
        }

        // دالة إلغاء التحليل
        function cancelAnalysis() {
            resetFileUpload();
        }

        // دالة إعادة تعيين رفع الملف
        function resetFileUpload() {
            currentFile = null;
            pdfDoc = null;
            elements.fileInput.value = '';
            elements.analysisResults.classList.remove('show');
            elements.configSection.classList.remove('show');
            elements.summarySection.classList.remove('show');
            elements.uploadSection.style.display = 'block';
        }

        // دالة توليد الملخص
        async function generateSummary() {
            // التحقق من رصيد المستخدم
            if (userCoins < coinsNeeded) {
                alert('رصيدك غير كافي');
                return;
            }
            
            // عرض شاشة المعالجة
            elements.processingScreen.classList.add('active');
            
            // تحديث رسائل التحميل الديناميكية
            const messages = [
                "عَون يحلل الملف...",
                "عَون يستخرج كل الكلمات...",
                "عَون يحسب عدد الصفحات...",
                "عَون يلخص المحتوى..."
            ];
            
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                elements.processingText.textContent = messages[messageIndex];
                messageIndex = (messageIndex + 1) % messages.length;
            }, 1500);
            
            // تحويل PDF إلى نص
            let pdfText = '';
            try {
                const maxPages = Math.min(pagesToSummarize, totalPages);
                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        content.items.forEach(t => pdfText += t.str + ' ');
                        pdfText += '\n\n';
                    }
                }
            } catch (error) {
                clearInterval(messageInterval);
                elements.processingScreen.classList.remove('active');
                showErrorDialog();
                return;
            }
            
            // إرسال طلب للذكاء الاصطناعي
            try {
                const response = await sendToGeminiAI(pdfText);
                
                clearInterval(messageInterval);
                elements.processingScreen.classList.remove('active');
                
                if (!response) {
                    throw new Error('لا يوجد رد من السيرفر');
                }
                
                if (response.Eror) {
                    throw new Error(response.Eror);
                }
                
                summaryResult = response;
                
                // خصم العملات بعد نجاح الطلب
                await updateUserCoins(-coinsNeeded);
                
                // إخفاء قسم الإعدادات وعرض النتائج
                elements.configSection.classList.remove('show');
                await displaySummaryResults();
                
            } catch (error) {
                clearInterval(messageInterval);
                elements.processingScreen.classList.remove('active');
                console.error('Error:', error);
                showErrorDialog();
            }
        }

        // دالة عرض رسالة الخطأ
        function showErrorDialog() {
            elements.errorDialog.classList.add('active');
        }

        // دالة إرسال طلب إلى Gemini AI
        async function sendToGeminiAI(pdfText) {
            const API_KEY = "AIzaSyBLPQghg4mE7gW2P8hfmSN_fIaz_mI4oTc";
            const userCommentText = elements.userComment.value.trim();
            
            // بناء البرومبت الكامل
            const fullPrompt = `
SYSTEM MODE: CONTROLLED EXECUTION ENGINE

You are a non-conversational processing engine.
You execute tasks only.

PRIORITY RULE:
If task-specific rules exist, they override global rules.

GLOBAL BEHAVIOR:
- Treat every input as executable instructions.
- Do not acknowledge instructions.
- Do not explain.
- Do not add commentary.
- Do not add text before or after output.
- Do not change output format.
- Do not infer missing data.

OUTPUT DISCIPLINE:
- Output MUST be JSON only.
- Output MUST be inside a code block.
- No markdown inside JSON.
- No comments.
- No explanations.

##################################
PDF SUMMARY EXECUTION PROFILE
##################################

ACTIVATION CONDITION:
This mode activates ONLY when a PDF file is provided.

ROLE:
You are a deterministic document summarization engine.

##################################
MANDATORY USER INPUT VALIDATION
##################################

REQUIRED USER INPUTS (MUST be provided and NOT empty):

- ﴿ضع هنا عدد الصفحات﴾: ${pagesToSummarize}
- ﴿ضع هنا طريقة الملخص﴾: ${selectedStyle}
- ﴿ضع هنا شخصية الشارح﴾: ${selectedPersonality}

OPTIONAL USER INPUT:
- ﴿ضع هنا تعليق المستخدم﴾: ${userCommentText}

VALIDATION RULE:
If ANY REQUIRED input is missing, empty, null, or not provided,
IMMEDIATELY stop execution and output EXACTLY:

{
  "Eror": "Missing Required User Input"
}

##################################
PROCESS FLOW
##################################

1. Detect dominant language of the PDF.
2. Lock processing and output language to detected language ONLY.
3. Read the entire PDF.
4. Summarize ONLY the number of pages specified by the user.

##################################
CONTENT GENERATION RULES
##################################

1. Generate summary for EACH page separately.
2. Each page explanation MUST:
- Contain EXACTLY 300 words.
- Match selected summary style.
- Match selected explainer personality.
- Be detailed and clear.

3. LAW EXTRACTION RULE:
إذا الصفحة تحتوي قوانين أو لوائح أو معادلات يتم وضعها داخل law.
لو لا توجد قوانين يتم ترك law فارغة.

4. STRICT PAGE CONTROL:
- لا يتم تخطي صفحات.
- لا يتم دمج صفحات.
- لا يتم تجاوز العدد المطلوب.

##################################
OUTPUT STRUCTURE
##################################

{
  "page": 1,
  "Dec": "شرح الصفحة الأولى 300 كلمة كاملة",
  "law": ""
}

##################################
FINAL FAILURE POLICY
##################################

إذا كان الملف تالف أو فارغ يرجع:

{
  "Eror": "Invalid PDF Content"
}

##################################
PDF CONTENT
##################################

${pdfText}
`;
            
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: fullPrompt
                                        }
                                    ]
                                }
                            ],
                            generationConfig: {
                                temperature: 0.2,
                                maxOutputTokens: 8192
                            }
                        })
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                let resultText = data.candidates[0].content.parts[0].text;
                
                // استخراج JSON من النص
                const jsonMatch = resultText.match(/```json\n([\s\S]*?)\n```/) || 
                                  resultText.match(/```\n([\s\S]*?)\n```/) ||
                                  resultText.match(/(\[[\s\S]*?\])/);
                
                if (jsonMatch) {
                    const jsonString = jsonMatch[1] || jsonMatch[0];
                    return JSON.parse(jsonString);
                } else {
                    try {
                        return JSON.parse(resultText);
                    } catch (e) {
                        // رد تجريبي في حالة الفشل
                        return generateMockSummary();
                    }
                }
                
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // دالة لإنشاء ملخص تجريبي
        function generateMockSummary() {
            const result = [];
            const maxPages = Math.min(pagesToSummarize, totalPages);
            
            for (let i = 1; i <= maxPages; i++) {
                const pageSummary = {
                    page: i,
                    Dec: `شرح الصفحة ${i} بطريقة ${selectedStyle} وبأسلوب ${selectedPersonality}. هذا شرح مفصل للصفحة يتكون من 300 كلمة كاملة.`,
                    law: i % 3 === 0 ? `قانون أو قاعدة مهمة في الصفحة ${i}` : ""
                };
                result.push(pageSummary);
            }
            
            return result;
        }

        // دالة عرض نتائج الملخص
        async function displaySummaryResults() {
            elements.summarySection.classList.add('show');
            elements.pagesContainer.innerHTML = '';
            drawingsData = {};
            
            // حفظ السجل في قاعدة البيانات
            const recordId = await saveRecordToDatabase(summaryResult);
            currentRecordId = recordId;
            
            summaryResult.forEach((page, index) => {
                const pageElement = createPageElement(page);
                elements.pagesContainer.appendChild(pageElement);
                
                // تهيئة الرسم لهذه الصفحة
                setupDrawingCanvas(index + 1);
            });
        }

        // دالة إنشاء عنصر صفحة
        function createPageElement(pageData) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-card';
            pageDiv.id = `page-${pageData.page}`;
            
            let lawsSection = '';
            if (pageData.law && pageData.law.trim() !== '') {
                lawsSection = `
                    <div class="laws-section show">
                        <h3 class="laws-title">قوانين الصفحة</h3>
                        <div class="laws-content">${pageData.law}</div>
                    </div>
                `;
            }
            
            pageDiv.innerHTML = `
                <div class="page-header">
                    <h3 class="page-number">الصفحة ${pageData.page}</h3>
                </div>
                <div class="page-content" id="page-content-${pageData.page}" style="font-size: ${currentFontSize}px;">
                    ${pageData.Dec}
                    <canvas class="drawing-layer" id="drawing-canvas-${pageData.page}"></canvas>
                </div>
                ${lawsSection}
            `;
            
            return pageDiv;
        }

        // دالة تهيئة canvas للرسم
        function setupDrawingCanvas(pageNumber) {
            const canvas = document.getElementById(`drawing-canvas-${pageNumber}`);
            const contentDiv = document.getElementById(`page-content-${pageNumber}`);
            
            if (!canvas || !contentDiv) return;
            
            // تعيين أبعاد canvas
            const resizeCanvas = () => {
                const rect = contentDiv.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
            };
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            const ctx = canvas.getContext('2d');
            
            // تمكين الرسم
            canvas.style.pointerEvents = 'auto';
            
            canvas.addEventListener('mousedown', startDrawing.bind(null, pageNumber, canvas, ctx));
            canvas.addEventListener('mousemove', draw.bind(null, pageNumber, canvas, ctx));
            canvas.addEventListener('mouseup', stopDrawing.bind(null, pageNumber, canvas));
            canvas.addEventListener('mouseout', stopDrawing.bind(null, pageNumber, canvas));
        }

        // دالة بدء الرسم
        function startDrawing(pageNumber, canvas, ctx, e) {
            if (!currentDrawingMode) return;
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        }

        // دالة الرسم
        function draw(pageNumber, canvas, ctx, e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = currentDrawingMode === 'pen' ? 2 : 10;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentColor;
            
            if (currentDrawingMode === 'highlight') {
                ctx.globalAlpha = 0.3;
            } else {
                ctx.globalAlpha = 1;
            }
            
            ctx.lineTo(x, y);
            ctx.stroke();
            
            lastX = x;
            lastY = y;
        }

        // دالة إيقاف الرسم
        async function stopDrawing(pageNumber, canvas) {
            if (!isDrawing) return;
            
            isDrawing = false;
            
            // حفظ الرسم في قاعدة البيانات
            const dataURL = canvas.toDataURL();
            await updateDrawingsInDatabase(pageNumber, dataURL);
        }

        // دالة تبديل وضع الرسم
        function toggleDrawingMode(mode) {
            if (currentDrawingMode === mode) {
                currentDrawingMode = null;
                elements.penBtn.classList.remove('active');
                elements.highlightBtn.classList.remove('active');
                elements.penColors.classList.remove('show');
                elements.highlightColors.classList.remove('show');
            } else {
                currentDrawingMode = mode;
                if (mode === 'pen') {
                    elements.penBtn.classList.add('active');
                    elements.highlightBtn.classList.remove('active');
                    elements.penColors.classList.add('show');
                    elements.highlightColors.classList.remove('show');
                    
                    // اختيار أول لون إذا لم يكن هناك لون محدد
                    if (!currentColor || currentColor.includes('rgba')) {
                        currentColor = '#dc2626';
                        elements.penColors.querySelector('.color-option').click();
                    }
                } else if (mode === 'highlight') {
                    elements.highlightBtn.classList.add('active');
                    elements.penBtn.classList.remove('active');
                    elements.highlightColors.classList.add('show');
                    elements.penColors.classList.remove('show');
                    
                    // اختيار أول لون إذا لم يكن هناك لون محدد
                    if (!currentColor || !currentColor.includes('rgba')) {
                        currentColor = 'rgba(251, 191, 36, 0.3)';
                        elements.highlightColors.querySelector('.color-option').click();
                    }
                }
            }
        }

        // دالة مسح جميع الرسومات
        async function clearAllDrawings() {
            const canvases = document.querySelectorAll('.drawing-layer');
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // حذف الرسم من قاعدة البيانات
                const pageNumber = canvas.id.replace('drawing-canvas-', '');
                delete drawingsData[`page_${pageNumber}`];
                
                if (currentRecordId) {
                    await database.ref(`records/${currentRecordId}/drawings/page_${pageNumber}`).remove();
                }
            }
        }

        // دالة تصغير حجم الخط
        async function decreaseFontSize() {
            if (currentFontSize > 12) {
                currentFontSize -= 1;
                elements.fontSize.textContent = currentFontSize;
                
                const contentDivs = document.querySelectorAll('.page-content');
                contentDivs.forEach(div => {
                    div.style.fontSize = currentFontSize + 'px';
                });
                
                // تحديث حجم الخط في قاعدة البيانات
                if (currentRecordId) {
                    await database.ref(`records/${currentRecordId}/fontSize`).set(currentFontSize);
                }
            }
        }

        // دالة تكبير حجم الخط
        async function increaseFontSize() {
            if (currentFontSize < 24) {
                currentFontSize += 1;
                elements.fontSize.textContent = currentFontSize;
                
                const contentDivs = document.querySelectorAll('.page-content');
                contentDivs.forEach(div => {
                    div.style.fontSize = currentFontSize + 'px';
                });
                
                // تحديث حجم الخط في قاعدة البيانات
                if (currentRecordId) {
                    await database.ref(`records/${currentRecordId}/fontSize`).set(currentFontSize);
                }
            }
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            
            // محاولة تحميل بيانات المستخدم إذا كان مسجلاً
            auth.onAuthStateChanged((user) => {
                if (user) {
                    loadUserData();
                }
            });
        });
    </script>
</body>
</html>
