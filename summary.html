from flask import Flask, request, jsonify
from flask_cors import CORS
import google.genai as genai
from google.genai import types
import base64
import json

app = Flask(__name__)
CORS(app)  # السماح بالطلبات من frontend

client = genai.Client(
    api_key="AIzaSyBLPQghg4mE7gW2P8hfmSN_fIaz_mI4oTc"
)

@app.route('/gemini-summary', methods=['POST'])
def gemini_summary():
    try:
        # استقبال البيانات من frontend
        prompt = request.form.get('prompt')
        pdf_file = request.files.get('pdf_file')
        selected_pages = request.form.get('selected_pages')
        summary_type = request.form.get('summary_type')
        explainer = request.form.get('explainer')
        user_comment = request.form.get('user_comment')
        
        # هنا يمكنك إرسال الملف والنص إلى Gemini
        response = client.models.generate_content(
            model="models/gemini-2.5-flash-lite",
            contents=[
                types.Content(
                    parts=[
                        types.Part(text=prompt),
                        types.Part.from_bytes(
                            data=pdf_file.read(),
                            mime_type="application/pdf"
                        )
                    ]
                )
            ],
            config=types.GenerateContentConfig(
                temperature=0.2,
                max_output_tokens=512
            )
        )
        
        # تحليل الاستجابة وإرجاع JSON
        result_text = response.candidates[0].content.parts[0].text
        # تحويل النص إلى JSON بناءً على هيكل الاستجابة
        
        return jsonify({"success": True, "data": json.loads(result_text)})
        
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

if __name__ == '__main__':
    app.run(debug=True, port=5000)
