<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>تلخيص PDF - عون</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
.header{background:#1a73e8;color:#fff;padding:15px;display:flex;justify-content:space-between}
.section{display:none;background:#fff;margin:20px;padding:20px;border-radius:8px}
.section.active{display:block}
button{padding:10px 20px;background:#1a73e8;color:#fff;border:0;border-radius:5px;cursor:pointer}
</style>
</head>

<body>

<div class="header">
<div>عون</div>
<div>النقاط: <span id="coinsCount">0</span></div>
</div>

<div id="uploadSection" class="section active">
<h2>رفع ملف PDF</h2>
<input type="file" id="pdfInput" accept=".pdf">
</div>

<div id="loadingSection" class="section">
<h2 id="loadingText">جارٍ المعالجة...</h2>
</div>

<div id="resultsSection" class="section">
<h2>النتيجة</h2>
<div id="resultsContent"></div>
</div>

<script>
// ================= Firebase =================
firebase.initializeApp({
apiKey:"AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
databaseURL:"https://marvel1-654dd-default-rtdb.firebaseio.com"
});
const database=firebase.database();

// ================= Globals =================
let pdfBuffer=null;
const GEMINI_KEY="AIzaSyBLPQghg4mE7gW2P8hfmSN_fIaz_mI4oTc";
const GEMINI_MODEL="gemini-2.5-flash-lite";

// ================= PDF Upload =================
document.getElementById("pdfInput").addEventListener("change",async e=>{
const file=e.target.files[0];
if(!file)return;
show("loadingSection","تحليل الملف...");
pdfBuffer=new Uint8Array(await file.arrayBuffer());
const result=await sendToGemini(1,"بسيط","دكتور جامعي","");
show("resultsSection");
display(result);
});

// ================= Gemini =================
async function sendToGemini(pages,style,personality,comment){

const prompt=`
OUTPUT JSON ONLY
[
 {
  "page":1,
  "Dec":"شرح 300 كلمة",
  "law":""
 }
]
`;

let binary="";
for(let i=0;i<pdfBuffer.length;i++){
binary+=String.fromCharCode(pdfBuffer[i]);
}
const base64=btoa(binary);

const response=await fetch(
`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_KEY}`,
{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
contents:[{
parts:[
{text:prompt},
{inline_data:{mime_type:"application/pdf",data:base64}}
]
}],
generationConfig:{
temperature:0.2,
maxOutputTokens:4096,
topP:0.8,
topK:40
}
})
});

if(!response.ok) throw new Error("Gemini error");

const data=await response.json();
const text=data.candidates[0].content.parts[0].text;
return JSON.parse(text);
}

// ================= UI =================
function show(id,text){
document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
if(text)document.getElementById("loadingText").textContent=text;
}

function display(results){
const c=document.getElementById("resultsContent");
c.innerHTML="";
results.forEach(r=>{
c.innerHTML+=`
<div style="margin:10px;padding:10px;border:1px solid #ccc">
<h3>الصفحة ${r.page}</h3>
<p>${r.Dec}</p>
${r.law?`<div><b>قوانين:</b>${r.law}</div>`:""}
</div>`;
});
}
</script>

</body>
</html>
