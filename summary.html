<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ„Ø®ÙŠØµ PDF - Ø¹ÙÙˆÙ†</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }
        
        .top-bar {
            background: #1a73e8;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .coins-display {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        h2 {
            color: #1a73e8;
            margin-bottom: 20px;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
        }
        
        #uploadArea {
            border: 3px dashed #1a73e8;
            border-radius: 8px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            background: #f8f9fa;
        }
        
        #uploadArea:hover {
            background: #e8f0fe;
        }
        
        #pdfInput {
            display: none;
        }
        
        .analysis-result {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .result-box {
            background: #e8f0fe;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid #1a73e8;
        }
        
        .result-value {
            font-size: 28px;
            font-weight: bold;
            color: #1a73e8;
            margin: 10px 0;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0d62d9;
        }
        
        .btn-secondary {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #c82333;
        }
        
        .control-group {
            margin: 20px 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        
        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .option-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .option-btn.selected {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin: 10px 0;
            resize: vertical;
            min-height: 80px;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 15px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }
        
        .result-page {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #ddd;
            position: relative;
        }
        
        .page-header {
            background: #1a73e8;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .law-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .tools {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .tool-btn {
            padding: 10px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .tool-btn.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        canvas {
            border: 2px solid #1a73e8;
            border-radius: 8px;
            background: white;
            cursor: crosshair;
            display: block;
            margin: 20px auto;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo">Ø¹ÙÙˆÙ†</div>
        <div class="coins-display">
            <span id="coinsCount">0</span> Ù†Ù‚Ø·Ø©
        </div>
    </div>
    
    <div class="container">
        <div id="alert" class="alert"></div>
        
        <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù -->
        <div id="uploadSection" class="section active">
            <h2>Ø±ÙØ¹ Ù…Ù„Ù PDF</h2>
            <div id="uploadArea">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
                <div style="font-size: 20px; margin-bottom: 10px; color: #1a73e8;">Ø§Ù†Ù‚Ø± Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù PDF Ù‡Ù†Ø§</div>
                <div style="color: #666;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10MB</div>
                <input type="file" id="pdfInput" accept=".pdf">
            </div>
        </div>
        
        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
        <div id="analysisSection" class="section">
            <h2>Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h2>
            <div class="analysis-result">
                <div class="result-box">
                    <div>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª</div>
                    <div class="result-value" id="pagesCount">0</div>
                </div>
                <div class="result-box">
                    <div>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</div>
                    <div class="result-value" id="wordsCount">0</div>
                </div>
                <div class="result-box">
                    <div>Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                    <div class="result-value" id="coinsCost">0</div>
                </div>
            </div>
            <div style="text-align: center; margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 6px;">
                Ø³ÙŠØªÙ… Ø®ØµÙ… <span id="coinsToDeduct" style="font-weight: bold; color: #1a73e8;">0</span> Ù†Ù‚Ø·Ø© Ù…Ù† Ø±ØµÙŠØ¯Ùƒ
            </div>
            <div class="buttons">
                <button id="btnConfirm" class="btn-primary">Ù…ØªØ§Ø¨Ø¹Ø©</button>
                <button id="btnCancel" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
        
        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµ -->
        <div id="controlSection" class="section">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµ</h2>
            
            <div class="control-group">
                <label>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙ„Ø®ÙŠØµÙ‡Ø§: <span id="pagesValue">1</span></label>
                <input type="range" id="pagesSlider" min="1" max="25" value="1">
            </div>
            
            <div class="control-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø´Ø±Ø­:</label>
                <div class="options" id="styleOptions">
                    <div class="option-btn" data-value="Ø¨Ø³ÙŠØ·">Ø¨Ø³ÙŠØ·</div>
                    <div class="option-btn" data-value="Ù…Ø¹Ù‚Ø¯">Ù…Ø¹Ù‚Ø¯</div>
                    <div class="option-btn" data-value="Ø·ÙÙˆÙ„ÙŠ">Ø·ÙÙˆÙ„ÙŠ</div>
                    <div class="option-btn" data-value="Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰">Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
                </div>
            </div>
            
            <div class="control-group">
                <label>Ø´Ø®ØµÙŠØ© Ø§Ù„Ø´Ø§Ø±Ø­:</label>
                <div class="options" id="personalityOptions">
                    <div class="option-btn" data-value="Ø¯ÙƒØªÙˆØ± Ø¬Ø§Ù…Ø¹ÙŠ">Ø¯ÙƒØªÙˆØ± Ø¬Ø§Ù…Ø¹ÙŠ</div>
                    <div class="option-btn" data-value="Ø£Ø³ØªØ§Ø° Ù…Ø¯Ø±Ø³ÙŠ">Ø£Ø³ØªØ§Ø° Ù…Ø¯Ø±Ø³ÙŠ</div>
                    <div class="option-btn" data-value="Ø·Ø§Ù„Ø¨">Ø·Ø§Ù„Ø¨</div>
                    <div class="option-btn" data-value="Ø¹Ø§Ù„Ù…">Ø¹Ø§Ù„Ù…</div>
                    <div class="option-btn" data-value="ØµØ¯ÙŠÙ‚">ØµØ¯ÙŠÙ‚</div>
                    <div class="option-btn" data-value="Ù‡Ø§ÙˆÙŠ">Ù‡Ø§ÙˆÙŠ</div>
                </div>
            </div>
            
            <div class="control-group">
                <label>ØªØ¹Ù„ÙŠÙ‚ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <textarea id="userComment" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
            </div>
            
            <div class="buttons">
                <button id="btnGenerate" class="btn-primary">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ„Ø®ÙŠØµ</button>
            </div>
        </div>
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div id="loadingSection" class="section">
            <div class="loading">
                <div style="font-size: 48px; margin-bottom: 20px;">â³</div>
                <div class="loading-text" id="loadingText">Ø¹ÙÙˆÙ† ÙŠØ­Ù„Ù„ Ø§Ù„Ù…Ù„Ù...</div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="resultsSection" class="section">
            <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ„Ø®ÙŠØµ</h2>
            
            <div class="tools">
                <button class="tool-btn active" id="btnPen">âœï¸ Ù‚Ù„Ù…</button>
                <button class="tool-btn" id="btnHighlighter">ğŸ–ï¸ ØªØ¸Ù„ÙŠÙ„</button>
                <input type="color" id="colorPicker" value="#000000">
                <button class="tool-btn" id="btnClear">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
                <button class="tool-btn" id="btnSaveDraw">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…</button>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <canvas id="drawingCanvas" width="750" height="400"></canvas>
            </div>
            
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // ==================== ØªÙ‡ÙŠØ¦Ø© Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ==================== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ====================
        let currentUser = null;
        let userData = null;
        let uploadedFile = null;
        let fileAnalysis = null;
        let selectedStyle = "Ø¨Ø³ÙŠØ·";
        let selectedPersonality = "Ø¯ÙƒØªÙˆØ± Ø¬Ø§Ù…Ø¹ÙŠ";
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø³Ù…
        let canvas, ctx;
        let drawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let lineWidth = 2;
        let drawings = [];

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====================
        async function checkAuth() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData();
                        resolve(true);
                    } else {
                        showAlert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        resolve(false);
                    }
                });
            });
        }

        async function loadUserData() {
            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                const usersRef = database.ref('users_Awn');
                const snapshot = await usersRef.once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userId !== 'noty_publick' && userData.email === currentUser.email) {
                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                            currentUser.uid = userId;
                            currentUser.dbId = userData.id;
                            currentUser.name = userData.name || '';
                            currentUser.coin = userData.coin || 0;
                            currentUser.admin = userData.admin === true;
                            currentUser.banned = userData.banned === true;
                            
                            // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø·
                            document.getElementById('coinsCount').textContent = currentUser.coin;
                            
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¸ÙˆØ±
                            if (currentUser.banned) {
                                await auth.signOut();
                                showAlert("Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±", "error");
                                setTimeout(() => {
                                    window.location.href = 'login.html';
                                }, 2000);
                                return false;
                            }
                            
                            return true;
                        }
                    }
                }
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await auth.signOut();
                showAlert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ", "error");
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return false;
                
            } catch (error) {
                console.error("Error loading user data:", error);
                return false;
            }
        }

        // ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ====================
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('pdfInput').click();
        });

        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ø§Ù„Ù…Ù„Ù
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, () => {
                document.getElementById('uploadArea').style.backgroundColor = '#e8f0fe';
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, () => {
                document.getElementById('uploadArea').style.backgroundColor = '#f8f9fa';
            }, false);
        });

        document.getElementById('uploadArea').addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                document.getElementById('pdfInput').files = files;
                handleFileUpload(files[0]);
            } else {
                showAlert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù PDF ÙÙ‚Ø·", "error");
            }
        }

        document.getElementById('pdfInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!await checkAuth()) return;
                await handleFileUpload(file);
            }
        });

        async function handleFileUpload(file) {
            if (file.size > 10 * 1024 * 1024) {
                showAlert("Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 10MB", "error");
                return;
            }

            uploadedFile = file;
            
            // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            showSection('loadingSection');
            updateLoadingText("Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...");
            
            // ØªØ­Ù„ÙŠÙ„ PDF
            await analyzePDF(file);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            showSection('analysisSection');
        }

        // ==================== ØªØ­Ù„ÙŠÙ„ PDF ====================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function analyzePDF(file) {
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }

                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;

                fileAnalysis = {
                    pages: pdf.numPages,
                    words: totalWords,
                    coins: coins,
                    fileName: file.name,
                    fileBuffer: buffer
                };

                document.getElementById('pagesCount').textContent = fileAnalysis.pages;
                document.getElementById('wordsCount').textContent = fileAnalysis.words.toLocaleString();
                document.getElementById('coinsCost').textContent = fileAnalysis.coins;
                document.getElementById('coinsToDeduct').textContent = fileAnalysis.coins;

            } catch (error) {
                console.error("Error analyzing PDF:", error);
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF", "error");
                showSection('uploadSection');
            }
        }

        // ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ====================
        document.getElementById('btnCancel').addEventListener('click', () => {
            resetUpload();
            showAlert("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡", "error");
        });

        document.getElementById('btnConfirm').addEventListener('click', async () => {
            if (!currentUser) {
                showAlert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "error");
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
            if (currentUser.coin < fileAnalysis.coins) {
                showAlert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ", "error");
                return;
            }

            // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            try {
                const userRef = database.ref(`users_Awn/${currentUser.uid}`);
                await userRef.update({
                    coin: currentUser.coin - fileAnalysis.coins
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ
                currentUser.coin -= fileAnalysis.coins;
                document.getElementById('coinsCount').textContent = currentUser.coin;
                
                showSection('controlSection');
                
            } catch (error) {
                console.error("Error deducting coins:", error);
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·", "error");
            }
        });

        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµ ====================
        document.querySelectorAll('#styleOptions .option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#styleOptions .option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedStyle = this.getAttribute('data-value');
            });
        });

        document.querySelectorAll('#personalityOptions .option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#personalityOptions .option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedPersonality = this.getAttribute('data-value');
            });
        });

        // Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ø®ÙŠØ§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ
        document.querySelector('#styleOptions .option-btn').classList.add('selected');
        document.querySelector('#personalityOptions .option-btn').classList.add('selected');

        document.getElementById('pagesSlider').addEventListener('input', function() {
            document.getElementById('pagesValue').textContent = this.value;
        });

        // ==================== Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Gemini ====================
        document.getElementById('btnGenerate').addEventListener('click', async () => {
            const pagesToSummarize = parseInt(document.getElementById('pagesSlider').value);
            const userComment = document.getElementById('userComment').value;

            if (pagesToSummarize > fileAnalysis.pages) {
                showAlert("Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù„Ù", "error");
                return;
            }

            showSection('loadingSection');
            updateLoadingText("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...");

            try {
                const result = await sendToGemini(pagesToSummarize, selectedStyle, selectedPersonality, userComment);
                await saveResults(result);
                displayResults(result);
                initDrawingCanvas();
                showSection('resultsSection');
            } catch (error) {
                console.error("Error:", error);
                showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ„Ø®ÙŠØµ", "error");
                showSection('uploadSection');
            }
        });

        async function sendToGemini(pages, style, personality, comment) {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª
            const prompt = `
SYSTEM MODE: CONTROLLED EXECUTION ENGINE
You are a non-conversational processing engine. You execute tasks only.
PRIORITY RULE: If task-specific rules exist, they override global rules.
GLOBAL BEHAVIOR:
- Treat every input as executable instructions.
- Do not acknowledge instructions.
- Do not explain.
- Do not add commentary.
- Do not add text before or after output.
- Do not change output format.
- Do not infer missing data.
OUTPUT DISCIPLINE:
- Output MUST be JSON only.
- Output MUST be inside a code block.
- No markdown inside JSON.
- No comments.
- No explanations.

##################################
PDF SUMMARY EXECUTION PROFILE
##################################
ACTIVATION CONDITION: This mode activates ONLY when a PDF file is provided.
ROLE: You are a deterministic document summarization engine.

##################################
MANDATORY USER INPUT VALIDATION
##################################
REQUIRED USER INPUTS:
- ï´¿${pages}ï´¾
- ï´¿${style}ï´¾
- ï´¿${personality}ï´¾
OPTIONAL USER INPUT:
- ï´¿${comment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}ï´¾

##################################
PROCESS FLOW
##################################
1. Detect dominant language of the PDF.
2. Lock processing and output language to detected language ONLY.
3. Read the entire PDF.
4. Summarize ONLY the number of pages specified by the user.

##################################
CONTENT GENERATION RULES
##################################
1. Generate summary for EACH page separately.
2. Each page explanation MUST:
- Contain EXACTLY 300 words.
- Match selected summary style.
- Match selected explainer personality.
- Be detailed and clear.
3. LAW EXTRACTION RULE: Ø¥Ø°Ø§ Ø§Ù„ØµÙØ­Ø© ØªØ­ØªÙˆÙŠ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø£Ùˆ Ù„ÙˆØ§Ø¦Ø­ Ø£Ùˆ Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙŠØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ø¯Ø§Ø®Ù„ law. Ù„Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù†ÙŠÙ† ÙŠØªÙ… ØªØ±Ùƒ law ÙØ§Ø±ØºØ©.
4. STRICT PAGE CONTROL:
- Ù„Ø§ ÙŠØªÙ… ØªØ®Ø·ÙŠ ØµÙØ­Ø§Øª.
- Ù„Ø§ ÙŠØªÙ… Ø¯Ù…Ø¬ ØµÙØ­Ø§Øª.
- Ù„Ø§ ÙŠØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.

##################################
OUTPUT STRUCTURE
##################################
[
  {
    "page": 1,
    "Dec": "Ø´Ø±Ø­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ 300 ÙƒÙ„Ù…Ø© ÙƒØ§Ù…Ù„Ø©",
    "law": ""
  }
]

##################################
FINAL FAILURE POLICY
##################################
Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ÙØ§Ø±Øº ÙŠØ±Ø¬Ø¹:
{
  "Eror": "Invalid PDF Content"
}

Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù‡Ùˆ PDF ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${fileAnalysis.pages} ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ ØªÙ„Ø®ÙŠØµ Ø£ÙˆÙ„ ${pages} ØµÙØ­Ø§Øª.
            `;

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Gemini API
            const apiKey = "AIzaSyBLPQghg4mE7gW2P8hfmSN_fIaz_mI4oTc";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ base64
            const base64Data = arrayBufferToBase64(fileAnalysis.fileBuffer);

            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: "application/pdf",
                                data: base64Data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    temperature: 0.2,
                    maxOutputTokens: 8192
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0].content.parts[0].text) {
                const text = data.candidates[0].content.parts[0].text;
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON Ù…Ù† Ø§Ù„Ù†Øµ
                const jsonMatch = text.match(/\[\s*\{[\s\S]*\}\s*\]/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            }
            
            throw new Error("Invalid response from Gemini");
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // ==================== Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ====================
        async function saveResults(results) {
            const recordId = `record_${Date.now()}_${currentUser.uid}`;
            const recordData = {
                userId: currentUser.uid,
                userName: currentUser.name || currentUser.email,
                userEmail: currentUser.email,
                fileName: uploadedFile.name,
                fileSize: uploadedFile.size,
                pages: fileAnalysis.pages,
                summarizedPages: results.length,
                summaryStyle: selectedStyle,
                explainerPersonality: selectedPersonality,
                coinsUsed: fileAnalysis.coins,
                summaryResults: results,
                timestamp: Date.now(),
                status: "completed",
                type: "summary"
            };

            await database.ref(`records/${recordId}`).set(recordData);
            console.log("Results saved to database");
            
            // Ø­ÙØ¸ Ø£ÙŠØ¶Ù‹Ø§ ÙÙŠ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await database.ref(`users_Awn/${currentUser.uid}/records/${recordId}`).set({
                type: "summary",
                fileName: uploadedFile.name,
                timestamp: Date.now(),
                coinsUsed: fileAnalysis.coins
            });
        }

        // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ====================
        function displayResults(results) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = '';
            
            results.forEach(result => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'result-page';
                pageDiv.innerHTML = `
                    <div class="page-header">
                        <div>Ø§Ù„ØµÙØ­Ø© ${result.page}</div>
                        <div>${selectedPersonality} - ${selectedStyle}</div>
                    </div>
                    <div style="line-height: 1.8; margin: 20px 0;">
                        ${result.Dec}
                    </div>
                    ${result.law ? `
                    <div class="law-section">
                        <strong>Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†:</strong>
                        <div style="margin-top: 10px;">${result.law}</div>
                    </div>
                    ` : ''}
                `;
                container.appendChild(pageDiv);
            });
        }

        // ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ù… ====================
        function initDrawingCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            loadDrawings();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            
            // Ø­ÙØ¸ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            drawings.push({
                tool: currentTool,
                color: currentColor,
                points: [{x: e.offsetX, y: e.offsetY}]
            });
        }

        function draw(e) {
            if (!drawing) return;
            
            ctx.lineWidth = currentTool === 'highlighter' ? 10 : lineWidth;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentTool === 'highlighter' ? currentColor + '80' : currentColor;
            
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ù„Ù„Ø±Ø³Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (drawings.length > 0) {
                drawings[drawings.length - 1].points.push({
                    x: e.offsetX,
                    y: e.offsetY
                });
            }
        }

        function stopDrawing() {
            drawing = false;
            ctx.beginPath();
        }

        // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…
        document.getElementById('btnPen').addEventListener('click', function() {
            currentTool = 'pen';
            lineWidth = 2;
            document.getElementById('btnPen').classList.add('active');
            document.getElementById('btnHighlighter').classList.remove('active');
        });

        document.getElementById('btnHighlighter').addEventListener('click', function() {
            currentTool = 'highlighter';
            lineWidth = 10;
            document.getElementById('btnHighlighter').classList.add('active');
            document.getElementById('btnPen').classList.remove('active');
        });

        document.getElementById('colorPicker').addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawings = [];
        });

        document.getElementById('btnSaveDraw').addEventListener('click', async () => {
            if (!drawings.length) {
                showAlert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø³Ù… Ù„Ø­ÙØ¸Ù‡", "error");
                return;
            }
            
            try {
                const drawingId = `drawing_${Date.now()}_${currentUser.uid}`;
                await database.ref(`drawings/${drawingId}`).set({
                    userId: currentUser.uid,
                    timestamp: Date.now(),
                    drawings: drawings,
                    relatedTo: uploadedFile.name
                });
                showAlert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…", "success");
            } catch (error) {
                console.error("Error saving drawing:", error);
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…", "error");
            }
        });

        async function loadDrawings() {
            try {
                const snapshot = await database.ref('drawings')
                    .orderByChild('userId')
                    .equalTo(currentUser.uid)
                    .limitToLast(1)
                    .once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const lastDrawing = Object.values(data)[0].drawings;
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù…
                    lastDrawing.forEach(drawing => {
                        ctx.strokeStyle = drawing.color;
                        ctx.lineWidth = drawing.tool === 'highlighter' ? 10 : 2;
                        ctx.lineCap = 'round';
                        
                        ctx.beginPath();
                        drawing.points.forEach((point, i) => {
                            if (i === 0) {
                                ctx.moveTo(point.x, point.y);
                            } else {
                                ctx.lineTo(point.x, point.y);
                            }
                        });
                        ctx.stroke();
                    });
                }
            } catch (error) {
                console.error("Error loading drawings:", error);
            }
        }

        // ==================== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showAlert(message, type = "success") {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function resetUpload() {
            document.getElementById('pdfInput').value = '';
            uploadedFile = null;
            fileAnalysis = null;
            showSection('uploadSection');
        }

        // ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            document.querySelector('#styleOptions .option-btn').classList.add('selected');
            document.querySelector('#personalityOptions .option-btn').classList.add('selected');
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¯Ø±Ø§Øº Ø£Ù†Ø¯ Ø¯Ø±ÙˆØ¨ Ù„Ù„Ø±ÙØ¹
            setupDragAndDrop();
        });

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#0d62d9';
                uploadArea.style.backgroundColor = '#e8f0fe';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#1a73e8';
                uploadArea.style.backgroundColor = '#f8f9fa';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#1a73e8';
                uploadArea.style.backgroundColor = '#f8f9fa';
            });
        }
    </script>
</body>
</html>
