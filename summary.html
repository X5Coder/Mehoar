<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تلخيص PDF - عون</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* ... نفس الـ CSS السابق ... */
    </style>
</head>
<body>
    <!-- ... نفس الـ HTML السابق ... -->

    <script>
        // ==================== Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ==================== Global Variables ====================
        let currentUser = null;
        let uploadedFile = null;
        let fileAnalysis = null;
        let selectedStyle = "بسيط";
        let selectedPersonality = "دكتور جامعي";
        let canvas, ctx;
        let drawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let pdfBuffer = null;
        let pdfDocument = null;
        let isAuthenticated = false; // ✅ تتبع حالة المصادقة

        // ==================== Authentication ====================
        async function initializeAuth() {
            return new Promise((resolve) => {
                // ✅ واحد listener فقط عند التحميل
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        const success = await loadUserData();
                        if (success) {
                            isAuthenticated = true;
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    } else {
                        showAlert("يجب تسجيل الدخول", "error");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        resolve(false);
                    }
                });
            });
        }

        async function loadUserData() {
            try {
                const snapshot = await database.ref('users_Awn').once('value');
                const users = snapshot.val();
                
                for (const [userId, userData] of Object.entries(users)) {
                    if (userId !== 'noty_publick' && userData.email === currentUser.email) {
                        currentUser.uid = userId;
                        currentUser.dbId = userData.id;
                        currentUser.name = userData.name || '';
                        currentUser.coin = userData.coin || 0;
                        currentUser.admin = userData.admin === true;
                        currentUser.banned = userData.banned === true;
                        
                        document.getElementById('coinsCount').textContent = currentUser.coin;
                        
                        if (currentUser.banned) {
                            await auth.signOut();
                            showAlert("حسابك محظور", "error");
                            setTimeout(() => window.location.href = 'login.html', 2000);
                            return false;
                        }
                        
                        return true;
                    }
                }
                
                await auth.signOut();
                showAlert("حساب غير موجود", "error");
                setTimeout(() => window.location.href = 'login.html', 2000);
                return false;
                
            } catch (error) {
                console.error("Error loading user:", error);
                return false;
            }
        }

        // ==================== File Upload ====================
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('pdfInput').click();
        });

        document.getElementById('pdfInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!isAuthenticated) {
                    showAlert("يجب تسجيل الدخول أولاً", "error");
                    return;
                }
                await handleFileUpload(file);
            }
        });

        async function handleFileUpload(file) {
            if (file.size > 10 * 1024 * 1024) {
                showAlert("الحد الأقصى 10MB", "error");
                return;
            }

            uploadedFile = file;
            showSection('loadingSection');
            updateLoadingText("جاري تحليل الملف...");
            
            try {
                await analyzePDF(file);
                showSection('analysisSection');
            } catch (error) {
                console.error("Error in file upload:", error);
                showAlert("خطأ في تحليل الملف", "error");
                showSection('uploadSection');
            }
        }

        // ==================== PDF Analysis ====================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function analyzePDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfBuffer = arrayBuffer; // ✅ حفظ الـ buffer بشكل صحيح
                
                pdfDocument = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                
                let totalWords = 0;
                const samplePages = Math.min(pdfDocument.numPages, 5);
                
                for (let i = 1; i <= samplePages; i++) {
                    const page = await pdfDocument.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }
                
                const avgWordsPerPage = Math.floor(totalWords / samplePages);
                const estimatedTotalWords = avgWordsPerPage * pdfDocument.numPages;

                // ✅ إصلاح مشكلة الكسور العشرية
                let coins = Math.ceil((estimatedTotalWords / 1000) * 2) / 2;
                coins = Math.ceil(coins); // ✅ تحويل إلى عدد صحيح
                if (coins < 1) coins = 1;
                if (coins > 100) coins = 100;

                fileAnalysis = {
                    pages: pdfDocument.numPages,
                    words: estimatedTotalWords,
                    coins: coins,
                    fileName: file.name
                };

                document.getElementById('pagesCount').textContent = fileAnalysis.pages;
                document.getElementById('wordsCount').textContent = fileAnalysis.words.toLocaleString();
                document.getElementById('coinsCost').textContent = fileAnalysis.coins;
                document.getElementById('coinsToDeduct').textContent = fileAnalysis.coins;

            } catch (error) {
                console.error("PDF error:", error);
                throw new Error("خطأ في قراءة الملف PDF");
            }
        }

        // ==================== Buttons ====================
        document.getElementById('btnCancel').addEventListener('click', () => {
            resetUpload();
            showAlert("تم الإلغاء", "error");
        });

        document.getElementById('btnConfirm').addEventListener('click', async () => {
            if (!currentUser) return;
            
            if (currentUser.coin < fileAnalysis.coins) {
                showAlert("رصيد غير كافي", "error");
                return;
            }

            const originalCoins = currentUser.coin;
            
            try {
                const userRef = database.ref(`users_Awn/${currentUser.uid}`);
                const newCoins = currentUser.coin - fileAnalysis.coins;
                
                await userRef.update({ coin: newCoins });
                
                currentUser.coin = newCoins;
                document.getElementById('coinsCount').textContent = newCoins;
                
                const transactionId = `trans_${Date.now()}_${currentUser.uid}`;
                await database.ref(`transactions/${transactionId}`).set({
                    userId: currentUser.uid,
                    type: "summary_deduction",
                    amount: fileAnalysis.coins,
                    originalAmount: originalCoins,
                    fileName: uploadedFile.name,
                    timestamp: Date.now(),
                    status: "processing"
                });
                
                currentUser.transactionId = transactionId;
                currentUser.originalCoins = originalCoins;
                
                showSection('controlSection');
                
            } catch (error) {
                console.error("Deduct error:", error);
                showAlert("خطأ في الخصم", "error");
                currentUser.coin = originalCoins;
                document.getElementById('coinsCount').textContent = originalCoins;
            }
        });

        // ==================== Controls ====================
        document.querySelectorAll('#styleOptions .option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#styleOptions .option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedStyle = this.dataset.value;
            });
        });

        document.querySelectorAll('#personalityOptions .option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#personalityOptions .option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedPersonality = this.dataset.value;
            });
        });

        document.querySelector('#styleOptions .option-btn').classList.add('selected');
        document.querySelector('#personalityOptions .option-btn').classList.add('selected');

        document.getElementById('pagesSlider').addEventListener('input', function() {
            const maxPages = fileAnalysis ? fileAnalysis.pages : 25;
            if (this.value > maxPages) {
                this.value = maxPages;
            }
            document.getElementById('pagesValue').textContent = this.value;
        });

        // ==================== Send to Gemini API ====================
        document.getElementById('btnGenerate').addEventListener('click', async () => {
            const pagesToSummarize = parseInt(document.getElementById('pagesSlider').value);
            const userComment = document.getElementById('userComment').value;

            if (pagesToSummarize > fileAnalysis.pages) {
                showAlert("الصفحات المطلوبة أكبر من الملف", "error");
                return;
            }

            showSection('loadingSection');
            updateLoadingText("جارٍ إرسال إلى Gemini...");

            try {
                const result = await sendToGemini(pagesToSummarize, selectedStyle, selectedPersonality, userComment);
                
                if (currentUser.transactionId) {
                    await database.ref(`transactions/${currentUser.transactionId}`).update({
                        status: "completed",
                        summaryResult: "success",
                        completedAt: Date.now()
                    });
                }
                
                await saveResults(result);
                displayResults(result);
                initDrawingCanvas();
                showSection('resultsSection');
                showAlert("تم التلخيص بنجاح!", "success");
                
            } catch (error) {
                console.error("Gemini error:", error);
                await refundCoins();
                showAlert(`خطأ في التلخيص: ${error.message}`, "error");
                showSection('uploadSection');
            }
        });

        async function sendToGemini(pages, style, personality, comment) {
            try {
                // ✅ التحقق من وجود pdfBuffer
                if (!pdfBuffer) {
                    throw new Error("PDF buffer is empty");
                }

                // ✅ تحويل PDF إلى base64 بطريقة آمنة
                const uint8Array = new Uint8Array(pdfBuffer);
                let base64Data = btoa(
                    Array.from(uint8Array)
                        .map(b => String.fromCharCode(b))
                        .join('')
                );

                // ✅ إنشاء البرومبت المحسن
                const prompt = `PDF SUMMARY INSTRUCTIONS:
Summarize the first ${pages} pages of this PDF document.
For each page, provide:
1. A detailed summary in Arabic (approximately 300 words)
2. Any laws, regulations, or formulas found on the page
Use this style: ${style}
Use this personality: ${personality}
${comment ? 'Additional notes: ' + comment : ''}

IMPORTANT: Return ONLY valid JSON in this exact format:
[
  {
    "page": 1,
    "Dec": "شرح مفصل للصفحة الأولى",
    "law": "القوانين إذا وجدت، وإلا اترك فارغًا"
  }
]`;

                // ✅ استخدام API Key المحدد مع النموذج الصحيح
                const apiKey = "AIzaSyBLPQghg4mE7gW2P8hfmSN_fIaz_mI4oTc";
                const model = "gemini-2.5-flash-lite";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: "application/pdf",
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.3,
                        maxOutputTokens: 4096, // ✅ تصحيح للحد الأقصى للنموذج
                        topP: 0.9,
                        topK: 40
                    }
                    // ✅ إزالة safetySettings غير المدعومة
                };

                console.log("Sending request to Gemini API...");
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API Error Response:", errorText);
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                console.log("Gemini Response received");

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts[0]) {
                    throw new Error("Invalid response structure from Gemini");
                }

                const responseText = data.candidates[0].content.parts[0].text;
                console.log("Response length:", responseText.length);

                // ✅ تحسين استخراج JSON
                let jsonResult;
                try {
                    // تنظيف النص من markdown
                    const cleanedText = responseText
                        .replace(/```json|```/g, '')
                        .replace(/^[\s\S]*?(\[)/, '$1') // إزالة أي نص قبل الـ JSON
                        .trim();
                    
                    jsonResult = JSON.parse(cleanedText);
                } catch (e) {
                    // محاولة بديلة
                    const jsonMatch = responseText.match(/\[\s*\{[\s\S]*\}\s*\]/);
                    if (jsonMatch) {
                        jsonResult = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error("No valid JSON found in response");
                    }
                }

                // التحقق من صحة الهيكل
                if (Array.isArray(jsonResult) && jsonResult.length > 0) {
                    const validatedResult = jsonResult.map((item, index) => ({
                        page: item.page || index + 1,
                        Dec: item.Dec || item.dec || item.summary || "لا يوجد شرح متاح",
                        law: item.law || ""
                    }));
                    return validatedResult;
                } else {
                    throw new Error("Invalid response format - expected array");
                }

            } catch (error) {
                console.error("Gemini API error:", error);
                throw error;
            }
        }

        async function refundCoins() {
            try {
                if (!currentUser || !currentUser.transactionId) return;
                
                const userRef = database.ref(`users_Awn/${currentUser.uid}`);
                await userRef.update({ coin: currentUser.originalCoins });
                
                currentUser.coin = currentUser.originalCoins;
                document.getElementById('coinsCount').textContent = currentUser.originalCoins;
                
                await database.ref(`transactions/${currentUser.transactionId}`).update({
                    status: "refunded",
                    refundedAt: Date.now(),
                    error: "Gemini API failed"
                });
                
            } catch (refundError) {
                console.error("Refund error:", refundError);
            }
        }

        // ==================== Save Results ====================
        async function saveResults(results) {
            try {
                const recordId = `record_${Date.now()}_${currentUser.uid}`;
                const recordData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.name || currentUser.email,
                    fileName: uploadedFile.name,
                    fileSize: uploadedFile.size,
                    pages: fileAnalysis.pages,
                    summarizedPages: results.length,
                    summaryStyle: selectedStyle,
                    explainerPersonality: selectedPersonality,
                    coinsUsed: fileAnalysis.coins,
                    summaryResults: results,
                    timestamp: Date.now(),
                    status: "completed",
                    type: "summary",
                    transactionId: currentUser.transactionId || null
                };

                await database.ref(`records/${recordId}`).set(recordData);
                await database.ref(`users_Awn/${currentUser.uid}/records/${recordId}`).set({
                    type: "summary",
                    fileName: uploadedFile.name,
                    timestamp: Date.now(),
                    coinsUsed: fileAnalysis.coins,
                    status: "completed"
                });
                
            } catch (error) {
                console.error("Save results error:", error);
                throw error;
            }
        }

        // ==================== Display Results ====================
        function displayResults(results) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = '';
            
            results.forEach(result => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-result';
                pageDiv.innerHTML = `
                    <div class="page-header">
                        <strong>الصفحة ${result.page}</strong>
                        <small>${selectedPersonality} - ${selectedStyle}</small>
                    </div>
                    <div style="line-height:1.7; margin:15px 0; text-align: right; direction: rtl;">
                        ${result.Dec}
                    </div>
                    ${result.law ? `
                    <div class="law-section">
                        <strong>القوانين/المعادلات:</strong>
                        <div style="margin-top:8px; text-align: right; direction: rtl;">${result.law}</div>
                    </div>
                    ` : ''}
                `;
                container.appendChild(pageDiv);
            });
        }

        // ==================== Drawing ====================
        function initDrawingCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // ✅ تصحيح CSS - توحيد الاسم
            document.getElementById('btnPen').classList.add('selected');
            
            loadDrawings();
        }

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function draw(e) {
            if (!drawing) return;
            
            ctx.lineWidth = currentTool === 'highlighter' ? 10 : 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentTool === 'highlighter' ? currentColor + '80' : currentColor;
            
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function stopDrawing() {
            drawing = false;
        }

        document.getElementById('btnPen').addEventListener('click', function() {
            currentTool = 'pen';
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('btnHighlighter').classList.remove('selected');
        });

        document.getElementById('btnHighlighter').addEventListener('click', function() {
            currentTool = 'highlighter';
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('btnPen').classList.remove('selected');
        });

        document.getElementById('colorPicker').addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        document.getElementById('btnSaveDraw').addEventListener('click', async () => {
            try {
                const drawingId = `draw_${Date.now()}_${currentUser.uid}`;
                const imageData = canvas.toDataURL();
                
                await database.ref(`drawings/${drawingId}`).set({
                    userId: currentUser.uid,
                    image: imageData,
                    timestamp: Date.now(),
                    relatedFile: uploadedFile.name,
                    relatedRecord: currentUser.transactionId
                });
                
                showAlert("تم حفظ الرسم", "success");
            } catch (error) {
                console.error("Save drawing error:", error);
                showAlert("خطأ في حفظ الرسم", "error");
            }
        });

        async function loadDrawings() {
            try {
                const snapshot = await database.ref('drawings')
                    .orderByChild('userId')
                    .equalTo(currentUser.uid)
                    .limitToLast(1)
                    .once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const lastDrawing = Object.values(data)[0];
                    
                    if (lastDrawing.image) {
                        const img = new Image();
                        img.onload = () => {
                            ctx.drawImage(img, 0, 0);
                        };
                        img.src = lastDrawing.image;
                    }
                }
            } catch (error) {
                console.error("Load drawings error:", error);
            }
        }

        // ==================== Helper Functions ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 4000);
        }

        function resetUpload() {
            document.getElementById('pdfInput').value = '';
            uploadedFile = null;
            fileAnalysis = null;
            pdfBuffer = null;
            pdfDocument = null;
            showSection('uploadSection');
        }

        // ==================== Initialize ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAuth();
            
            document.querySelector('#styleOptions .option-btn').classList.add('selected');
            document.querySelector('#personalityOptions .option-btn').classList.add('selected');
        });
    </script>
</body>
</html>
