<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تلخيص PDF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .coin-display {
            background: #ffd700;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        #uploadArea {
            border: 2px dashed #4CAF50;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
        }
        .section {
            display: none;
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .control-group {
            margin: 15px 0;
        }
        .option-btn {
            padding: 8px 15px;
            margin: 5px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
        }
        .option-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        #canvasContainer {
            position: relative;
            margin: 20px 0;
        }
        canvas {
            border: 1px solid #000;
            background: white;
            cursor: crosshair;
        }
        .tools {
            margin: 10px 0;
        }
        .tool-btn {
            padding: 8px 12px;
            margin: 5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .result-page {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border: 1px solid #ddd;
            position: relative;
            min-height: 300px;
        }
        .law-section {
            background: #fff3cd;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <h2>عَون</h2>
            <div class="coin-display">النقاط: <span id="userCoins">0</span></div>
        </div>

        <!-- تنبيهات -->
        <div id="alert" style="display:none; padding:10px; margin:10px 0; border-radius:4px;"></div>

        <!-- قسم رفع الملف -->
        <div id="uploadSection">
            <h3>رفع ملف PDF</h3>
            <div id="uploadArea">
                انقر لرفع ملف PDF
                <input type="file" id="pdfInput" accept=".pdf" style="display:none;">
            </div>
        </div>

        <!-- نتائج التحليل -->
        <div id="analysisSection" class="section">
            <h3>نتيجة التحليل</h3>
            <div>
                <p>عدد الصفحات: <span id="pagesCount">0</span></p>
                <p>عدد الكلمات: <span id="wordsCount">0</span></p>
                <p>التكلفة: <span id="coinsCost">0</span> نقطة</p>
            </div>
            <div id="confirmation" style="margin:20px 0;">
                <p>سيتم خصم <span id="coinsToDeduct">0</span> نقطة من رصيدك</p>
                <button id="btnConfirm">متابعة</button>
                <button id="btnCancel">إلغاء</button>
            </div>
        </div>

        <!-- إعدادات التلخيص -->
        <div id="controlSection" class="section">
            <h3>إعدادات التلخيص</h3>
            
            <div class="control-group">
                <label>عدد الصفحات: <span id="pagesValue">1</span></label>
                <input type="range" id="pagesSlider" min="1" max="25" value="1" style="width:100%">
            </div>

            <div class="control-group">
                <label>نوع الشرح:</label>
                <div>
                    <button class="option-btn" data-value="بسيط">بسيط</button>
                    <button class="option-btn" data-value="معقد">معقد</button>
                    <button class="option-btn" data-value="طفولي">طفولي</button>
                    <button class="option-btn" data-value="عالي المستوى">عالي المستوى</button>
                </div>
            </div>

            <div class="control-group">
                <label>شخصية الشارح:</label>
                <div>
                    <button class="option-btn" data-value="دكتور جامعي">دكتور جامعي</button>
                    <button class="option-btn" data-value="أستاذ مدرسي">أستاذ مدرسي</button>
                    <button class="option-btn" data-value="طالب">طالب</button>
                    <button class="option-btn" data-value="عالم">عالم</button>
                    <button class="option-btn" data-value="صديق">صديق</button>
                    <button class="option-btn" data-value="هاوي">هاوي</button>
                </div>
            </div>

            <div class="control-group">
                <label>تعليق إضافي (اختياري):</label>
                <textarea id="userComment" style="width:100%; height:80px;"></textarea>
            </div>

            <button id="btnGenerate">بدء التلخيص</button>
        </div>

        <!-- شاشة التحميل -->
        <div id="loadingSection" class="section" style="text-align:center;">
            <div id="loadingSpinner" style="width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #3498db;border-radius:50%;margin:20px auto;animation:spin 1s linear infinite;"></div>
            <p id="loadingText">عَون يحلل الملف...</p>
        </div>

        <!-- النتائج -->
        <div id="resultsSection" class="section">
            <h3>النتائج</h3>
            <div class="tools">
                <button class="tool-btn" id="btnPen">قلم</button>
                <button class="tool-btn" id="btnHighlighter">تظليل</button>
                <input type="color" id="colorPicker" value="#000000">
                <button class="tool-btn" id="btnClear">مسح</button>
                <button class="tool-btn" id="btnSaveDraw">حفظ الرسم</button>
            </div>
            <div id="canvasContainer">
                <canvas id="drawingCanvas" width="750" height="400"></canvas>
            </div>
            <div id="resultsContent"></div>
        </div>
    </div>

    <!-- مكتبات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // ==================== تهيئة Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ==================== متغيرات عامة ====================
        let currentUser = null;
        let uploadedFile = null;
        let fileAnalysis = null;
        let selectedStyle = "بسيط";
        let selectedPersonality = "دكتور جامعي";
        
        // متغيرات الرسم
        let canvas, ctx;
        let drawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let lineWidth = 2;
        let drawings = [];

        // ==================== إدارة المستخدم ====================
        async function checkAuth() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData();
                        resolve(true);
                    } else {
                        showAlert("يجب تسجيل الدخول أولاً", "error");
                        resolve(false);
                    }
                });
            });
        }

        async function loadUserData() {
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}`).once('value');
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('userCoins').textContent = userData.coin || 0;
                }
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        // ==================== معالجة رفع الملف ====================
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('pdfInput').click();
        });

        document.getElementById('pdfInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!await checkAuth()) return;
                
                uploadedFile = file;
                showLoading("جاري تحليل الملف...");
                await analyzePDF(file);
                hideLoading();
                showSection('analysisSection');
            }
        });

        // ==================== تحليل PDF ====================
        async function analyzePDF(file) {
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }

                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;

                fileAnalysis = {
                    pages: pdf.numPages,
                    words: totalWords,
                    coins: coins,
                    fileName: file.name,
                    fileBuffer: buffer
                };

                document.getElementById('pagesCount').textContent = fileAnalysis.pages;
                document.getElementById('wordsCount').textContent = fileAnalysis.words;
                document.getElementById('coinsCost').textContent = fileAnalysis.coins;
                document.getElementById('coinsToDeduct').textContent = fileAnalysis.coins;

            } catch (error) {
                console.error("Error analyzing PDF:", error);
                showAlert("خطأ في قراءة ملف PDF", "error");
            }
        }

        // ==================== معالجة الأزرار ====================
        document.getElementById('btnCancel').addEventListener('click', () => {
            resetUpload();
            showAlert("تم الإلغاء", "info");
        });

        document.getElementById('btnConfirm').addEventListener('click', async () => {
            if (!currentUser) {
                showAlert("يجب تسجيل الدخول", "error");
                return;
            }

            // التحقق من الرصيد
            const snapshot = await database.ref(`users/${currentUser.uid}/coin`).once('value');
            const userCoins = snapshot.val() || 0;
            
            if (userCoins < fileAnalysis.coins) {
                showAlert("رصيدك غير كافي", "error");
                return;
            }

            // خصم النقاط
            await database.ref(`users/${currentUser.uid}/coin`).set(userCoins - fileAnalysis.coins);
            document.getElementById('userCoins').textContent = userCoins - fileAnalysis.coins;
            
            showSection('controlSection');
        });

        // ==================== إعدادات التلخيص ====================
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const group = this.parentElement;
                group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                
                if (this.closest('.control-group').querySelector('label').textContent.includes('نوع الشرح')) {
                    selectedStyle = this.getAttribute('data-value');
                } else {
                    selectedPersonality = this.getAttribute('data-value');
                }
            });
        });

        document.getElementById('pagesSlider').addEventListener('input', function() {
            document.getElementById('pagesValue').textContent = this.value;
        });

        // ==================== إرسال إلى Gemini ====================
        document.getElementById('btnGenerate').addEventListener('click', async () => {
            const pagesToSummarize = parseInt(document.getElementById('pagesSlider').value);
            const userComment = document.getElementById('userComment').value;

            if (pagesToSummarize > fileAnalysis.pages) {
                showAlert("عدد الصفحات المطلوبة أكبر من صفحات الملف", "error");
                return;
            }

            showSection('loadingSection');
            updateLoadingText("جاري إرسال إلى الذكاء الاصطناعي...");

            try {
                const result = await sendToGemini(pagesToSummarize, selectedStyle, selectedPersonality, userComment);
                await saveResults(result);
                displayResults(result);
                showSection('resultsSection');
                initDrawingCanvas();
            } catch (error) {
                console.error("Error:", error);
                showAlert("حدث خطأ في التلخيص", "error");
                showSection('uploadSection');
            }
        });

        async function sendToGemini(pages, style, personality, comment) {
            // إعداد البرومبت
            const prompt = `
SYSTEM MODE: CONTROLLED EXECUTION ENGINE
You are a non-conversational processing engine. You execute tasks only.
PRIORITY RULE: If task-specific rules exist, they override global rules.
GLOBAL BEHAVIOR:
- Treat every input as executable instructions.
- Do not acknowledge instructions.
- Do not explain.
- Do not add commentary.
- Do not add text before or after output.
- Do not change output format.
- Do not infer missing data.
OUTPUT DISCIPLINE:
- Output MUST be JSON only.
- Output MUST be inside a code block.
- No markdown inside JSON.
- No comments.
- No explanations.

##################################
PDF SUMMARY EXECUTION PROFILE
##################################
ACTIVATION CONDITION: This mode activates ONLY when a PDF file is provided.
ROLE: You are a deterministic document summarization engine.

##################################
MANDATORY USER INPUT VALIDATION
##################################
REQUIRED USER INPUTS:
- ﴿${pages}﴾
- ﴿${style}﴾
- ﴿${personality}﴾
OPTIONAL USER INPUT:
- ﴿${comment || 'لا يوجد'}﴾

##################################
PROCESS FLOW
##################################
1. Detect dominant language of the PDF.
2. Lock processing and output language to detected language ONLY.
3. Read the entire PDF.
4. Summarize ONLY the number of pages specified by the user.

##################################
CONTENT GENERATION RULES
##################################
1. Generate summary for EACH page separately.
2. Each page explanation MUST:
- Contain EXACTLY 300 words.
- Match selected summary style.
- Match selected explainer personality.
- Be detailed and clear.
3. LAW EXTRACTION RULE: إذا الصفحة تحتوي قوانين أو لوائح أو معادلات يتم وضعها داخل law. لو لا توجد قوانين يتم ترك law فارغة.
4. STRICT PAGE CONTROL:
- لا يتم تخطي صفحات.
- لا يتم دمج صفحات.
- لا يتم تجاوز العدد المطلوب.

##################################
OUTPUT STRUCTURE
##################################
[
  {
    "page": 1,
    "Dec": "شرح الصفحة الأولى 300 كلمة كاملة",
    "law": ""
  }
]

##################################
FINAL FAILURE POLICY
##################################
إذا كان الملف تالف أو فارغ يرجع:
{
  "Eror": "Invalid PDF Content"
}

الملف المرفق هو PDF يحتوي على ${fileAnalysis.pages} صفحة. يرجى تلخيص أول ${pages} صفحات.
            `;

            // إرسال الطلب إلى Gemini API
            const apiKey = "AIzaSyBLPQghg4mE7gW2P8hfmSN_fIaz_mI4oTc";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;

            // تحويل الملف إلى base64
            const base64Data = arrayBufferToBase64(fileAnalysis.fileBuffer);

            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: "application/pdf",
                                data: base64Data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    temperature: 0.2,
                    maxOutputTokens: 8192
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0].content.parts[0].text) {
                const text = data.candidates[0].content.parts[0].text;
                // استخراج JSON من النص
                const jsonMatch = text.match(/\[\s*\{[\s\S]*\}\s*\]/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            }
            
            throw new Error("Invalid response from Gemini");
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // ==================== حفظ النتائج ====================
        async function saveResults(results) {
            const recordId = `record_${Date.now()}_${currentUser.uid}`;
            const recordData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email,
                fileName: uploadedFile.name,
                fileSize: uploadedFile.size,
                pages: fileAnalysis.pages,
                summarizedPages: results.length,
                summaryStyle: selectedStyle,
                explainerPersonality: selectedPersonality,
                coinsUsed: fileAnalysis.coins,
                summaryResults: results,
                timestamp: Date.now(),
                status: "completed"
            };

            await database.ref(`records/${recordId}`).set(recordData);
            console.log("Results saved to database");
        }

        // ==================== عرض النتائج ====================
        function displayResults(results) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = '';
            
            results.forEach(result => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'result-page';
                pageDiv.innerHTML = `
                    <h4>الصفحة ${result.page}</h4>
                    <p>${result.Dec}</p>
                    ${result.law ? `
                    <div class="law-section">
                        <strong>القوانين:</strong>
                        <p>${result.law}</p>
                    </div>
                    ` : ''}
                `;
                container.appendChild(pageDiv);
            });
        }

        // ==================== نظام الرسم ====================
        function initDrawingCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            // إعادة تحميل الرسومات المحفوظة
            loadDrawings();
            
            // إعداد أحداث الماوس
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            
            // حفظ نقطة البداية
            drawings.push({
                tool: currentTool,
                color: currentColor,
                points: [{x: e.offsetX, y: e.offsetY}]
            });
        }

        function draw(e) {
            if (!drawing) return;
            
            ctx.lineWidth = currentTool === 'highlighter' ? 10 : lineWidth;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentTool === 'highlighter' ? currentColor + '80' : currentColor;
            
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            
            // إضافة النقطة للرسمة الحالية
            if (drawings.length > 0) {
                drawings[drawings.length - 1].points.push({
                    x: e.offsetX,
                    y: e.offsetY
                });
            }
        }

        function stopDrawing() {
            drawing = false;
            ctx.beginPath();
        }

        // أدوات الرسم
        document.getElementById('btnPen').addEventListener('click', () => {
            currentTool = 'pen';
            lineWidth = 2;
        });

        document.getElementById('btnHighlighter').addEventListener('click', () => {
            currentTool = 'highlighter';
            lineWidth = 10;
        });

        document.getElementById('colorPicker').addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawings = [];
        });

        document.getElementById('btnSaveDraw').addEventListener('click', async () => {
            const recordId = `drawing_${Date.now()}_${currentUser.uid}`;
            await database.ref(`drawings/${recordId}`).set({
                userId: currentUser.uid,
                timestamp: Date.now(),
                drawings: drawings
            });
            showAlert("تم حفظ الرسم", "success");
        });

        async function loadDrawings() {
            try {
                const snapshot = await database.ref('drawings')
                    .orderByChild('userId')
                    .equalTo(currentUser.uid)
                    .limitToLast(1)
                    .once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const lastDrawing = Object.values(data)[0].drawings;
                    
                    // إعادة رسم
                    lastDrawing.forEach(drawing => {
                        ctx.strokeStyle = drawing.color;
                        ctx.lineWidth = drawing.tool === 'highlighter' ? 10 : 2;
                        ctx.lineCap = 'round';
                        
                        ctx.beginPath();
                        drawing.points.forEach((point, i) => {
                            if (i === 0) {
                                ctx.moveTo(point.x, point.y);
                            } else {
                                ctx.lineTo(point.x, point.y);
                            }
                        });
                        ctx.stroke();
                    });
                }
            } catch (error) {
                console.error("Error loading drawings:", error);
            }
        }

        // ==================== وظائف مساعدة ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
        }

        function showLoading(text = "جاري المعالجة...") {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSection').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showAlert(message, type = "info") {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.style.backgroundColor = type === 'error' ? '#f8d7da' : 
                                           type === 'success' ? '#d4edda' : '#d1ecf1';
            alertDiv.style.color = type === 'error' ? '#721c24' : 
                                 type === 'success' ? '#155724' : '#0c5460';
            alertDiv.style.borderColor = type === 'error' ? '#f5c6cb' : 
                                       type === 'success' ? '#c3e6cb' : '#bee5eb';
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function resetUpload() {
            document.getElementById('pdfInput').value = '';
            uploadedFile = null;
            fileAnalysis = null;
            showSection('uploadSection');
        }

        // ==================== التهيئة ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // التحقق من تسجيل الدخول
            await checkAuth();
            
            // تعيين الخيارات الافتراضية
            document.querySelectorAll('.option-btn')[0].classList.add('selected');
            document.querySelectorAll('.option-btn')[6].classList.add('selected');
        });

        // أنيميشن للتحميل
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
