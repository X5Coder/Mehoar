<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ„Ø®ÙŠØµ PDF - Ø¹ÙˆÙ†</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        body { font-family: Arial; margin: 0; padding: 0; background: #f5f5f5; }
        .header { background: #1a73e8; color: white; padding: 15px 20px; display: flex; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: bold; }
        .coins { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: none; }
        .section.active { display: block; }
        h2 { color: #1a73e8; margin-bottom: 20px; }
        #uploadArea { border: 3px dashed #1a73e8; border-radius: 8px; padding: 50px 20px; text-align: center; cursor: pointer; background: #f8f9fa; }
        input[type="file"] { display: none; }
        .analysis-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .result-box { background: #e8f0fe; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #1a73e8; }
        .result-value { font-size: 24px; font-weight: bold; color: #1a73e8; margin: 5px 0; }
        .buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        button { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-secondary { background: #dc3545; color: white; }
        .control-group { margin: 15px 0; }
        .options { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .option-btn { padding: 8px 15px; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; }
        .option-btn.selected { background: #1a73e8; color: white; border-color: #1a73e8; }
        textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; margin: 10px 0; min-height: 80px; }
        .loading { text-align: center; padding: 30px; }
        .page-result { background: white; border: 1px solid #ddd; border-radius: 6px; padding: 20px; margin: 15px 0; }
        .page-header { background: #1a73e8; color: white; padding: 12px; border-radius: 4px; margin-bottom: 15px; }
        .law-section { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 12px; margin: 10px 0; }
        .tools { display: flex; gap: 8px; margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 4px; }
        canvas { border: 2px solid #1a73e8; border-radius: 6px; background: white; cursor: crosshair; display: block; margin: 0 auto; }
        .alert { padding: 12px; border-radius: 4px; margin: 10px 0; display: none; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Ø¹ÙˆÙ†</div>
        <div class="coins">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="coinsCount">0</span></div>
    </div>
    
    <div class="container">
        <div id="alert" class="alert"></div>
        
        <div id="uploadSection" class="section active">
            <h2>Ø±ÙØ¹ Ù…Ù„Ù PDF Ù„Ù„ØªÙ„Ø®ÙŠØµ</h2>
            <div id="uploadArea">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“</div>
                <div style="font-size: 18px; margin-bottom: 5px; color: #1a73e8;">Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ Ù…Ù„Ù PDF</div>
                <div style="color: #666;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10MB</div>
                <input type="file" id="pdfInput" accept=".pdf">
            </div>
        </div>
        
        <div id="analysisSection" class="section">
            <h2>Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h2>
            <div class="analysis-grid">
                <div class="result-box">
                    <div>Ø§Ù„ØµÙØ­Ø§Øª</div>
                    <div class="result-value" id="pagesCount">0</div>
                </div>
                <div class="result-box">
                    <div>Ø§Ù„ÙƒÙ„Ù…Ø§Øª</div>
                    <div class="result-value" id="wordsCount">0</div>
                </div>
                <div class="result-box">
                    <div>Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                    <div class="result-value" id="coinsCost">0</div>
                </div>
            </div>
            <div style="text-align: center; margin: 15px 0; padding: 12px; background: #fff3cd; border-radius: 6px;">
                Ø³ÙŠØªÙ… Ø®ØµÙ… <span id="coinsToDeduct" style="font-weight: bold; color: #1a73e8;">0</span> Ù†Ù‚Ø·Ø©
            </div>
            <div class="buttons">
                <button id="btnConfirm" class="btn-primary">Ù…ØªØ§Ø¨Ø¹Ø©</button>
                <button id="btnCancel" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
        
        <div id="controlSection" class="section">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø®ÙŠØµ</h2>
            
            <div class="control-group">
                <label>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª: <span id="pagesValue">1</span></label>
                <input type="range" id="pagesSlider" min="1" max="25" value="1" style="width:100%; margin:10px 0;">
            </div>
            
            <div class="control-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø´Ø±Ø­:</label>
                <div class="options" id="styleOptions">
                    <div class="option-btn" data-value="Ø¨Ø³ÙŠØ·">Ø¨Ø³ÙŠØ·</div>
                    <div class="option-btn" data-value="Ù…Ø¹Ù‚Ø¯">Ù…Ø¹Ù‚Ø¯</div>
                    <div class="option-btn" data-value="Ø·ÙÙˆÙ„ÙŠ">Ø·ÙÙˆÙ„ÙŠ</div>
                    <div class="option-btn" data-value="Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰">Ø¹Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
                </div>
            </div>
            
            <div class="control-group">
                <label>Ø´Ø®ØµÙŠØ© Ø§Ù„Ø´Ø§Ø±Ø­:</label>
                <div class="options" id="personalityOptions">
                    <div class="option-btn" data-value="Ø¯ÙƒØªÙˆØ± Ø¬Ø§Ù…Ø¹ÙŠ">Ø¯ÙƒØªÙˆØ± Ø¬Ø§Ù…Ø¹ÙŠ</div>
                    <div class="option-btn" data-value="Ø£Ø³ØªØ§Ø° Ù…Ø¯Ø±Ø³ÙŠ">Ø£Ø³ØªØ§Ø° Ù…Ø¯Ø±Ø³ÙŠ</div>
                    <div class="option-btn" data-value="Ø·Ø§Ù„Ø¨">Ø·Ø§Ù„Ø¨</div>
                    <div class="option-btn" data-value="Ø¹Ø§Ù„Ù…">Ø¹Ø§Ù„Ù…</div>
                    <div class="option-btn" data-value="ØµØ¯ÙŠÙ‚">ØµØ¯ÙŠÙ‚</div>
                    <div class="option-btn" data-value="Ù‡Ø§ÙˆÙŠ">Ù‡Ø§ÙˆÙŠ</div>
                </div>
            </div>
            
            <div class="control-group">
                <label>ØªØ¹Ù„ÙŠÙ‚ Ø¥Ø¶Ø§ÙÙŠ:</label>
                <textarea id="userComment" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
            </div>
            
            <div class="buttons">
                <button id="btnGenerate" class="btn-primary">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ„Ø®ÙŠØµ</button>
            </div>
        </div>
        
        <div id="loadingSection" class="section">
            <div class="loading">
                <div style="font-size: 40px; margin-bottom: 15px;">â³</div>
                <div id="loadingText">Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
            </div>
        </div>
        
        <div id="resultsSection" class="section">
            <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ„Ø®ÙŠØµ</h2>
            
            <div class="tools">
                <button class="option-btn active" id="btnPen">âœï¸ Ù‚Ù„Ù…</button>
                <button class="option-btn" id="btnHighlighter">ğŸ–ï¸ ØªØ¸Ù„ÙŠÙ„</button>
                <input type="color" id="colorPicker" value="#000000" style="height:40px;">
                <button class="option-btn" id="btnClear">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
                <button class="option-btn" id="btnSaveDraw">ğŸ’¾ Ø­ÙØ¸</button>
            </div>
            
            <div style="text-align:center; margin:15px 0;">
                <canvas id="drawingCanvas" width="700" height="350"></canvas>
            </div>
            
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // ==================== Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ==================== Global Variables ====================
        let currentUser = null;
        let uploadedFile = null;
        let fileAnalysis = null;
        let selectedStyle = "Ø¨Ø³ÙŠØ·";
        let selectedPersonality = "Ø¯ÙƒØªÙˆØ± Ø¬Ø§Ù…Ø¹ÙŠ";
        let canvas, ctx;
        let drawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';

        // ==================== Authentication ====================
        async function checkAuth() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData();
                        resolve(true);
                    } else {
                        showAlert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "error");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        resolve(false);
                    }
                });
            });
        }

        async function loadUserData() {
            try {
                const snapshot = await database.ref('users_Awn').once('value');
                const users = snapshot.val();
                
                for (const [userId, userData] of Object.entries(users)) {
                    if (userId !== 'noty_publick' && userData.email === currentUser.email) {
                        currentUser.uid = userId;
                        currentUser.dbId = userData.id;
                        currentUser.name = userData.name || '';
                        currentUser.coin = userData.coin || 0;
                        currentUser.admin = userData.admin === true;
                        currentUser.banned = userData.banned === true;
                        
                        document.getElementById('coinsCount').textContent = currentUser.coin;
                        
                        if (currentUser.banned) {
                            await auth.signOut();
                            showAlert("Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±", "error");
                            setTimeout(() => window.location.href = 'login.html', 2000);
                            return false;
                        }
                        
                        return true;
                    }
                }
                
                await auth.signOut();
                showAlert("Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "error");
                setTimeout(() => window.location.href = 'login.html', 2000);
                return false;
                
            } catch (error) {
                console.error("Error loading user:", error);
                return false;
            }
        }

        // ==================== File Upload ====================
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('pdfInput').click();
        });

        document.getElementById('pdfInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!await checkAuth()) return;
                await handleFileUpload(file);
            }
        });

        async function handleFileUpload(file) {
            if (file.size > 10 * 1024 * 1024) {
                showAlert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB", "error");
                return;
            }

            uploadedFile = file;
            showSection('loadingSection');
            updateLoadingText("Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...");
            
            await analyzePDF(file);
            showSection('analysisSection');
        }

        // ==================== PDF Analysis ====================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function analyzePDF(file) {
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }

                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;

                fileAnalysis = {
                    pages: pdf.numPages,
                    words: totalWords,
                    coins: coins,
                    fileName: file.name,
                    fileBuffer: buffer
                };

                document.getElementById('pagesCount').textContent = fileAnalysis.pages;
                document.getElementById('wordsCount').textContent = fileAnalysis.words.toLocaleString();
                document.getElementById('coinsCost').textContent = fileAnalysis.coins;
                document.getElementById('coinsToDeduct').textContent = fileAnalysis.coins;

            } catch (error) {
                console.error("PDF error:", error);
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© PDF", "error");
                showSection('uploadSection');
            }
        }

        // ==================== Buttons ====================
        document.getElementById('btnCancel').addEventListener('click', () => {
            resetUpload();
            showAlert("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡", "error");
        });

        document.getElementById('btnConfirm').addEventListener('click', async () => {
            if (!currentUser) return;
            
            if (currentUser.coin < fileAnalysis.coins) {
                showAlert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ", "error");
                return;
            }

            try {
                const userRef = database.ref(`users_Awn/${currentUser.uid}`);
                await userRef.update({ coin: currentUser.coin - fileAnalysis.coins });
                
                currentUser.coin -= fileAnalysis.coins;
                document.getElementById('coinsCount').textContent = currentUser.coin;
                
                showSection('controlSection');
                
            } catch (error) {
                console.error("Deduct error:", error);
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®ØµÙ…", "error");
            }
        });

        // ==================== Controls ====================
        document.querySelectorAll('#styleOptions .option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#styleOptions .option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedStyle = this.dataset.value;
            });
        });

        document.querySelectorAll('#personalityOptions .option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#personalityOptions .option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedPersonality = this.dataset.value;
            });
        });

        document.querySelector('#styleOptions .option-btn').classList.add('selected');
        document.querySelector('#personalityOptions .option-btn').classList.add('selected');

        document.getElementById('pagesSlider').addEventListener('input', function() {
            document.getElementById('pagesValue').textContent = this.value;
        });

        // ==================== Send to Gemini API ====================
        document.getElementById('btnGenerate').addEventListener('click', async () => {
            const pagesToSummarize = parseInt(document.getElementById('pagesSlider').value);
            const userComment = document.getElementById('userComment').value;

            if (pagesToSummarize > fileAnalysis.pages) {
                showAlert("Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ù„Ù", "error");
                return;
            }

            showSection('loadingSection');
            updateLoadingText("Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Gemini...");

            try {
                const result = await sendToGemini(pagesToSummarize, selectedStyle, selectedPersonality, userComment);
                await saveResults(result);
                displayResults(result);
                initDrawingCanvas();
                showSection('resultsSection');
            } catch (error) {
                console.error("Gemini error:", error);
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ„Ø®ÙŠØµ: " + error.message, "error");
                showSection('uploadSection');
            }
        });

        async function sendToGemini(pages, style, personality, comment) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª
            const prompt = `
SYSTEM MODE: CONTROLLED EXECUTION ENGINE
You are a non-conversational processing engine. You execute tasks only.
PRIORITY RULE: If task-specific rules exist, they override global rules.
GLOBAL BEHAVIOR:
- Treat every input as executable instructions.
- Do not acknowledge instructions.
- Do not explain.
- Do not add commentary.
- Do not add text before or after output.
- Do not change output format.
- Do not infer missing data.
OUTPUT DISCIPLINE:
- Output MUST be JSON only.
- Output MUST be inside a code block.
- No markdown inside JSON.
- No comments.
- No explanations.

##################################
PDF SUMMARY EXECUTION PROFILE
##################################
ACTIVATION CONDITION: This mode activates ONLY when a PDF file is provided.
ROLE: You are a deterministic document summarization engine.

##################################
MANDATORY USER INPUT VALIDATION
##################################
REQUIRED USER INPUTS:
- ï´¿${pages}ï´¾
- ï´¿${style}ï´¾
- ï´¿${personality}ï´¾
OPTIONAL USER INPUT:
- ï´¿${comment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}ï´¾

##################################
PROCESS FLOW
##################################
1. Detect dominant language of the PDF.
2. Lock processing and output language to detected language ONLY.
3. Read the entire PDF.
4. Summarize ONLY the number of pages specified by the user.

##################################
CONTENT GENERATION RULES
##################################
1. Generate summary for EACH page separately.
2. Each page explanation MUST:
- Contain EXACTLY 300 words.
- Match selected summary style.
- Match selected explainer personality.
- Be detailed and clear.
3. LAW EXTRACTION RULE: Ø¥Ø°Ø§ Ø§Ù„ØµÙØ­Ø© ØªØ­ØªÙˆÙŠ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø£Ùˆ Ù„ÙˆØ§Ø¦Ø­ Ø£Ùˆ Ù…Ø¹Ø§Ø¯Ù„Ø§Øª ÙŠØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ø¯Ø§Ø®Ù„ law. Ù„Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù†ÙŠÙ† ÙŠØªÙ… ØªØ±Ùƒ law ÙØ§Ø±ØºØ©.
4. STRICT PAGE CONTROL:
- Ù„Ø§ ÙŠØªÙ… ØªØ®Ø·ÙŠ ØµÙØ­Ø§Øª.
- Ù„Ø§ ÙŠØªÙ… Ø¯Ù…Ø¬ ØµÙØ­Ø§Øª.
- Ù„Ø§ ÙŠØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.

##################################
OUTPUT STRUCTURE
##################################
[
  {
    "page": 1,
    "Dec": "Ø´Ø±Ø­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ 300 ÙƒÙ„Ù…Ø© ÙƒØ§Ù…Ù„Ø©",
    "law": ""
  }
]

##################################
FINAL FAILURE POLICY
##################################
Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ÙØ§Ø±Øº ÙŠØ±Ø¬Ø¹:
{
  "Eror": "Invalid PDF Content"
}

Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù‡Ùˆ PDF ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${fileAnalysis.pages} ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ ØªÙ„Ø®ÙŠØµ Ø£ÙˆÙ„ ${pages} ØµÙØ­Ø§Øª.
            `;

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ base64
            const base64Data = arrayBufferToBase64(fileAnalysis.fileBuffer);

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Gemini API - Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            const apiKey = "AIzaSyBLPQghg4mE7gW2P8hfmSN_fIaz_mI4oTc";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: "application/pdf",
                                data: base64Data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    temperature: 0.2,
                    maxOutputTokens: 8192
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            
            console.log("Gemini response:", data);
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0].text) {
                const text = data.candidates[0].content.parts[0].text;
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON Ù…Ù† Ø§Ù„Ù†Øµ
                const jsonMatch = text.match(/\[\s*\{[\s\S]*\}\s*\]/);
                if (jsonMatch) {
                    try {
                        return JSON.parse(jsonMatch[0]);
                    } catch (e) {
                        throw new Error("Invalid JSON format in response");
                    }
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ JSONØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹
                    try {
                        const parsed = JSON.parse(text);
                        if (Array.isArray(parsed)) {
                            return parsed;
                        }
                    } catch (e) {
                        throw new Error("No valid JSON found in response");
                    }
                }
            } else if (data.error) {
                throw new Error(`Gemini API Error: ${data.error.message}`);
            }
            
            throw new Error("Invalid response format from Gemini");
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // ==================== Save Results ====================
        async function saveResults(results) {
            const recordId = `record_${Date.now()}_${currentUser.uid}`;
            const recordData = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                fileName: uploadedFile.name,
                fileSize: uploadedFile.size,
                pages: fileAnalysis.pages,
                summarizedPages: results.length,
                summaryStyle: selectedStyle,
                explainerPersonality: selectedPersonality,
                coinsUsed: fileAnalysis.coins,
                summaryResults: results,
                timestamp: Date.now(),
                status: "completed",
                type: "summary"
            };

            await database.ref(`records/${recordId}`).set(recordData);
            
            // Ø­ÙØ¸ ÙÙŠ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await database.ref(`users_Awn/${currentUser.uid}/records/${recordId}`).set({
                type: "summary",
                fileName: uploadedFile.name,
                timestamp: Date.now(),
                coinsUsed: fileAnalysis.coins
            });
            
            showAlert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬", "success");
        }

        // ==================== Display Results ====================
        function displayResults(results) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = '';
            
            results.forEach(result => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-result';
                pageDiv.innerHTML = `
                    <div class="page-header">
                        <strong>Ø§Ù„ØµÙØ­Ø© ${result.page}</strong>
                        <small>${selectedPersonality} - ${selectedStyle}</small>
                    </div>
                    <div style="line-height:1.7; margin:15px 0;">
                        ${result.Dec}
                    </div>
                    ${result.law ? `
                    <div class="law-section">
                        <strong>Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†:</strong>
                        <div style="margin-top:8px;">${result.law}</div>
                    </div>
                    ` : ''}
                `;
                container.appendChild(pageDiv);
            });
        }

        // ==================== Drawing ====================
        function initDrawingCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            loadDrawings();
        }

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function draw(e) {
            if (!drawing) return;
            
            ctx.lineWidth = currentTool === 'highlighter' ? 10 : 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentTool === 'highlighter' ? currentColor + '80' : currentColor;
            
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function stopDrawing() {
            drawing = false;
        }

        document.getElementById('btnPen').addEventListener('click', function() {
            currentTool = 'pen';
            this.classList.add('selected');
            document.getElementById('btnHighlighter').classList.remove('selected');
        });

        document.getElementById('btnHighlighter').addEventListener('click', function() {
            currentTool = 'highlighter';
            this.classList.add('selected');
            document.getElementById('btnPen').classList.remove('selected');
        });

        document.getElementById('colorPicker').addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        document.getElementById('btnSaveDraw').addEventListener('click', async () => {
            try {
                const drawingId = `draw_${Date.now()}_${currentUser.uid}`;
                const imageData = canvas.toDataURL();
                
                await database.ref(`drawings/${drawingId}`).set({
                    userId: currentUser.uid,
                    image: imageData,
                    timestamp: Date.now(),
                    relatedFile: uploadedFile.name
                });
                
                showAlert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…", "success");
            } catch (error) {
                console.error("Save drawing error:", error);
                showAlert("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…", "error");
            }
        });

        async function loadDrawings() {
            try {
                const snapshot = await database.ref('drawings')
                    .orderByChild('userId')
                    .equalTo(currentUser.uid)
                    .limitToLast(1)
                    .once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const lastDrawing = Object.values(data)[0];
                    
                    if (lastDrawing.image) {
                        const img = new Image();
                        img.onload = () => {
                            ctx.drawImage(img, 0, 0);
                        };
                        img.src = lastDrawing.image;
                    }
                }
            } catch (error) {
                console.error("Load drawings error:", error);
            }
        }

        // ==================== Helper Functions ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 4000);
        }

        function resetUpload() {
            document.getElementById('pdfInput').value = '';
            uploadedFile = null;
            fileAnalysis = null;
            showSection('uploadSection');
        }

        // ==================== Initialize ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            
            document.querySelector('#styleOptions .option-btn').classList.add('selected');
            document.querySelector('#personalityOptions .option-btn').classList.add('selected');
        });
    </script>
</body>
</html>
