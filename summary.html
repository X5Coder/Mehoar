<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ÿπŸéŸàŸÜ - ÿÆÿØŸÖÿ© ÿßŸÑÿ™ŸÑÿÆŸäÿµ</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        :root {
            --bg-color: #E5D8C6;
            --card-color: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --accent-dark: #5D4037;
            --accent-light: #8D6E63;
            --beige-gradient: linear-gradient(145deg, #D7CCC8, #BCAAA4);
            --border-radius: 24px;
            --border-radius-large: 32px;
            --navbar-height: 80px;
            --transition-quick: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --success-color: #059669;
            --error-color: #DC2626;
            --border-color: #000000;
        }
        
        body {
            font-family: 'Almarai', 'Tajawal', -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            -webkit-font-smoothing: antialiased;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        /* Loading Screens */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 64px;
            background: linear-gradient(145deg, var(--accent-dark), #795548);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(93, 64, 55, 0.1);
            border-left-color: var(--accent-dark);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        /* Navbar */
        .native-navbar {
            position: fixed;
            top: 15px;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: rgba(229, 216, 198, 0.96);
            backdrop-filter: saturate(200%) blur(30px);
            -webkit-backdrop-filter: saturate(200%) blur(30px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            z-index: 10000;
            border-bottom: 2px solid rgba(93, 64, 55, 0.1);
            box-shadow: 0 10px 40px rgba(93, 64, 55, 0.08);
            margin: 0 20px;
            width: calc(100% - 40px);
            border: 3px solid var(--border-color);
            border-radius: 28px;
        }
        
        .logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 42px;
            background: linear-gradient(145deg, var(--accent-dark), #795548);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1.5px;
            cursor: pointer;
            transition: var(--transition-quick);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .coins-display {
            background: linear-gradient(145deg, var(--accent-dark), #795548);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(93, 64, 55, 0.2);
            border: 3px solid var(--border-color);
            transition: var(--transition-quick);
        }
        
        .coins-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(93, 64, 55, 0.3);
        }
        
        .coins-display i {
            font-size: 18px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        /* Main Content */
        .main-content {
            padding-top: calc(var(--navbar-height) + 60px);
            padding-left: 28px;
            padding-right: 28px;
            padding-bottom: 100px;
            max-width: 100%;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 40px;
            margin-bottom: 40px;
            border: 4px solid var(--border-color);
            box-shadow: 0 16px 48px rgba(93, 64, 55, 0.08);
            text-align: center;
        }
        
        .section-title {
            font-family: 'Almarai', sans-serif;
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--accent-dark);
            margin-bottom: 10px;
            letter-spacing: -1px;
        }
        
        .section-subtitle {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 30px;
            font-weight: 500;
        }
        
        .upload-area {
            border: 3px dashed var(--accent-light);
            border-radius: var(--border-radius);
            padding: 50px 30px;
            margin-bottom: 30px;
            cursor: pointer;
            transition: var(--transition-quick);
            background: rgba(141, 110, 99, 0.05);
            border-color: var(--border-color);
        }
        
        .upload-area:hover {
            border-color: var(--accent-dark);
            background: rgba(141, 110, 99, 0.1);
        }
        
        .upload-icon {
            font-size: 60px;
            color: var(--accent-light);
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-light);
            font-style: italic;
        }
        
        .upload-btn {
            background: linear-gradient(145deg, var(--accent-dark), #795548);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 15px 40px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition-quick);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border: 3px solid var(--border-color);
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(93, 64, 55, 0.25);
        }
        
        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Cost Preview */
        .cost-preview {
            background: rgba(141, 110, 99, 0.1);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 30px;
            border: 3px solid var(--border-color);
            display: none;
        }
        
        .cost-preview.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        .cost-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-dark);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .cost-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .cost-item {
            text-align: center;
            flex: 1;
            min-width: 200px;
        }
        
        .cost-label {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .cost-value {
            font-family: 'Almarai', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--accent-dark);
        }
        
        .cost-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 12px 30px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition-quick);
            min-width: 150px;
            border: 3px solid var(--border-color);
        }
        
        .confirm-btn {
            background: linear-gradient(145deg, var(--success-color), #047857);
            color: white;
        }
        
        .cancel-btn {
            background: linear-gradient(145deg, var(--error-color), #B91C1C);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        /* Settings Section */
        .settings-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 40px;
            margin-bottom: 40px;
            border: 4px solid var(--border-color);
            box-shadow: 0 16px 48px rgba(93, 64, 55, 0.08);
            display: none;
        }
        
        .settings-section.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .setting-group {
            background: rgba(141, 110, 99, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 3px solid var(--border-color);
        }
        
        .setting-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-title i {
            color: var(--accent-light);
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .option-btn {
            padding: 12px;
            border: 3px solid var(--border-color);
            border-radius: var(--border-radius);
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-quick);
            text-align: center;
        }
        
        .option-btn:hover {
            transform: translateY(-2px);
            border-color: var(--accent-dark);
        }
        
        .option-btn.selected {
            background: var(--accent-dark);
            color: white;
            border-color: var(--accent-dark);
        }
        
        .text-input {
            width: 100%;
            padding: 14px 18px;
            border: 3px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: var(--transition-quick);
            background: white;
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--accent-dark);
            box-shadow: 0 0 0 3px rgba(93, 64, 55, 0.1);
        }
        
        .generate-btn {
            background: linear-gradient(145deg, var(--accent-dark), #795548);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 18px 50px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition-quick);
            display: block;
            margin: 0 auto;
            min-width: 250px;
            border: 3px solid var(--border-color);
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(93, 64, 55, 0.25);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Result Section */
        .result-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 40px;
            margin-bottom: 40px;
            border: 4px solid var(--border-color);
            box-shadow: 0 16px 48px rgba(93, 64, 55, 0.08);
            display: none;
        }
        
        .result-section.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid rgba(93, 64, 55, 0.1);
        }
        
        .result-title {
            font-family: 'Almarai', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent-dark);
            letter-spacing: -1px;
        }
        
        .result-content-container {
            position: relative;
            background: #f9f9f9;
            border-radius: var(--border-radius);
            border: 3px solid var(--border-color);
            overflow: hidden;
            min-height: 500px;
            max-height: 800px;
            padding: 20px;
        }
        
        .result-content {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
            padding: 10px;
            min-height: 500px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Drawing Canvas */
        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            cursor: crosshair;
            touch-action: none;
        }
        
        /* Drawing Controls */
        .drawing-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 3px solid var(--border-color);
            z-index: 10;
            display: none;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }
        
        .drawing-controls.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .drawing-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .drawing-controls-title {
            font-family: 'Almarai', sans-serif;
            font-weight: 800;
            color: var(--accent-dark);
            font-size: 1.1rem;
        }
        
        .close-drawing {
            background: var(--error-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .tool-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tool-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: var(--transition-quick);
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
        }
        
        .tool-btn.selected {
            background: var(--accent-dark);
            color: white;
            border-color: var(--accent-dark);
        }
        
        .color-selection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .color-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-quick);
        }
        
        .color-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }
        
        .drawing-actions {
            display: flex;
            gap: 10px;
        }
        
        .drawing-action-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: var(--transition-quick);
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
        }
        
        .drawing-action-btn:hover {
            transform: translateY(-2px);
            background: #f5f5f5;
        }
        
        /* Pen Button */
        .pen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, var(--accent-dark), #795548);
            color: white;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transition: var(--transition-quick);
            box-shadow: 0 8px 24px rgba(93, 64, 55, 0.2);
        }
        
        .pen-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 12px 32px rgba(93, 64, 55, 0.3);
        }
        
        .pen-btn i {
            font-size: 24px;
        }
        
        /* Font Controls for Result */
        .font-controls-result {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: 3px solid var(--border-color);
        }
        
        .font-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--beige-gradient);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-quick);
            font-weight: 800;
            font-size: 18px;
            color: var(--accent-dark);
        }
        
        .font-btn:hover {
            transform: translateY(-2px);
            background: var(--accent-dark);
            color: white;
        }
        
        .raw-summary {
            background: rgba(141, 110, 99, 0.1);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 30px;
            border: 3px solid var(--border-color);
        }
        
        .raw-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .raw-title i {
            color: var(--accent-light);
        }
        
        .raw-points {
            list-style: none;
            padding: 0;
        }
        
        .raw-points li {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 12px;
            border-right: 4px solid var(--accent-dark);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .raw-points li i {
            color: var(--accent-dark);
            margin-top: 3px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 60px 28px 40px;
            color: var(--text-secondary);
            border-top: 3px solid rgba(93, 64, 55, 0.1);
            margin-top: 100px;
        }
        
        .copyright {
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            margin-bottom: 40px;
            font-weight: 500;
        }
        
        .support-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .support-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-dark);
            margin-bottom: 8px;
        }
        
        .support-links {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .support-link {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(145deg, var(--accent-dark), #795548);
            border: 3px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-quick);
            box-shadow: 0 8px 24px rgba(93, 64, 55, 0.15);
        }
        
        .support-link:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 16px 40px rgba(93, 64, 55, 0.25);
        }
        
        .support-link i {
            font-size: 26px;
            color: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .developer-credit {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            color: rgba(100, 116, 139, 0.7);
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid rgba(93, 64, 55, 0.05);
            cursor: pointer;
            transition: var(--transition-quick);
        }
        
        .developer-credit:hover {
            color: var(--accent-dark);
            transform: scale(1.05);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 3px solid var(--border-color);
            z-index: 10001;
            min-width: 300px;
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-color: var(--success-color);
        }
        
        .notification.error {
            border-color: var(--error-color);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-icon {
            font-size: 24px;
        }
        
        .notification.success .notification-icon {
            color: var(--success-color);
        }
        
        .notification.error .notification-icon {
            color: var(--error-color);
        }
        
        .notification-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .native-navbar {
                padding: 0 20px;
                margin: 0 16px;
                top: 12px;
                width: calc(100% - 32px);
                height: 70px;
            }
            
            .logo {
                font-size: 36px;
            }
            
            .coins-display {
                padding: 10px 20px;
                font-size: 15px;
            }
            
            .main-content {
                padding-top: calc(70px + 40px);
                padding-left: 20px;
                padding-right: 20px;
                padding-bottom: 60px;
            }
            
            .section-title {
                font-size: 1.8rem;
            }
            
            .upload-section, .settings-section, .result-section {
                padding: 28px 20px;
                margin-left: 0;
                margin-right: 0;
                width: 100%;
                border-radius: 24px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .upload-icon {
                font-size: 50px;
            }
            
            .cost-details {
                flex-direction: column;
                align-items: center;
            }
            
            .cost-item {
                min-width: 100%;
            }
            
            .cost-actions {
                flex-direction: column;
            }
            
            .action-btn {
                min-width: 100%;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .generate-btn {
                min-width: 100%;
                padding: 16px 30px;
            }
            
            .result-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .pen-btn {
                width: 48px;
                height: 48px;
                top: 15px;
                right: 15px;
            }
            
            .drawing-controls {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 320px;
            }
            
            .font-controls-result {
                width: 100%;
                justify-content: center;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                min-width: auto;
                top: 80px;
            }
        }
        
        @media (max-width: 480px) {
            .native-navbar {
                padding: 0 16px;
                margin: 0 12px;
                top: 10px;
                width: calc(100% - 24px);
                height: 65px;
            }
            
            .logo {
                font-size: 32px;
            }
            
            .coins-display {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .main-content {
                padding-left: 16px;
                padding-right: 16px;
                padding-top: calc(65px + 30px);
            }
            
            .section-title {
                font-size: 1.6rem;
            }
            
            .section-subtitle {
                font-size: 1rem;
            }
            
            .upload-section, .settings-section, .result-section {
                padding: 24px 16px;
            }
            
            .upload-area {
                padding: 30px 16px;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .generate-btn {
                padding: 14px 20px;
                font-size: 1.1rem;
            }
            
            .pen-btn {
                width: 44px;
                height: 44px;
                top: 10px;
                right: 10px;
            }
            
            .pen-btn i {
                font-size: 20px;
            }
            
            .font-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 360px) {
            .logo {
                font-size: 28px;
            }
            
            .coins-display {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .section-title {
                font-size: 1.4rem;
            }
            
            .upload-icon {
                font-size: 40px;
            }
            
            .upload-text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen" style="display: none;">
        <div class="loading-logo">ÿπŸéŸàŸÜ</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="native-navbar" id="navbar">
        <div class="logo" onclick="window.location.href='home.html'">ÿπŸéŸàŸÜ</div>
        <div class="nav-left">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <h1 class="section-title">ÿÆÿØŸÖÿ© ÿ™ŸÑÿÆŸäÿµ PDF</h1>
            <p class="section-subtitle">ÿßÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ Ÿàÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÑÿÆÿµ ÿ¥ÿßŸÖŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</p>
            
            <div class="upload-area" id="upload-area" onclick="document.getElementById('pdfFile').click()">
                <div class="upload-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="upload-text" id="upload-text">ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF</div>
            </div>
            
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
            
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</h3>
                <div class="cost-details">
                    <div class="cost-item">
                        <div class="cost-label">ÿπÿØÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™</div>
                        <div class="cost-value" id="page-count">0</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</div>
                        <div class="cost-value" id="cost-amount">0 ÿπŸÖŸÑÿ©</div>
                    </div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" onclick="cancelProcess()">
                        <i class="fas fa-times"></i>
                        ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                    <button class="action-btn confirm-btn" onclick="confirmProcess()">
                        <i class="fas fa-check"></i>
                        ŸÖÿ™ÿßÿ®ÿπÿ©
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Settings Section -->
        <section class="settings-section" id="settings-section">
            <h2 class="section-title">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÑÿÆŸäÿµ</h2>
            <p class="section-subtitle">ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑŸÉ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ŸÅÿ∂ŸÑ ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ™ŸÑÿÆŸäÿµ</p>
            
            <div class="settings-grid">
                <!-- ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ¥ÿ±ÿ≠ -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-comment-alt"></i>
                        ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ¥ÿ±ÿ≠ ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ∂ŸÑÿü
                    </h3>
                    <div class="options-grid" id="explanation-level">
                        <button class="option-btn" data-value="ÿ∑ŸÅŸàŸÑŸä">ÿ∑ŸÅŸàŸÑŸä</button>
                        <button class="option-btn" data-value="ŸÖÿπŸÇÿØ">ŸÖÿπŸÇÿØ</button>
                        <button class="option-btn selected" data-value="ÿ®ÿ≥Ÿäÿ∑">ÿ®ÿ≥Ÿäÿ∑</button>
                    </div>
                </div>
                
                <!-- ÿßŸÑŸÑŸáÿ¨ÿ© -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-language"></i>
                        ÿßŸÑŸÑŸáÿ¨ÿ© ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ∂ŸÑÿü
                    </h3>
                    <div class="options-grid" id="dialect">
                        <button class="option-btn selected" data-value="ŸÖÿµÿ±Ÿä">ŸÖÿµÿ±Ÿä</button>
                        <button class="option-btn" data-value="ÿ≥ÿπŸàÿØŸä">ÿ≥ÿπŸàÿØŸä</button>
                        <button class="option-btn" data-value="ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä">ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä</button>
                        <button class="option-btn" data-value="ÿπÿ±ÿ®ŸäŸá ŸÅÿµÿ≠Ÿâ">ÿπÿ±ÿ®ŸäŸá ŸÅÿµÿ≠Ÿâ</button>
                    </div>
                </div>
                
                <!-- ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ¥ÿßÿ±ÿ≠ -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-user-tie"></i>
                        ŸÖŸÜ ŸáŸà ÿßŸÑÿ¥ÿÆÿµ ÿßŸÑÿ∞Ÿä ÿ™ŸÅÿ∂ŸÑ ÿßŸÜ Ÿäÿ¥ÿ±ÿ≠ ŸÑŸÉÿü
                    </h3>
                    <div class="options-grid" id="explainer-persona">
                        <button class="option-btn" data-value="ÿ∑ÿßŸÑÿ®">ÿ∑ÿßŸÑÿ®</button>
                        <button class="option-btn selected" data-value="ŸÖÿØÿ±ÿ≥">ŸÖÿØÿ±ÿ≥</button>
                        <button class="option-btn" data-value="ÿØŸÉÿ™Ÿàÿ± ÿ¨ÿßŸÖÿπÿ©">ÿØŸÉÿ™Ÿàÿ± ÿ¨ÿßŸÖÿπÿ©</button>
                        <button class="option-btn" data-value="ÿπÿßŸÑŸÖ">ÿπÿßŸÑŸÖ</button>
                    </div>
                </div>
                
                <!-- ŸÑÿ∫ÿ© ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨ -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-globe"></i>
                        ŸÖÿß ŸáŸä ŸÑÿ∫ÿ© ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ∂ŸÑÿü
                    </h3>
                    <div class="options-grid" id="output-language">
                        <button class="option-btn selected" data-value="ÿπÿ±ÿ®Ÿä">ÿπÿ±ÿ®Ÿä</button>
                        <button class="option-btn" data-value="ÿßŸÜÿ¨ŸÑŸäÿ≤Ÿä">ÿßŸÜÿ¨ŸÑŸäÿ≤Ÿä</button>
                    </div>
                    <input type="text" class="text-input" id="custom-language" placeholder="ÿ£Ÿà ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ŸÑÿ∫ÿ© ÿ£ÿÆÿ±Ÿâ" style="margin-top: 15px;">
                </div>
                
                <!-- ÿ™ÿπŸÑŸäŸÇ ÿßÿÆÿ™Ÿäÿßÿ±Ÿä -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-edit"></i>
                        ÿ™ÿπŸÑŸäŸÇ ÿßÿÆÿ™Ÿäÿßÿ±Ÿä (ÿ™ÿ±ŸÉŸäÿ≤ ÿÆÿßÿµ)
                    </h3>
                    <textarea class="text-input" id="optional-comment" rows="4" placeholder="ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇÿßŸã ŸÑÿ™Ÿàÿ¨ŸäŸá ÿπŸéŸàŸÜ ŸÑŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿ¥Ÿäÿ° ŸÖÿπŸäŸÜ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)"></textarea>
                </div>
            </div>
            
            <button class="generate-btn" id="generate-btn" onclick="generateSummary()">
                <i class="fas fa-robot"></i>
                ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            </button>
        </section>
        
        <!-- Result Section -->
        <section class="result-section" id="result-section">
            <div class="result-header">
                <h2 class="result-title" id="result-title">ŸÖŸÑÿÆÿµ ÿßŸÑŸÖŸÑŸÅ</h2>
                <div class="font-controls-result">
                    <button class="font-btn" onclick="changeResultFontSize('decrease')">-</button>
                    <span style="font-weight: 700; color: var(--accent-dark);">ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑</span>
                    <button class="font-btn" onclick="changeResultFontSize('increase')">+</button>
                </div>
            </div>
            
            <div class="result-content-container" id="result-content-container">
                <div class="result-content" id="result-content"></div>
                <canvas class="drawing-canvas" id="drawing-canvas"></canvas>
                <div class="pen-btn" id="pen-btn" onclick="toggleDrawingControls()">
                    <i class="fas fa-pen"></i>
                </div>
                <div class="drawing-controls" id="drawing-controls">
                    <div class="drawing-controls-header">
                        <div class="drawing-controls-title">ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ±ÿ≥ŸÖ</div>
                        <button class="close-drawing" onclick="toggleDrawingControls()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="tool-selection">
                        <button class="tool-btn selected" data-tool="pen" onclick="selectTool('pen')">ŸÇŸÑŸÖ</button>
                        <button class="tool-btn" data-tool="highlighter" onclick="selectTool('highlighter')">ŸáÿßŸäŸÑÿßŸäÿ™ÿ±</button>
                    </div>
                    <div class="color-selection">
                        <div class="color-btn" style="background: #FF0000;" data-color="#FF0000" onclick="selectColor('#FF0000')"></div>
                        <div class="color-btn" style="background: #00FF00;" data-color="#00FF00" onclick="selectColor('#00FF00')"></div>
                        <div class="color-btn" style="background: #0000FF;" data-color="#0000FF" onclick="selectColor('#0000FF')"></div>
                        <div class="color-btn" style="background: #FFFF00;" data-color="#FFFF00" onclick="selectColor('#FFFF00')"></div>
                        <div class="color-btn" style="background: #FFA500;" data-color="#FFA500" onclick="selectColor('#FFA500')"></div>
                        <div class="color-btn" style="background: #800080;" data-color="#800080" onclick="selectColor('#800080')"></div>
                        <div class="color-btn" style="background: #000000;" data-color="#000000" onclick="selectColor('#000000')"></div>
                        <div class="color-btn" style="background: #FFFFFF; border-color: #000;" data-color="#FFFFFF" onclick="selectColor('#FFFFFF')"></div>
                    </div>
                    <div class="drawing-actions">
                        <button class="drawing-action-btn" onclick="clearDrawing()">
                            <i class="fas fa-trash"></i> ŸÖÿ≥ÿ≠
                        </button>
                        <button class="drawing-action-btn" onclick="saveDrawing()">
                            <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="raw-summary" id="raw-summary">
                <h3 class="raw-title">
                    <i class="fas fa-bullseye"></i>
                    ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                </h3>
                <ul class="raw-points" id="raw-points">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÜŸÇÿßÿ∑ ŸáŸÜÿß -->
                </ul>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer">
            <p class="copyright">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÖŸÜÿµÿ© ÿπŸéŸàŸÜ¬© 2026</p>
            
            <div class="support-section">
                <div class="support-title">ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä</div>
                <div class="support-links">
                    <a href="https://wa.me/966583617539" target="_blank" class="support-link">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://t.me/HNHv1" target="_blank" class="support-link">
                        <i class="fab fa-telegram"></i>
                    </a>
                </div>
            </div>
            
            <div class="developer-credit" onclick="window.open('https://t.me/X5Coder', '_blank')">
                ÿ®ÿ±ŸÖÿ¨ÿ© Ÿàÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± ùêäùêàùêåùêé
            </div>
        </footer>
    </div>
    
    <script>
        // ÿ™ŸáŸäÿ¶ÿ© PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let fileInfo = {
            name: '',
            size: 0,
            pages: 0,
            words: 0,
            cost: 0
        };
        
        let selectedSettings = {
            explanationLevel: 'ÿ®ÿ≥Ÿäÿ∑',
            dialect: 'ŸÖÿµÿ±Ÿä',
            explainerPersona: 'ŸÖÿØÿ±ÿ≥',
            outputLanguage: 'ÿπÿ±ÿ®Ÿä',
            customLanguage: '',
            optionalComment: ''
        };
        
        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";
        
        // ÿ™ÿ≠ÿ¨ŸäŸÖ ÿßŸÑÿÆÿ∑
        let resultFontSize = 16;
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ±ÿ≥ŸÖ
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let drawingHistory = [];
        let canvas = null;
        let ctx = null;
        
        // ========== ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ==========
        
        function showNotification(message, type = 'info') {
            try {
                const notification = document.getElementById('notification');
                const notificationIcon = document.getElementById('notification-icon');
                const notificationText = document.getElementById('notification-text');
                
                if (!notification || !notificationIcon || !notificationText) {
                    console.error('Notification elements not found');
                    return;
                }
                
                notificationText.textContent = message;
                notification.className = 'notification';
                
                if (type === 'success') {
                    notification.classList.add('success');
                    notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                } else if (type === 'error') {
                    notification.classList.add('error');
                    notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                } else {
                    notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } catch (error) {
                console.error('Error in showNotification:', error);
            }
        }
        
        function changeResultFontSize(action) {
            const resultContent = document.getElementById('result-content');
            if (!resultContent) return;
            
            if (action === 'increase' && resultFontSize < 24) {
                resultFontSize += 2;
            } else if (action === 'decrease' && resultFontSize > 12) {
                resultFontSize -= 2;
            }
            
            resultContent.style.fontSize = resultFontSize + 'px';
        }
        
        // ========== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ==========
        
        async function loadUserData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    window.location.replace('login.html');
                    return;
                }
                
                const usersRef = database.ref('users_Awn');
                const snapshot = await usersRef.once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    let userFound = false;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userId !== 'noty_publick' && userData.email === user.email) {
                            currentUser = {
                                id: userId,
                                email: userData.email,
                                name: userData.name || '',
                                coin: userData.coin || 0,
                                admin: userData.admin === true || false,
                                banned: userData.banned === true || false
                            };
                            
                            userCoins = userData.coin || 0;
                            const coinsCount = document.getElementById('coins-count');
                            if (coinsCount) {
                                coinsCount.textContent = userCoins;
                            }
                            userFound = true;
                            break;
                        }
                    }
                    
                    if (!userFound) {
                        await auth.signOut();
                        window.location.replace('login.html');
                    }
                } else {
                    await auth.signOut();
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.location.replace('login.html');
            }
        }
        
        async function setupUser() {
            try {
                await loadUserData();
                
                if (currentUser && currentUser.banned !== true) {
                    const navbar = document.getElementById('navbar');
                    const mainContent = document.getElementById('main-content');
                    
                    if (navbar) navbar.style.display = 'flex';
                    if (mainContent) mainContent.style.display = 'block';
                } else {
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error setting up user:', error);
                window.location.replace('login.html');
            }
        }
        
        // ========== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ==========
        
        function setupFileUpload() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadArea = document.getElementById('upload-area');
            
            if (pdfFile) {
                pdfFile.addEventListener('change', handleFileSelect);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-dark)';
                uploadArea.style.backgroundColor = 'rgba(141, 110, 99, 0.1)';
            }
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                await handleFile(files[0]);
            }
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            await handleFile(file);
        }
        
        async function handleFile(file) {
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÖÿ™ÿØÿßÿØ ÿßŸÑŸÖŸÑŸÅ
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ŸÅŸÇÿ∑', 'error');
                resetFileInput();
                return;
            }
            
            selectedFile = file;
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            
            if (uploadText) uploadText.textContent = file.name;
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-dark)';
                uploadArea.style.backgroundColor = 'rgba(141, 110, 99, 0.1)';
            }
            
            // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            await analyzePDF(file);
        }
        
        async function analyzePDF(file) {
            try {
                showLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ...');
                
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                
                // ÿ™ÿ≠ŸÑŸäŸÑ ŸÉŸÑ ÿµŸÅÿ≠ÿ©
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÉŸÑŸÅÿ©
                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;
                
                // ÿ™ŸÇÿ±Ÿäÿ® ŸÑÿ±ŸÇŸÖ Ÿàÿßÿ≠ÿØ ÿ®ÿπÿØ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿπÿ¥ÿ±Ÿäÿ©
                coins = Math.round(coins * 10) / 10;
                
                fileInfo = {
                    name: file.name,
                    size: file.size,
                    pages: pdf.numPages,
                    words: totalWords,
                    cost: coins
                };
                
                console.log('File analysis complete:', fileInfo);
                
                hideLoading();
                
                // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÉŸÑŸÅÿ©
                const pageCount = document.getElementById('page-count');
                const costAmount = document.getElementById('cost-amount');
                const costPreview = document.getElementById('cost-preview');
                
                if (pageCount) pageCount.textContent = fileInfo.pages;
                if (costAmount) costAmount.textContent = fileInfo.cost + ' ÿπŸÖŸÑÿ©';
                if (costPreview) costPreview.classList.add('show');
                
                showNotification('ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                
            } catch (error) {
                console.error('Error analyzing PDF:', error);
                hideLoading();
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error');
                resetFileInput();
            }
        }
        
        function resetFileInput() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            const costPreview = document.getElementById('cost-preview');
            
            if (pdfFile) pdfFile.value = '';
            selectedFile = null;
            if (uploadText) uploadText.textContent = 'ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF';
            if (uploadArea) {
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
            }
            if (costPreview) costPreview.classList.remove('show');
        }
        
        function cancelProcess() {
            resetFileInput();
            const costPreview = document.getElementById('cost-preview');
            if (costPreview) costPreview.classList.remove('show');
            showNotification('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©', 'info');
        }
        
        // ========== ÿØÿßŸÑÿ© ÿ≤ÿ± ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ==========
        function confirmProcess() {
            console.log('confirmProcess called');
            
            const uploadSection = document.getElementById('upload-section');
            const settingsSection = document.getElementById('settings-section');
            const costPreview = document.getElementById('cost-preview');
            
            if (!uploadSection || !settingsSection || !costPreview) {
                console.error('Required elements not found');
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÜÿßÿµÿ±', 'error');
                return;
            }
            
            if (!fileInfo || !fileInfo.cost || fileInfo.cost === 0) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }
            
            console.log('User coins:', userCoins, 'File cost:', fileInfo.cost);
            
            if (userCoins < fileInfo.cost) {
                showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä. ÿ™ÿ≠ÿ™ÿßÿ¨ ${fileInfo.cost} ÿπŸÖŸÑÿ© ÿ®ŸäŸÜŸÖÿß ÿ±ÿµŸäÿØŸÉ ${userCoins}`, 'error');
                return;
            }
            
            uploadSection.style.display = 'none';
            settingsSection.classList.add('show');
            costPreview.classList.remove('show');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÑÿÆŸäÿµ', 'success');
        }
        
        // ========== ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÑÿÆŸäÿµ ==========
        
        function setupSettingsEvents() {
            // ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ¥ÿ±ÿ≠
            const explanationLevelBtns = document.querySelectorAll('#explanation-level .option-btn');
            explanationLevelBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    explanationLevelBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.explanationLevel = this.getAttribute('data-value');
                    console.log('Selected explanation level:', selectedSettings.explanationLevel);
                });
            });
            
            // ÿßŸÑŸÑŸáÿ¨ÿ©
            const dialectBtns = document.querySelectorAll('#dialect .option-btn');
            dialectBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    dialectBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.dialect = this.getAttribute('data-value');
                    console.log('Selected dialect:', selectedSettings.dialect);
                });
            });
            
            // ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ¥ÿßÿ±ÿ≠
            const explainerPersonaBtns = document.querySelectorAll('#explainer-persona .option-btn');
            explainerPersonaBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    explainerPersonaBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.explainerPersona = this.getAttribute('data-value');
                    console.log('Selected explainer persona:', selectedSettings.explainerPersona);
                });
            });
            
            // ŸÑÿ∫ÿ© ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨
            const outputLanguageBtns = document.querySelectorAll('#output-language .option-btn');
            outputLanguageBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    outputLanguageBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.outputLanguage = this.getAttribute('data-value');
                    console.log('Selected output language:', selectedSettings.outputLanguage);
                });
            });
            
            // ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑŸÖÿÆÿµÿµÿ©
            const customLanguage = document.getElementById('custom-language');
            if (customLanguage) {
                customLanguage.addEventListener('input', function() {
                    if (this.value.trim()) {
                        selectedSettings.customLanguage = this.value.trim();
                        selectedSettings.outputLanguage = this.value.trim();
                        console.log('Custom language set:', selectedSettings.outputLanguage);
                    }
                });
            }
            
            // ÿßŸÑÿ™ÿπŸÑŸäŸÇ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±Ÿä
            const optionalComment = document.getElementById('optional-comment');
            if (optionalComment) {
                optionalComment.addEventListener('input', function() {
                    selectedSettings.optionalComment = this.value.trim();
                    console.log('Optional comment set:', selectedSettings.optionalComment);
                });
            }
        }
        
        function createPrompt() {
            const outputLanguage = selectedSettings.customLanguage || selectedSettings.outputLanguage;
            
            return `ROLE:
You are an AI specialized in **strict PDF analysis and summarization** following Google Gemini Flash 2.5 Lite standards.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES (IN ARABIC):
========================
ŸÑÿ∫ÿ©_ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨        = ${outputLanguage}
ÿßŸÑŸÑŸáÿ¨ÿ©             = ${selectedSettings.dialect}
ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿ¥ÿ±ÿ≠        = ${selectedSettings.explanationLevel}
ÿ¥ÿÆÿµŸäÿ©_ÿßŸÑÿ¥ÿßÿ±ÿ≠       = ${selectedSettings.explainerPersona}
ÿ™ÿπŸÑŸäŸÇ_ÿßÿÆÿ™Ÿäÿßÿ±Ÿä      = ${selectedSettings.optionalComment || 'ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ÿßÿ∞ÿß ŸÑŸÖ ŸäŸÉÿ™ÿ® ŸÑŸÖ Ÿäÿ§ÿ´ÿ±'}

========================
TASK:
========================
1. Analyze the provided PDF **from the first word to the last word only**.
2. Do NOT use any external knowledge.
3. Do NOT infer, guess, or add explanations not present in the PDF.
4. If the PDF is empty, corrupted, unreadable, or has no meaningful content ‚Üí return the fallback JSON exactly as defined below.
5. Generate a **full summary** in a **single page**, strictly following:
   - Explanation level: ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿ¥ÿ±ÿ≠
   - Explainer persona: ÿ¥ÿÆÿµŸäÿ©_ÿßŸÑÿ¥ÿßÿ±ÿ≠
   - Output language: ŸÑÿ∫ÿ©_ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨
   - Dialect: ÿßŸÑŸÑŸáÿ¨ÿ©
   - Optional comment: ÿ™ÿπŸÑŸäŸÇ_ÿßÿÆÿ™Ÿäÿßÿ±Ÿä (ignore if empty)
   - The summary must cover **100% of the PDF content**. No important information inside the PDF should be omitted.
   - The style must fully match the user-selected level and persona.

6. **RAW field rules**:
   - Extract **3‚Äì5 sentences**, not questions, but **direct statements summarizing the key content or useful insights**.
   - **Priority:** Any explicit rules, laws, or constraints in the PDF come first. Then include other important points.
   - All sentences must be understandable **alone** to capture the gist of the PDF content.

========================
OUTPUT FORMAT (STRICT):
========================
- Output MUST be **VALID JSON ONLY**
- No Markdown
- No extra text
- No comments
- Keys must appear **exactly in this order**

========================
JSON SCHEMA:
========================
{
  "head": "",
  "raw": [],
  "page": ""
}

========================
FIELD RULES:
========================
1. head:
   - Exactly 5 words
   - Represents the PDF content accurately
   - Written in ŸÑÿ∫ÿ©_ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨

2. raw:
   - Array of **direct statements**, not questions
   - Minimum 3 items, maximum 5 items
   - Priority:
     a) Explicit rules, laws, or constraints in the PDF
     b) If none exist, summarize the most useful points clearly
   - Must be understandable **alone** without reading the full summary
   - Written in the specified language, dialect, and style

3. page:
   - Full detailed explanation of the summary
   - Must follow **ÿ¥ÿÆÿµŸäÿ©_ÿßŸÑÿ¥ÿßÿ±ÿ≠** explaining in **ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿ¥ÿ±ÿ≠**
   - Strictly based on PDF content only
   - Must cover **everything in the PDF**; nothing should be skipped
   - No added knowledge or interpretation

========================
FAILURE / EMPTY PDF RESPONSE (MANDATORY):
========================
If the PDF is empty, unreadable, or invalid, RETURN EXACTLY:

{
  "head": "Not Output",
  "raw": "Not Output",
  "page": "Not Output"
}

========================
ABSOLUTE CONSTRAINTS:
========================
- Do NOT output anything except the final JSON
- Do NOT mention instructions or analysis steps
- Do NOT hallucinate or guess
- Be strict, literal, and deterministic`;
        }
        
        async function generateSummary() {
            if (!selectedFile) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ PDF ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }
            
            if (userCoins < fileInfo.cost) {
                showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä. ÿ™ÿ≠ÿ™ÿßÿ¨ ${fileInfo.cost} ÿπŸÖŸÑÿ© ÿ®ŸäŸÜŸÖÿß ÿ±ÿµŸäÿØŸÉ ${userCoins}`, 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°...';
            }
            
            try {
                showLoading('ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ...');
                
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const result = reader.result;
                        const base64Data = result.split(',')[1];
                        resolve(base64Data);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });
                
                const prompt = createPrompt();
                console.log('Generated prompt:', prompt);
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: prompt,
                        PDF_BASE64: base64
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                let result;
                try {
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        result = JSON.parse(jsonMatch[0]);
                    } else {
                        result = JSON.parse(text);
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e, 'Response:', text);
                    throw new Error('ÿ±ÿØ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±');
                }
                
                console.log('Parsed result:', result);
                
                if (result.head === "Not Output" && result.raw === "Not Output" && result.page === "Not Output") {
                    throw new Error('ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑ ŸÑŸÑŸÇÿ±ÿßÿ°ÿ©');
                }
                
                await deductCoins(fileInfo.cost);
                await saveResultToDatabase(result);
                displayResult(result);
                
                const settingsSection = document.getElementById('settings-section');
                const resultSection = document.getElementById('result-section');
                
                if (settingsSection) settingsSection.classList.remove('show');
                if (resultSection) resultSection.classList.add('show');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                showNotification('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                
            } catch (error) {
                console.error('Error generating summary:', error);
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ: ' + error.message, 'error');
            } finally {
                hideLoading();
                const generateBtn = document.getElementById('generate-btn');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-robot"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä';
                }
            }
        }
        
        async function deductCoins(amount) {
            try {
                const newCoins = userCoins - amount;
                userCoins = newCoins;
                
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(newCoins);
                const coinsCount = document.getElementById('coins-count');
                if (coinsCount) {
                    coinsCount.textContent = newCoins;
                }
                
                console.log(`Deducted ${amount} coins. New balance: ${newCoins}`);
                
            } catch (error) {
                console.error('Error deducting coins:', error);
                throw error;
            }
        }
        
        async function saveResultToDatabase(result) {
            try {
                const recordId = 'record_' + Date.now();
                const recordData = {
                    id: currentUser.id,
                    process: 'ŸÖŸÑÿÆÿµ',
                    data: result,
                    timestamp: Date.now(),
                    fileName: fileInfo.name,
                    cost: fileInfo.cost,
                    pages: fileInfo.pages,
                    settings: selectedSettings
                };
                
                await database.ref(`records/${recordId}`).set(recordData);
                console.log('Result saved to database:', recordId);
                
            } catch (error) {
                console.error('Error saving result to database:', error);
            }
        }
        
        function displayResult(result) {
            const resultTitle = document.getElementById('result-title');
            const resultContent = document.getElementById('result-content');
            const rawPoints = document.getElementById('raw-points');
            
            if (resultTitle) {
                resultTitle.textContent = result.head || 'ŸÖŸÑÿÆÿµ ÿßŸÑŸÖŸÑŸÅ';
            }
            
            if (resultContent) {
                resultContent.innerHTML = '';
                
                if (result.page) {
                    const paragraphs = result.page.split('\n').filter(p => p.trim());
                    paragraphs.forEach(paragraph => {
                        const p = document.createElement('p');
                        p.textContent = paragraph;
                        p.style.marginBottom = '20px';
                        p.style.lineHeight = '1.8';
                        resultContent.appendChild(p);
                    });
                } else {
                    resultContent.textContent = 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÑŸÑÿπÿ±ÿ∂';
                }
                
                resultContent.style.fontSize = resultFontSize + 'px';
            }
            
            if (rawPoints) {
                rawPoints.innerHTML = '';
                
                if (result.raw && Array.isArray(result.raw) && result.raw.length > 0) {
                    result.raw.forEach(point => {
                        const li = document.createElement('li');
                        li.innerHTML = `<i class="fas fa-check-circle"></i> ${point}`;
                        rawPoints.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.innerHTML = '<i class="fas fa-info-circle"></i> ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜŸÇÿßÿ∑ ÿ±ÿ¶Ÿäÿ≥Ÿäÿ©';
                    rawPoints.appendChild(li);
                }
            }
            
            // ÿ™ŸáŸäÿ¶ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑÿ±ÿ≥ŸÖ ÿ®ÿπÿØ ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
            setTimeout(initDrawingCanvas, 100);
        }
        
        // ========== Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ±ÿ≥ŸÖ ==========
        
        function initDrawingCanvas() {
            canvas = document.getElementById('drawing-canvas');
            if (!canvas) return;
            
            const container = document.getElementById('result-content-container');
            if (!container) return;
            
            // ÿ™ÿπŸäŸäŸÜ ÿ£ÿ®ÿπÿßÿØ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥ ŸÑÿ™ÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑÿ≠ÿßŸàŸäÿ©
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            ctx = canvas.getContext('2d');
            if (!ctx) return;
            
            // ÿ™ŸáŸäÿ¶ÿ© ÿ≠ÿØÿ´ÿßÿ™ ÿßŸÑÿ±ÿ≥ŸÖ
            setupDrawingEvents();
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ ÿ•ŸÜ Ÿàÿ¨ÿØ
            loadSavedDrawing();
        }
        
        function setupDrawingEvents() {
            if (!canvas || !ctx) return;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // ÿØÿπŸÖ ÿßŸÑŸÑŸÖÿ≥
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                startDrawing({
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    offsetX: touch.clientX - rect.left,
                    offsetY: touch.clientY - rect.top
                });
            }
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                draw({
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    offsetX: touch.clientX - rect.left,
                    offsetY: touch.clientY - rect.top
                });
            }
        }
        
        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ¨ŸÑ
            drawingHistory.push({
                type: 'start',
                x: e.offsetX,
                y: e.offsetY,
                tool: currentTool,
                color: currentColor
            });
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            ctx.lineTo(e.offsetX, e.offsetY);
            
            if (currentTool === 'pen') {
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = currentColor;
            } else if (currentTool === 'highlighter') {
                ctx.lineWidth = 10;
                ctx.lineCap = 'round';
                ctx.strokeStyle = currentColor + '80'; // ÿ¥ŸÅÿßŸÅŸäÿ© 50%
            }
            
            ctx.stroke();
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ¨ŸÑ
            drawingHistory.push({
                type: 'draw',
                x: e.offsetX,
                y: e.offsetY,
                tool: currentTool,
                color: currentColor
            });
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.closePath();
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ¨ŸÑ
                drawingHistory.push({
                    type: 'end',
                    tool: currentTool,
                    color: currentColor
                });
            }
        }
        
        function toggleDrawingControls() {
            const drawingControls = document.getElementById('drawing-controls');
            if (drawingControls) {
                if (drawingControls.classList.contains('show')) {
                    drawingControls.classList.remove('show');
                } else {
                    drawingControls.classList.add('show');
                }
            }
        }
        
        function selectTool(tool) {
            currentTool = tool;
            
            const toolBtns = document.querySelectorAll('.tool-btn');
            toolBtns.forEach(btn => {
                btn.classList.remove('selected');
                if (btn.getAttribute('data-tool') === tool) {
                    btn.classList.add('selected');
                }
            });
            
            console.log('Selected tool:', tool);
        }
        
        function selectColor(color) {
            currentColor = color;
            
            const colorBtns = document.querySelectorAll('.color-btn');
            colorBtns.forEach(btn => {
                btn.classList.remove('selected');
                if (btn.getAttribute('data-color') === color) {
                    btn.classList.add('selected');
                }
            });
            
            console.log('Selected color:', color);
        }
        
        function clearDrawing() {
            if (!ctx || !canvas) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingHistory = [];
            
            // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if (currentUser) {
                database.ref(`drawings/${currentUser.id}`).remove()
                    .then(() => {
                        console.log('Drawing cleared from database');
                        showNotification('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ±ÿ≥ŸÖ', 'success');
                    })
                    .catch(error => {
                        console.error('Error clearing drawing from database:', error);
                    });
            }
        }
        
        async function saveDrawing() {
            if (!ctx || !canvas || !currentUser) return;
            
            try {
                const drawingData = {
                    history: drawingHistory,
                    canvasSize: {
                        width: canvas.width,
                        height: canvas.height
                    },
                    timestamp: Date.now()
                };
                
                await database.ref(`drawings/${currentUser.id}`).set(drawingData);
                showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ÿ≥ŸÖ', 'success');
                console.log('Drawing saved to database');
                
            } catch (error) {
                console.error('Error saving drawing:', error);
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ÿ≥ŸÖ', 'error');
            }
        }
        
        async function loadSavedDrawing() {
            if (!ctx || !canvas || !currentUser) return;
            
            try {
                const snapshot = await database.ref(`drawings/${currentUser.id}`).once('value');
                if (snapshot.exists()) {
                    const drawingData = snapshot.val();
                    
                    if (drawingData.history && Array.isArray(drawingData.history)) {
                        drawingHistory = drawingData.history;
                        redrawFromHistory();
                        console.log('Drawing loaded from database');
                    }
                }
            } catch (error) {
                console.error('Error loading drawing:', error);
            }
        }
        
        function redrawFromHistory() {
            if (!ctx || !drawingHistory.length) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let currentPath = null;
            
            drawingHistory.forEach(entry => {
                if (entry.type === 'start') {
                    currentPath = {
                        points: [{x: entry.x, y: entry.y}],
                        tool: entry.tool,
                        color: entry.color
                    };
                } else if (entry.type === 'draw' && currentPath) {
                    currentPath.points.push({x: entry.x, y: entry.y});
                } else if (entry.type === 'end' && currentPath) {
                    drawPath(currentPath);
                    currentPath = null;
                }
            });
        }
        
        function drawPath(path) {
            if (!ctx || !path.points.length) return;
            
            ctx.beginPath();
            ctx.moveTo(path.points[0].x, path.points[0].y);
            
            for (let i = 1; i < path.points.length; i++) {
                ctx.lineTo(path.points[i].x, path.points[i].y);
            }
            
            if (path.tool === 'pen') {
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = path.color;
            } else if (path.tool === 'highlighter') {
                ctx.lineWidth = 10;
                ctx.lineCap = 'round';
                ctx.strokeStyle = path.color + '80';
            }
            
            ctx.stroke();
            ctx.closePath();
        }
        
        function showLoading(text = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...') {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            
            if (loadingScreen && loadingText) {
                loadingText.textContent = text;
                loadingScreen.style.display = 'flex';
                setTimeout(() => {
                    loadingScreen.style.opacity = '1';
                }, 10);
            }
        }
        
        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        }
        
        // ========== ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ==========
        
        async function initApp() {
            showLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
            
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    hideLoading();
                    window.location.replace('login.html');
                    return;
                }
                
                try {
                    await setupUser();
                    setupFileUpload();
                    setupSettingsEvents();
                    
                    const confirmBtn = document.querySelector('.confirm-btn');
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Confirm button clicked via event listener');
                            confirmProcess();
                        });
                    }
                    
                    console.log('App initialized successfully');
                    console.log('Current user:', currentUser);
                    
                    hideLoading();
                    
                } catch (error) {
                    console.error('Error initializing app:', error);
                    hideLoading();
                    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ', 'error');
                } finally {
                    setTimeout(() => {
                        unsubscribe();
                    }, 100);
                }
            });
        }
        
        history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function(event) {
            history.pushState(null, null, window.location.href);
        });
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
