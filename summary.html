<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ÿπŸàŸÜ - ÿÆÿØŸÖÿ© ÿ™ŸÑÿÆŸäÿµ PDF</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-color: #F5F1E8;
            --card-color: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-primary: #8B7355;
            --accent-secondary: #A9927D;
            --accent-dark: #5D4037;
            --border-color: #D4A574;
            --border-radius: 20px;
            --border-radius-large: 28px;
            --navbar-height: 70px;
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --success-color: #38A169;
            --error-color: #E53E3E;
            --warning-color: #DD6B20;
            --shadow-light: 0 4px 12px rgba(139, 115, 85, 0.1);
            --shadow-medium: 0 8px 24px rgba(139, 115, 85, 0.15);
            --shadow-heavy: 0 12px 36px rgba(139, 115, 85, 0.2);
        }
        
        body {
            font-family: 'Almarai', 'Tajawal', -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            -webkit-font-smoothing: antialiased;
            max-width: 100vw;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 800;
            font-size: 48px;
            color: var(--accent-primary);
            margin-bottom: 20px;
            letter-spacing: -1px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(139, 115, 85, 0.1);
            border-left-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            max-width: 80%;
            line-height: 1.6;
        }
        
        /* Navbar */
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: var(--bg-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10000;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
            box-shadow: var(--shadow-light);
        }
        
        .logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 36px;
            color: var(--accent-primary);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .coins-display {
            background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-light);
            transition: var(--transition-smooth);
        }
        
        .coins-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .coins-display i {
            font-size: 16px;
        }
        
        /* Audio and Pen Controls - Hidden by default */
        .reading-tools {
            display: none;
            align-items: center;
            gap: 12px;
            margin-left: 15px;
        }
        
        .reading-tools.visible {
            display: flex;
        }
        
        .tool-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: white;
            border: 1px solid rgba(139, 115, 85, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: var(--accent-primary);
            font-size: 18px;
            position: relative;
        }
        
        .tool-btn:hover {
            background: rgba(139, 115, 85, 0.1);
        }
        
        .tool-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        /* Pen Tools Popup */
        .pen-tools-popup {
            position: absolute;
            top: 55px;
            left: 0;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.1);
            display: none;
            flex-direction: column;
            gap: 12px;
            width: 280px;
            z-index: 10001;
            animation: slideDown 0.3s ease-out;
        }
        
        .pen-tools-popup.show {
            display: flex;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pen-type-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .pen-type-btn {
            padding: 10px;
            border: 1px solid rgba(139, 115, 85, 0.2);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            font-size: 12px;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .pen-type-btn:hover {
            background: rgba(139, 115, 85, 0.05);
        }
        
        .pen-type-btn.selected {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .pen-type-btn i {
            font-size: 14px;
        }
        
        .color-palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(139, 115, 85, 0.2);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 6px rgba(139, 115, 85, 0.3);
        }
        
        .pen-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .pen-action-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(139, 115, 85, 0.2);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            font-size: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .pen-action-btn:hover {
            background: rgba(139, 115, 85, 0.05);
        }
        
        .pen-action-btn.clear-all {
            background: #FEE2E2;
            color: #DC2626;
            border-color: #FCA5A5;
        }
        
        .pen-action-btn.clear-all:hover {
            background: #FECACA;
        }
        
        /* Audio Controls */
        .audio-controls-popup {
            position: absolute;
            top: 55px;
            left: 0;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.1);
            display: none;
            flex-direction: column;
            gap: 8px;
            width: 180px;
            z-index: 10001;
            animation: slideDown 0.3s ease-out;
        }
        
        .audio-controls-popup.show {
            display: flex;
        }
        
        .audio-control-btn {
            padding: 10px 12px;
            border: 1px solid rgba(139, 115, 85, 0.2);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            font-size: 13px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .audio-control-btn:hover {
            background: rgba(139, 115, 85, 0.1);
        }
        
        /* Main Content */
        .main-content {
            padding-top: calc(var(--navbar-height) + 30px);
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 60px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            text-align: center;
            border: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        .section-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 10px;
        }
        
        .section-subtitle {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 25px;
            font-weight: 400;
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            margin-bottom: 25px;
            cursor: pointer;
            transition: var(--transition-smooth);
            background: rgba(212, 165, 116, 0.05);
        }
        
        .upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(212, 165, 116, 0.1);
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--accent-primary);
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .upload-hint {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Cost Preview */
        .cost-preview {
            background: rgba(139, 115, 85, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 25px;
            border: 1px solid rgba(139, 115, 85, 0.1);
            display: none;
            animation: slideUp 0.4s ease-out;
        }
        
        .cost-preview.show {
            display: block;
        }
        
        .cost-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .cost-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .cost-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        
        .cost-label {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .cost-value {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .cost-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .confirm-btn {
            background: linear-gradient(145deg, var(--success-color), #2F855A);
            color: white;
        }
        
        .cancel-btn {
            background: linear-gradient(145deg, var(--error-color), #C53030);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        /* Settings Section */
        .settings-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(139, 115, 85, 0.1);
            display: none;
            animation: slideUp 0.4s ease-out;
        }
        
        .settings-section.show {
            display: block;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .setting-group {
            background: rgba(139, 115, 85, 0.03);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        .setting-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .setting-title i {
            color: var(--accent-secondary);
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        
        .option-btn {
            padding: 10px 12px;
            border: 1px solid rgba(139, 115, 85, 0.2);
            border-radius: 14px;
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
        }
        
        .option-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        
        .option-btn.selected {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .text-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(139, 115, 85, 0.2);
            border-radius: var(--border-radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            transition: var(--transition-smooth);
            background: white;
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        }
        
        .generate-btn {
            background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 16px 40px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: block;
            margin: 0 auto;
            min-width: 240px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Result Section */
        .result-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.1);
            display: none;
            animation: slideUp 0.4s ease-out;
            width: 100%;
            min-height: auto;
        }
        
        .result-section.show {
            display: block;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
            background: white;
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }
        
        .result-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .result-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .font-controls-result {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 115, 85, 0.05);
            padding: 6px 12px;
            border-radius: 16px;
        }
        
        .font-btn {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: white;
            border: 1px solid rgba(139, 115, 85, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-weight: 700;
            font-size: 16px;
            color: var(--accent-primary);
        }
        
        .font-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .result-content-container {
            position: relative;
            background: #fafafa;
            padding: 40px;
            width: 100%;
            min-height: auto;
            transition: min-height 0.3s ease;
        }
        
        .result-content {
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-primary);
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(139, 115, 85, 0.1);
            transition: font-size 0.3s ease;
            min-height: 500px;
            position: relative;
            z-index: 1;
        }
        
        .highlighted-word {
            background: linear-gradient(120deg, rgba(56, 161, 105, 0.2) 0%, rgba(56, 161, 105, 0.3) 100%);
            padding: 2px 4px;
            border-radius: 4px;
            color: #1A202C;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* Drawing Canvas - Fixed to result content */
        .drawing-canvas {
            position: absolute;
            top: 40px;
            left: 40px;
            width: calc(100% - 80px);
            height: calc(100% - 80px);
            z-index: 2;
            pointer-events: none;
            touch-action: none;
        }
        
        .drawing-canvas.active {
            pointer-events: auto;
        }
        
        /* Raw Summary */
        .raw-summary {
            background: rgba(139, 115, 85, 0.05);
            border-radius: var(--border-radius);
            padding: 30px;
            margin: 0 40px 40px;
            border: 1px solid rgba(139, 115, 85, 0.1);
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            z-index: 1;
        }
        
        .raw-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .raw-title i {
            color: var(--accent-secondary);
        }
        
        .raw-points {
            list-style: none;
            padding: 0;
        }
        
        .raw-points li {
            padding: 15px 20px;
            margin-bottom: 12px;
            background: white;
            border-radius: 12px;
            border-right: 5px solid var(--accent-primary);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: var(--shadow-light);
            line-height: 1.6;
        }
        
        .raw-points li i {
            color: var(--accent-primary);
            margin-top: 3px;
            font-size: 1.1rem;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            border-top: 1px solid rgba(139, 115, 85, 0.1);
            margin-top: 40px;
        }
        
        .copyright {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 30px;
            font-weight: 400;
        }
        
        .support-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .support-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }
        
        .support-links {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        .support-link {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-light);
        }
        
        .support-link:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .support-link i {
            font-size: 22px;
            color: white;
        }
        
        .developer-credit {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            color: rgba(100, 116, 139, 0.6);
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(139, 115, 85, 0.05);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .developer-credit:hover {
            color: var(--accent-primary);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.1);
            z-index: 10001;
            min-width: 280px;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-right: 4px solid var(--success-color);
        }
        
        .notification.error {
            border-right: 4px solid var(--error-color);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification-icon {
            font-size: 20px;
        }
        
        .notification.success .notification-icon {
            color: var(--success-color);
        }
        
        .notification.error .notification-icon {
            color: var(--error-color);
        }
        
        .notification-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
        }
        
        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                max-width: 100%;
            }
            
            .result-content {
                max-width: 900px;
            }
            
            .raw-summary {
                max-width: 900px;
            }
        }
        
        @media (max-width: 768px) {
            .native-navbar {
                padding: 0 16px;
                height: 60px;
            }
            
            .logo {
                font-size: 28px;
            }
            
            .coins-display {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .reading-tools {
                gap: 8px;
            }
            
            .tool-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .pen-tools-popup {
                width: 260px;
                top: 50px;
            }
            
            .audio-controls-popup {
                width: 160px;
                top: 50px;
            }
            
            .main-content {
                padding-top: calc(60px + 20px);
                padding-left: 16px;
                padding-right: 16px;
                padding-bottom: 40px;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .upload-section, .settings-section, .result-section {
                padding: 24px 16px;
                margin-left: 0;
                margin-right: 0;
            }
            
            .upload-area {
                padding: 30px 16px;
            }
            
            .cost-details {
                flex-direction: column;
                gap: 15px;
            }
            
            .cost-item {
                min-width: 100%;
            }
            
            .cost-actions {
                flex-direction: column;
            }
            
            .action-btn {
                min-width: 100%;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .generate-btn {
                min-width: 100%;
                padding: 14px 24px;
            }
            
            .result-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
                padding: 16px;
            }
            
            .result-title {
                font-size: 1.3rem;
            }
            
            .result-toolbar {
                width: 100%;
                justify-content: center;
            }
            
            .result-content-container {
                padding: 16px;
            }
            
            .result-content {
                padding: 20px;
                min-height: 400px;
                max-width: 100%;
            }
            
            .drawing-canvas {
                top: 16px;
                left: 16px;
                width: calc(100% - 32px);
                height: calc(100% - 32px);
            }
            
            .raw-summary {
                margin: 0 16px 30px;
                padding: 20px;
                max-width: 100%;
            }
            
            .raw-points li {
                padding: 12px 16px;
            }
            
            .notification {
                left: 16px;
                right: 16px;
                min-width: auto;
                top: 70px;
            }
        }
        
        @media (max-width: 480px) {
            .logo {
                font-size: 24px;
            }
            
            .coins-display {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
            
            .section-subtitle {
                font-size: 0.95rem;
            }
            
            .upload-icon {
                font-size: 40px;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .generate-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .font-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .result-content {
                padding: 16px;
                min-height: 300px;
            }
            
            .tool-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
            
            .pen-tools-popup {
                width: 240px;
            }
            
            .pen-type-selector {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .color-palette {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .color-option {
                width: 28px;
                height: 28px;
            }
            
            .support-links {
                gap: 12px;
            }
            
            .support-link {
                width: 44px;
                height: 44px;
            }
        }
        
        @media (max-width: 360px) {
            .logo {
                font-size: 22px;
            }
            
            .coins-display {
                padding: 5px 10px;
                font-size: 11px;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .upload-icon {
                font-size: 36px;
            }
            
            .upload-text {
                font-size: 1rem;
            }
            
            .reading-tools {
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen" style="display: none;">
        <div class="loading-logo">ÿπŸàŸÜ</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="native-navbar" id="navbar">
        <div class="logo" id="home-logo" onclick="reloadPage()">ÿπŸàŸÜ</div>
        <div class="nav-left">
            <div class="reading-tools" id="reading-tools">
                <div class="tool-btn" id="pen-tool-btn" onclick="togglePenTools()">
                    <i class="fas fa-pen"></i>
                    <div class="pen-tools-popup" id="pen-tools-popup">
                        <div class="pen-type-selector">
                            <button class="pen-type-btn" onclick="selectPenType('normal')" id="normal-pen">
                                <i class="fas fa-pen"></i>
                                <span>ŸÇŸÑŸÖ ÿπÿßÿØŸä</span>
                            </button>
                            <button class="pen-type-btn" onclick="selectPenType('highlighter')" id="highlighter-pen">
                                <i class="fas fa-highlighter"></i>
                                <span>ÿ™ŸÖŸäŸäÿ≤</span>
                            </button>
                            <button class="pen-type-btn" onclick="selectPenType('eraser')" id="eraser-pen">
                                <i class="fas fa-eraser"></i>
                                <span>ŸÖŸÖÿ≠ÿßÿ©</span>
                            </button>
                            <button class="pen-type-btn" onclick="selectPenType('fading')" id="fading-pen">
                                <i class="fas fa-magic"></i>
                                <span>ŸäÿÆÿ™ŸÅŸä</span>
                            </button>
                        </div>
                        
                        <div class="color-palette">
                            <div class="color-option" style="background: #3B82F6;" onclick="selectColor('#3B82F6')" title="ÿ£ÿ≤ÿ±ŸÇ"></div>
                            <div class="color-option" style="background: #EF4444;" onclick="selectColor('#EF4444')" title="ÿ£ÿ≠ŸÖÿ±"></div>
                            <div class="color-option" style="background: #10B981;" onclick="selectColor('#10B981')" title="ÿ£ÿÆÿ∂ÿ±"></div>
                            <div class="color-option" style="background: #F59E0B;" onclick="selectColor('#F59E0B')" title="ÿ£ÿµŸÅÿ±"></div>
                            <div class="color-option" style="background: #8B5CF6;" onclick="selectColor('#8B5CF6')" title="ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä"></div>
                            <div class="color-option" style="background: #000000;" onclick="selectColor('#000000')" title="ÿ£ÿ≥ŸàÿØ"></div>
                            <div class="color-option" style="background: #FFFFFF; border: 2px solid #ccc;" onclick="selectColor('#FFFFFF')" title="ÿ£ÿ®Ÿäÿ∂"></div>
                        </div>
                        
                        <div class="pen-actions">
                            <button class="pen-action-btn" onclick="undoDrawing()">
                                <i class="fas fa-undo"></i>
                                ÿ™ÿ±ÿßÿ¨ÿπ
                            </button>
                            <button class="pen-action-btn" onclick="redoDrawing()">
                                <i class="fas fa-redo"></i>
                                ÿ™ŸÇÿØŸÖ
                            </button>
                            <button class="pen-action-btn clear-all" onclick="clearAllDrawings()">
                                <i class="fas fa-trash"></i>
                                ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="tool-btn" id="audio-tool-btn" onclick="toggleAudioTools()">
                    <i class="fas fa-volume-up"></i>
                    <div class="audio-controls-popup" id="audio-controls-popup">
                        <button class="audio-control-btn" onclick="pauseResumeAudio()" id="pause-btn">
                            <i class="fas fa-pause"></i>
                            ÿ•ŸäŸÇÿßŸÅ/ŸÖÿ™ÿßÿ®ÿπÿ©
                        </button>
                        <button class="audio-control-btn" onclick="restartAudio()">
                            <i class="fas fa-redo"></i>
                            ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <h1 class="section-title">ÿÆÿØŸÖÿ© ÿ™ŸÑÿÆŸäÿµ PDF</h1>
            <p class="section-subtitle">ÿßÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ Ÿàÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÑÿÆÿµ ÿ¥ÿßŸÖŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</p>
            
            <div class="upload-area" id="upload-area" onclick="document.getElementById('pdfFile').click()">
                <div class="upload-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="upload-text" id="upload-text">ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF</div>
                <div class="upload-hint">ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ÿßŸÑŸÖŸÑŸÅ ŸáŸÜÿß</div>
            </div>
            
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
            
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</h3>
                <div class="cost-details">
                    <div class="cost-item">
                        <div class="cost-label">ÿπÿØÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™</div>
                        <div class="cost-value" id="page-count">0</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</div>
                        <div class="cost-value" id="cost-amount">0 ÿπŸÖŸÑÿ©</div>
                    </div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" onclick="cancelProcess()">
                        <i class="fas fa-times"></i>
                        ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                    <button class="action-btn confirm-btn" onclick="confirmProcess()">
                        <i class="fas fa-check"></i>
                        ŸÖÿ™ÿßÿ®ÿπÿ©
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Settings Section -->
        <section class="settings-section" id="settings-section">
            <h2 class="section-title">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÑÿÆŸäÿµ</h2>
            <p class="section-subtitle">ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ© ŸÑŸÉ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ŸÅÿ∂ŸÑ ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ™ŸÑÿÆŸäÿµ</p>
            
            <div class="settings-grid">
                <!-- ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ¥ÿ±ÿ≠ -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-comment-alt"></i>
                        ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ¥ÿ±ÿ≠ ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ∂ŸÑÿü
                    </h3>
                    <div class="options-grid" id="explanation-level">
                        <button class="option-btn" data-value="ÿ∑ŸÅŸàŸÑŸä">ÿ∑ŸÅŸàŸÑŸä</button>
                        <button class="option-btn" data-value="ŸÖÿπŸÇÿØ">ŸÖÿπŸÇÿØ</button>
                        <button class="option-btn selected" data-value="ÿ®ÿ≥Ÿäÿ∑">ÿ®ÿ≥Ÿäÿ∑</button>
                    </div>
                </div>
                
                <!-- ÿßŸÑŸÑŸáÿ¨ÿ© -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-language"></i>
                        ÿßŸÑŸÑŸáÿ¨ÿ© ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ∂ŸÑÿü
                    </h3>
                    <div class="options-grid" id="dialect">
                        <button class="option-btn selected" data-value="ŸÖÿµÿ±Ÿä">ŸÖÿµÿ±Ÿä</button>
                        <button class="option-btn" data-value="ÿ≥ÿπŸàÿØŸä">ÿ≥ÿπŸàÿØŸä</button>
                        <button class="option-btn" data-value="ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä">ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä</button>
                        <button class="option-btn" data-value="ÿπÿ±ÿ®ŸäŸá ŸÅÿµÿ≠Ÿâ">ÿπÿ±ÿ®ŸäŸá ŸÅÿµÿ≠Ÿâ</button>
                    </div>
                </div>
                
                <!-- ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ¥ÿßÿ±ÿ≠ -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-user-tie"></i>
                        ŸÖŸÜ ŸáŸà ÿßŸÑÿ¥ÿÆÿµ ÿßŸÑÿ∞Ÿä ÿ™ŸÅÿ∂ŸÑ ÿßŸÜ Ÿäÿ¥ÿ±ÿ≠ ŸÑŸÉÿü
                    </h3>
                    <div class="options-grid" id="explainer-persona">
                        <button class="option-btn" data-value="ÿ∑ÿßŸÑÿ®">ÿ∑ÿßŸÑÿ®</button>
                        <button class="option-btn selected" data-value="ŸÖÿØÿ±ÿ≥">ŸÖÿØÿ±ÿ≥</button>
                        <button class="option-btn" data-value="ÿØŸÉÿ™Ÿàÿ± ÿ¨ÿßŸÖÿπÿ©">ÿØŸÉÿ™Ÿàÿ± ÿ¨ÿßŸÖÿπÿ©</button>
                        <button class="option-btn" data-value="ÿπÿßŸÑŸÖ">ÿπÿßŸÑŸÖ</button>
                    </div>
                </div>
                
                <!-- ŸÑÿ∫ÿ© ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨ -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-globe"></i>
                        ŸÖÿß ŸáŸä ŸÑÿ∫ÿ© ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ™Ÿä ÿ™ŸÅÿ∂ŸÑÿü
                    </h3>
                    <div class="options-grid" id="output-language">
                        <button class="option-btn selected" data-value="ÿπÿ±ÿ®Ÿä">ÿπÿ±ÿ®Ÿä</button>
                        <button class="option-btn" data-value="ÿßŸÜÿ¨ŸÑŸäÿ≤Ÿä">ÿßŸÜÿ¨ŸÑŸäÿ≤Ÿä</button>
                    </div>
                    <input type="text" class="text-input" id="custom-language" placeholder="ÿ£Ÿà ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ŸÑÿ∫ÿ© ÿ£ÿÆÿ±Ÿâ" style="margin-top: 15px;">
                </div>
                
                <!-- ÿ™ÿπŸÑŸäŸÇ ÿßÿÆÿ™Ÿäÿßÿ±Ÿä -->
                <div class="setting-group">
                    <h3 class="setting-title">
                        <i class="fas fa-edit"></i>
                        ÿ™ÿπŸÑŸäŸÇ ÿßÿÆÿ™Ÿäÿßÿ±Ÿä (ÿ™ÿ±ŸÉŸäÿ≤ ÿÆÿßÿµ)
                    </h3>
                    <textarea class="text-input" id="optional-comment" rows="4" placeholder="ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇÿßŸã ŸÑÿ™Ÿàÿ¨ŸäŸá ÿπŸàŸÜ ŸÑŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿ¥Ÿäÿ° ŸÖÿπŸäŸÜ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)"></textarea>
                </div>
            </div>
            
            <button class="generate-btn" id="generate-btn" onclick="generateSummary()">
                <i class="fas fa-robot"></i>
                ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            </button>
        </section>
        
        <!-- Result Section -->
        <section class="result-section" id="result-section">
            <div class="result-header">
                <h2 class="result-title" id="result-title">ŸÖŸÑÿÆÿµ ÿßŸÑŸÖŸÑŸÅ</h2>
                <div class="result-toolbar">
                    <div class="font-controls-result">
                        <button class="font-btn" onclick="changeResultFontSize('decrease')">-</button>
                        <span style="font-weight: 600; color: var(--accent-primary); padding: 0 8px;">ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑</span>
                        <button class="font-btn" onclick="changeResultFontSize('increase')">+</button>
                    </div>
                </div>
            </div>
            
            <div class="result-content-container" id="result-content-container">
                <div class="result-content" id="result-content"></div>
                <canvas class="drawing-canvas" id="drawing-canvas"></canvas>
            </div>
            
            <div class="raw-summary" id="raw-summary">
                <h3 class="raw-title">
                    <i class="fas fa-bullseye"></i>
                    ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                </h3>
                <ul class="raw-points" id="raw-points">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÜŸÇÿßÿ∑ ŸáŸÜÿß -->
                </ul>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer">
            <p class="copyright">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÖŸÜÿµÿ© ÿπŸàŸÜ¬© 2026</p>
            
            <div class="support-section">
                <div class="support-title">ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä</div>
                <div class="support-links">
                    <a href="https://wa.me/966583617539" target="_blank" class="support-link">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://t.me/HNHv1" target="_blank" class="support-link">
                        <i class="fab fa-telegram"></i>
                    </a>
                </div>
            </div>
            
            <div class="developer-credit" onclick="window.open('https://t.me/X5Coder', '_blank')">
                ÿ®ÿ±ŸÖÿ¨ÿ© Ÿàÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± ùêäùêàùêåùêé
            </div>
        </footer>
    </div>
    
    <script>
        // ÿ™ŸáŸäÿ¶ÿ© PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let fileInfo = {
            name: '',
            size: 0,
            pages: 0,
            words: 0,
            cost: 0
        };
        
        let selectedSettings = {
            explanationLevel: 'ÿ®ÿ≥Ÿäÿ∑',
            dialect: 'ŸÖÿµÿ±Ÿä',
            explainerPersona: 'ŸÖÿØÿ±ÿ≥',
            outputLanguage: 'ÿπÿ±ÿ®Ÿä',
            customLanguage: '',
            optionalComment: ''
        };
        
        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";
        
        // ÿ™ÿ≠ÿ¨ŸäŸÖ ÿßŸÑÿÆÿ∑
        let resultFontSize = 16;
        const minFontSize = 12;
        const maxFontSize = 24;
        
        // ÿßŸÑÿµŸàÿ™
        let isAudioPlaying = false;
        let isAudioPaused = false;
        let audioUtterance = null;
        let currentWordIndex = 0;
        let textWords = [];
        let originalHTML = '';
        let audioStartTime = 0;
        let wordTimers = [];
        
        // ÿßŸÑÿ±ÿ≥ŸÖ
        let isDrawingEnabled = false;
        let isDrawing = false;
        let currentPenType = 'normal'; // normal, highlighter, eraser, fading
        let currentColor = '#3B82F6';
        let canvas = null;
        let ctx = null;
        let lastX = 0;
        let lastY = 0;
        
        // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ±ÿ≥ŸÖ ŸÑŸÑÿ™ÿ±ÿßÿ¨ÿπ/ÿßŸÑÿ™ŸÇÿØŸÖ
        let drawingHistory = [];
        let historyIndex = -1;
        let tempPaths = [];
        let fadingPaths = [];
        
        // ========== ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ==========
        
        function reloadPage() {
            location.reload();
        }
        
        function showNotification(message, type = 'info') {
            try {
                const notification = document.getElementById('notification');
                const notificationIcon = document.getElementById('notification-icon');
                const notificationText = document.getElementById('notification-text');
                
                if (!notification || !notificationIcon || !notificationText) {
                    console.error('Notification elements not found');
                    return;
                }
                
                notificationText.textContent = message;
                notification.className = 'notification';
                
                if (type === 'success') {
                    notification.classList.add('success');
                    notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                } else if (type === 'error') {
                    notification.classList.add('error');
                    notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                } else {
                    notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } catch (error) {
                console.error('Error in showNotification:', error);
            }
        }
        
        function changeResultFontSize(action) {
            const resultContent = document.getElementById('result-content');
            const container = document.getElementById('result-content-container');
            const rawSummary = document.getElementById('raw-summary');
            
            if (!resultContent || !container || !rawSummary) return;
            
            if (action === 'increase' && resultFontSize < maxFontSize) {
                resultFontSize += 2;
            } else if (action === 'decrease' && resultFontSize > minFontSize) {
                resultFontSize -= 2;
            }
            
            resultContent.style.fontSize = resultFontSize + 'px';
            
            // ÿ∂ÿ®ÿ∑ ÿßÿ±ÿ™ŸÅÿßÿπ ÿßŸÑÿ≠ÿßŸàŸäÿ© ŸÑŸäÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
            const contentHeight = resultContent.scrollHeight + 80;
            container.style.minHeight = Math.max(400, contentHeight) + 'px';
            
            // ÿ∂ÿ®ÿ∑ ŸÖŸàÿ∂ÿπ ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            const containerRect = container.getBoundingClientRect();
            const containerBottom = containerRect.bottom + window.scrollY;
            
            rawSummary.style.marginTop = '40px';
            rawSummary.style.marginBottom = '40px';
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿ≥ŸàŸÖÿßÿ™ ÿ®ÿπÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ≠ÿ¨ŸÖ
            setTimeout(redrawAll, 100);
        }
        
        function showReadingTools() {
            const readingTools = document.getElementById('reading-tools');
            if (readingTools) {
                readingTools.classList.add('visible');
            }
        }
        
        // ========== ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÇŸÑŸÖ ==========
        
        function togglePenTools() {
            const penToolsPopup = document.getElementById('pen-tools-popup');
            const audioToolsPopup = document.getElementById('audio-controls-popup');
            
            if (penToolsPopup) {
                if (penToolsPopup.classList.contains('show')) {
                    penToolsPopup.classList.remove('show');
                    document.removeEventListener('click', hidePenToolsOutside);
                } else {
                    penToolsPopup.classList.add('show');
                    if (audioToolsPopup) {
                        audioToolsPopup.classList.remove('show');
                    }
                    
                    // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
                    setTimeout(() => {
                        document.addEventListener('click', hidePenToolsOutside, { once: true });
                    }, 10);
                }
            }
        }
        
        function hidePenToolsOutside(e) {
            const penToolsPopup = document.getElementById('pen-tools-popup');
            const penToolBtn = document.getElementById('pen-tool-btn');
            
            if (penToolsPopup && penToolBtn && 
                !penToolsPopup.contains(e.target) && 
                !penToolBtn.contains(e.target)) {
                penToolsPopup.classList.remove('show');
            }
        }
        
        function selectPenType(type) {
            currentPenType = type;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
            const penTypeBtns = document.querySelectorAll('.pen-type-btn');
            penTypeBtns.forEach(btn => btn.classList.remove('selected'));
            
            const selectedBtn = document.getElementById(`${type}-pen`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÇŸÑŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            if (!isDrawingEnabled) {
                enableDrawing();
                const penToolBtn = document.getElementById('pen-tool-btn');
                if (penToolBtn) {
                    penToolBtn.classList.add('active');
                }
            }
            
            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿ®ÿπÿØ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±
            setTimeout(() => {
                const penToolsPopup = document.getElementById('pen-tools-popup');
                if (penToolsPopup) {
                    penToolsPopup.classList.remove('show');
                }
            }, 300);
        }
        
        function selectColor(color) {
            currentColor = color;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÑŸàŸÜ ÿßŸÑŸÖÿÆÿ™ÿßÿ±
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => option.classList.remove('selected'));
            
            event.target.classList.add('selected');
            
            // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÇŸÑŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸÅÿπŸÑÿßŸã
            if (!isDrawingEnabled) {
                enableDrawing();
                const penToolBtn = document.getElementById('pen-tool-btn');
                if (penToolBtn) {
                    penToolBtn.classList.add('active');
                }
            }
        }
        
        function initDrawingCanvas() {
            canvas = document.getElementById('drawing-canvas');
            if (!canvas) return;
            
            const resultContent = document.getElementById('result-content');
            if (!resultContent) return;
            
            // ÿ∂ÿ®ÿ∑ ÿ£ÿ®ÿπÿßÿØ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥ ŸÑÿ™ÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÜÿµ
            const rect = resultContent.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // Ÿàÿ∂ÿπ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥ ŸÅŸàŸÇ ÿßŸÑŸÜÿµ
            canvas.style.top = rect.top + 'px';
            canvas.style.left = rect.left + 'px';
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            ctx = canvas.getContext('2d');
            if (!ctx) return;
            
            // ÿ•ÿπÿØÿßÿØ ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            setupDrawingEvents();
            loadSavedDrawings();
        }
        
        function setupDrawingEvents() {
            if (!canvas || !ctx) return;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1 && isDrawingEnabled) {
                const touch = e.touches[0];
                startDrawing({
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
            }
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1 && isDrawing && isDrawingEnabled) {
                const touch = e.touches[0];
                draw({
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
            }
        }
        
        function startDrawing(e) {
            if (!isDrawingEnabled) return;
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            // ÿ®ÿØÿ° ŸÖÿ≥ÿßÿ± ÿ¨ÿØŸäÿØ
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑŸÖÿ§ŸÇÿ™
            tempPaths.push({
                type: currentPenType,
                color: currentColor,
                points: [{x: lastX, y: lastY}],
                lineWidth: getLineWidth()
            });
        }
        
        function draw(e) {
            if (!isDrawing || !isDrawingEnabled) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±ÿ≥ŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑŸÇŸÑŸÖ
            ctx.lineWidth = getLineWidth();
            ctx.globalCompositeOperation = getCompositeOperation();
            
            if (currentPenType === 'eraser') {
                ctx.strokeStyle = '#FFFFFF';
                ctx.globalAlpha = 1;
            } else if (currentPenType === 'fading') {
                ctx.strokeStyle = currentColor;
                ctx.globalAlpha = 0.7;
            } else {
                ctx.strokeStyle = currentColor;
                ctx.globalAlpha = currentPenType === 'highlighter' ? 0.3 : 1;
            }
            
            // ÿ±ÿ≥ŸÖ ÿßŸÑÿÆÿ∑
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜŸÇÿ∑ÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑŸÖÿ§ŸÇÿ™
            if (tempPaths.length > 0) {
                tempPaths[tempPaths.length - 1].points.push({x: currentX, y: currentY});
            }
            
            lastX = currentX;
            lastY = currentY;
        }
        
        function stopDrawing() {
            if (!isDrawing) return;
            
            isDrawing = false;
            ctx.closePath();
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿßÿ± ŸÅŸä ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÖÿ≥ÿßÿ± ŸÖÿ§ŸÇÿ™
            if (tempPaths.length > 0) {
                const lastPath = tempPaths[tempPaths.length - 1];
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÇŸÑŸÖ ŸÖŸÜ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ∞Ÿä ŸäÿÆÿ™ŸÅŸä
                if (currentPenType === 'fading') {
                    fadingPaths.push({...lastPath, timestamp: Date.now()});
                    setTimeout(() => fadeDrawing(lastPath), 2000);
                } else {
                    // ÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÑŸÑÿ™ÿ±ÿßÿ¨ÿπ
                    saveToHistory(lastPath);
                }
                
                // ÿ≠ŸÅÿ∏ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                saveDrawingToDatabase(lastPath);
                
                // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©
                tempPaths = [];
            }
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±ÿ≥ŸÖ
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
        }
        
        function getLineWidth() {
            switch(currentPenType) {
                case 'normal': return 2;
                case 'highlighter': return 15;
                case 'eraser': return 20;
                case 'fading': return 3;
                default: return 2;
            }
        }
        
        function getCompositeOperation() {
            if (currentPenType === 'eraser') {
                return 'destination-out';
            }
            return 'source-over';
        }
        
        function fadeDrawing(path) {
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿßÿ± ŸÅŸä ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© Ÿàÿ•ÿ≤ÿßŸÑÿ™Ÿá
            const index = fadingPaths.findIndex(p => 
                p.timestamp === path.timestamp && 
                JSON.stringify(p.points) === JSON.stringify(path.points));
            
            if (index !== -1) {
                fadingPaths.splice(index, 1);
                redrawAll();
            }
        }
        
        function saveToHistory(path) {
            // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ®ÿπÿØ ÿßŸÑŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ≠ÿßŸÑŸä
            drawingHistory = drawingHistory.slice(0, historyIndex + 1);
            drawingHistory.push({...path});
            historyIndex = drawingHistory.length - 1;
        }
        
        function undoDrawing() {
            if (historyIndex >= 0) {
                historyIndex--;
                redrawAll();
            }
        }
        
        function redoDrawing() {
            if (historyIndex < drawingHistory.length - 1) {
                historyIndex++;
                redrawAll();
            }
        }
        
        function clearAllDrawings() {
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑÿ±ÿ≥ŸàŸÖÿßÿ™ÿü')) {
                drawingHistory = [];
                fadingPaths = [];
                tempPaths = [];
                historyIndex = -1;
                
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                
                // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                if (currentUser) {
                    database.ref(`drawings/${currentUser.id}`).remove()
                        .catch(error => {
                            console.error('Error clearing drawings from database:', error);
                        });
                }
            }
        }
        
        function redrawAll() {
            if (!ctx || !canvas) return;
            
            // ŸÖÿ≥ÿ≠ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ÿ•ÿπÿßÿØÿ© ÿ±ÿ≥ŸÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ≠ÿ™Ÿâ ÿßŸÑŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ≠ÿßŸÑŸä
            for (let i = 0; i <= historyIndex; i++) {
                drawPath(drawingHistory[i]);
            }
            
            // ÿ•ÿπÿßÿØÿ© ÿ±ÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿÆÿ™ŸÅŸä
            fadingPaths.forEach(path => drawPath(path));
        }
        
        function drawPath(path) {
            if (!path || !path.points || path.points.length < 2) return;
            
            ctx.beginPath();
            ctx.moveTo(path.points[0].x, path.points[0].y);
            
            // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±ÿ≥ŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿßÿ±
            ctx.lineWidth = path.lineWidth || getLineWidth();
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (path.type === 'eraser') {
                ctx.strokeStyle = '#FFFFFF';
                ctx.globalCompositeOperation = 'destination-out';
                ctx.globalAlpha = 1;
            } else if (path.type === 'fading') {
                ctx.strokeStyle = path.color || currentColor;
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 0.7;
            } else {
                ctx.strokeStyle = path.color || currentColor;
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = path.type === 'highlighter' ? 0.3 : 1;
            }
            
            // ÿ±ÿ≥ŸÖ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸÇÿßÿ∑
            for (let i = 1; i < path.points.length; i++) {
                ctx.lineTo(path.points[i].x, path.points[i].y);
            }
            
            ctx.stroke();
            ctx.closePath();
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
        }
        
        function enableDrawing() {
            isDrawingEnabled = true;
            if (canvas) {
                canvas.classList.add('active');
            }
            initDrawingCanvas();
        }
        
        function disableDrawing() {
            isDrawingEnabled = false;
            isDrawing = false;
            if (canvas) {
                canvas.classList.remove('active');
            }
        }
        
        async function saveDrawingToDatabase(path) {
            if (!currentUser || !path) return;
            
            try {
                const drawingId = 'drawing_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const drawingData = {
                    type: path.type,
                    color: path.color,
                    points: path.points,
                    lineWidth: path.lineWidth,
                    timestamp: Date.now(),
                    position: {
                        contentTop: canvas.style.top,
                        contentLeft: canvas.style.left,
                        contentWidth: canvas.style.width,
                        contentHeight: canvas.style.height
                    }
                };
                
                await database.ref(`drawings/${currentUser.id}/${drawingId}`).set(drawingData);
                
            } catch (error) {
                console.error('Error saving drawing to database:', error);
            }
        }
        
        async function loadSavedDrawings() {
            if (!currentUser || !ctx || !canvas) return;
            
            try {
                const snapshot = await database.ref(`drawings/${currentUser.id}`).once('value');
                if (snapshot.exists()) {
                    const drawings = snapshot.val();
                    drawingHistory = [];
                    
                    Object.values(drawings).forEach(drawingData => {
                        if (drawingData && drawingData.points) {
                            drawingHistory.push({
                                type: drawingData.type || 'normal',
                                color: drawingData.color || '#3B82F6',
                                points: drawingData.points,
                                lineWidth: drawingData.lineWidth || 2
                            });
                        }
                    });
                    
                    historyIndex = drawingHistory.length - 1;
                    redrawAll();
                }
            } catch (error) {
                console.error('Error loading drawings from database:', error);
            }
        }
        
        // ========== ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿµŸàÿ™ ==========
        
        function toggleAudioTools() {
            const audioToolsPopup = document.getElementById('audio-controls-popup');
            const penToolsPopup = document.getElementById('pen-tools-popup');
            
            if (audioToolsPopup) {
                if (audioToolsPopup.classList.contains('show')) {
                    audioToolsPopup.classList.remove('show');
                    document.removeEventListener('click', hideAudioToolsOutside);
                } else {
                    audioToolsPopup.classList.add('show');
                    if (penToolsPopup) {
                        penToolsPopup.classList.remove('show');
                    }
                    
                    // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
                    setTimeout(() => {
                        document.addEventListener('click', hideAudioToolsOutside, { once: true });
                    }, 10);
                }
            }
        }
        
        function hideAudioToolsOutside(e) {
            const audioToolsPopup = document.getElementById('audio-controls-popup');
            const audioToolBtn = document.getElementById('audio-tool-btn');
            
            if (audioToolsPopup && audioToolBtn && 
                !audioToolsPopup.contains(e.target) && 
                !audioToolBtn.contains(e.target)) {
                audioToolsPopup.classList.remove('show');
            }
        }
        
        function startAudio() {
            const resultContent = document.getElementById('result-content');
            if (!resultContent) return;
            
            // ÿ≠ŸÅÿ∏ HTML ÿßŸÑÿ£ÿµŸÑŸä
            originalHTML = resultContent.innerHTML;
            
            // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµ
            const text = resultContent.textContent;
            textWords = text.split(/\s+/);
            currentWordIndex = 0;
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸÑÿßŸÖ ÿ®ÿµŸàÿ™ ÿ±ÿ¨ŸÑ
            audioUtterance = new SpeechSynthesisUtterance(text);
            audioUtterance.lang = 'ar-SA';
            audioUtterance.rate = 0.85;
            audioUtterance.pitch = 1.0;
            audioUtterance.volume = 1;
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ™ ÿ±ÿ¨ŸÑ
            const voices = speechSynthesis.getVoices();
            const arabicVoice = voices.find(voice => 
                voice.lang.startsWith('ar'));
            
            if (arabicVoice) {
                audioUtterance.voice = arabicVoice;
            }
            
            // ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑŸÉŸÑÿßŸÖ
            audioUtterance.onstart = function() {
                isAudioPlaying = true;
                isAudioPaused = false;
                audioStartTime = Date.now();
                updatePauseButton();
                startWordHighlighting();
            };
            
            // ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸÉŸÑÿßŸÖ
            audioUtterance.onend = function() {
                isAudioPlaying = false;
                currentWordIndex = 0;
                const audioToolBtn = document.getElementById('audio-tool-btn');
                if (audioToolBtn) audioToolBtn.classList.remove('active');
                
                // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿµ ÿßŸÑÿ£ÿµŸÑŸä
                restoreOriginalText();
                hideAudioTools();
            };
            
            // ÿπŸÜÿØ ÿßŸÑÿÆÿ∑ÿ£
            audioUtterance.onerror = function(event) {
                console.error('Speech synthesis error:', event);
                isAudioPlaying = false;
                const audioToolBtn = document.getElementById('audio-tool-btn');
                if (audioToolBtn) audioToolBtn.classList.remove('active');
                restoreOriginalText();
                hideAudioTools();
            };
            
            // ÿ®ÿØÿ° ÿßŸÑŸÇÿ±ÿßÿ°ÿ©
            speechSynthesis.speak(audioUtterance);
            const audioToolBtn = document.getElementById('audio-tool-btn');
            if (audioToolBtn) audioToolBtn.classList.add('active');
        }
        
        function startWordHighlighting() {
            if (!isAudioPlaying) return;
            
            // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ§ŸÇÿ™ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
            wordTimers.forEach(timer => clearTimeout(timer));
            wordTimers = [];
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ®Ÿä ŸÑŸÉŸÑ ŸÉŸÑŸÖÿ©
            const wordDuration = 120; // 120ms ŸÑŸÉŸÑ ŸÉŸÑŸÖÿ© ŸÅŸä ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑
            
            for (let i = 0; i < textWords.length; i++) {
                const timer = setTimeout(() => {
                    if (isAudioPlaying && !isAudioPaused) {
                        highlightWord(i);
                    }
                }, i * wordDuration);
                
                wordTimers.push(timer);
            }
        }
        
        function highlightWord(index) {
            if (index >= textWords.length) return;
            
            const resultContent = document.getElementById('result-content');
            if (!resultContent) return;
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ÿßŸÑŸÜÿµ ŸÖÿπ ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
            let newHTML = '';
            let wordCount = 0;
            
            // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑŸÜÿµ ÿßŸÑÿ£ÿµŸÑŸä ÿ•ŸÑŸâ ŸÅŸÇÿ±ÿßÿ™ ŸàŸÉŸÑŸÖÿßÿ™
            const paragraphs = originalHTML.split(/<p>|<\/p>/).filter(p => p.trim());
            
            paragraphs.forEach((para) => {
                if (para.trim()) {
                    const words = para.split(/(\s+)/);
                    let paragraphHTML = '';
                    
                    words.forEach(word => {
                        if (word.trim()) {
                            if (wordCount === index) {
                                paragraphHTML += `<span class="highlighted-word">${word}</span>`;
                            } else {
                                paragraphHTML += word;
                            }
                            wordCount++;
                        } else {
                            paragraphHTML += word;
                        }
                    });
                    
                    newHTML += `<p>${paragraphHTML}</p>`;
                }
            });
            
            resultContent.innerHTML = newHTML;
            currentWordIndex = index;
        }
        
        function restoreOriginalText() {
            const resultContent = document.getElementById('result-content');
            if (resultContent && originalHTML) {
                resultContent.innerHTML = originalHTML;
            }
        }
        
        function pauseResumeAudio() {
            if (!audioUtterance) return;
            
            if (isAudioPaused) {
                speechSynthesis.resume();
                isAudioPaused = false;
                audioStartTime = Date.now() - (currentWordIndex * 120);
                startWordHighlighting();
            } else {
                speechSynthesis.pause();
                isAudioPaused = true;
                
                // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ§ŸÇÿ™ÿßÿ™
                wordTimers.forEach(timer => clearTimeout(timer));
                wordTimers = [];
            }
            
            updatePauseButton();
        }
        
        function updatePauseButton() {
            const pauseBtn = document.getElementById('pause-btn');
            if (pauseBtn) {
                if (isAudioPaused) {
                    pauseBtn.innerHTML = '<i class="fas fa-play"></i> ŸÖÿ™ÿßÿ®ÿπÿ©';
                } else {
                    pauseBtn.innerHTML = '<i class="fas fa-pause"></i> ÿ•ŸäŸÇÿßŸÅ';
                }
            }
        }
        
        function restartAudio() {
            stopAudio();
            setTimeout(() => {
                startAudio();
            }, 100);
        }
        
        function stopAudio() {
            if (audioUtterance) {
                speechSynthesis.cancel();
                isAudioPlaying = false;
                isAudioPaused = false;
                
                // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ§ŸÇÿ™ÿßÿ™
                wordTimers.forEach(timer => clearTimeout(timer));
                wordTimers = [];
                
                restoreOriginalText();
                
                const audioToolBtn = document.getElementById('audio-tool-btn');
                if (audioToolBtn) {
                    audioToolBtn.classList.remove('active');
                }
                
                hideAudioTools();
            }
        }
        
        function hideAudioTools() {
            const audioToolsPopup = document.getElementById('audio-controls-popup');
            if (audioToolsPopup) {
                audioToolsPopup.classList.remove('show');
            }
        }
        
        // ========== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ==========
        
        async function loadUserData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    window.location.replace('login.html');
                    return;
                }
                
                const usersRef = database.ref('users_Awn');
                const snapshot = await usersRef.once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    let userFound = false;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userId !== 'noty_publick' && userData.email === user.email) {
                            currentUser = {
                                id: userId,
                                email: userData.email,
                                name: userData.name || '',
                                coin: userData.coin || 0,
                                admin: userData.admin === true || false,
                                banned: userData.banned === true || false
                            };
                            
                            userCoins = userData.coin || 0;
                            const coinsCount = document.getElementById('coins-count');
                            if (coinsCount) {
                                coinsCount.textContent = userCoins;
                            }
                            userFound = true;
                            break;
                        }
                    }
                    
                    if (!userFound) {
                        await auth.signOut();
                        window.location.replace('login.html');
                    }
                } else {
                    await auth.signOut();
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.location.replace('login.html');
            }
        }
        
        async function setupUser() {
            try {
                await loadUserData();
                
                if (currentUser && currentUser.banned !== true) {
                    const navbar = document.getElementById('navbar');
                    const mainContent = document.getElementById('main-content');
                    
                    if (navbar) navbar.style.display = 'flex';
                    if (mainContent) mainContent.style.display = 'block';
                } else {
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error setting up user:', error);
                window.location.replace('login.html');
            }
        }
        
        // ========== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ==========
        
        function setupFileUpload() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadArea = document.getElementById('upload-area');
            
            if (pdfFile) {
                pdfFile.addEventListener('change', handleFileSelect);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-primary)';
                uploadArea.style.backgroundColor = 'rgba(139, 115, 85, 0.1)';
            }
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                await handleFile(files[0]);
            }
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            await handleFile(file);
        }
        
        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ŸÅŸÇÿ∑', 'error');
                resetFileInput();
                return;
            }
            
            selectedFile = file;
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            
            if (uploadText) uploadText.textContent = file.name;
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-primary)';
                uploadArea.style.backgroundColor = 'rgba(139, 115, 85, 0.1)';
            }
            
            await analyzePDF(file);
        }
        
        async function analyzePDF(file) {
            try {
                const loadingMessages = [
                    'ÿπŸàŸÜ Ÿäÿ≠ŸÑŸÑ ÿßŸÑŸÖŸÑŸÅ...',
                    'ÿπŸàŸÜ Ÿäÿ≥ÿ™ÿÆÿ±ÿ¨ ÿßŸÑŸÜÿµ...',
                    'ÿπŸàŸÜ ŸäÿπÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™...',
                    'ÿπŸàŸÜ Ÿäÿ≠ÿ≥ÿ® ÿßŸÑÿ™ŸÉŸÑŸÅÿ©...'
                ];
                
                let messageIndex = 0;
                const loadingInterval = setInterval(() => {
                    showLoading(loadingMessages[messageIndex]);
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                }, 1500);
                
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }
                
                clearInterval(loadingInterval);
                
                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;
                coins = Math.round(coins * 10) / 10;
                
                fileInfo = {
                    name: file.name,
                    size: file.size,
                    pages: pdf.numPages,
                    words: totalWords,
                    cost: coins
                };
                
                hideLoading();
                
                const pageCount = document.getElementById('page-count');
                const costAmount = document.getElementById('cost-amount');
                const costPreview = document.getElementById('cost-preview');
                
                if (pageCount) pageCount.textContent = fileInfo.pages;
                if (costAmount) costAmount.textContent = fileInfo.cost + ' ÿπŸÖŸÑÿ©';
                if (costPreview) costPreview.classList.add('show');
                
                showNotification('ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                
            } catch (error) {
                console.error('Error analyzing PDF:', error);
                hideLoading();
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error');
                resetFileInput();
            }
        }
        
        function resetFileInput() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            const costPreview = document.getElementById('cost-preview');
            
            if (pdfFile) pdfFile.value = '';
            selectedFile = null;
            if (uploadText) uploadText.textContent = 'ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF';
            if (uploadArea) {
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
            }
            if (costPreview) costPreview.classList.remove('show');
        }
        
        function cancelProcess() {
            resetFileInput();
            const costPreview = document.getElementById('cost-preview');
            if (costPreview) costPreview.classList.remove('show');
            showNotification('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©', 'info');
        }
        
        function confirmProcess() {
            const uploadSection = document.getElementById('upload-section');
            const settingsSection = document.getElementById('settings-section');
            const costPreview = document.getElementById('cost-preview');
            
            if (!uploadSection || !settingsSection || !costPreview) {
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÜÿßÿµÿ±', 'error');
                return;
            }
            
            if (!fileInfo || !fileInfo.cost || fileInfo.cost === 0) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }
            
            if (userCoins < fileInfo.cost) {
                showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä. ÿ™ÿ≠ÿ™ÿßÿ¨ ${fileInfo.cost} ÿπŸÖŸÑÿ© ÿ®ŸäŸÜŸÖÿß ÿ±ÿµŸäÿØŸÉ ${userCoins}`, 'error');
                return;
            }
            
            uploadSection.style.display = 'none';
            settingsSection.classList.add('show');
            costPreview.classList.remove('show');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÑÿÆŸäÿµ', 'success');
        }
        
        // ========== ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÑÿÆŸäÿµ ==========
        
        function setupSettingsEvents() {
            const explanationLevelBtns = document.querySelectorAll('#explanation-level .option-btn');
            explanationLevelBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    explanationLevelBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.explanationLevel = this.getAttribute('data-value');
                });
            });
            
            const dialectBtns = document.querySelectorAll('#dialect .option-btn');
            dialectBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    dialectBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.dialect = this.getAttribute('data-value');
                });
            });
            
            const explainerPersonaBtns = document.querySelectorAll('#explainer-persona .option-btn');
            explainerPersonaBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    explainerPersonaBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.explainerPersona = this.getAttribute('data-value');
                });
            });
            
            const outputLanguageBtns = document.querySelectorAll('#output-language .option-btn');
            outputLanguageBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    outputLanguageBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSettings.outputLanguage = this.getAttribute('data-value');
                });
            });
            
            const customLanguage = document.getElementById('custom-language');
            if (customLanguage) {
                customLanguage.addEventListener('input', function() {
                    if (this.value.trim()) {
                        selectedSettings.customLanguage = this.value.trim();
                        selectedSettings.outputLanguage = this.value.trim();
                    }
                });
            }
            
            const optionalComment = document.getElementById('optional-comment');
            if (optionalComment) {
                optionalComment.addEventListener('input', function() {
                    selectedSettings.optionalComment = this.value.trim();
                });
            }
        }
        
        function createPrompt() {
            const outputLanguage = selectedSettings.customLanguage || selectedSettings.outputLanguage;
            
            return `ROLE:
You are an AI specialized in **strict PDF analysis and summarization** following Google Gemini Flash 2.5 Lite standards.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES (IN ARABIC):
========================
ŸÑÿ∫ÿ©_ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨        = ${outputLanguage}
ÿßŸÑŸÑŸáÿ¨ÿ©             = ${selectedSettings.dialect}
ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿ¥ÿ±ÿ≠        = ${selectedSettings.explanationLevel}
ÿ¥ÿÆÿµŸäÿ©_ÿßŸÑÿ¥ÿßÿ±ÿ≠       = ${selectedSettings.explainerPersona}
ÿ™ÿπŸÑŸäŸÇ_ÿßÿÆÿ™Ÿäÿßÿ±Ÿä      = ${selectedSettings.optionalComment || 'ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ÿßÿ∞ÿß ŸÑŸÖ ŸäŸÉÿ™ÿ® ŸÑŸÖ Ÿäÿ§ÿ´ÿ±'}

========================
TASK:
========================
1. Analyze the provided PDF **from the first word to the last word only**.
2. Operate in **closed-book mode**: only PDF content can be used; external knowledge is forbidden.
3. Do NOT infer, guess, or add explanations not present in the PDF.
4. If the PDF is empty, corrupted, unreadable, or has no meaningful content ‚Üí return the fallback JSON exactly as defined below.
5. Generate a **full summary** with **complete coverage** of the PDF:
   - The AI has **freedom to determine the length** of the summary based on the file size and content complexity.
   - If the PDF is large ‚Üí produce a detailed, longer summary covering every part.
   - If the PDF is small ‚Üí produce a concise summary covering all key points.
   - The goal is a **self-sufficient summary** that allows the user to understand all important content **without reading the full PDF**.
   - Explanation level: ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿ¥ÿ±ÿ≠
   - Explainer persona: ÿ¥ÿÆÿµŸäÿ©_ÿßŸÑÿ¥ÿßÿ±ÿ≠
   - Output language: ŸÑÿ∫ÿ©_ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨
   - Dialect: ÿßŸÑŸÑŸáÿ¨ÿ©
   - Optional comment: ÿ™ÿπŸÑŸäŸÇ_ÿßÿÆÿ™Ÿäÿßÿ±Ÿä (ignore if empty)
   - The style must fully match the user-selected level and persona.

6. **RAW field rules**:
   - Extract **3‚Äì10 sentences**, not questions, but **direct statements summarizing the key content, laws, rules, or insights** from the PDF.
   - **Priority:** Any explicit rules, laws, or constraints in the PDF come first, then include the most important points or conclusions.
   - All sentences must be understandable **alone** and **directly traceable to PDF content**.
   - RAW must be derived solely from the PDF; no external knowledge, examples, or interpretations are allowed.
   - Minimum 3 sentences, maximum 10 sentences.

========================
OUTPUT FORMAT (STRICT):
========================
- Output MUST be **VALID JSON ONLY**
- No Markdown
- No extra text
- No comments
- Keys must appear **exactly in this order**

========================
JSON SCHEMA:
========================
{
  "head": "",
  "raw": [],
  "page": ""
}

========================
FIELD RULES:
========================
1. head:
   - Exactly 5 words
   - Represents the PDF content accurately
   - Written in ŸÑÿ∫ÿ©_ÿßŸÑÿ•ÿÆÿ±ÿßÿ¨

2. raw:
   - Array of **direct statements**, not questions
   - Minimum 3 items, maximum 10 items
   - Priority:
     a) Explicit rules, laws, or constraints in the PDF
     b) If none exist, summarize the most useful points or insights clearly
   - Must be understandable **alone** without reading the full summary
   - Written in the specified language, dialect, and style

3. page:
   - Full detailed explanation of the summary
   - Must follow **ÿ¥ÿÆÿµŸäÿ©_ÿßŸÑÿ¥ÿßÿ±ÿ≠** explaining in **ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿ¥ÿ±ÿ≠**
   - Strictly based on PDF content only
   - Must cover **everything in the PDF**; nothing should be skipped
   - No added knowledge or interpretation
   - **The AI may determine the summary length freely** to ensure full coverage and user self-sufficiency

========================
FAILURE / EMPTY PDF RESPONSE (MANDATORY):
========================
If the PDF is empty, unreadable, or invalid, RETURN EXACTLY:

{
  "head": "Not Output",
  "raw": "Not Output",
  "page": "Not Output"
}

========================
ABSOLUTE CONSTRAINTS:
========================
- Do NOT output anything except the final JSON
- Do NOT mention instructions or analysis steps
- Do NOT hallucinate or guess
- Be strict, literal, and deterministic
- Every output sentence must be semantically traceable to the PDF`;
        }
        
        async function generateSummary() {
            if (!selectedFile) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ PDF ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }
            
            if (userCoins < fileInfo.cost) {
                showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä. ÿ™ÿ≠ÿ™ÿßÿ¨ ${fileInfo.cost} ÿπŸÖŸÑÿ© ÿ®ŸäŸÜŸÖÿß ÿ±ÿµŸäÿØŸÉ ${userCoins}`, 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°...';
            }
            
            try {
                const loadingMessages = [
                    'ÿπŸàŸÜ Ÿäÿ≠ŸÑŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ...',
                    'ÿπŸàŸÜ Ÿäÿ¨Ÿáÿ≤ ÿßŸÑŸÖŸÑÿÆÿµ...',
                    'ÿπŸàŸÜ ŸäŸÜÿ≥ŸÇ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨...',
                    'ÿπŸàŸÜ ŸäŸÉŸÖŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©...'
                ];
                
                let messageIndex = 0;
                const loadingInterval = setInterval(() => {
                    showLoading(loadingMessages[messageIndex]);
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                }, 2000);
                
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const result = reader.result;
                        const base64Data = result.split(',')[1];
                        resolve(base64Data);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });
                
                const prompt = createPrompt();
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: prompt,
                        PDF_BASE64: base64
                    })
                });
                
                clearInterval(loadingInterval);
                
                if (!response.ok) {
                    throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±: ${response.status}`);
                }
                
                const text = await response.text();
                let result;
                
                try {
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        result = JSON.parse(jsonMatch[0]);
                    } else {
                        result = JSON.parse(text);
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e, 'Response:', text);
                    throw new Error('ÿ±ÿØ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±');
                }
                
                if (result.head === "Not Output" && result.raw === "Not Output" && result.page === "Not Output") {
                    throw new Error('ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑ ŸÑŸÑŸÇÿ±ÿßÿ°ÿ©');
                }
                
                await deductCoins(fileInfo.cost);
                await saveResultToDatabase(result);
                displayResult(result);
                
                const settingsSection = document.getElementById('settings-section');
                const resultSection = document.getElementById('result-section');
                
                if (settingsSection) settingsSection.classList.remove('show');
                if (resultSection) resultSection.classList.add('show');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // ÿ•ÿ∏Ÿáÿßÿ± ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ÿ®ÿπÿØ ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
                showReadingTools();
                
                showNotification('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                
            } catch (error) {
                console.error('Error generating summary:', error);
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ: ' + error.message, 'error');
            } finally {
                hideLoading();
                const generateBtn = document.getElementById('generate-btn');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-robot"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÑÿÆŸäÿµ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä';
                }
            }
        }
        
        async function deductCoins(amount) {
            try {
                const newCoins = userCoins - amount;
                userCoins = newCoins;
                
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(newCoins);
                const coinsCount = document.getElementById('coins-count');
                if (coinsCount) {
                    coinsCount.textContent = newCoins;
                }
                
            } catch (error) {
                console.error('Error deducting coins:', error);
                throw error;
            }
        }
        
        async function saveResultToDatabase(result) {
            try {
                const recordId = 'record_' + Date.now();
                const recordData = {
                    id: currentUser.id,
                    process: 'ŸÖŸÑÿÆÿµ',
                    data: result,
                    timestamp: Date.now(),
                    fileName: fileInfo.name,
                    cost: fileInfo.cost,
                    pages: fileInfo.pages,
                    settings: selectedSettings
                };
                
                await database.ref(`records/${recordId}`).set(recordData);
                
            } catch (error) {
                console.error('Error saving result to database:', error);
            }
        }
        
        function displayResult(result) {
            const resultTitle = document.getElementById('result-title');
            const resultContent = document.getElementById('result-content');
            const rawPoints = document.getElementById('raw-points');
            const container = document.getElementById('result-content-container');
            
            if (resultTitle) {
                resultTitle.textContent = result.head || 'ŸÖŸÑÿÆÿµ ÿßŸÑŸÖŸÑŸÅ';
            }
            
            if (resultContent) {
                resultContent.innerHTML = '';
                
                if (result.page) {
                    const paragraphs = result.page.split('\n').filter(p => p.trim());
                    paragraphs.forEach(paragraph => {
                        const p = document.createElement('p');
                        p.textContent = paragraph;
                        p.style.marginBottom = '20px';
                        p.style.lineHeight = '1.8';
                        resultContent.appendChild(p);
                    });
                } else {
                    resultContent.textContent = 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÑŸÑÿπÿ±ÿ∂';
                }
                
                resultContent.style.fontSize = resultFontSize + 'px';
                
                // ÿ∂ÿ®ÿ∑ ÿßÿ±ÿ™ŸÅÿßÿπ ÿßŸÑÿ≠ÿßŸàŸäÿ© ŸÑŸäÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
                if (container) {
                    const contentHeight = resultContent.scrollHeight + 80;
                    container.style.minHeight = Math.max(400, contentHeight) + 'px';
                }
            }
            
            if (rawPoints) {
                rawPoints.innerHTML = '';
                
                if (result.raw && Array.isArray(result.raw) && result.raw.length > 0) {
                    result.raw.forEach(point => {
                        const li = document.createElement('li');
                        li.innerHTML = `<i class="fas fa-check-circle"></i> ${point}`;
                        rawPoints.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.innerHTML = '<i class="fas fa-info-circle"></i> ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜŸÇÿßÿ∑ ÿ±ÿ¶Ÿäÿ≥Ÿäÿ©';
                    rawPoints.appendChild(li);
                }
            }
            
            // ÿ∂ÿ®ÿ∑ ŸÖŸàÿ∂ÿπ ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            setTimeout(() => {
                adjustRawSummaryPosition();
                // ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© ŸÉÿßŸÜŸÅÿßÿ≥ ÿßŸÑÿ±ÿ≥ŸÖ ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
                initDrawingCanvas();
            }, 100);
        }
        
        function adjustRawSummaryPosition() {
            const container = document.getElementById('result-content-container');
            const rawSummary = document.getElementById('raw-summary');
            
            if (!container || !rawSummary) return;
            
            const containerRect = container.getBoundingClientRect();
            const containerBottom = containerRect.bottom + window.scrollY;
            
            rawSummary.style.marginTop = '40px';
            rawSummary.style.marginBottom = '40px';
        }
        
        function showLoading(text = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...') {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            
            if (loadingScreen && loadingText) {
                loadingText.textContent = text;
                loadingScreen.style.display = 'flex';
                setTimeout(() => {
                    loadingScreen.style.opacity = '1';
                }, 10);
            }
        }
        
        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            }
        }
        
        // ========== ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ==========
        
        async function initApp() {
            showLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
            
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    hideLoading();
                    window.location.replace('login.html');
                    return;
                }
                
                try {
                    await setupUser();
                    setupFileUpload();
                    setupSettingsEvents();
                    
                    // ÿ™ŸáŸäÿ¶ÿ© ÿ£ÿØÿßÿ© ÿßŸÑŸÇŸÑŸÖ
                    selectPenType('normal');
                    selectColor('#3B82F6');
                    
                    const confirmBtn = document.querySelector('.confirm-btn');
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            confirmProcess();
                        });
                    }
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿ¨ŸÖ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
                    window.addEventListener('resize', function() {
                        adjustRawSummaryPosition();
                        if (canvas) {
                            initDrawingCanvas();
                        }
                    });
                    
                    hideLoading();
                    
                } catch (error) {
                    console.error('Error initializing app:', error);
                    hideLoading();
                    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ', 'error');
                } finally {
                    setTimeout(() => {
                        unsubscribe();
                    }, 100);
                }
            });
        }
        
        history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function(event) {
            history.pushState(null, null, window.location.href);
        });
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
