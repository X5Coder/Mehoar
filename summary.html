<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>عَون - خدمة التلخيص</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- مكتبة PDF.js لحساب عدد الكلمات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-color: #F8FAFC;
            --card-color: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --accent-dark: #0F172A;
            --black-gradient: linear-gradient(145deg, #0F172A, #1E293B);
            --border-radius: 24px;
            --border-radius-large: 32px;
            --navbar-height: 80px;
            --transition-quick: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --admin-color: #DC2626;
            --success-color: #059669;
            --warning-color: #D97706;
            --info-color: #2563EB;
        }
        
        body {
            font-family: 'Almarai', 'Tajawal', -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            -webkit-font-smoothing: antialiased;
        }
        
        /* شاشة التحميل */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 64px;
            background: linear-gradient(145deg, #0F172A, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(15, 23, 42, 0.1);
            border-left-color: var(--accent-dark);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        /* شريط التنقل */
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: saturate(200%) blur(30px);
            -webkit-backdrop-filter: saturate(200%) blur(30px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            z-index: 10000;
            border-bottom: 2px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
            margin: 0 20px;
            top: 15px;
            width: calc(100% - 40px);
            border: 3px solid #0F172A;
            border-radius: 28px;
        }
        
        .logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 42px;
            background: linear-gradient(145deg, #0F172A, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1.5px;
            cursor: pointer;
            transition: var(--transition-quick);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .coins-display {
            background: var(--black-gradient);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.2);
            border: 3px solid #0F172A;
            transition: var(--transition-quick);
        }
        
        .coins-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.3);
        }
        
        .coins-display i {
            font-size: 18px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        .font-size-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 20px;
        }
        
        .font-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: white;
            border: 3px solid #0F172A;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-quick);
            color: #0F172A;
            font-weight: 800;
            font-size: 1.2rem;
        }
        
        .font-btn:hover {
            background: var(--black-gradient);
            color: white;
            transform: translateY(-2px);
        }
        
        /* المحتوى الرئيسي */
        .main-content {
            padding-top: calc(var(--navbar-height) + 60px);
            padding-left: 28px;
            padding-right: 28px;
            padding-bottom: 100px;
            max-width: 1300px;
            margin: 0 auto;
        }
        
        /* قسم رفع الملف */
        .upload-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 36px;
            margin-bottom: 40px;
            border: 4px solid var(--accent-dark);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .section-title {
            font-family: 'Almarai', sans-serif;
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--accent-dark);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .upload-area {
            border: 4px dashed var(--accent-dark);
            border-radius: var(--border-radius-large);
            padding: 50px 30px;
            background: rgba(15, 23, 42, 0.02);
            cursor: pointer;
            transition: var(--transition-quick);
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            background: rgba(15, 23, 42, 0.05);
            transform: translateY(-5px);
        }
        
        .upload-icon {
            font-size: 64px;
            color: var(--accent-dark);
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }
        
        .file-input {
            display: none;
        }
        
        /* معلومات الملف بعد الرفع */
        .file-info {
            background: rgba(15, 23, 42, 0.05);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-top: 30px;
            border: 3px solid rgba(15, 23, 42, 0.1);
            text-align: right;
            display: none;
        }
        
        .file-info.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background: white;
            border-radius: 16px;
            padding: 18px;
            border: 2px solid rgba(15, 23, 42, 0.1);
        }
        
        .info-label {
            font-family: 'Almarai', sans-serif;
            font-weight: 800;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .info-value {
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            color: var(--accent-dark);
            font-size: 1.1rem;
        }
        
        .coins-cost {
            color: var(--admin-color);
            font-weight: 900;
        }
        
        /* أزرار التحكم */
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .action-btn {
            padding: 16px 40px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition-quick);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-width: 180px;
        }
        
        .continue-btn {
            background: var(--black-gradient);
            color: white;
            border: 3px solid var(--accent-dark);
        }
        
        .continue-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.25);
        }
        
        .cancel-btn {
            background: white;
            color: var(--accent-dark);
            border: 3px solid var(--accent-dark);
        }
        
        .cancel-btn:hover {
            transform: translateY(-5px);
            background: rgba(15, 23, 42, 0.05);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* قسم الإعدادات */
        .settings-section {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 36px;
            margin-bottom: 40px;
            border: 4px solid var(--accent-dark);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .settings-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        /* شريط عدد الصفحات */
        .pages-slider {
            margin-bottom: 40px;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .slider-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-dark);
        }
        
        .page-count {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--info-color);
            background: rgba(37, 99, 235, 0.1);
            padding: 8px 16px;
            border-radius: 12px;
        }
        
        .slider-container {
            position: relative;
            height: 50px;
            background: rgba(15, 23, 42, 0.05);
            border-radius: 25px;
            overflow: hidden;
        }
        
        .slider-track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }
        
        .slider-segment {
            flex: 1;
            border-right: 2px solid white;
            position: relative;
        }
        
        .slider-segment:last-child {
            border-right: none;
        }
        
        .slider-segment.active {
            background: var(--info-color);
        }
        
        .slider-segment-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .slider-input {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        /* اختيارات الإعدادات */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .option-group {
            background: rgba(15, 23, 42, 0.02);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 3px solid rgba(15, 23, 42, 0.1);
        }
        
        .option-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--accent-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-title i {
            color: var(--info-color);
        }
        
        .option-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option-choice {
            padding: 16px;
            background: white;
            border-radius: 16px;
            border: 3px solid rgba(15, 23, 42, 0.1);
            cursor: pointer;
            transition: var(--transition-quick);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .option-choice:hover {
            transform: translateX(-10px);
            border-color: var(--info-color);
        }
        
        .option-choice.selected {
            background: var(--info-color);
            color: white;
            border-color: var(--info-color);
        }
        
        .option-choice.selected .check-icon {
            display: block;
        }
        
        .check-icon {
            display: none;
            color: white;
        }
        
        .custom-language {
            margin-top: 15px;
            display: none;
        }
        
        .custom-input {
            width: 100%;
            padding: 14px 18px;
            border: 3px solid var(--accent-dark);
            border-radius: 16px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: var(--transition-quick);
        }
        
        .custom-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .comment-section {
            margin-top: 30px;
        }
        
        .comment-input {
            width: 100%;
            padding: 18px;
            border: 3px solid rgba(15, 23, 42, 0.2);
            border-radius: 16px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
            transition: var(--transition-quick);
        }
        
        .comment-input:focus {
            outline: none;
            border-color: var(--info-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* شاشة التلخيص الناتج */
        .result-section {
            display: none;
        }
        
        .result-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .pages-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            margin-top: 40px;
        }
        
        .result-page {
            background: white;
            border-radius: var(--border-radius-large);
            padding: 36px;
            border: 4px solid var(--accent-dark);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.08);
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid rgba(15, 23, 42, 0.1);
        }
        
        .page-number {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .page-badge {
            background: var(--info-color);
            color: white;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .page-content {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
            margin-bottom: 30px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .laws-section {
            background: rgba(15, 23, 42, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 3px solid rgba(15, 23, 42, 0.1);
            display: none;
        }
        
        .laws-section.show {
            display: block;
        }
        
        .laws-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .laws-title i {
            color: var(--warning-color);
        }
        
        .laws-content {
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 992px) {
            .main-content {
                padding-top: calc(var(--navbar-height) + 50px);
                padding-left: 24px;
                padding-right: 24px;
                padding-bottom: 80px;
            }
            
            .section-title {
                font-size: 1.8rem;
            }
            
            .upload-section, .settings-section, .result-page {
                padding: 32px 28px;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .native-navbar {
                padding: 0 24px;
                margin: 0 16px;
                top: 12px;
                width: calc(100% - 32px);
                height: 70px;
            }
            
            .logo {
                font-size: 36px;
            }
            
            .coins-display {
                padding: 10px 20px;
                font-size: 15px;
            }
            
            .main-content {
                padding-top: calc(70px + 40px);
                padding-left: 20px;
                padding-right: 20px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .page-number {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .native-navbar {
                padding: 0 20px;
                margin: 0 12px;
                top: 10px;
                width: calc(100% - 24px);
            }
            
            .logo {
                font-size: 32px;
            }
            
            .coins-display {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .main-content {
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .upload-icon {
                font-size: 48px;
            }
            
            .slider-segment-number {
                font-size: 0.8rem;
            }
            
            .page-content {
                font-size: 1rem;
            }
        }
        
        /* حجم الخطوط الديناميكي */
        body.font-small .page-content,
        body.font-small .laws-content {
            font-size: 0.9rem;
        }
        
        body.font-large .page-content,
        body.font-large .laws-content {
            font-size: 1.2rem;
        }
        
        body.font-xlarge .page-content,
        body.font-xlarge .laws-content {
            font-size: 1.4rem;
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">عَون</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">جاري التحميل...</div>
    </div>
    
    <!-- شريط التنقل -->
    <nav class="native-navbar" style="display: none;" id="navbar">
        <div class="logo" id="logo">عَون</div>
        <div class="nav-right">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
            <div class="font-size-controls" id="font-controls" style="display: none;">
                <button class="font-btn" id="font-decrease">A-</button>
                <button class="font-btn" id="font-increase">A+</button>
            </div>
        </div>
    </nav>
    
    <!-- المحتوى الرئيسي -->
    <div class="main-content" style="display: none;" id="main-content">
        <!-- قسم رفع الملف -->
        <section class="upload-section" id="upload-section">
            <h2 class="section-title">تلخيص PDF</h2>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">انقر لرفع ملف PDF</div>
                <div class="upload-hint">المقاس الأقصى: 20MB | الملفات المدعومة: PDF فقط</div>
                <input type="file" class="file-input" id="pdf-file" accept=".pdf">
            </div>
            
            <div class="file-info" id="file-info">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">اسم الملف</div>
                        <div class="info-value" id="file-name">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">حجم الملف</div>
                        <div class="info-value" id="file-size">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">عدد الصفحات</div>
                        <div class="info-value" id="page-count">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">عدد الكلمات</div>
                        <div class="info-value" id="word-count">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">التكلفة (عملات)</div>
                        <div class="info-value coins-cost" id="coins-cost">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">رصيدك الحالي</div>
                        <div class="info-value" id="current-coins">-</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn cancel-btn" id="cancel-upload">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="action-btn continue-btn" id="continue-btn" disabled>
                        <i class="fas fa-arrow-right"></i>
                        المتابعة
                    </button>
                </div>
            </div>
        </section>
        
        <!-- قسم إعدادات التلخيص -->
        <section class="settings-section" id="settings-section">
            <h2 class="section-title">إعدادات التلخيص</h2>
            
            <!-- شريط عدد الصفحات -->
            <div class="pages-slider">
                <div class="slider-header">
                    <div class="slider-title">عدد الصفحات الملخصة</div>
                    <div class="page-count" id="selected-pages">1 صفحة</div>
                </div>
                <div class="slider-container">
                    <div class="slider-track" id="slider-track">
                        <!-- سيتم إنشاء 25 قطعة بالجافاسكريبت -->
                    </div>
                    <input type="range" class="slider-input" id="pages-slider" min="1" max="25" value="1">
                </div>
            </div>
            
            <!-- اختيارات الإعدادات -->
            <div class="options-grid">
                <div class="option-group">
                    <div class="option-title">
                        <i class="fas fa-comment-dots"></i>
                        طريقة الشرح
                    </div>
                    <div class="option-choices" id="explanation-style">
                        <div class="option-choice" data-value="طفولي">
                            <span>طفولي</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="معقد">
                            <span>معقد</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="بسيط">
                            <span>بسيط</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="option-title">
                        <i class="fas fa-globe"></i>
                        اللهجة المفضلة
                    </div>
                    <div class="option-choices" id="dialect">
                        <div class="option-choice" data-value="مصري">
                            <span>مصري</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="سعودي">
                            <span>سعودي</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="جزائري">
                            <span>جزائري</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="عربيه فصحى">
                            <span>عربيه فصحى</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="option-title">
                        <i class="fas fa-user-tie"></i>
                        الشخص الشارح
                    </div>
                    <div class="option-choices" id="explainer">
                        <div class="option-choice" data-value="طالب">
                            <span>طالب</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="عالم">
                            <span>عالم</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="دكتور جامعة">
                            <span>دكتور جامعة</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="مدرس">
                            <span>مدرس</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="option-title">
                        <i class="fas fa-language"></i>
                        لغة الإخراج
                    </div>
                    <div class="option-choices" id="output-language">
                        <div class="option-choice" data-value="عربي">
                            <span>عربي</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="انجليزي">
                            <span>انجليزي</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="same">
                            <span>نفس لغة الملف</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                        <div class="option-choice" data-value="custom">
                            <span>لغة مخصصة</span>
                            <i class="fas fa-check check-icon"></i>
                        </div>
                    </div>
                    <div class="custom-language" id="custom-language-input">
                        <input type="text" class="custom-input" id="custom-language" placeholder="اكتب اسم اللغة (مثل: فرنسي، ألماني، إسباني)">
                    </div>
                </div>
            </div>
            
            <!-- التعليق الاختياري -->
            <div class="comment-section">
                <div class="option-title">
                    <i class="fas fa-edit"></i>
                    تعليق إضافي (اختياري)
                </div>
                <textarea class="comment-input" id="comment" placeholder="اكتب أي تعليق أو ملاحظة إضافية تريد أن يراعيها التلخيص..."></textarea>
            </div>
            
            <!-- أزرار التحكم -->
            <div class="action-buttons">
                <button class="action-btn cancel-btn" id="cancel-settings">
                    <i class="fas fa-arrow-right fa-rotate-180"></i>
                    رجوع
                </button>
                <button class="action-btn continue-btn" id="generate-btn">
                    <i class="fas fa-robot"></i>
                    إنشاء التلخيص
                </button>
            </div>
        </section>
        
        <!-- قسم نتائج التلخيص -->
        <section class="result-section" id="result-section">
            <h2 class="section-title">التلخيص الناتج</h2>
            <div class="pages-container" id="pages-container">
                <!-- سيتم إضافة الصفحات هنا بالجافاسكريبت -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn continue-btn" id="new-summary">
                    <i class="fas fa-plus"></i>
                    تلخيص جديد
                </button>
            </div>
        </section>
    </div>

    <script>
        // تهيئة Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // العناصر الرئيسية
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            loadingText: document.getElementById('loading-text'),
            navbar: document.getElementById('navbar'),
            logo: document.getElementById('logo'),
            coinsCount: document.getElementById('coins-count'),
            fontControls: document.getElementById('font-controls'),
            fontDecrease: document.getElementById('font-decrease'),
            fontIncrease: document.getElementById('font-increase'),
            mainContent: document.getElementById('main-content'),
            
            // قسم رفع الملف
            uploadArea: document.getElementById('upload-area'),
            pdfFile: document.getElementById('pdf-file'),
            fileInfo: document.getElementById('file-info'),
            fileName: document.getElementById('file-name'),
            fileSize: document.getElementById('file-size'),
            pageCount: document.getElementById('page-count'),
            wordCount: document.getElementById('word-count'),
            coinsCost: document.getElementById('coins-cost'),
            currentCoins: document.getElementById('current-coins'),
            cancelUpload: document.getElementById('cancel-upload'),
            continueBtn: document.getElementById('continue-btn'),
            
            // قسم الإعدادات
            settingsSection: document.getElementById('settings-section'),
            selectedPages: document.getElementById('selected-pages'),
            sliderTrack: document.getElementById('slider-track'),
            pagesSlider: document.getElementById('pages-slider'),
            explanationStyle: document.getElementById('explanation-style'),
            dialect: document.getElementById('dialect'),
            explainer: document.getElementById('explainer'),
            outputLanguage: document.getElementById('output-language'),
            customLanguageInput: document.getElementById('custom-language-input'),
            customLanguage: document.getElementById('custom-language'),
            comment: document.getElementById('comment'),
            cancelSettings: document.getElementById('cancel-settings'),
            generateBtn: document.getElementById('generate-btn'),
            
            // قسم النتائج
            resultSection: document.getElementById('result-section'),
            pagesContainer: document.getElementById('pages-container'),
            newSummary: document.getElementById('new-summary')
        };

        // متغيرات التطبيق
        let currentUser = null;
        let userCoins = 0;
        let currentFile = null;
        let fileInfo = {
            name: '',
            size: 0,
            pages: 0,
            words: 0,
            coins: 0
        };
        let summarySettings = {
            pages: 1,
            explanationStyle: 'طفولي',
            dialect: 'مصري',
            explainer: 'طالب',
            outputLanguage: 'عربي',
            customLanguage: '',
            comment: ''
        };
        let summaryResult = null;
        
        // تهيئة التطبيق
        async function initApp() {
            try {
                // الانتظار حتى اكتمال تحميل Firebase
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // التحقق من حالة المصادقة
                const user = auth.currentUser;
                if (!user) {
                    window.location.replace('login.html');
                    return;
                }
                
                // جلب بيانات المستخدم
                await loadUserData();
                
                // إعداد واجهة المستخدم
                setupUI();
                
                // إخفاء شاشة التحميل
                hideLoadingScreen();
                
            } catch (error) {
                console.error('خطأ في تهيئة التطبيق:', error);
                alert('حدث خطأ في تحميل التطبيق. يرجى المحاولة مرة أخرى.');
                window.location.replace('home.html');
            }
        }
        
        // تحميل بيانات المستخدم
        async function loadUserData() {
            try {
                const user = auth.currentUser;
                const snapshot = await database.ref('users_Awn').once('value');
                const users = snapshot.val();
                
                let userData = null;
                for (const [userId, data] of Object.entries(users)) {
                    if (userId !== 'noty_publick' && data.email === user.email) {
                        userData = { id: userId, ...data };
                        break;
                    }
                }
                
                if (!userData || userData.banned === true) {
                    await auth.signOut();
                    window.location.replace('login.html');
                    return;
                }
                
                currentUser = {
                    id: userData.id,
                    email: userData.email,
                    name: userData.name || '',
                    coin: userData.coin || 0,
                    admin: userData.admin === true || false
                };
                
                userCoins = userData.coin || 0;
                elements.coinsCount.textContent = userCoins;
                
            } catch (error) {
                console.error('خطأ في تحميل بيانات المستخدم:', error);
                throw error;
            }
        }
        
        // إعداد واجهة المستخدم
        function setupUI() {
            // إعداد شريط التنقل
            elements.logo.addEventListener('click', () => {
                window.location.href = 'home.html';
            });
            
            // إعداد عناصر رفع الملف
            elements.uploadArea.addEventListener('click', () => {
                elements.pdfFile.click();
            });
            
            elements.pdfFile.addEventListener('change', handleFileUpload);
            elements.cancelUpload.addEventListener('click', resetUpload);
            elements.continueBtn.addEventListener('click', showSettingsSection);
            
            // إعداد شريط الصفحات
            setupPagesSlider();
            
            // إعداد اختيارات الإعدادات
            setupOptionChoices(elements.explanationStyle, 'explanationStyle');
            setupOptionChoices(elements.dialect, 'dialect');
            setupOptionChoices(elements.explainer, 'explainer');
            setupOptionChoices(elements.outputLanguage, 'outputLanguage');
            
            // إعداد زر التوليد
            elements.generateBtn.addEventListener('click', generateSummary);
            elements.cancelSettings.addEventListener('click', cancelSettings);
            
            // إعداد أزرار التحكم بالخط
            elements.fontDecrease.addEventListener('click', decreaseFontSize);
            elements.fontIncrease.addEventListener('click', increaseFontSize);
            
            // إعداد زر التلخيص الجديد
            elements.newSummary.addEventListener('click', resetToUpload);
            
            // اختيار القيم الافتراضية
            selectDefaultOptions();
        }
        
        // إعداد شريط عدد الصفحات
        function setupPagesSlider() {
            // إنشاء 25 قطعة في شريط التقدم
            for (let i = 1; i <= 25; i++) {
                const segment = document.createElement('div');
                segment.className = 'slider-segment';
                segment.innerHTML = `<div class="slider-segment-number">${i}</div>`;
                elements.sliderTrack.appendChild(segment);
            }
            
            // تحديث العرض عند تغيير قيمة السلايدر
            elements.pagesSlider.addEventListener('input', updatePagesSlider);
            updatePagesSlider(); // التهيئة الأولى
        }
        
        // تحديث شريط الصفحات
        function updatePagesSlider() {
            const value = parseInt(elements.pagesSlider.value);
            summarySettings.pages = value;
            
            // تحديث العدد المعروض
            elements.selectedPages.textContent = `${value} صفحة`;
            
            // تحديث القطع النشطة
            const segments = elements.sliderTrack.querySelectorAll('.slider-segment');
            segments.forEach((segment, index) => {
                if (index < value) {
                    segment.classList.add('active');
                } else {
                    segment.classList.remove('active');
                }
            });
        }
        
        // إعداد اختيارات الإعدادات
        function setupOptionChoices(container, settingKey) {
            const choices = container.querySelectorAll('.option-choice');
            choices.forEach(choice => {
                choice.addEventListener('click', () => {
                    // إلغاء تحديد جميع الخيارات
                    choices.forEach(c => c.classList.remove('selected'));
                    
                    // تحديد الخيار الجديد
                    choice.classList.add('selected');
                    
                    // حفظ القيمة المختارة
                    const value = choice.getAttribute('data-value');
                    summarySettings[settingKey] = value;
                    
                    // إظهار حقل اللغة المخصصة إذا تم اختيارها
                    if (settingKey === 'outputLanguage' && value === 'custom') {
                        elements.customLanguageInput.style.display = 'block';
                    } else if (settingKey === 'outputLanguage') {
                        elements.customLanguageInput.style.display = 'none';
                    }
                });
            });
        }
        
        // اختيار القيم الافتراضية
        function selectDefaultOptions() {
            // طريقة الشرح: طفولي
            elements.explanationStyle.querySelector(`[data-value="طفولي"]`).click();
            
            // اللهجة: مصري
            elements.dialect.querySelector(`[data-value="مصري"]`).click();
            
            // الشخص الشارح: طالب
            elements.explainer.querySelector(`[data-value="طالب"]`).click();
            
            // لغة الإخراج: عربي
            elements.outputLanguage.querySelector(`[data-value="عربي"]`).click();
        }
        
        // التعامل مع رفع الملف
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // التحقق من نوع الملف
            if (!file.type.includes('pdf')) {
                alert('⚠️ يرجى رفع ملف PDF فقط');
                return;
            }
            
            // التحقق من حجم الملف (20MB كحد أقصى)
            if (file.size > 20 * 1024 * 1024) {
                alert('⚠️ حجم الملف كبير جداً. الحد الأقصى 20MB');
                return;
            }
            
            currentFile = file;
            
            // إظهار شاشة التحميل
            showLoading('جاري تحليل الملف...');
            
            try {
                // حساب عدد الصفحات والكلمات
                await analyzePDF(file);
                
                // حساب التكلفة
                calculateCost();
                
                // عرض معلومات الملف
                displayFileInfo();
                
                // التحقق من الرصيد الكافي
                if (userCoins >= fileInfo.coins) {
                    elements.continueBtn.disabled = false;
                } else {
                    alert('⚠️ رصيدك غير كافي لإتمام العملية. يرجى شحن رصيدك.');
                    elements.continueBtn.disabled = true;
                }
                
            } catch (error) {
                console.error('خطأ في تحليل الملف:', error);
                alert('❌ حدث خطأ في تحليل الملف. يرجى التأكد من صحة الملف وإعادة المحاولة.');
            } finally {
                hideLoading();
            }
        }
        
        // تحليل PDF باستخدام pdf.js (من محلل.html)
        async function analyzePDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const buffer = e.target.result;
                        const typedarray = new Uint8Array(buffer);
                        
                        // تحميل PDF باستخدام pdf.js
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 
                            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        
                        let totalWords = 0;
                        
                        // حساب عدد الكلمات في كل صفحة
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            
                            if (content.items.length > 0) {
                                let text = '';
                                content.items.forEach(t => text += t.str + ' ');
                                const words = text.trim().split(/\s+/).filter(w => w.length >= 2);
                                totalWords += words.length;
                            } else {
                                // إذا كانت الصفحة فارغة أو لا تحتوي على نص
                                totalWords += 250; // تقدير افتراضي
                            }
                        }
                        
                        // حفظ المعلومات
                        fileInfo = {
                            name: file.name,
                            size: file.size,
                            pages: pdf.numPages,
                            words: totalWords,
                            coins: 0
                        };
                        
                        // تحديد عدد الصفحات الأقصى للسلايدر
                        const maxPages = Math.min(pdf.numPages, 25);
                        elements.pagesSlider.max = maxPages;
                        summarySettings.pages = Math.min(summarySettings.pages, maxPages);
                        elements.pagesSlider.value = summarySettings.pages;
                        updatePagesSlider();
                        
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // حساب التكلفة (نفس نظام محلل.html)
        function calculateCost() {
            // حساب العملات بناءً على عدد الكلمات
            let coins = Math.ceil((fileInfo.words / 1000) * 2) / 2;
            if (coins < 1) coins = 1;
            
            fileInfo.coins = coins;
        }
        
        // عرض معلومات الملف
        function displayFileInfo() {
            elements.fileName.textContent = fileInfo.name;
            elements.fileSize.textContent = formatFileSize(fileInfo.size);
            elements.pageCount.textContent = fileInfo.pages;
            elements.wordCount.textContent = fileInfo.words.toLocaleString();
            elements.coinsCost.textContent = fileInfo.coins;
            elements.currentCoins.textContent = userCoins;
            
            elements.fileInfo.classList.add('show');
        }
        
        // تنسيق حجم الملف
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // إعادة تعيين رفع الملف
        function resetUpload() {
            currentFile = null;
            fileInfo = {
                name: '',
                size: 0,
                pages: 0,
                words: 0,
                coins: 0
            };
            
            elements.pdfFile.value = '';
            elements.fileInfo.classList.remove('show');
            elements.continueBtn.disabled = true;
        }
        
        // عرض قسم الإعدادات
        function showSettingsSection() {
            elements.uploadSection.style.display = 'none';
            elements.settingsSection.classList.add('show');
            elements.resultSection.classList.remove('show');
        }
        
        // العودة من قسم الإعدادات
        function cancelSettings() {
            elements.settingsSection.classList.remove('show');
            elements.uploadSection.style.display = 'block';
        }
        
        // توليد التلخيص
        async function generateSummary() {
            try {
                // جمع الإعدادات
                summarySettings.comment = elements.comment.value;
                if (summarySettings.outputLanguage === 'custom') {
                    summarySettings.customLanguage = elements.customLanguage.value.trim();
                    if (!summarySettings.customLanguage) {
                        alert('⚠️ يرجى إدخال اللغة المخصصة');
                        return;
                    }
                }
                
                // التحقق من الرصيد الكافي
                if (userCoins < fileInfo.coins) {
                    alert('⚠️ رصيدك غير كافي لإتمام العملية. يرجى شحن رصيدك.');
                    return;
                }
                
                // إظهار شاشة التحميل
                showLoading('جاري إنشاء التلخيص...');
                
                // تحويل PDF إلى Base64 (نفس نظام تجربه.html)
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(currentFile);
                });
                
                // إنشاء البرومت
                const prompt = createPrompt();
                
                // إعداد بيانات الإرسال
                const requestData = {
                    id: "12345",
                    pass: "12345abcde57",
                    data: prompt,
                    PDF_BASE64: base64
                };
                
                // إرسال الطلب للسيرفر
                const SERVER = 'https://wet-aidan-kimon-66eadaf6.koyeb.app';
                const response = await fetch(SERVER + '/api/KIMO_DEV', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`خطأ في السيرفر: ${response.status}`);
                }
                
                const resultText = await response.text();
                console.log('النتيجة من السيرفر:', resultText);
                
                let result;
                try {
                    result = JSON.parse(resultText);
                } catch (e) {
                    throw new Error('❌ النتيجة ليست بصيغة JSON صحيحة');
                }
                
                // التحقق من وجود خطأ
                if (result.Eror) {
                    throw new Error(result.Eror);
                }
                
                // خصم العملات من رصيد المستخدم
                await deductCoins();
                
                // حفظ النتيجة في Firebase
                await saveResultToFirebase(result);
                
                // عرض النتيجة
                summaryResult = result;
                displaySummaryResult();
                
            } catch (error) {
                console.error('خطأ في إنشاء التلخيص:', error);
                alert(`❌ حدث خطأ: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // إنشاء البرومت (بناءً على الإعدادات)
        function createPrompt() {
            const { pages, explanationStyle, dialect, explainer, outputLanguage, customLanguage, comment } = summarySettings;
            
            let languageOutput = outputLanguage;
            if (outputLanguage === 'custom' && customLanguage) {
                languageOutput = customLanguage;
            }
            
            return `SYSTEM MODE: STRICT CONTROLLED EXECUTION ENGINE

أنت محرك تنفيذ مهام وتحليل مستندات فقط وليس مساعد محادثة. تقوم بتنفيذ الطلب مباشرة بدون أي مقدمات أو تعليقات أو شرح خارج المطلوب.

عند استلام ملف PDF يجب تنفيذ المراحل التالية بالترتيب الإجباري:

أولاً: تحليل الملف بالكامل من البداية للنهاية لفهم المحتوى العام والأفكار الرئيسية والتفاصيل المهمة بدون تخطي أي جزء.

ثانياً: تحديد اللغة الأساسية المستخدمة داخل الملف.

ثالثاً: تنفيذ عملية التلخيص الاحترافي بناءً على المدخلات التالية مع الالتزام الكامل بها.

يجب عليك إنشاء تلخيص احترافي عالي الجودة يلتزم التزامًا صارمًا بكل المدخلات التي سيضعها المستخدم. يجب أن يكون عدد الصفحات الناتج مساويًا تمامًا للقيمة المحددة هنا {{عدد_الصفحات=${pages}}} ويمنع منعًا باتًا زيادة أو تقليل عدد الصفحات عن هذا الرقم.

يجب أن تكون لغة التلخيص والتحويل النهائي للناتج مطابقة تمامًا للغة التالية {{لغة_الإخراج=${languageOutput}}}.  

إذا كانت القيمة تشير إلى استخدام نفس لغة الملف فيجب الالتزام باللغة التي تم اكتشافها داخل الملف.

يجب أن يكون أسلوب الشرح والتلخيص مطابقًا تمامًا للطريقة التالية {{طريقة_الشرح=${explanationStyle}}} ويجب أن ينعكس هذا الأسلوب بوضوح داخل طريقة عرض المعلومات.

يجب أن يتم تقديم التلخيص باستخدام اللهجة التالية {{اللهجة_المفضلة=${dialect}}} ويجب الالتزام بهذه اللهجة طوال التلخيص بالكامل دون تغيير.

يجب أن يتم تقديم التلخيص وكأنه صادر من شخصية {{الشخص_الشارح=${explainer}}} ويجب أن يظهر أسلوب التفكير وطريقة عرض المعلومات بما يتناسب مع هذه الشخصية.

يجب مراعاة التعليق التالي إن وُجد ودمجه داخل أسلوب التلخيص بدون الإشارة إليه بشكل مباشر {{تعليق_اختياري=${comment || "لا يوجد تعليق"}}}

--------------------------------------------

قواعد التنفيذ الصارمة:

- تحليل الملف كاملًا قبل بدء التلخيص
- الالتزام الكامل بجميع المدخلات بدون أي تعديل أو تفسير إضافي
- استخراج أهم الأفكار والمعلومات الجوهرية فقط
- يمنع إضافة أي معلومات غير موجودة داخل الملف
- يمنع الافتراض أو التخمين
- يمنع تجاوز عدد الصفحات المحدد
- يجب تقسيم التلخيص إلى صفحات مساوية تمامًا لعدد الصفحات المحدد
- كل صفحة يجب أن تحتوي فقط على محتوى خاص بها
- يجب أن يكون النص النهائي بالكامل مكتوب بلغة {{لغة_الإخراج}}

--------------------------------------------

OUTPUT FORMAT (HARD LOCK JSON STRUCTURE):

يجب أن يكون الإخراج بصيغة JSON فقط وبدون أي نص خارج الجيسون.

يجب إنشاء عنصر لكل صفحة باستخدام نفس عدد الصفحات المدخل من المستخدم.

هيكل كل صفحة يجب أن يكون كالتالي:

pageX:
dec : النص الملخص الخاص بالصفحة
rew : القوانين أو القواعد المذكورة داخل نفس محتوى الصفحة إذا كانت موجودة، وإذا لم تكن موجودة تترك فارغة ""

حيث X يمثل رقم الصفحة ويجب أن يبدأ من 1 وحتى {{عدد_الصفحات}} بدون نقصان أو زيادة.

--------------------------------------------

قواعد الجيسون:

- يمنع إضافة أي مفاتيح إضافية
- يمنع تغيير أسماء الحقول
- يمنع تغيير ترتيب الصفحات
- يجب أن يكون عدد الصفحات داخل الجيسون مطابق تمامًا لعدد الصفحات المدخل
- يمنع إضافة شروحات أو تعليقات خارج الجيسون

--------------------------------------------

سياسة الخطأ:

إذا كان الملف فارغ أو تالف أو غير قابل للقراءة أو حدث فشل في استخراج المحتوى يجب أن يكون الإخراج فقط بالشكل التالي:

{
"page": 1,
"dec": "No Output",
"raw": ""
}`;
        }
        
        // خصم العملات من رصيد المستخدم
        async function deductCoins() {
            try {
                const newCoins = userCoins - fileInfo.coins;
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(newCoins);
                userCoins = newCoins;
                elements.coinsCount.textContent = userCoins;
            } catch (error) {
                console.error('خطأ في خصم العملات:', error);
                throw error;
            }
        }
        
        // حفظ النتيجة في Firebase
        async function saveResultToFirebase(result) {
            try {
                const recordId = Date.now().toString();
                const recordData = {
                    id: currentUser.id,
                    process: 'ملخص',
                    data: result,
                    pages: summarySettings.pages,
                    timestamp: Date.now(),
                    fileName: fileInfo.name,
                    coinsUsed: fileInfo.coins
                };
                
                await database.ref(`records/${recordId}`).set(recordData);
            } catch (error) {
                console.error('خطأ في حفظ النتيجة:', error);
                throw error;
            }
        }
        
        // عرض نتائج التلخيص
        function displaySummaryResult() {
            elements.settingsSection.classList.remove('show');
            elements.resultSection.classList.add('show');
            elements.fontControls.style.display = 'flex';
            
            // مسح المحتوى القديم
            elements.pagesContainer.innerHTML = '';
            
            // إنشاء صفحة لكل نتيجة
            if (Array.isArray(summaryResult)) {
                // إذا كانت النتيجة مصفوفة
                summaryResult.forEach((page, index) => {
                    createResultPage(index + 1, page.dec || '', page.rew || '');
                });
            } else if (typeof summaryResult === 'object') {
                // إذا كانت النتيجة كائن (للنسخ القديم)
                Object.keys(summaryResult).forEach(key => {
                    const page = summaryResult[key];
                    const pageNumber = parseInt(key.replace('page', ''));
                    createResultPage(pageNumber, page.dec || '', page.rew || '');
                });
            }
        }
        
        // إنشاء صفحة نتيجة
        function createResultPage(pageNumber, content, laws) {
            const pageElement = document.createElement('div');
            pageElement.className = 'result-page';
            
            const lawsSection = laws && laws.trim() !== '' ? 
                `<div class="laws-section show">
                    <div class="laws-title">
                        <i class="fas fa-gavel"></i>
                        القوانين والقواعد
                    </div>
                    <div class="laws-content">${laws}</div>
                </div>` : '';
            
            pageElement.innerHTML = `
                <div class="page-header">
                    <div class="page-number">
                        <i class="fas fa-file-alt"></i>
                        الصفحة ${pageNumber}
                        <span class="page-badge">ملخص</span>
                    </div>
                </div>
                <div class="page-content">${content}</div>
                ${lawsSection}
            `;
            
            elements.pagesContainer.appendChild(pageElement);
        }
        
        // إعادة التعيين للبدء من جديد
        function resetToUpload() {
            resetUpload();
            elements.settingsSection.classList.remove('show');
            elements.resultSection.classList.remove('show');
            elements.uploadSection.style.display = 'block';
            elements.fontControls.style.display = 'none';
            
            // إعادة تعيين الإعدادات
            selectDefaultOptions();
            elements.comment.value = '';
            elements.customLanguage.value = '';
        }
        
        // التحكم بحجم الخط
        function decreaseFontSize() {
            if (document.body.classList.contains('font-large')) {
                document.body.classList.remove('font-large');
                document.body.classList.add('font-small');
            } else if (document.body.classList.contains('font-xlarge')) {
                document.body.classList.remove('font-xlarge');
                document.body.classList.add('font-large');
            } else {
                document.body.classList.add('font-small');
            }
        }
        
        function increaseFontSize() {
            if (document.body.classList.contains('font-small')) {
                document.body.classList.remove('font-small');
            } else if (document.body.classList.contains('font-large')) {
                document.body.classList.remove('font-large');
                document.body.classList.add('font-xlarge');
            } else {
                document.body.classList.add('font-large');
            }
        }
        
        // إظهار شاشة التحميل
        function showLoading(text) {
            elements.loadingText.textContent = text;
            elements.loadingScreen.style.display = 'flex';
            elements.loadingScreen.style.opacity = '1';
        }
        
        // إخفاء شاشة التحميل
        function hideLoading() {
            elements.loadingScreen.style.opacity = '0';
            setTimeout(() => {
                elements.loadingScreen.style.display = 'none';
            }, 500);
        }
        
        // إخفاء شاشة التحميل الأولى
        function hideLoadingScreen() {
            setTimeout(() => {
                elements.loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    elements.loadingScreen.style.display = 'none';
                    elements.navbar.style.display = 'flex';
                    elements.mainContent.style.display = 'block';
                }, 500);
            }, 500);
        }
        
        // بدء التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initApp);
        
        // منع العودة للخلف
        history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function() {
            history.pushState(null, null, window.location.href);
        });
    </script>
</body>
</html>
