<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ø¹ÙˆÙ† - Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ */
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        :root {
            --bg-color:#F5F1E8; --card-color:#FFFFFF; --text-primary:#2D3748; --text-secondary:#718096;
            --accent-primary:#8B7355; --accent-secondary:#A9927D; --accent-dark:#5D4037; --border-color:#D4A574;
            --border-radius:16px; --border-radius-lg:20px; --border-radius-xl:24px; --navbar-height:70px;
            --transition-smooth:all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            --success-color:#4CAF50; --error-color:#F44336; --info-color:#2196F3;
            --gradient-primary:linear-gradient(145deg, #8B7355 0%, #A9927D 100%);
            --gradient-success:linear-gradient(145deg, #4CAF50 0%, #45a049 100%);
            --gradient-error:linear-gradient(145deg, #F44336 0%, #d32f2f 100%);
            --gradient-info:linear-gradient(145deg, #2196F3 0%, #1976D2 100%);
            --shadow-light:0 4px 12px rgba(139,115,85,0.1);
            --shadow-medium:0 8px 24px rgba(139,115,85,0.15);
            --shadow-heavy:0 12px 36px rgba(139,115,85,0.2);
        }
        body {
            font-family:'Almarai','Tajawal',sans-serif; background:var(--bg-color); color:var(--text-primary);
            min-height:100vh; direction:rtl; overflow-x:hidden; padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            display:flex; flex-direction:column; align-items:center;
        }
        .loading-screen {
            position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg-color);
            display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:99999;
            transition:opacity 0.5s;
        }
        .loading-logo { font-weight:800; font-size:56px; color:var(--accent-primary); margin-bottom:25px; animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1); opacity:1;} 50%{transform:scale(1.05); opacity:0.8;} }
        .loading-spinner {
            width:70px; height:70px; border:5px solid rgba(139,115,85,0.1); border-left-color:var(--accent-primary);
            border-right-color:var(--accent-secondary); border-radius:50%; animation:spin 1.2s infinite; margin-bottom:30px;
        }
        @keyframes spin { to { transform:rotate(360deg); } }
        .loading-text { font-family:'Tajawal'; color:var(--text-primary); font-size:1.3rem; text-align:center; background:rgba(139,115,85,0.1); padding:15px 30px; border-radius:50px; backdrop-filter:blur(10px); }
        
        /* Navbar */
        .native-navbar {
            position:fixed; top:0; left:0; right:0; height:var(--navbar-height); background:rgba(245,241,232,0.9);
            backdrop-filter:blur(25px); display:flex; align-items:center; justify-content:space-between;
            padding:0 max(25px, env(safe-area-inset-right)); z-index:10000; border-bottom:1px solid rgba(139,115,85,0.15);
            box-shadow:var(--shadow-light); padding-top:env(safe-area-inset-top);
        }
        .logo { font-weight:900; font-size:42px; color:var(--accent-primary); cursor:pointer; transition:0.1s; }
        .logo:active { transform:scale(0.95); }
        .nav-left { display:flex; align-items:center; gap:18px; }
        .records-btn {
            background:rgba(139,115,85,0.15); color:var(--accent-primary); padding:12px 22px; border-radius:var(--border-radius-lg);
            font-weight:700; font-size:15px; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow-light);
            transition:0.1s; cursor:pointer; border:1px solid rgba(139,115,85,0.2);
        }
        .records-btn:active { transform:scale(0.95); background:rgba(139,115,85,0.3); }
        .records-btn i { font-size:16px; }
        .coins-display {
            background:var(--gradient-primary); color:white; padding:12px 25px; border-radius:var(--border-radius-lg);
            font-weight:700; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow-light); transition:0.1s;
        }
        .coins-display:active { transform:scale(0.95); }
        
        /* Main Content */
        .main-content {
            padding-top:calc(var(--navbar-height) + 20px); padding-left:max(20px, env(safe-area-inset-left));
            padding-right:max(20px, env(safe-area-inset-right)); padding-bottom:50px; width:100%; max-width:1400px;
            margin:0 auto; display:flex; flex-direction:column; align-items:center;
        }
        
        /* Upload Section */
        .upload-section {
            background:white; border-radius:var(--border-radius-xl); padding:35px; margin-bottom:35px;
            box-shadow:var(--shadow-medium); text-align:center; border:1px solid rgba(139,115,85,0.12);
            width:100%; max-width:900px; animation:fadeInUp 0.6s;
        }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
        .section-title { font-size:clamp(1.8rem,4vw,2.2rem); font-weight:800; color:var(--accent-primary); margin-bottom:15px; }
        .section-subtitle { font-family:'Tajawal'; color:var(--text-secondary); font-size:clamp(1rem,2vw,1.1rem); margin-bottom:30px; }
        .upload-area {
            border:3px dashed var(--border-color); border-radius:var(--border-radius-xl); padding:min(50px,8vh) 25px;
            margin-bottom:30px; cursor:pointer; transition:0.1s; background:rgba(212,165,116,0.05);
        }
        .upload-area:active { transform:scale(0.99); border-color:var(--accent-primary); background:rgba(212,165,116,0.1); }
        .upload-icon { font-size:clamp(48px,8vw,56px); color:var(--accent-primary); margin-bottom:20px; animation:bounce 2s infinite; }
        @keyframes bounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .upload-text { font-family:'Tajawal'; font-size:clamp(1.1rem,3vw,1.3rem); color:var(--text-primary); margin-bottom:10px; }
        .upload-hint { font-family:'Tajawal'; color:var(--text-secondary); font-style:italic; }
        .cost-preview {
            background:rgba(139,115,85,0.06); border-radius:var(--border-radius-xl); padding:25px; margin-top:30px;
            border:1px solid rgba(139,115,85,0.12); display:none; animation:slideUp 0.4s;
        }
        .cost-preview.show { display:block; }
        .cost-title { font-size:1.4rem; font-weight:700; color:var(--accent-primary); margin-bottom:20px; }
        .cost-details { display:flex; justify-content:space-around; flex-wrap:wrap; gap:20px; margin-bottom:25px; }
        .cost-item { text-align:center; flex:1; min-width:160px; }
        .cost-label { font-family:'Tajawal'; color:var(--text-secondary); margin-bottom:8px; }
        .cost-value { font-size:1.5rem; font-weight:800; color:var(--accent-primary); }
        .cost-actions { display:flex; gap:15px; justify-content:center; flex-wrap:wrap; }
        .action-btn {
            padding:16px 32px; border:none; border-radius:var(--border-radius); font-family:'Almarai'; font-size:1rem;
            font-weight:700; cursor:pointer; transition:0.1s; min-width:160px; display:flex; align-items:center; gap:10px;
            box-shadow:var(--shadow-light);
        }
        .action-btn:active { transform:scale(0.95); }
        .confirm-btn { background:var(--gradient-success); color:white; }
        .cancel-btn { background:var(--gradient-error); color:white; }
        
        /* Settings Section (Ù…Ù‚Ø§Ù„ÙŠ) */
        .settings-section {
            background:white; border-radius:var(--border-radius-xl); padding:35px; margin-bottom:35px;
            box-shadow:var(--shadow-medium); border:1px solid rgba(139,115,85,0.12); display:none;
            animation:slideUp 0.4s; width:100%; max-width:900px;
        }
        .settings-section.show { display:block; }
        .settings-grid {
            display:grid; grid-template-columns:repeat(auto-fit, minmax(300px,1fr)); gap:30px; margin-bottom:35px;
        }
        .setting-group {
            background:rgba(139,115,85,0.04); border-radius:var(--border-radius-xl); padding:25px;
            border:1px solid rgba(139,115,85,0.12);
        }
        .setting-title {
            font-size:1.3rem; font-weight:700; color:var(--accent-primary); margin-bottom:15px; display:flex; align-items:center; gap:10px;
        }
        .slider-container { padding:20px 0; }
        .slider-value { font-size:2.5rem; font-weight:800; color:var(--accent-primary); text-align:center; margin-bottom:10px; }
        .slider-labels { display:flex; justify-content:space-between; font-family:'Tajawal'; color:var(--text-secondary); margin-bottom:5px; }
        .slider {
            width:100%; height:25px; -webkit-appearance:none; background:linear-gradient(to right, var(--accent-secondary), var(--accent-primary));
            outline:none; border-radius:12px;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance:none; width:38px; height:38px; border-radius:var(--border-radius); background:var(--accent-primary);
            cursor:pointer; box-shadow:var(--shadow-medium); border:4px solid white;
        }
        .extra-cost { text-align:center; color:var(--text-secondary); margin-top:15px; }
        .extra-cost span { color:var(--success-color); font-weight:700; }
        
        .options-grid {
            display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:20px;
        }
        .option-btn {
            padding:14px 16px; border:2px solid rgba(139,115,85,0.25); border-radius:var(--border-radius);
            background:white; font-family:'Tajawal'; cursor:pointer; transition:0.1s; text-align:center;
        }
        .option-btn:active { transform:scale(0.95); }
        .option-btn.selected { background:var(--gradient-primary); color:white; border-color:var(--accent-primary); }
        
        .total-cost-box {
            text-align:center; padding:20px; background:rgba(139,115,85,0.04); border-radius:var(--border-radius-xl);
            margin:25px 0;
        }
        .total-cost-label { font-family:'Tajawal'; color:var(--text-secondary); margin-bottom:5px; }
        .total-cost-number { font-size:2.5rem; font-weight:900; color:var(--accent-primary); }
        .generate-btn {
            background:var(--gradient-primary); color:white; border:none; border-radius:var(--border-radius);
            padding:18px 45px; font-family:'Almarai'; font-size:1.2rem; font-weight:700; cursor:pointer;
            transition:0.1s; display:block; margin:0 auto; min-width:280px; display:flex; align-items:center; justify-content:center; gap:12px;
            box-shadow:var(--shadow-medium);
        }
        .generate-btn:active:not(:disabled) { transform:scale(0.95); }
        .generate-btn:disabled { opacity:0.6; cursor:not-allowed; }
        
        /* Questions Display Section (Ù…Ù‚Ø§Ù„ÙŠ) */
        .essay-section {
            background:white; border-radius:var(--border-radius-xl); padding:35px; margin-bottom:35px;
            box-shadow:var(--shadow-heavy); border:1px solid rgba(139,115,85,0.12); display:none;
            animation:slideUp 0.4s; width:100%; max-width:900px;
        }
        .essay-section.show { display:block; }
        .essay-header {
            display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap; gap:15px;
        }
        .essay-header h2 { font-size:1.8rem; font-weight:800; color:var(--accent-primary); }
        .essay-info { background:rgba(139,115,85,0.08); padding:10px 20px; border-radius:var(--border-radius); }
        
        .question-progress {
            display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;
        }
        .q-counter { font-size:1.2rem; color:var(--text-secondary); }
        .q-counter span { color:var(--accent-primary); font-weight:800; font-size:1.6rem; margin:0 5px; }
        
        .question-box {
            background:rgba(139,115,85,0.04); border-radius:var(--border-radius-xl); padding:30px; margin-bottom:25px;
            border:1px solid rgba(139,115,85,0.15);
        }
        .question-text {
            font-family:'Tajawal'; font-size:1.3rem; line-height:2; color:var(--text-primary);
            padding:20px; background:white; border-radius:var(--border-radius); margin-bottom:20px;
        }
        .answer-label {
            font-family:'Almarai'; font-weight:700; color:var(--accent-primary); margin-bottom:10px; display:flex; align-items:center; gap:8px;
        }
        .answer-textarea {
            width:100%; min-height:200px; padding:20px; border:2px solid rgba(139,115,85,0.2); border-radius:var(--border-radius-xl);
            font-family:'Tajawal'; font-size:1.1rem; line-height:1.8; resize:vertical; background:white; transition:0.1s;
        }
        .answer-textarea:focus { outline:none; border-color:var(--accent-primary); box-shadow:var(--shadow-light); }
        
        .navigation-buttons {
            display:flex; justify-content:space-between; gap:15px; margin:30px 0;
        }
        .nav-btn {
            padding:15px 30px; border:none; border-radius:var(--border-radius); font-family:'Almarai'; font-weight:700;
            cursor:pointer; transition:0.1s; min-width:140px; display:flex; align-items:center; justify-content:center; gap:8px;
            background:var(--gradient-primary); color:white; box-shadow:var(--shadow-light);
        }
        .nav-btn:active:not(:disabled) { transform:scale(0.95); }
        .nav-btn:disabled { opacity:0.4; cursor:not-allowed; }
        
        .submit-final-btn {
            background:var(--gradient-success); color:white; border:none; border-radius:var(--border-radius);
            padding:20px 50px; font-family:'Almarai'; font-size:1.3rem; font-weight:700; cursor:pointer;
            transition:0.1s; display:block; margin:40px auto 20px; min-width:320px; display:flex; align-items:center; justify-content:center; gap:15px;
            box-shadow:var(--shadow-medium);
        }
        .submit-final-btn:active:not(:disabled) { transform:scale(0.95); }
        .submit-final-btn:disabled { opacity:0.5; cursor:not-allowed; }
        
        /* Evaluation Section */
        .evaluation-section {
            background:white; border-radius:var(--border-radius-xl); padding:35px; margin-bottom:35px;
            box-shadow:var(--shadow-heavy); border:1px solid rgba(139,115,85,0.12); display:none;
            animation:slideUp 0.4s; width:100%; max-width:1200px;
        }
        .evaluation-section.show { display:block; }
        .eval-header { display:flex; justify-content:space-between; margin-bottom:40px; flex-wrap:wrap; }
        .eval-card {
            background:rgba(139,115,85,0.03); border-radius:var(--border-radius-xl); padding:25px; margin-bottom:25px;
            border-right:8px solid var(--accent-primary);
        }
        .eval-question { font-weight:700; font-size:1.2rem; margin-bottom:20px; }
        .eval-model { background:rgba(33,150,243,0.1); padding:20px; border-radius:var(--border-radius); margin-bottom:15px; }
        .eval-model-title { color:var(--info-color); font-weight:700; margin-bottom:5px; display:flex; align-items:center; gap:8px; }
        .eval-percent { font-size:1.8rem; font-weight:800; color:var(--success-color); margin:15px 0; }
        .eval-advice { background:rgba(255,193,7,0.1); padding:15px; border-radius:var(--border-radius); border-right:5px solid #ffc107; }
        .footer { text-align:center; padding:45px 20px; color:var(--text-secondary); border-top:1px solid rgba(139,115,85,0.12); width:100%; max-width:900px; }
        .footer.hidden { display:none; }
        
        /* Records Modal (Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù€ Question.html) */
        .records-modal {
            position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.75); display:flex; align-items:center; justify-content:center;
            z-index:10002; opacity:0; visibility:hidden; transition:0.2s; backdrop-filter:blur(10px); padding:20px;
        }
        .records-modal.show { opacity:1; visibility:visible; }
        .records-content {
            background:white; border-radius:var(--border-radius-xl); width:min(900px,95vw); max-height:min(85vh,90vh);
            overflow-y:auto; position:relative; box-shadow:var(--shadow-heavy); animation:modalAppear 0.2s;
        }
        @keyframes modalAppear { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
        .records-header {
            display:flex; justify-content:space-between; align-items:center; padding:20px 25px; border-bottom:2px solid rgba(139,115,85,0.15);
            background:white; position:sticky; top:0; z-index:10;
        }
        .records-header h2 { font-size:1.6rem; font-weight:800; color:var(--accent-primary); display:flex; align-items:center; gap:10px; }
        .close-records-btn { background:none; border:none; font-size:1.8rem; color:var(--text-secondary); cursor:pointer; transition:0.1s; width:48px; height:48px; border-radius:var(--border-radius); }
        .close-records-btn:active { transform:scale(0.9); background:rgba(139,115,85,0.1); }
        .records-list { padding:25px; }
        .no-records { text-align:center; padding:60px 20px; font-family:'Tajawal'; color:var(--text-secondary); font-size:1.2rem; }
        .record-card {
            background:rgba(139,115,85,0.04); border-radius:var(--border-radius-xl); padding:20px; margin-bottom:15px;
            border:1px solid rgba(139,115,85,0.1); cursor:pointer; transition:0.1s;
        }
        .record-card:active { transform:scale(0.98); background:rgba(139,115,85,0.08); }
        .notification {
            position:fixed; top:calc(var(--navbar-height)+20px); right:max(20px,env(safe-area-inset-right)); background:white;
            border-radius:var(--border-radius); padding:20px; box-shadow:var(--shadow-heavy); z-index:10001;
            min-width:320px; transform:translateX(120%); transition:0.3s;
        }
        .notification.show { transform:translateX(0); }
        .notification.success { border-right:5px solid var(--success-color); }
        .notification.error { border-right:5px solid var(--error-color); }
        .notification-content { display:flex; align-items:center; gap:15px; }
        .developer-credit { font-size:0.95rem; color:rgba(100,116,139,0.6); margin-top:25px; padding-top:25px; border-top:1px solid rgba(139,115,85,0.06); cursor:pointer; transition:0.1s; }
        .developer-credit:active { transform:scale(0.98); color:var(--accent-primary); }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen" style="display:none;">
        <div class="loading-logo">Ø¹ÙˆÙ†</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon"><i class="fas fa-info-circle"></i></div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>
    
    <!-- Records Modal -->
    <div class="records-modal" id="records-modal">
        <div class="records-content">
            <div class="records-header">
                <h2><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©</h2>
                <button class="close-records-btn" id="close-records-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="records-list" id="records-list">
                <div class="no-records" id="no-records" style="display:none;"><i class="fas fa-folder-open"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>
            </div>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="native-navbar" id="navbar">
        <div class="logo" id="home-logo">Ø¹ÙˆÙ†</div>
        <div class="nav-left">
            <div class="records-btn" id="records-btn"><i class="fas fa-history"></i><span>Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span></div>
            <div class="coins-display"><i class="fas fa-coins"></i><span id="coins-count">0</span></div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <h1 class="section-title">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©</h1>
            <p class="section-subtitle">Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚Ø§Ù„ÙŠØ© Ù…Ø®ØµØµØ©</p>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon"><i class="fas fa-file-pdf"></i></div>
                <div class="upload-text" id="upload-text">Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ Ù…Ù„Ù PDF</div>
                <div class="upload-hint">Ø£Ùˆ Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</div>
            </div>
            <input type="file" id="pdfFile" accept=".pdf" style="display:none;">
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ù</h3>
                <div class="cost-details">
                    <div class="cost-item"><div class="cost-label">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª</div><div class="cost-value" id="page-count">0</div></div>
                    <div class="cost-item"><div class="cost-label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div><div class="cost-value" id="cost-amount">0 Ø¹Ù…Ù„Ø©</div></div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" id="cancel-btn"><i class="fas fa-times"></i>Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="action-btn confirm-btn" id="confirm-btn"><i class="fas fa-check"></i>Ù…ØªØ§Ø¨Ø¹Ø©</button>
                </div>
            </div>
        </section>
        
        <!-- Settings Section (Ù…Ù‚Ø§Ù„ÙŠ) -->
        <section class="settings-section" id="settings-section">
            <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©</h2>
            <p class="section-subtitle">Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</p>
            <div class="settings-grid">
                <!-- Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
                <div class="setting-group">
                    <h3 class="setting-title"><i class="fas fa-sort-numeric-up"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                    <div class="slider-container">
                        <div class="slider-value" id="questions-count">8</div>
                        <div class="slider-labels"><span>5</span><span>40</span></div>
                        <input type="range" min="5" max="40" value="8" class="slider" id="questions-slider">
                        <div class="extra-cost" id="extra-cost-display">ØªÙƒÙ„ÙØ© Ø¥Ø¶Ø§ÙÙŠØ©: <span id="extra-cost">0</span> Ø¹Ù…Ù„Ø©</div>
                    </div>
                </div>
                <!-- Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø© -->
                <div class="setting-group">
                    <h3 class="setting-title"><i class="fas fa-chart-line"></i> Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</h3>
                    <div class="options-grid" id="difficulty-level">
                        <button class="option-btn selected" data-value="Ø³Ù‡Ù„">Ø³Ù‡Ù„</button>
                        <button class="option-btn" data-value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</button>
                        <button class="option-btn" data-value="ØµØ¹Ø¨">ØµØ¹Ø¨</button>
                    </div>
                </div>
                <!-- Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
                <div class="setting-group">
                    <h3 class="setting-title"><i class="fas fa-coins"></i> Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
                    <div class="total-cost-box">
                        <div class="total-cost-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                        <div class="total-cost-number" id="total-cost-display">0</div>
                        <div style="font-size:1rem;">Ø¹Ù…Ù„Ø©</div>
                    </div>
                </div>
            </div>
            <button class="generate-btn" id="generate-btn"><i class="fas fa-robot"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
        </section>
        
        <!-- Essay Questions Section -->
        <section class="essay-section" id="essay-section">
            <div class="essay-header">
                <h2><i class="fas fa-pen-fancy"></i> Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©</h2>
                <div class="essay-info" id="essay-info">Ø§Ù„ØµØ¹ÙˆØ¨Ø©: <span id="display-difficulty">Ø³Ù‡Ù„</span></div>
            </div>
            <div class="question-progress">
                <div class="q-counter">Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="current-q-num">1</span> / <span id="total-q-num">8</span></div>
                <div class="progress-bar-container" style="width:70%; height:8px; background:#eee; border-radius:4px;">
                    <div class="progress-bar-fill" id="progress-fill" style="width:0%; height:100%; background:var(--gradient-primary); border-radius:4px;"></div>
                </div>
            </div>
            <div class="question-box">
                <div class="question-text" id="question-text">...</div>
                <div class="answer-label"><i class="fas fa-edit"></i> Ø¥Ø¬Ø§Ø¨ØªÙƒ:</div>
                <textarea class="answer-textarea" id="answer-textarea" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            </div>
            <div class="navigation-buttons">
                <button class="nav-btn" id="prev-btn" disabled><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button class="nav-btn" id="next-btn">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
            </div>
            <button class="submit-final-btn" id="submit-final-btn" disabled><i class="fas fa-check-double"></i> ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
        </section>
        
        <!-- Evaluation Section -->
        <section class="evaluation-section" id="evaluation-section">
            <h2 class="section-title">Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>
            <div id="evaluation-container"></div>
        </section>
        
        <!-- Footer -->
        <footer class="footer" id="footer">
            <p class="copyright">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…Ù†ØµØ© Ø¹ÙˆÙ† Â© 2026</p>
            <div class="support-section">
                <div class="support-title">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</div>
                <div class="support-links">
                    <a href="https://wa.me/966583617539" target="_blank" class="support-link"><i class="fab fa-whatsapp"></i></a>
                    <a href="https://t.me/HNHv1" target="_blank" class="support-link"><i class="fab fa-telegram"></i></a>
                </div>
            </div>
            <div class="developer-credit">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø·ÙˆØ± ğŠğˆğŒğ</div>
        </footer>
    </div>
    
    <script>
        // ØªÙ‡ÙŠØ¦Ø© PDF.js Ùˆ Firebase
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let fileInfo = { name:'', pages:0, baseCost:0 }; // baseCost Ø«Ø§Ø¨Øª 5 Ø¹Ù…Ù„Ø§Øª ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø£Ùˆ Ù†Ø­Ø³Ø¨ Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø§Øª)
        let currentSettings = { questionsCount:8, difficulty:'Ø³Ù‡Ù„', extraCost:0, totalCost:0 };
        let essayQuestions = null; // { Q1: "Ø³Ø¤Ø§Ù„", Q2: ... }
        let userAnswers = []; // Ù†Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
        let currentQuestionIndex = 0;
        let currentRecordId = null;
        let evaluationData = null; // Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙ…Øª Ø§Ù„Ø«Ø§Ù†ÙŠ
        
        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";
        
        // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loadingMessages = ['Ø¹ÙˆÙ† ÙŠÙ‚Ø±Ø£ Ù…Ù„ÙÙƒ...','Ø¹ÙˆÙ† ÙŠÙÙƒØ± ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...','Ø¹ÙˆÙ† ÙŠØµÙŠØº Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©...','Ø¹ÙˆÙ† ÙŠØ±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...'];
        
        // ========== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
        function showNotification(message, type='info') {
            const notif = document.getElementById('notification');
            document.getElementById('notification-text').textContent = message;
            notif.className = 'notification';
            if(type==='success') { notif.classList.add('success'); document.getElementById('notification-icon').innerHTML='<i class="fas fa-check-circle"></i>'; }
            else if(type==='error') { notif.classList.add('error'); document.getElementById('notification-icon').innerHTML='<i class="fas fa-exclamation-circle"></i>'; }
            else { document.getElementById('notification-icon').innerHTML='<i class="fas fa-info-circle"></i>'; }
            notif.classList.add('show'); setTimeout(()=>notif.classList.remove('show'),3000);
        }
        function showLoading(text) { document.getElementById('loading-text').textContent=text; document.getElementById('loading-screen').style.display='flex'; setTimeout(()=>document.getElementById('loading-screen').style.opacity='1',10); }
        function hideLoading() { document.getElementById('loading-screen').style.opacity='0'; setTimeout(()=>document.getElementById('loading-screen').style.display='none',300); }
        function hideFooter() { document.getElementById('footer').classList.add('hidden'); }
        function showFooter() { document.getElementById('footer').classList.remove('hidden'); }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
        function calculateExtraCost(count) {
            if(count>=5 && count<=8) return 0;
            else if(count>=9 && count<=15) return 8;
            else if(count>=16 && count<=20) return 13;
            else if(count>=21 && count<=30) return 20;
            else if(count>=31 && count<=40) return 25;
            return 0;
        }
        function updateCost() {
            let count = parseInt(document.getElementById('questions-slider').value);
            document.getElementById('questions-count').textContent = count;
            let extra = calculateExtraCost(count);
            currentSettings.extraCost = extra;
            document.getElementById('extra-cost').textContent = extra;
            let total = (fileInfo.baseCost || 5) + extra; // baseCost Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù†Ø­ÙØ¸Ù‡ Ù…Ù† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù (Ø£Ùˆ 5 Ø§ÙØªØ±Ø§Ø¶ÙŠ)
            currentSettings.totalCost = total;
            document.getElementById('total-cost-display').textContent = total;
        }
        
        // ========== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
        async function loadUserData() {
            const user = auth.currentUser;
            if(!user) { window.location.replace('login.html'); return false; }
            const usersRef = database.ref('users_Awn');
            const snapshot = await usersRef.once('value');
            if(snapshot.exists()) {
                const users = snapshot.val();
                for(const [uid, data] of Object.entries(users)) {
                    if(uid!=='noty_publick' && data.email===user.email) {
                        currentUser = { id:uid, email:data.email, name:data.name||'', coin:data.coin||0, banned:data.banned||false };
                        userCoins = data.coin||0;
                        document.getElementById('coins-count').textContent = userCoins;
                        return true;
                    }
                }
            }
            await auth.signOut(); window.location.replace('login.html'); return false;
        }
        
        // ========== Ø±ÙØ¹ ÙˆØªØ­Ù„ÙŠÙ„ PDF ==========
        function setupFileUpload() {
            const pdfFile = document.getElementById('pdfFile');
            document.getElementById('upload-area').addEventListener('click', ()=>pdfFile.click());
            pdfFile.addEventListener('change', e => { if(e.target.files[0]) handleFile(e.target.files[0]); });
            document.getElementById('cancel-btn').addEventListener('click', ()=>{ document.getElementById('pdfFile').value=''; document.getElementById('upload-text').textContent='Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ Ù…Ù„Ù PDF'; document.getElementById('cost-preview').classList.remove('show'); selectedFile=null; });
            document.getElementById('confirm-btn').addEventListener('click', ()=>{
                if(!fileInfo.baseCost) { showNotification('Ø­Ù„Ù„ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹','error'); return; }
                if(userCoins < fileInfo.baseCost) { showNotification(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. ØªØ­ØªØ§Ø¬ ${fileInfo.baseCost} Ø¹Ù…Ù„Ø©`,'error'); return; }
                document.getElementById('upload-section').style.display='none';
                document.getElementById('settings-section').classList.add('show');
            });
        }
        async function handleFile(file) {
            if(!file.name.toLowerCase().endsWith('.pdf')) { showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ PDF ÙÙ‚Ø·','error'); return; }
            selectedFile = file;
            document.getElementById('upload-text').textContent = file.name;
            await analyzePDF(file);
        }
        async function analyzePDF(file) {
            showLoading('Ø¹ÙˆÙ† ÙŠØ­Ù„Ù„ Ø§Ù„Ù…Ù„Ù...');
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let totalWords = 0;
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    content.items.forEach(t => totalWords += t.str.split(/\s+/).length);
                }
                let coins = Math.ceil((totalWords/1000)*2)/2; if(coins<1) coins=1; coins = Math.round(coins*10)/10;
                fileInfo = { name:file.name, pages:pdf.numPages, baseCost:coins };
                document.getElementById('page-count').textContent = fileInfo.pages;
                document.getElementById('cost-amount').textContent = fileInfo.baseCost + ' Ø¹Ù…Ù„Ø©';
                document.getElementById('cost-preview').classList.add('show');
                updateCost(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©
                hideLoading(); showNotification('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù','success');
            } catch(e) { hideLoading(); showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù','error'); }
        }
        
        // ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ==========
        function setupSettingsEvents() {
            document.getElementById('questions-slider').addEventListener('input', updateCost);
            document.querySelectorAll('#difficulty-level .option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#difficulty-level .option-btn').forEach(b=>b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.difficulty = this.dataset.value;
                });
            });
            document.getElementById('generate-btn').addEventListener('click', generateEssayQuestions);
            updateCost();
        }
        
        // ========== Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ø£ÙˆÙ„) ==========
        function createPrompt1() {
            return `SYSTEM ROLE: STRICT PDF ESSAY QUESTION GENERATOR ENGINE
ZERO-DEVIATION MODE

You are a deterministic execution engine.
No chat. No explanation. No comments. No extra keys. No markdown. No text outside JSON.
Any deviation = INVALID OUTPUT.

----------------------------------
ACTIVATION CONDITIONS
----------------------------------
Execute ONLY if a readable PDF file is provided.
Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© = ${currentSettings.questionsCount}
Ù…Ø³ØªÙˆÙ‰_Ø§Ù„ØµØ¹ÙˆØ¨Ø© = ${currentSettings.difficulty}

----------------------------------
CORE DIRECTIVE
----------------------------------
1) Read the ENTIRE PDF.
2) Generate essay questions that collectively cover the FULL document.
3) Questions must not be concentrated in one section.
4) Do NOT repeat ideas.

----------------------------------
DIFFICULTY CONTROL
----------------------------------
${currentSettings.difficulty === 'Ø³Ù‡Ù„' ? 'Direct questions, clearly stated facts, no inference.' : 
  currentSettings.difficulty === 'Ù…ØªÙˆØ³Ø·' ? 'Direct but deeper, require understanding relationships.' : 
  'Inference-based, require synthesis between multiple sections, analytical reasoning.'}

----------------------------------
OUTPUT FORMAT (STRICT JSON ONLY)
----------------------------------
Return ONLY this structure:
{
  "Q1": "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„",
  "Q2": "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ",
  ...
}
Keys must increment sequentially until ${currentSettings.questionsCount}. No extra fields.`;
        }
        
        async function generateEssayQuestions() {
            if(!selectedFile) { showNotification('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','error'); return; }
            if(userCoins < currentSettings.totalCost) { showNotification(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ`,'error'); return; }
            
            document.getElementById('generate-btn').disabled = true;
            document.getElementById('generate-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
            try {
                showLoading('Ø¹ÙˆÙ† ÙŠØ­Ù„Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...');
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(selectedFile);
                });
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id:ID, pass:PASS, data:createPrompt1(), PDF_BASE64:base64 })
                });
                const text = await response.text();
                hideLoading();
                if(text.includes("INVALID") || text.includes("INSUFFICIENT")) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
                // ØªÙˆÙ‚Ø¹ JSON
                essayQuestions = JSON.parse(text);
                if(!essayQuestions || Object.keys(essayQuestions).length !== currentSettings.questionsCount) throw new Error('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚');
                
                // Ø®ØµÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Øª
                userCoins -= currentSettings.totalCost;
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(userCoins);
                document.getElementById('coins-count').textContent = userCoins;
                
                // ØªÙ‡ÙŠØ¦Ø© Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                userAnswers = new Array(currentSettings.questionsCount).fill('');
                currentQuestionIndex = 0;
                
                // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                document.getElementById('settings-section').classList.remove('show');
                document.getElementById('essay-section').classList.add('show');
                hideFooter();
                renderQuestion();
                
                // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
                await saveRecord('generated');
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­','success');
            } catch(e) {
                console.error(e);
                showNotification('Ø®Ø·Ø£: '+e.message,'error');
            } finally {
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('generate-btn').innerHTML = '<i class="fas fa-robot"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©';
            }
        }
        
        // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Firebase Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        function setupAutoSave() {
            const textarea = document.getElementById('answer-textarea');
            textarea.addEventListener('input', function() {
                if(!essayQuestions) return;
                userAnswers[currentQuestionIndex] = this.value;
                // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (real-time)
                if(currentRecordId) {
                    database.ref(`records/${currentRecordId}/userAnswers`).set(userAnswers);
                    database.ref(`records/${currentRecordId}/lastUpdate`).set(Date.now());
                }
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…
                checkAllAnswered();
            });
        }
        
        function checkAllAnswered() {
            const allAnswered = userAnswers.every(ans => ans.trim().length > 0);
            document.getElementById('submit-final-btn').disabled = !allAnswered;
        }
        
        function renderQuestion() {
            const qKey = `Q${currentQuestionIndex+1}`;
            document.getElementById('question-text').textContent = essayQuestions[qKey] || '';
            document.getElementById('answer-textarea').value = userAnswers[currentQuestionIndex] || '';
            document.getElementById('current-q-num').textContent = currentQuestionIndex+1;
            document.getElementById('total-q-num').textContent = currentSettings.questionsCount;
            document.getElementById('progress-fill').style.width = `${((currentQuestionIndex+1)/currentSettings.questionsCount)*100}%`;
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').disabled = currentQuestionIndex === currentSettings.questionsCount-1;
            document.getElementById('display-difficulty').textContent = currentSettings.difficulty;
        }
        
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
        document.getElementById('prev-btn').addEventListener('click', ()=>{
            if(currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(); }
        });
        document.getElementById('next-btn').addEventListener('click', ()=>{
            if(currentQuestionIndex < currentSettings.questionsCount-1) { currentQuestionIndex++; renderQuestion(); }
        });
        
        // ========== ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ø«Ø§Ù†ÙŠ ==========
        document.getElementById('submit-final-btn').addEventListener('click', async function() {
            if(userAnswers.some(ans => !ans.trim())) { showNotification('Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹','error'); return; }
            this.disabled = true; this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...';
            try {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Øµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                let qaText = '';
                for(let i=0; i<currentSettings.questionsCount; i++) {
                    qaText += `Q${i+1} : ${essayQuestions[`Q${i+1}`]}\nR${i+1} : ${userAnswers[i]}\n`;
                }
                
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(selectedFile);
                });
                
                const evalPrompt = `SYSTEM ROLE: STRICT PDF ESSAY EVALUATION ENGINE
ZERO-DEVIATION MODE

You are a deterministic evaluation engine.
No chat. No explanation. No comments. No extra keys. No markdown. No text outside JSON.
Any deviation = INVALID OUTPUT.

----------------------------------
ACTIVATION CONDITIONS
----------------------------------
Execute ONLY if a readable PDF is provided.
Questions & answers are provided exactly in this pattern:
${qaText}
If format mismatch â†’ RETURN EXACTLY: INVALID FORMAT

----------------------------------
CORE DIRECTIVE
----------------------------------
1) Read the ENTIRE PDF.
2) For EACH question:
   â€¢ Extract ideal model answer strictly from PDF.
   â€¢ Compare user's answer to model answer.
   â€¢ Compute semantic similarity percentage (0â€“100).
   â€¢ Evaluate conceptual completeness, missing points, incorrect claims.
3) Similarity reflects concept accuracy, coverage, logic, terminology.

----------------------------------
OUTPUT FORMAT (STRICT JSON ONLY)
----------------------------------
Return ONLY this structure:
{
  "C1": "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù",
  "X1": "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø© %",
  "B1": "Ù†ØµÙŠØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„ØªØ­Ø³ÙŠÙ†",
  "C2": "...",
  "X2": "...",
  "B2": "..."
}
Continue sequentially. No extra keys.`;
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id:ID, pass:PASS, data:evalPrompt, PDF_BASE64:base64 })
                });
                const evalText = await response.text();
                if(evalText.includes("INVALID")) throw new Error('ÙØ´Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
                evaluationData = JSON.parse(evalText);
                
                // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if(currentRecordId) {
                    await database.ref(`records/${currentRecordId}/evaluation`).set(evaluationData);
                    await database.ref(`records/${currentRecordId}/userAnswers`).set(userAnswers); // Ø¢Ø®Ø± Ù†Ø³Ø®Ø©
                    await database.ref(`records/${currentRecordId}/submitted`).set(true);
                }
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                displayEvaluation();
                document.getElementById('essay-section').classList.remove('show');
                document.getElementById('evaluation-section').classList.add('show');
                showNotification('ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­','success');
            } catch(e) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: '+e.message,'error');
                console.error(e);
            } finally {
                this.disabled = false; this.innerHTML = '<i class="fas fa-check-double"></i> ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª';
            }
        });
        
        function displayEvaluation() {
            const container = document.getElementById('evaluation-container');
            if(!evaluationData) return;
            let html = '';
            const count = currentSettings.questionsCount;
            for(let i=1; i<=count; i++) {
                const model = evaluationData[`C${i}`] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                const percent = evaluationData[`X${i}`] || '0';
                const advice = evaluationData[`B${i}`] || '';
                html += `
                <div class="eval-card">
                    <div class="eval-question">Ø³Ø¤Ø§Ù„ ${i}: ${essayQuestions[`Q${i}`]}</div>
                    <div class="eval-model"><span class="eval-model-title"><i class="fas fa-book-open"></i> Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</span> ${model}</div>
                    <div class="eval-percent"><i class="fas fa-chart-pie"></i> Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©: ${percent}%</div>
                    <div class="eval-advice"><i class="fas fa-lightbulb"></i> Ù†ØµÙŠØ­Ø©: ${advice}</div>
                </div>`;
            }
            container.innerHTML = html;
        }
        
        // ========== Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ==========
        async function saveRecord(action) {
            if(!currentUser) return;
            const recordId = 'essay_' + Date.now();
            currentRecordId = recordId;
            const recordData = {
                id: currentUser.id,
                process: 'Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚Ø§Ù„ÙŠØ©',
                fileName: fileInfo.name,
                settings: currentSettings,
                questions: essayQuestions,
                userAnswers: userAnswers,
                timestamp: Date.now(),
                evaluation: evaluationData || null
            };
            await database.ref(`records/${recordId}`).set(recordData);
        }
        
        // ========== Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù€ Question.html) ==========
        function setupRecords() {
            document.getElementById('records-btn').addEventListener('click', showRecords);
            document.getElementById('close-records-btn').addEventListener('click', ()=>document.getElementById('records-modal').classList.remove('show'));
            window.addEventListener('click', e => { if(e.target.classList.contains('records-modal')) document.getElementById('records-modal').classList.remove('show'); });
        }
        async function showRecords() {
            const modal = document.getElementById('records-modal');
            const listDiv = document.getElementById('records-list');
            listDiv.innerHTML = '<div class="no-records" style="display:block;"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            modal.classList.add('show');
            try {
                const snapshot = await database.ref('records').orderByChild('id').equalTo(currentUser.id).once('value');
                listDiv.innerHTML = '';
                if(snapshot.exists()) {
                    const records = [];
                    snapshot.forEach(child => records.push({ key:child.key, ...child.val() }));
                    records.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
                    records.forEach(rec => {
                        const card = document.createElement('div'); card.className = 'record-card';
                        const date = new Date(rec.timestamp||Date.now()).toLocaleString('ar-EG');
                        const evalExist = rec.evaluation ? 'âœ… ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…' : 'â³ Ù„Ù… ÙŠÙ‚ÙŠÙ… Ø¨Ø¹Ø¯';
                        card.innerHTML = `<div style="display:flex; justify-content:space-between;"><span><i class="fas fa-file-pdf"></i> ${rec.fileName||'Ù…Ù„Ù'}</span><span>${date}</span></div>
                                          <div style="margin-top:10px;"><span>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${rec.settings?.questionsCount||0}</span> | <span>Ø§Ù„ØµØ¹ÙˆØ¨Ø©: ${rec.settings?.difficulty||''}</span></div>
                                          <div style="margin-top:8px; color:var(--accent-primary);">${evalExist}</div>`;
                        card.addEventListener('click', ()=> loadEssayRecord(rec));
                        listDiv.appendChild(card);
                    });
                } else {
                    listDiv.innerHTML = '<div class="no-records" style="display:block;"><i class="fas fa-folder-open"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p></div>';
                }
            } catch(e) { listDiv.innerHTML = '<div class="no-records">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>'; }
        }
        
        function loadEssayRecord(rec) {
            document.getElementById('records-modal').classList.remove('show');
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            selectedFile = null; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù„Ù ÙˆÙ„ÙƒÙ† Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù† ÙˆØ¬Ø¯Øª
            fileInfo = { name: rec.fileName, baseCost:0 };
            currentSettings = rec.settings || { questionsCount:8, difficulty:'Ø³Ù‡Ù„' };
            essayQuestions = rec.questions || {};
            userAnswers = rec.userAnswers || [];
            evaluationData = rec.evaluation || null;
            currentRecordId = rec.key;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('settings-section').classList.remove('show');
            document.getElementById('essay-section').classList.remove('show');
            document.getElementById('evaluation-section').classList.remove('show');
            
            if(evaluationData) {
                displayEvaluation();
                document.getElementById('evaluation-section').classList.add('show');
            } else {
                // Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ù‚ÙŠÙ…Ø©
                document.getElementById('essay-section').classList.add('show');
                currentQuestionIndex = 0;
                renderQuestion();
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                if(userAnswers.length === currentSettings.questionsCount) {
                    document.getElementById('answer-textarea').value = userAnswers[currentQuestionIndex]||'';
                    checkAllAnswered();
                }
            }
            hideFooter();
        }
        
        // ========== Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ==========
        document.getElementById('home-logo').addEventListener('click', ()=>{
            window.location.reload(); // Ø¨Ø³ÙŠØ·
        });
        
        // ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ==========
        async function init() {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
            auth.onAuthStateChanged(async user => {
                if(!user) { window.location.replace('login.html'); return; }
                await loadUserData();
                if(currentUser?.banned) { window.location.replace('login.html'); return; }
                setupFileUpload();
                setupSettingsEvents();
                setupRecords();
                setupAutoSave();
                hideLoading();
            });
        }
        
        history.pushState(null,null,location.href);
        window.addEventListener('popstate', ()=>history.pushState(null,null,location.href));
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
