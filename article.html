<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>ÿπŸàŸÜ - ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸÇÿßŸÑŸäÿ©</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-color: #F5F1E8;
            --card-color: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-primary: #8B7355;
            --accent-secondary: #A9927D;
            --accent-dark: #5D4037;
            --border-color: #D4A574;
            --border-radius: 16px;
            --border-radius-lg: 20px;
            --border-radius-xl: 24px;
            --navbar-height: 70px;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --info-color: #2196F3;
            --warning-color: #FFC107;
            --gradient-primary: linear-gradient(145deg, #8B7355 0%, #A9927D 100%);
            --gradient-success: linear-gradient(145deg, #4CAF50 0%, #45a049 100%);
            --gradient-error: linear-gradient(145deg, #F44336 0%, #d32f2f 100%);
            --shadow-light: 0 4px 12px rgba(139,115,85,0.1);
            --shadow-medium: 0 8px 24px rgba(139,115,85,0.15);
        }

        body {
            font-family: 'Almarai', 'Tajawal', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.3s;
            padding: 20px;
        }

        .loading-logo {
            font-weight: 800;
            font-size: clamp(40px, 10vw, 56px);
            color: var(--accent-primary);
            margin-bottom: 25px;
            animation: pulse 1.5s infinite;
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .loading-spinner {
            width: min(70px, 15vw);
            height: min(70px, 15vw);
            border: 5px solid rgba(139,115,85,0.1);
            border-left-color: var(--accent-primary);
            border-right-color: var(--accent-secondary);
            border-radius: 50%;
            animation: spin 1.2s infinite;
            margin-bottom: 30px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-family: 'Tajawal';
            color: var(--text-primary);
            font-size: clamp(1rem, 4vw, 1.3rem);
            text-align: center;
            background: rgba(139,115,85,0.1);
            padding: 15px 30px;
            border-radius: 50px;
            width: 90%;
            max-width: 400px;
        }

        /* Navbar */
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: rgba(245,241,232,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10000;
            border-bottom: 1px solid rgba(139,115,85,0.15);
            box-shadow: var(--shadow-light);
        }

        .logo {
            font-weight: 900;
            font-size: clamp(28px, 6vw, 42px);
            color: var(--accent-primary);
            cursor: pointer;
            transition: 0.1s;
        }

        .logo:active { transform: scale(0.95); }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .records-btn {
            background: rgba(139,115,85,0.15);
            color: var(--accent-primary);
            padding: 10px 16px;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 1px solid rgba(139,115,85,0.2);
            white-space: nowrap;
        }

        .records-btn:active { transform: scale(0.95); background: rgba(139,115,85,0.3); }
        .records-btn i { font-size: 16px; }

        .coins-display {
            background: var(--gradient-primary);
            color: white;
            padding: 10px 18px;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-size: 14px;
        }

        .coins-display:active { transform: scale(0.95); }

        /* Main Content */
        .main-content {
            padding-top: calc(var(--navbar-height) + 20px);
            padding-left: 16px;
            padding-right: 16px;
            padding-bottom: 30px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Upload Section */
        .upload-section,
        .settings-section,
        .essay-section,
        .evaluation-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 25px 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(139,115,85,0.12);
            width: 100%;
            max-width: 900px;
            animation: fadeInUp 0.4s;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 10px;
            text-align: center;
        }

        .section-subtitle {
            font-family: 'Tajawal';
            color: var(--text-secondary);
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            margin-bottom: 25px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: 30px 20px;
            margin-bottom: 25px;
            cursor: pointer;
            transition: 0.1s;
            background: rgba(212,165,116,0.05);
            width: 100%;
        }

        .upload-area:active {
            transform: scale(0.99);
            border-color: var(--accent-primary);
            background: rgba(212,165,116,0.1);
        }

        .upload-icon {
            font-size: clamp(40px, 8vw, 56px);
            color: var(--accent-primary);
            margin-bottom: 15px;
            animation: bounce 2s infinite;
            text-align: center;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .upload-text {
            font-family: 'Tajawal';
            font-size: clamp(1rem, 4vw, 1.2rem);
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
            word-break: break-word;
        }

        .upload-hint {
            font-family: 'Tajawal';
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            font-size: 0.9rem;
        }

        .cost-preview {
            background: rgba(139,115,85,0.06);
            border-radius: var(--border-radius-xl);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(139,115,85,0.12);
            display: none;
        }

        .cost-preview.show { display: block; }

        .cost-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .cost-details {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .cost-item {
            text-align: center;
            min-width: 120px;
        }

        .cost-label {
            font-family: 'Tajawal';
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .cost-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .cost-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 14px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai';
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.1s;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:active { transform: scale(0.95); }
        .confirm-btn { background: var(--gradient-success); color: white; }
        .cancel-btn { background: var(--gradient-error); color: white; }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (min-width: 768px) {
            .settings-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .setting-group {
            background: rgba(139,115,85,0.04);
            border-radius: var(--border-radius-xl);
            padding: 20px;
            border: 1px solid rgba(139,115,85,0.12);
        }

        .setting-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider-container { padding: 15px 0; }

        .slider-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 10px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'Tajawal';
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .slider {
            width: 100%;
            height: 25px;
            -webkit-appearance: none;
            background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary));
            outline: none;
            border-radius: 12px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 35px;
            height: 35px;
            border-radius: var(--border-radius);
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            border: 3px solid white;
        }

        .extra-cost {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 15px;
            font-size: 0.95rem;
        }

        .extra-cost span {
            color: var(--success-color);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .option-btn {
            padding: 12px 10px;
            border: 2px solid rgba(139,115,85,0.25);
            border-radius: var(--border-radius);
            background: white;
            font-family: 'Tajawal';
            cursor: pointer;
            transition: 0.1s;
            text-align: center;
            font-size: 0.95rem;
        }

        .option-btn:active { transform: scale(0.95); }
        .option-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .total-cost-box {
            text-align: center;
            padding: 20px;
            background: rgba(139,115,85,0.04);
            border-radius: var(--border-radius-xl);
            margin: 15px 0;
        }

        .total-cost-label {
            font-family: 'Tajawal';
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .total-cost-number {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--accent-primary);
            line-height: 1.2;
        }

        .generate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 16px 30px;
            font-family: 'Almarai';
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.1s;
            display: block;
            margin: 0 auto;
            width: 100%;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .generate-btn:active:not(:disabled) { transform: scale(0.98); }
        .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Essay Section */
        .essay-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (min-width: 768px) {
            .essay-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .essay-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .essay-info {
            background: rgba(139,115,85,0.08);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .question-progress {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .question-progress {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .q-counter {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .q-counter span {
            color: var(--accent-primary);
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0 5px;
        }

        .progress-bar-container {
            flex: 1;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            max-width: 100%;
        }

        @media (min-width: 768px) {
            .progress-bar-container {
                max-width: 300px;
            }
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.2s;
        }

        .question-box {
            background: rgba(139,115,85,0.04);
            border-radius: var(--border-radius-xl);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(139,115,85,0.15);
        }

        .question-text {
            font-family: 'Tajawal';
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .answer-label {
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .answer-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid rgba(139,115,85,0.2);
            border-radius: var(--border-radius-lg);
            font-family: 'Tajawal';
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            background: white;
        }

        .answer-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-light);
        }

        .navigation-buttons {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin: 20px 0;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai';
            font-weight: 700;
            cursor: pointer;
            transition: 0.1s;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--gradient-primary);
            color: white;
            font-size: 0.95rem;
        }

        .nav-btn:active:not(:disabled) { transform: scale(0.95); }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .submit-final-btn {
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 16px 30px;
            font-family: 'Almarai';
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.1s;
            display: block;
            margin: 30px auto 10px;
            width: 100%;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-final-btn:active:not(:disabled) { transform: scale(0.98); }
        .submit-final-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Evaluation Cards */
        .evaluation-card {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(139,115,85,0.15);
            box-shadow: var(--shadow-light);
            overflow: hidden;
        }

        .evaluation-question-header {
            background: rgba(139,115,85,0.08);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-right: 6px solid var(--accent-primary);
        }

        .evaluation-question-text {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent-primary);
            line-height: 1.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .evaluation-answers-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .evaluation-answers-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .user-answer-box {
            background: rgba(33,150,243,0.05);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(33,150,243,0.2);
        }

        .model-answer-box {
            background: rgba(76,175,80,0.05);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(76,175,80,0.2);
        }

        .answer-title {
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .answer-title i {
            font-size: 1.2rem;
        }

        .answer-content {
            font-family: 'Tajawal';
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: var(--border-radius);
        }

        .advice-box {
            background: rgba(139,115,85,0.05);
            padding: 20px;
            border-radius: var(--border-radius);
            border-right: 6px solid var(--accent-primary);
            margin-top: 20px;
        }

        .advice-title {
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advice-text {
            font-family: 'Tajawal';
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            border-top: 1px solid rgba(139,115,85,0.12);
            margin-top: 20px;
            width: 100%;
            max-width: 900px;
        }

        .footer.hidden { display: none; }

        .support-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .support-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .support-links {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .support-link {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.1s;
        }

        .support-link:active { transform: scale(0.95); }
        .support-link i { font-size: 24px; color: white; }

        .developer-credit {
            font-size: 0.9rem;
            color: rgba(100,116,139,0.6);
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(139,115,85,0.06);
            cursor: pointer;
        }

        /* Records Modal */
        .records-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: 0.2s;
            padding: 20px;
        }

        .records-modal.show { opacity: 1; visibility: visible; }

        .records-content {
            background: white;
            border-radius: var(--border-radius-xl);
            width: 100%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid rgba(139,115,85,0.15);
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .records-header h2 {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-records-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .close-records-btn:active { background: rgba(139,115,85,0.1); }

        .records-list { padding: 20px; }

        .no-records {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .record-card {
            background: rgba(139,115,85,0.04);
            border-radius: var(--border-radius-lg);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(139,115,85,0.1);
            cursor: pointer;
            transition: 0.1s;
            overflow: hidden;
        }

        .record-card:active { transform: scale(0.98); background: rgba(139,115,85,0.08); }

        .record-file-name {
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .record-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .record-meta span {
            background: rgba(139,115,85,0.1);
            padding: 4px 10px;
            border-radius: var(--border-radius);
        }

        .record-status {
            color: var(--success-color);
            font-weight: 700;
            font-size: 0.9rem;
        }

        .record-status.pending {
            color: var(--warning-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: calc(var(--navbar-height) + 10px);
            right: 20px;
            background: white;
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow-medium);
            z-index: 20001;
            max-width: 350px;
            width: calc(100% - 40px);
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-right: 5px solid var(--info-color);
        }

        .notification.show { transform: translateX(0); }
        .notification.success { border-right-color: var(--success-color); }
        .notification.error { border-right-color: var(--error-color); }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon { font-size: 24px; }
        .notification.success .notification-icon { color: var(--success-color); }
        .notification.error .notification-icon { color: var(--error-color); }
        .notification-text { font-family: 'Tajawal'; font-size: 1rem; flex: 1; }

        /* Utilities */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">ÿπŸàŸÜ</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon"><i class="fas fa-info-circle"></i></div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>

    <!-- Records Modal -->
    <div class="records-modal" id="records-modal">
        <div class="records-content">
            <div class="records-header">
                <h2><i class="fas fa-history"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸÇÿßŸÑŸäÿ©</h2>
                <button class="close-records-btn" id="close-records-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="records-list" id="records-list">
                <div class="no-records" id="no-records"><i class="fas fa-folder-open"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã</p></div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="native-navbar" id="navbar">
        <div class="logo" id="home-logo">ÿπŸàŸÜ</div>
        <div class="nav-left">
            <div class="records-btn" id="records-btn"><i class="fas fa-history"></i><span class="records-text">ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™</span></div>
            <div class="coins-display"><i class="fas fa-coins"></i><span id="coins-count">0</span></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <h1 class="section-title">ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸÇÿßŸÑŸäÿ©</h1>
            <p class="section-subtitle">ÿßÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖŸÇÿßŸÑŸäÿ© ŸÖÿÆÿµÿµÿ©</p>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon"><i class="fas fa-file-pdf"></i></div>
                <div class="upload-text" id="upload-text">ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF</div>
                <div class="upload-hint">ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ÿßŸÑŸÖŸÑŸÅ ŸáŸÜÿß</div>
            </div>
            <input type="file" id="pdfFile" accept=".pdf" style="display:none;">
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÑŸÅ</h3>
                <div class="cost-details">
                    <div class="cost-item"><div class="cost-label">ÿπÿØÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™</div><div class="cost-value" id="page-count">0</div></div>
                    <div class="cost-item"><div class="cost-label">ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©</div><div class="cost-value" id="cost-amount">0</div></div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" id="cancel-btn"><i class="fas fa-times"></i>ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="action-btn confirm-btn" id="confirm-btn"><i class="fas fa-check"></i>ŸÖÿ™ÿßÿ®ÿπÿ©</button>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section class="settings-section" id="settings-section" style="display:none;">
            <h2 class="section-title">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©</h2>
            <p class="section-subtitle">ÿßÿÆÿ™ÿ± ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸàŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµÿπŸàÿ®ÿ©</p>
            <div class="settings-grid">
                <div class="setting-group">
                    <h3 class="setting-title"><i class="fas fa-sort-numeric-up"></i> ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©</h3>
                    <div class="slider-container">
                        <div class="slider-value" id="questions-count">8</div>
                        <div class="slider-labels"><span>5</span><span>40</span></div>
                        <input type="range" min="5" max="40" value="8" class="slider" id="questions-slider">
                        <div class="extra-cost" id="extra-cost-display">ÿ™ŸÉŸÑŸÅÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©: <span id="extra-cost">0</span> ÿπŸÖŸÑÿ©</div>
                    </div>
                </div>
                <div class="setting-group">
                    <h3 class="setting-title"><i class="fas fa-chart-line"></i> ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµÿπŸàÿ®ÿ©</h3>
                    <div class="options-grid" id="difficulty-level">
                        <button class="option-btn selected" data-value="ÿ≥ŸáŸÑ">ÿ≥ŸáŸÑ</button>
                        <button class="option-btn" data-value="ŸÖÿ™Ÿàÿ≥ÿ∑">ŸÖÿ™Ÿàÿ≥ÿ∑</button>
                        <button class="option-btn" data-value="ÿµÿπÿ®">ÿµÿπÿ®</button>
                    </div>
                </div>
            </div>
            <div class="total-cost-box">
                <div class="total-cost-label">ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©</div>
                <div class="total-cost-number" id="total-cost-display">0</div>
                <div style="font-size:0.9rem;">ÿπŸÖŸÑÿ©</div>
            </div>
            <button class="generate-btn" id="generate-btn"><i class="fas fa-robot"></i> ÿ®ÿØÿ° ÿßŸÑÿ™ŸÇŸäŸäŸÖ</button>
        </section>

        <!-- Essay Section -->
        <section class="essay-section" id="essay-section" style="display:none;">
            <div class="essay-header">
                <h2><i class="fas fa-pen-fancy"></i> ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸÇÿßŸÑŸäÿ©</h2>
                <div class="essay-info" id="essay-info">ÿßŸÑÿµÿπŸàÿ®ÿ©: <span id="display-difficulty">ÿ≥ŸáŸÑ</span></div>
            </div>
            <div class="question-progress">
                <div class="q-counter">ÿßŸÑÿ≥ÿ§ÿßŸÑ <span id="current-q-num">1</span> / <span id="total-q-num">8</span></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progress-fill" style="width:0%;"></div>
                </div>
            </div>
            <div class="question-box">
                <div class="question-text" id="question-text">...</div>
                <div class="answer-label"><i class="fas fa-edit"></i> ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ:</div>
                <textarea class="answer-textarea" id="answer-textarea" placeholder="ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ŸáŸÜÿß..."></textarea>
            </div>
            <div class="navigation-buttons">
                <button class="nav-btn" id="prev-btn" disabled><i class="fas fa-arrow-right"></i> ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>
                <button class="nav-btn" id="next-btn">ÿßŸÑÿ™ÿßŸÑŸä <i class="fas fa-arrow-left"></i></button>
            </div>
            <button class="submit-final-btn" id="submit-final-btn" disabled><i class="fas fa-check-double"></i> ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™</button>
        </section>

        <!-- Evaluation Section -->
        <section class="evaluation-section" id="evaluation-section" style="display:none;">
            <h2 class="section-title">ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ™ŸÇŸäŸäŸÖ</h2>
            <div id="evaluation-container"></div>
        </section>

        <!-- Footer -->
        <footer class="footer" id="footer">
            <p class="copyright">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÖŸÜÿµÿ© ÿπŸàŸÜ ¬© 2026</p>
            <div class="support-section">
                <div class="support-title">ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä</div>
                <div class="support-links">
                    <a href="https://wa.me/966583617539" target="_blank" class="support-link"><i class="fab fa-whatsapp"></i></a>
                    <a href="https://t.me/HNHv1" target="_blank" class="support-link"><i class="fab fa-telegram"></i></a>
                </div>
            </div>
            <div class="developer-credit" id="developer-credit">ÿ®ÿ±ŸÖÿ¨ÿ© Ÿàÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± ùêäùêàùêåùêé</div>
        </footer>
    </div>

    <script>
        // ÿ™ŸáŸäÿ¶ÿ© PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿπÿßŸÖÿ©
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let fileInfo = { name: '', pages: 0, baseCost: 5 };
        let currentSettings = { questionsCount: 8, difficulty: 'ÿ≥ŸáŸÑ', extraCost: 0, totalCost: 5 };
        let essayQuestions = [];
        let userAnswers = [];
        let currentQuestionIndex = 0;
        let currentRecordId = null;
        let evaluationData = null;
        let currentRecord = null;

        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";

        // ===== ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© =====
        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-screen').style.display = 'flex';
            setTimeout(() => document.getElementById('loading-screen').style.opacity = '1', 10);
        }

        function hideLoading() {
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 300);
        }

        function showNotification(message, type = 'info') {
            const notif = document.getElementById('notification');
            document.getElementById('notification-text').textContent = message;
            notif.className = 'notification';
            if (type === 'success') {
                notif.classList.add('success');
                document.getElementById('notification-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                notif.classList.add('error');
                document.getElementById('notification-icon').innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            } else {
                document.getElementById('notification-icon').innerHTML = '<i class="fas fa-info-circle"></i>';
            }
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        function hideFooter() {
            document.getElementById('footer').classList.add('hidden');
        }

        function showFooter() {
            document.getElementById('footer').classList.remove('hidden');
        }

        // ===== ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© =====
        function calculateExtraCost(count) {
            if (count >= 5 && count <= 8) return 0;
            else if (count >= 9 && count <= 15) return 8;
            else if (count >= 16 && count <= 20) return 13;
            else if (count >= 21 && count <= 30) return 20;
            else if (count >= 31 && count <= 40) return 25;
            return 0;
        }

        function updateCost() {
            const count = parseInt(document.getElementById('questions-slider').value);
            document.getElementById('questions-count').textContent = count;
            currentSettings.questionsCount = count;
            
            const extra = calculateExtraCost(count);
            currentSettings.extraCost = extra;
            document.getElementById('extra-cost').textContent = extra;
            
            const total = fileInfo.baseCost + extra;
            currentSettings.totalCost = total;
            document.getElementById('total-cost-display').textContent = total;
        }

        // ===== ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ =====
        async function loadUserData() {
            const user = auth.currentUser;
            if (!user) {
                window.location.replace('login.html');
                return false;
            }

            try {
                const usersRef = database.ref('users_Awn');
                const snapshot = await usersRef.once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    for (const [uid, data] of Object.entries(users)) {
                        if (uid !== 'noty_publick' && data.email === user.email) {
                            currentUser = {
                                id: uid,
                                email: data.email,
                                name: data.name || '',
                                coin: data.coin || 0,
                                banned: data.banned || false
                            };
                            userCoins = data.coin || 0;
                            document.getElementById('coins-count').textContent = userCoins;
                            
                            if (currentUser.banned) {
                                await auth.signOut();
                                window.location.replace('login.html');
                                return false;
                            }
                            return true;
                        }
                    }
                }
                
                await auth.signOut();
                window.location.replace('login.html');
                return false;
            } catch (error) {
                console.error('Error loading user:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', 'error');
                return false;
            }
        }

        // ===== ÿ±ŸÅÿπ Ÿàÿ™ÿ≠ŸÑŸäŸÑ PDF =====
        function setupFileUpload() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadArea = document.getElementById('upload-area');

            uploadArea.addEventListener('click', () => pdfFile.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--accent-primary)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '';
            });

            uploadArea.addEventListener('drop', async (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '';
                const file = e.dataTransfer.files[0];
                if (file) await handleFile(file);
            });

            pdfFile.addEventListener('change', (e) => {
                if (e.target.files[0]) handleFile(e.target.files[0]);
            });

            document.getElementById('cancel-btn').addEventListener('click', () => {
                document.getElementById('pdfFile').value = '';
                document.getElementById('upload-text').textContent = 'ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF';
                document.getElementById('cost-preview').classList.remove('show');
                selectedFile = null;
            });

            document.getElementById('confirm-btn').addEventListener('click', () => {
                if (!selectedFile) {
                    showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿ£ŸàŸÑÿßŸã', 'error');
                    return;
                }
                if (userCoins < fileInfo.baseCost) {
                    showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç. ÿ™ÿ≠ÿ™ÿßÿ¨ ${fileInfo.baseCost} ÿπŸÖŸÑÿ©`, 'error');
                    return;
                }
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('settings-section').style.display = 'block';
            });
        }

        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ŸÅŸÇÿ∑', 'error');
                return;
            }

            selectedFile = file;
            document.getElementById('upload-text').textContent = file.name;
            await analyzePDF(file);
        }

        async function analyzePDF(file) {
            showLoading('ÿπŸàŸÜ Ÿäÿ≠ŸÑŸÑ ÿßŸÑŸÖŸÑŸÅ...');
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                fileInfo = {
                    name: file.name,
                    pages: pdf.numPages,
                    baseCost: 5
                };

                document.getElementById('page-count').textContent = fileInfo.pages;
                document.getElementById('cost-amount').textContent = fileInfo.baseCost + ' ÿπŸÖŸÑÿ©';
                document.getElementById('cost-preview').classList.add('show');
                updateCost();
                hideLoading();
                showNotification('ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
            } catch (error) {
                console.error('PDF analysis error:', error);
                hideLoading();
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ', 'error');
            }
        }

        // ===== ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© =====
        function setupSettingsEvents() {
            document.getElementById('questions-slider').addEventListener('input', updateCost);

            document.querySelectorAll('#difficulty-level .option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#difficulty-level .option-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.difficulty = this.dataset.value;
                });
            });

            document.getElementById('generate-btn').addEventListener('click', generateAndEvaluate);
            updateCost();
        }

        // ===== ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ÿ±ŸàŸÖÿ®ÿ™ ÿßŸÑŸÖŸàÿ≠ÿØ =====
        function createUnifiedPrompt() {
            return `========================================
SYSTEM ROLE: STRICT PDF ESSAY QA ENGINE
FULL-DOCUMENT ANALYSIS MODE
ZERO-DEVIATION POLICY
========================================

You are a deterministic execution engine.
No chat.
No explanation.
No markdown.
No comments.
No extra text.
Return JSON ONLY.
Any deviation = INVALID OUTPUT.

----------------------------------
ACTIVATION CONDITIONS
----------------------------------

Execute ONLY if:
‚Ä¢ A readable PDF is provided
‚Ä¢ {{ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ©}} is provided
‚Ä¢ {{ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿµÿπŸàÿ®ÿ©}} is provided

If any missing ‚Üí RETURN EXACTLY:
INSUFFICIENT INPUT

----------------------------------
CORE EXECUTION FLOW
----------------------------------

1) Read the ENTIRE PDF from first word to last word.
2) Treat the document as ONE unified structured source.
3) Analyze ALL sections equally.
4) Ensure coverage spans the FULL document.
5) Do NOT focus on a single section.
6) Do NOT repeat ideas or concepts.
7) Each question must target a distinct concept.

----------------------------------
DIFFICULTY CONTROL (MANDATORY)
----------------------------------

Interpret {{ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿµÿπŸàÿ®ÿ©}} strictly:

IF = "ÿ≥ŸáŸÑ":
‚Ä¢ Questions must be directly stated in the PDF
‚Ä¢ Answers explicitly present
‚Ä¢ Clear factual recall
‚Ä¢ Cover entire file

IF = "ŸÖÿ™Ÿàÿ≥ÿ∑":
‚Ä¢ Questions directly based on text
‚Ä¢ Require deeper understanding
‚Ä¢ Hard but still text-based
‚Ä¢ No inference outside document
‚Ä¢ Cover entire file

IF = "ÿµÿπÿ®":
‚Ä¢ Questions must be logically inferred from PDF
‚Ä¢ Require synthesis between multiple sections
‚Ä¢ Analytical and conceptual
‚Ä¢ No external knowledge
‚Ä¢ Still derived strictly from document

----------------------------------
QUESTION COUNT RULE
----------------------------------

‚Ä¢ Generate EXACTLY {{ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ©}} questions
‚Ä¢ No more
‚Ä¢ No less

----------------------------------
EVALUATION REQUIREMENT
----------------------------------

For EACH question:

1) Generate the question.
2) Generate the precise model answer strictly from the PDF.
3) Compare with the user's answer.
4) Write a tailored improvement advice based on:
   ‚Ä¢ Missing points
   ‚Ä¢ Conceptual weakness
   ‚Ä¢ Incomplete reasoning
   ‚Ä¢ Structural clarity

Advice must:
‚Ä¢ Be specific
‚Ä¢ Reference conceptual gap
‚Ä¢ Not generic
‚Ä¢ Not repeated between evaluations

----------------------------------
STRICT OUTPUT FORMAT (JSON ONLY)
----------------------------------

Return EXACTLY this structure:

{
  "ÿ™ŸÇŸäŸäŸÖ_1": {
    "ÿßŸÑÿ≥ÿ§ÿßŸÑ": "...",
    "ÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ": "...",
    "ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©": "...",
    "ŸÜÿµŸäÿ≠ÿ©": "..."
  },
  "ÿ™ŸÇŸäŸäŸÖ_2": {
    "ÿßŸÑÿ≥ÿ§ÿßŸÑ": "...",
    "ÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ": "...",
    "ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©": "...",
    "ŸÜÿµŸäÿ≠ÿ©": "..."
  }
}

‚Ä¢ Continue sequentially until {{ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ©}}
‚Ä¢ Keys must be ÿ™ŸÇŸäŸäŸÖ_1, ÿ™ŸÇŸäŸäŸÖ_2, ÿ™ŸÇŸäŸäŸÖ_3 ...
‚Ä¢ No extra keys
‚Ä¢ No additional fields
‚Ä¢ No trailing commas
‚Ä¢ Valid strict JSON only

ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© = ${currentSettings.questionsCount}
ŸÖÿ≥ÿ™ŸàŸâ_ÿßŸÑÿµÿπŸàÿ®ÿ© = ${currentSettings.difficulty}

ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:
${userAnswers.map((ans, index) => `ÿßŸÑÿ≥ÿ§ÿßŸÑ ${index + 1}: ${essayQuestions[index] || 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ®ÿπÿØ'}\nÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${index + 1}: ${ans || 'ŸÑŸÖ ŸäŸÉÿ™ÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ÿ¨ÿßÿ®ÿ©'}`).join('\n\n')}`;
        }

        function cleanJSONResponse(text) {
            try {
                // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ JSON ŸÅŸä ÿßŸÑŸÜÿµ
                const start = text.indexOf('{');
                const end = text.lastIndexOf('}');
                if (start !== -1 && end !== -1) {
                    const jsonStr = text.substring(start, end + 1);
                    return JSON.parse(jsonStr);
                }
            } catch (e) {
                console.error('JSON parse error:', e);
            }
            return null;
        }

        // ===== ÿ•ŸÜÿ¥ÿßÿ° Ÿàÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© (ÿ®ÿ±ŸàŸÖÿ®ÿ™ ŸÖŸàÿ≠ÿØ) =====
        async function generateAndEvaluate() {
            if (!selectedFile) {
                showNotification('ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ', 'error');
                return;
            }

            if (userCoins < currentSettings.totalCost) {
                showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç. ÿ™ÿ≠ÿ™ÿßÿ¨ ${currentSettings.totalCost} ÿπŸÖŸÑÿ©`, 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©...';

            try {
                showLoading('ÿπŸàŸÜ ŸäŸÇÿ±ÿ£ ŸÖŸÑŸÅŸÉ ŸàŸäŸÜÿ¥ÿ¶ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©...');
                
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(selectedFile);
                });

                // ÿ£ŸàŸÑ ÿßÿ≥ÿ™ÿØÿπÿßÿ°: ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÅŸÇÿ∑
                const prompt1 = createUnifiedPrompt().replace(/ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:[\s\S]*$/, '');
                
                const response1 = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: prompt1,
                        PDF_BASE64: base64
                    })
                });

                const text1 = await response1.text();
                
                if (text1.includes("INVALID") || text1.includes("INSUFFICIENT")) {
                    throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©');
                }

                const questionsData = cleanJSONResponse(text1);
                if (!questionsData) {
                    throw new Error('ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ±ÿØ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                }

                // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                essayQuestions = [];
                for (let i = 1; i <= currentSettings.questionsCount; i++) {
                    const evalItem = questionsData[`ÿ™ŸÇŸäŸäŸÖ_${i}`];
                    if (evalItem && evalItem["ÿßŸÑÿ≥ÿ§ÿßŸÑ"]) {
                        essayQuestions.push(evalItem["ÿßŸÑÿ≥ÿ§ÿßŸÑ"]);
                    } else {
                        throw new Error(`ÿßŸÑÿ≥ÿ§ÿßŸÑ ${i} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™`);
                    }
                }

                // ÿÆÿµŸÖ ÿßŸÑÿπŸÖŸÑÿßÿ™
                userCoins -= currentSettings.totalCost;
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(userCoins);
                document.getElementById('coins-count').textContent = userCoins;

                // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™
                userAnswers = new Array(currentSettings.questionsCount).fill('');
                currentQuestionIndex = 0;

                // ÿπÿ±ÿ∂ ŸÇÿ≥ŸÖ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©
                document.getElementById('settings-section').style.display = 'none';
                document.getElementById('essay-section').style.display = 'block';
                hideFooter();

                await saveRecord('generated');
                renderQuestion();
                showNotification('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');

            } catch (error) {
                console.error('Generation error:', error);
                showNotification('ÿÆÿ∑ÿ£: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-robot"></i> ÿ®ÿØÿ° ÿßŸÑÿ™ŸÇŸäŸäŸÖ';
            }
        }

        function renderQuestion() {
            if (!essayQuestions || essayQuestions.length === 0) return;
            
            document.getElementById('question-text').textContent = essayQuestions[currentQuestionIndex] || 'ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
            document.getElementById('answer-textarea').value = userAnswers[currentQuestionIndex] || '';
            document.getElementById('current-q-num').textContent = currentQuestionIndex + 1;
            document.getElementById('total-q-num').textContent = currentSettings.questionsCount;
            
            const progress = ((currentQuestionIndex + 1) / currentSettings.questionsCount) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').disabled = currentQuestionIndex === currentSettings.questionsCount - 1;
            document.getElementById('display-difficulty').textContent = currentSettings.difficulty;
            
            checkAllAnswered();
        }

        function checkAllAnswered() {
            if (!userAnswers) return;
            const allAnswered = userAnswers.every(ans => ans && ans.trim().length > 0);
            document.getElementById('submit-final-btn').disabled = !allAnswered;
        }

        // ===== ÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶Ÿä =====
        function setupAutoSave() {
            const textarea = document.getElementById('answer-textarea');
            textarea.addEventListener('input', function() {
                if (!essayQuestions || essayQuestions.length === 0) return;
                userAnswers[currentQuestionIndex] = this.value;
                if (currentRecordId) {
                    database.ref(`records/${currentRecordId}/userAnswers`).set(userAnswers);
                }
                checkAllAnswered();
            });
        }

        // ===== ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ŸÜŸÇŸÑ =====
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentQuestionIndex < currentSettings.questionsCount - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        });

        // ===== ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ŸàÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÜŸáÿßÿ¶Ÿä =====
        document.getElementById('submit-final-btn').addEventListener('click', async function() {
            if (!userAnswers || userAnswers.some(ans => !ans || !ans.trim())) {
                showNotification('ÿ£ŸÉŸÖŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÇŸäŸäŸÖ...';

            try {
                showLoading('ÿπŸàŸÜ ŸäŸÇŸäŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ...');

                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(selectedFile);
                });

                // ÿßŸÑÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿ´ÿßŸÜŸä: ÿßŸÑÿ™ŸÇŸäŸäŸÖ ŸÖÿπ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: createUnifiedPrompt(),
                        PDF_BASE64: base64
                    })
                });

                const evalText = await response.text();
                hideLoading();

                if (evalText.includes("INVALID") || evalText.includes("INSUFFICIENT")) {
                    throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ - ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ±ÿ≥ŸÑ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                }

                const evaluation = cleanJSONResponse(evalText);
                if (!evaluation) {
                    console.error('ÿßŸÑÿ±ÿØ ÿßŸÑÿÆÿßŸÖ:', evalText);
                    throw new Error('ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
                }

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                const evaluationCount = Object.keys(evaluation).length;
                if (evaluationCount !== currentSettings.questionsCount) {
                    throw new Error(`ÿπÿØÿØ ÿπŸÜÿßÿµÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖ (${evaluationCount}) ŸÑÿß Ÿäÿ∑ÿßÿ®ŸÇ ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© (${currentSettings.questionsCount})`);
                }

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑŸÉŸÑ ÿ≥ÿ§ÿßŸÑ
                for (let i = 1; i <= currentSettings.questionsCount; i++) {
                    const evalItem = evaluation[`ÿ™ŸÇŸäŸäŸÖ_${i}`];
                    if (!evalItem) {
                        throw new Error(`ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑÿ© - ÿßŸÑÿ≥ÿ§ÿßŸÑ ${i} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ`);
                    }
                    if (!evalItem["ÿßŸÑÿ≥ÿ§ÿßŸÑ"] || !evalItem["ÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ"] || !evalItem["ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©"] || !evalItem["ŸÜÿµŸäÿ≠ÿ©"]) {
                        throw new Error(`ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑÿ© ŸÑŸÑÿ≥ÿ§ÿßŸÑ ${i}`);
                    }
                }

                evaluationData = evaluation;

                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                if (currentRecordId) {
                    await database.ref(`records/${currentRecordId}/evaluation`).set(evaluationData);
                    await database.ref(`records/${currentRecordId}/submitted`).set(true);
                }

                // ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸäŸäŸÖ
                displayEvaluation();
                document.getElementById('essay-section').style.display = 'none';
                document.getElementById('evaluation-section').style.display = 'block';
                showNotification('ÿ™ŸÖ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');

            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÇŸäŸäŸÖ:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÇŸäŸäŸÖ: ' + error.message, 'error');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check-double"></i> ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™';
            }
        });

        function displayEvaluation() {
            const container = document.getElementById('evaluation-container');
            if (!evaluationData) return;

            let html = '';
            
            // ÿßŸÑŸÖÿ±Ÿàÿ± ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿπŸÜÿßÿµÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖ
            for (let i = 1; i <= currentSettings.questionsCount; i++) {
                const evalItem = evaluationData[`ÿ™ŸÇŸäŸäŸÖ_${i}`];
                if (!evalItem) continue;

                const question = evalItem["ÿßŸÑÿ≥ÿ§ÿßŸÑ"] || '';
                const userAnswer = evalItem["ÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ"] || '';
                const modelAnswer = evalItem["ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©_ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ©"] || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
                const advice = evalItem["ŸÜÿµŸäÿ≠ÿ©"] || 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿµŸäÿ≠ÿ©';

                html += `
                    <div class="evaluation-card">
                        <div class="evaluation-question-header">
                            <div class="evaluation-question-text">ÿ≥ÿ§ÿßŸÑ ${i}: ${question}</div>
                        </div>
                        
                        <div class="evaluation-answers-grid">
                            <div class="user-answer-box">
                                <div class="answer-title">
                                    <i class="fas fa-user" style="color: #2196F3;"></i>
                                    ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ:
                                </div>
                                <div class="answer-content">${userAnswer}</div>
                            </div>
                            
                            <div class="model-answer-box">
                                <div class="answer-title">
                                    <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                                    ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨Ÿäÿ© ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ:
                                </div>
                                <div class="answer-content">${modelAnswer}</div>
                            </div>
                        </div>
                        
                        <div class="advice-box">
                            <div class="advice-title">
                                <i class="fas fa-lightbulb" style="color: #FFC107;"></i>
                                ŸÜÿµŸäÿ≠ÿ© ŸÖÿÆÿµÿµÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ:
                            </div>
                            <div class="advice-text">${advice}</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // ===== ÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ¨ŸÑ =====
        async function saveRecord(action) {
            if (!currentUser) return;
            const recordId = 'essay_' + Date.now();
            currentRecordId = recordId;
            const recordData = {
                id: currentUser.id,
                process: 'ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖŸÇÿßŸÑŸäÿ©',
                fileName: fileInfo.name,
                settings: currentSettings,
                questions: essayQuestions,
                userAnswers: userAnswers,
                timestamp: Date.now(),
                evaluation: evaluationData || null,
                submitted: !!evaluationData
            };
            await database.ref(`records/${recordId}`).set(recordData);
        }

        // ===== ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ =====
        function setupRecords() {
            const modal = document.getElementById('records-modal');
            const recordsBtn = document.getElementById('records-btn');
            const closeBtn = document.getElementById('close-records-btn');

            recordsBtn.addEventListener('click', showRecords);
            closeBtn.addEventListener('click', () => modal.classList.remove('show'));

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });
        }

        async function showRecords() {
            const modal = document.getElementById('records-modal');
            const listDiv = document.getElementById('records-list');
            const noRecords = document.getElementById('no-records');

            if (!currentUser) return;

            listDiv.innerHTML = '<div class="no-records"><i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>';
            modal.classList.add('show');

            try {
                const snapshot = await database.ref('records')
                    .orderByChild('id')
                    .equalTo(currentUser.id)
                    .once('value');

                listDiv.innerHTML = '';

                if (snapshot.exists()) {
                    const records = [];
                    snapshot.forEach(child => {
                        const record = child.val();
                        records.push({
                            key: child.key,
                            ...record
                        });
                    });
                    
                    records.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    records.forEach(rec => {
                        const card = document.createElement('div');
                        card.className = 'record-card';
                        
                        const date = new Date(rec.timestamp || Date.now()).toLocaleString('ar-EG');
                        const status = rec.evaluation ? '‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ŸÇŸäŸäŸÖ' : '‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©';
                        const statusClass = rec.evaluation ? 'record-status' : 'record-status pending';
                        const settings = rec.settings || {};
                        
                        card.innerHTML = `
                            <div class="record-file-name">
                                <i class="fas fa-file-pdf"></i> ${rec.fileName || 'ŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}
                            </div>
                            <div class="record-meta">
                                <span><i class="fas fa-list-ol"></i> ${settings.questionsCount || 0} ÿ≥ÿ§ÿßŸÑ</span>
                                <span><i class="fas fa-chart-line"></i> ${settings.difficulty || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                                <span><i class="fas fa-coins"></i> ${settings.totalCost || 0} ÿπŸÖŸÑÿ©</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                                <span class="${statusClass}">${status}</span>
                                <span style="color:var(--text-secondary); font-size:0.85rem;">${date}</span>
                            </div>
                        `;
                        
                        card.addEventListener('click', () => loadEssayRecord(rec));
                        listDiv.appendChild(card);
                    });

                    noRecords.style.display = 'none';
                } else {
                    listDiv.innerHTML = '';
                    noRecords.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading records:', error);
                listDiv.innerHTML = '<div class="no-records">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™</div>';
            }
        }

        function loadEssayRecord(rec) {
            document.getElementById('records-modal').classList.remove('show');

            fileInfo = { name: rec.fileName, baseCost: 5 };
            currentSettings = rec.settings || { questionsCount: 8, difficulty: 'ÿ≥ŸáŸÑ', extraCost: 0, totalCost: 5 };
            essayQuestions = rec.questions || [];
            userAnswers = rec.userAnswers || [];
            evaluationData = rec.evaluation || null;
            currentRecordId = rec.key;
            currentRecord = rec;

            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';
            document.getElementById('essay-section').style.display = 'none';
            document.getElementById('evaluation-section').style.display = 'none';

            if (evaluationData) {
                displayEvaluation();
                document.getElementById('evaluation-section').style.display = 'block';
                hideFooter();
            } else {
                document.getElementById('essay-section').style.display = 'block';
                currentQuestionIndex = 0;
                showNotification('Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ¨ŸÑ ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÇŸäŸäŸÖŸá ÿ®ÿπÿØ. ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ ÿ´ŸÖ ÿ≥ŸÑŸÖ', 'info');
                renderQuestion();
                hideFooter();
            }
        }

        // ===== ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© =====
        document.getElementById('home-logo').addEventListener('click', () => {
            window.location.reload();
        });

        document.getElementById('developer-credit').addEventListener('click', () => {
            window.open('https://t.me/X5Coder', '_blank');
        });

        // ===== ÿßŸÑÿ™ŸáŸäÿ¶ÿ© =====
        async function init() {
            showLoading('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...');
            
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.replace('login.html');
                    return;
                }

                const loaded = await loadUserData();
                if (!loaded) return;

                setupFileUpload();
                setupSettingsEvents();
                setupRecords();
                setupAutoSave();

                document.getElementById('settings-section').style.display = 'none';
                document.getElementById('essay-section').style.display = 'none';
                document.getElementById('evaluation-section').style.display = 'none';

                hideLoading();
            });
        }

        history.pushState(null, null, location.href);
        window.addEventListener('popstate', () => history.pushState(null, null, location.href));

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
