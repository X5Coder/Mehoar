<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>عون - نظام الأسئلة الذكي</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-color: #F5F1E8;
            --card-color: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-primary: #8B7355;
            --accent-secondary: #A9927D;
            --accent-dark: #5D4037;
            --border-color: #D4A574;
            --border-radius: 16px;
            --border-radius-lg: 20px;
            --border-radius-xl: 24px;
            --navbar-height: 70px;
            --transition-smooth: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --info-color: #2196F3;
            --gradient-primary: linear-gradient(145deg, #8B7355 0%, #A9927D 100%);
            --gradient-success: linear-gradient(145deg, #4CAF50 0%, #45a049 100%);
            --gradient-error: linear-gradient(145deg, #F44336 0%, #d32f2f 100%);
            --shadow-light: 0 4px 12px rgba(139, 115, 85, 0.1);
            --shadow-medium: 0 8px 24px rgba(139, 115, 85, 0.15);
            --shadow-heavy: 0 12px 36px rgba(139, 115, 85, 0.2);
        }
        
        body {
            font-family: 'Almarai', 'Tajawal', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            width: 100vw;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 800;
            font-size: 56px;
            color: var(--accent-primary);
            margin-bottom: 25px;
            letter-spacing: -1px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .loading-spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(139, 115, 85, 0.1);
            border-left-color: var(--accent-primary);
            border-right-color: var(--accent-secondary);
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-primary);
            font-size: 1.3rem;
            text-align: center;
            max-width: 80%;
            line-height: 1.8;
            font-weight: 600;
            background: rgba(139, 115, 85, 0.1);
            padding: 15px 30px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 115, 85, 0.2);
        }
        
        .loading-subtext {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 15px;
            opacity: 0.8;
        }
        
        /* Navbar */
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: rgba(245, 241, 232, 0.9);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 max(25px, env(safe-area-inset-right));
            z-index: 10000;
            border-bottom: 1px solid rgba(139, 115, 85, 0.15);
            box-shadow: var(--shadow-light);
            padding-top: env(safe-area-inset-top);
        }
        
        .logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 42px;
            color: var(--accent-primary);
            cursor: pointer;
            transition: var(--transition-smooth);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .logo:hover {
            transform: scale(1.05) rotate(-2deg);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        
        .coins-display {
            background: var(--gradient-primary);
            color: white;
            padding: 12px 25px;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-light);
            transition: var(--transition-smooth);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .coins-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .coins-display i {
            font-size: 18px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }
        
        /* Main Content */
        .main-content {
            padding-top: calc(var(--navbar-height) + 20px);
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            padding-bottom: 50px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - var(--navbar-height) - 70px);
        }
        
        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: var(--shadow-medium);
            text-align: center;
            border: 1px solid rgba(139, 115, 85, 0.12);
            width: 100%;
            max-width: 900px;
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-title {
            font-family: 'Almarai', sans-serif;
            font-size: clamp(1.8rem, 4vw, 2.2rem);
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.1);
        }
        
        .section-subtitle {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: clamp(1rem, 2vw, 1.1rem);
            margin-bottom: 30px;
            font-weight: 400;
            text-align: center;
            line-height: 1.6;
        }
        
        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: min(50px, 8vh) 25px;
            margin-bottom: 30px;
            cursor: pointer;
            transition: var(--transition-smooth);
            background: rgba(212, 165, 116, 0.05);
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(139, 115, 85, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(212, 165, 116, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .upload-icon {
            font-size: clamp(48px, 8vw, 56px);
            color: var(--accent-primary);
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .upload-text {
            font-family: 'Tajawal', sans-serif;
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .upload-hint {
            font-family: 'Tajawal', sans-serif;
            font-size: clamp(0.9rem, 2vw, 0.95rem);
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Cost Preview */
        .cost-preview {
            background: rgba(139, 115, 85, 0.06);
            border-radius: var(--border-radius-xl);
            padding: 25px;
            margin-top: 30px;
            border: 1px solid rgba(139, 115, 85, 0.12);
            display: none;
            animation: slideUp 0.4s ease-out;
        }
        
        .cost-preview.show {
            display: block;
        }
        
        .cost-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .cost-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .cost-item {
            text-align: center;
            flex: 1;
            min-width: 160px;
        }
        
        .cost-label {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .cost-value {
            font-family: 'Almarai', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .cost-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Buttons */
        .action-btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            min-width: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow-button);
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .action-btn:active::after {
            width: 300px;
            height: 300px;
        }
        
        .action-btn:active {
            transform: scale(0.98);
        }
        
        .confirm-btn {
            background: var(--gradient-success);
            color: white;
        }
        
        .cancel-btn {
            background: var(--gradient-error);
            color: white;
        }
        
        /* Questions Settings Section */
        .questions-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(139, 115, 85, 0.12);
            display: none;
            animation: slideUp 0.4s ease-out;
            width: 100%;
            max-width: 900px;
        }
        
        .questions-section.show {
            display: block;
        }
        
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(300px, 100%), 1fr));
            gap: 30px;
            margin-bottom: 35px;
        }
        
        .question-group {
            background: rgba(139, 115, 85, 0.04);
            border-radius: var(--border-radius-xl);
            padding: 25px;
            border: 1px solid rgba(139, 115, 85, 0.12);
            transition: var(--transition-smooth);
        }
        
        .question-group:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-light);
            border-color: var(--accent-primary);
        }
        
        .question-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Type Selection */
        .type-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .type-btn {
            padding: 14px 16px;
            border: 2px solid rgba(139, 115, 85, 0.25);
            border-radius: var(--border-radius);
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            min-height: 48px;
            position: relative;
            overflow: hidden;
        }
        
        .type-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }
        
        .type-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-medium);
        }
        
        /* Slider */
        .slider-container {
            padding: 25px 0;
        }
        
        .slider-value {
            font-family: 'Almarai', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.2);
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .slider {
            width: 100%;
            height: 25px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary));
            outline: none;
            border-radius: 12px;
            position: relative;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 38px;
            height: 38px;
            border-radius: var(--border-radius);
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            border: 4px solid white;
            transition: var(--transition-smooth);
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2) rotate(10deg);
            box-shadow: var(--shadow-heavy);
        }
        
        .max-questions {
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 15px;
            padding: 10px;
            background: rgba(139, 115, 85, 0.08);
            border-radius: var(--border-radius);
        }
        
        .max-questions span {
            color: var(--accent-primary);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        /* Difficulty Options */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }
        
        .option-btn {
            padding: 14px 16px;
            border: 2px solid rgba(139, 115, 85, 0.25);
            border-radius: var(--border-radius);
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            min-height: 48px;
        }
        
        .option-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }
        
        .option-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-medium);
        }
        
        .additional-cost {
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 15px;
        }
        
        .additional-cost span {
            color: var(--success-color);
            font-weight: 700;
        }
        
        .generate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 18px 45px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: block;
            margin: 0 auto;
            min-width: min(280px, 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: var(--shadow-button);
            position: relative;
            overflow: hidden;
        }
        
        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .generate-btn:hover::before {
            left: 100%;
        }
        
        .generate-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: var(--shadow-button-hover);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Questions Display Section - 2 Column View */
        .questions-display-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.12);
            display: none;
            animation: slideUp 0.4s ease-out;
            width: 100%;
            max-width: 1400px;
        }
        
        .questions-display-section.show {
            display: block;
        }
        
        .display-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(139, 115, 85, 0.15);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .display-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .display-info {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            background: rgba(139, 115, 85, 0.08);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        /* 2 Column Grid */
        .questions-grid-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 992px) {
            .questions-grid-2col {
                grid-template-columns: 1fr;
            }
        }
        
        .question-card {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 25px;
            border: 1px solid rgba(139, 115, 85, 0.15);
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-light);
            height: fit-content;
        }
        
        .question-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            border-color: var(--accent-primary);
        }
        
        .question-card.correct {
            border-right: 8px solid var(--success-color);
            background: linear-gradient(145deg, white, rgba(76, 175, 80, 0.05));
        }
        
        .question-card.incorrect {
            border-right: 8px solid var(--error-color);
            background: linear-gradient(145deg, white, rgba(244, 67, 54, 0.05));
        }
        
        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .question-number-badge {
            background: var(--accent-primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.3rem;
            box-shadow: var(--shadow-light);
        }
        
        .question-type-badge {
            background: rgba(139, 115, 85, 0.15);
            color: var(--accent-primary);
            padding: 8px 18px;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .question-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.2rem;
            line-height: 1.8;
            color: var(--text-primary);
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(139, 115, 85, 0.04);
            border-radius: var(--border-radius);
            border: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        /* Options */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: white;
            border-radius: var(--border-radius);
            border: 2px solid rgba(139, 115, 85, 0.2);
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
        }
        
        .option-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(-5px);
            box-shadow: var(--shadow-light);
        }
        
        .option-item.selected {
            border-color: var(--accent-primary);
            background: rgba(139, 115, 85, 0.1);
        }
        
        .option-item.correct-answer {
            border-color: var(--success-color);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .option-item.wrong-answer {
            border-color: var(--error-color);
            background: rgba(244, 67, 54, 0.1);
        }
        
        .option-marker {
            width: 35px;
            height: 35px;
            border-radius: var(--border-radius);
            background: rgba(139, 115, 85, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--accent-primary);
            transition: var(--transition-smooth);
        }
        
        .option-item.selected .option-marker {
            background: var(--accent-primary);
            color: white;
        }
        
        .option-item.correct-answer .option-marker {
            background: var(--success-color);
            color: white;
        }
        
        .option-item.wrong-answer .option-marker {
            background: var(--error-color);
            color: white;
        }
        
        /* Result indicators */
        .result-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
            font-family: 'Tajawal', sans-serif;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-indicator.correct {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success-color);
        }
        
        .result-indicator.incorrect {
            background: rgba(244, 67, 54, 0.15);
            color: var(--error-color);
        }
        
        .model-answer {
            margin-top: 20px;
            padding: 20px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: var(--border-radius);
            border-right: 5px solid var(--info-color);
            font-family: 'Tajawal', sans-serif;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .model-answer-title {
            font-weight: 700;
            color: var(--info-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .model-answer-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
        }
        
        /* Essay answer input */
        .essay-answer-input {
            margin-top: 20px;
        }
        
        .essay-answer-input textarea {
            width: 100%;
            padding: 20px;
            border: 2px solid rgba(139, 115, 85, 0.2);
            border-radius: var(--border-radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            line-height: 1.8;
            resize: vertical;
            min-height: 150px;
            transition: var(--transition-smooth);
            background: white;
        }
        
        .essay-answer-input textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-light);
        }
        
        .essay-answer-input textarea:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Submit Button */
        .submit-answers-btn {
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 20px 50px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: block;
            margin: 40px auto 20px;
            min-width: min(320px, 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: var(--shadow-button);
            position: relative;
            overflow: hidden;
        }
        
        .submit-answers-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .submit-answers-btn:hover::before {
            left: 100%;
        }
        
        .submit-answers-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .submit-answers-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: var(--shadow-button-hover);
        }
        
        .submit-answers-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Results Summary */
        .results-summary {
            background: linear-gradient(145deg, white, rgba(139, 115, 85, 0.05));
            border-radius: var(--border-radius-xl);
            padding: 40px;
            margin: 40px 0;
            border: 1px solid rgba(139, 115, 85, 0.15);
            animation: scaleIn 0.6s ease-out;
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .score-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 50px;
            flex-wrap: wrap;
        }
        
        .score-circle {
            position: relative;
            width: 180px;
            height: 180px;
        }
        
        .score-circle-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(139, 115, 85, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .score-circle-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0deg, var(--success-color) 0deg, transparent 0deg);
            transition: all 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .score-circle-inner {
            position: absolute;
            width: 70%;
            height: 70%;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: var(--shadow-medium);
        }
        
        .score-percentage {
            font-family: 'Almarai', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .score-info {
            text-align: center;
        }
        
        .score-info h3 {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-primary);
            margin-bottom: 10px;
        }
        
        .score-info p {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        
        .encouragement-message {
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            font-size: 1.6rem;
            color: var(--accent-primary);
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            border-right: 5px solid var(--accent-primary);
            animation: pulse 2s infinite;
        }
        
        /* Essay Results */
        .essay-results {
            margin-top: 50px;
        }
        
        .essay-results-title {
            font-family: 'Almarai', sans-serif;
            font-size: 2rem;
            color: var(--accent-primary);
            margin-bottom: 40px;
            text-align: center;
            position: relative;
        }
        
        .essay-results-title::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--accent-primary);
            border-radius: 3px;
        }
        
        .essay-answer-box {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(139, 115, 85, 0.15);
            box-shadow: var(--shadow-light);
            transition: var(--transition-smooth);
        }
        
        .essay-answer-box:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        
        .essay-answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(139, 115, 85, 0.1);
        }
        
        .essay-answer-number {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
        }
        
        .essay-question-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(139, 115, 85, 0.06);
            border-radius: var(--border-radius);
        }
        
        .essay-user-answer {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(33, 150, 243, 0.08);
            border-radius: var(--border-radius);
            border-right: 5px solid var(--info-color);
        }
        
        .essay-user-answer-title {
            font-weight: 700;
            color: var(--info-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .essay-model-answer {
            padding: 20px;
            background: rgba(76, 175, 80, 0.08);
            border-radius: var(--border-radius);
            border-right: 5px solid var(--success-color);
        }
        
        .essay-model-answer-title {
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 45px 20px;
            color: var(--text-secondary);
            border-top: 1px solid rgba(139, 115, 85, 0.12);
            margin-top: 45px;
            width: 100%;
            max-width: 900px;
        }
        
        .footer.hidden {
            display: none;
        }
        
        .copyright {
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            margin-bottom: 35px;
        }
        
        .support-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 35px;
        }
        
        .support-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 12px;
        }
        
        .support-links {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .support-link {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius);
            background: var(--gradient-primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-button);
            position: relative;
            overflow: hidden;
        }
        
        .support-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .support-link:hover::before {
            left: 100%;
        }
        
        .support-link:active {
            transform: scale(0.95);
        }
        
        .support-link:hover {
            transform: translateY(-5px) rotate(5deg);
            box-shadow: var(--shadow-button-hover);
        }
        
        .support-link i {
            font-size: 28px;
            color: white;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }
        
        .developer-credit {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            color: rgba(100, 116, 139, 0.6);
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(139, 115, 85, 0.06);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .developer-credit:hover {
            color: var(--accent-primary);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: calc(var(--navbar-height) + 20px);
            right: max(20px, env(safe-area-inset-right));
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.12);
            z-index: 10001;
            min-width: min(320px, 90vw);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-right: 5px solid var(--success-color);
        }
        
        .notification.error {
            border-right: 5px solid var(--error-color);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-icon {
            font-size: 24px;
        }
        
        .notification.success .notification-icon {
            color: var(--success-color);
        }
        
        .notification.error .notification-icon {
            color: var(--error-color);
        }
        
        .notification-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.05rem;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(139, 115, 85, 0.1);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .native-navbar {
                padding: 0 20px;
                padding-top: env(safe-area-inset-top);
                height: calc(65px + env(safe-area-inset-top));
            }
            
            .logo {
                font-size: 32px;
            }
            
            .coins-display {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .main-content {
                padding-top: calc(65px + env(safe-area-inset-top) + 20px);
                padding-left: 20px;
                padding-right: 20px;
            }
            
            .upload-section, .questions-section, .questions-display-section {
                padding: 25px 20px;
            }
            
            .upload-area {
                padding: 35px 20px;
            }
            
            .cost-details {
                flex-direction: column;
            }
            
            .cost-actions {
                flex-direction: column;
            }
            
            .action-btn {
                min-width: 100%;
            }
            
            .type-options {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .display-header {
                flex-direction: column;
                text-align: center;
            }
            
            .question-header {
                justify-content: center;
            }
            
            .score-container {
                flex-direction: column;
                text-align: center;
            }
            
            .score-circle {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen" style="display: none;">
        <div class="loading-logo">عون</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">جاري التحميل...</div>
        <div class="loading-subtext" id="loading-subtext"></div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="native-navbar" id="navbar">
        <div class="logo" id="home-logo">عون</div>
        <div class="nav-left">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <h1 class="section-title">نظام الأسئلة الذكي</h1>
            <p class="section-subtitle">ارفع ملف PDF الخاص بك واحصل على أسئلة ذكية باستخدام الذكاء الاصطناعي المتقدم</p>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="upload-text" id="upload-text">انقر لرفع ملف PDF</div>
                <div class="upload-hint">أو اسحب وأفلت الملف هنا</div>
            </div>
            
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
            
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">تفاصيل التكلفة الأساسية</h3>
                <div class="cost-details">
                    <div class="cost-item">
                        <div class="cost-label">عدد الصفحات</div>
                        <div class="cost-value" id="page-count">0</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">التكلفة الأساسية</div>
                        <div class="cost-value" id="cost-amount">0 عملة</div>
                    </div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" id="cancel-btn">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="action-btn confirm-btn" id="confirm-btn">
                        <i class="fas fa-check"></i>
                        متابعة
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Questions Settings Section -->
        <section class="questions-section" id="questions-section">
            <h2 class="section-title">إعدادات الأسئلة</h2>
            <p class="section-subtitle">اختر نوع الأسئلة وعددها ودرجة الصعوبة</p>
            
            <div class="questions-grid">
                <!-- نوع الأسئلة -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-question-circle"></i>
                        نوع الأسئلة
                    </h3>
                    <div class="type-options" id="question-type">
                        <button class="type-btn selected" data-value="اختياري">اختياري</button>
                        <button class="type-btn" data-value="صح وخطأ">صح وخطأ</button>
                        <button class="type-btn" data-value="مقالي">مقالي</button>
                    </div>
                </div>
                
                <!-- عدد الأسئلة -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-sort-numeric-up"></i>
                        عدد الأسئلة
                    </h3>
                    <div class="slider-container">
                        <div class="slider-value" id="questions-count">10</div>
                        <div class="slider-labels">
                            <span id="min-label">1</span>
                            <span id="max-label">80</span>
                        </div>
                        <input type="range" min="1" max="80" value="10" class="slider" id="questions-slider">
                        <div class="max-questions" id="max-questions-info">
                            الحد الأقصى: <span id="max-questions-value">80</span> سؤال
                        </div>
                        <div class="additional-cost" id="additional-cost">
                            تكلفة إضافية: <span id="extra-cost">0</span> عملة
                        </div>
                    </div>
                </div>
                
                <!-- درجة الصعوبة -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-chart-line"></i>
                        درجة الصعوبة
                    </h3>
                    <div class="options-grid" id="difficulty-level">
                        <button class="option-btn selected" data-value="سهل">سهل</button>
                        <button class="option-btn" data-value="متوسط">متوسط</button>
                        <button class="option-btn" data-value="صعب">صعب</button>
                    </div>
                </div>
                
                <!-- التكلفة النهائية -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-calculator"></i>
                        التكلفة النهائية
                    </h3>
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-family: 'Almarai', sans-serif; color: var(--text-secondary); font-size: 1rem; margin-bottom: 8px;">
                            التكلفة الأساسية
                        </div>
                        <div style="font-family: 'Almarai', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--accent-primary); margin-bottom: 12px;" id="base-cost-display">
                            0 عملة
                        </div>
                        <div style="height: 2px; background: rgba(139, 115, 85, 0.2); margin: 15px 0;"></div>
                        <div style="font-family: 'Almarai', sans-serif; color: var(--text-secondary); font-size: 1rem; margin-bottom: 8px;">
                            التكلفة الإضافية
                        </div>
                        <div style="font-family: 'Almarai', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--success-color); margin-bottom: 12px;" id="total-extra-cost">
                            +0 عملة
                        </div>
                        <div style="height: 2px; background: rgba(139, 115, 85, 0.2); margin: 15px 0;"></div>
                        <div style="font-family: 'Almarai', sans-serif; color: var(--accent-primary); font-size: 1rem; margin-bottom: 8px;">
                            التكلفة الإجمالية
                        </div>
                        <div style="font-family: 'Almarai', sans-serif; font-size: 2.5rem; font-weight: 900; color: var(--accent-primary);" id="total-cost-display">
                            0 عملة
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="generate-btn" id="generate-btn">
                <i class="fas fa-robot"></i>
                إنشاء الأسئلة
            </button>
        </section>
        
        <!-- Questions Display Section -->
        <section class="questions-display-section" id="questions-display-section">
            <div class="display-header">
                <h2 class="display-title" id="display-title">الأسئلة</h2>
                <div class="display-info" id="display-info">
                    <span id="question-type-display">اختياري</span> | 
                    <span id="question-count-display">10</span> أسئلة | 
                    <span id="question-difficulty-display">سهل</span>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar-container" id="progress-bar-container">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
            </div>
            
            <!-- Questions Grid - 2 Columns -->
            <div class="questions-grid-2col" id="questions-container">
                <!-- سيتم إضافة الأسئلة هنا ديناميكياً -->
            </div>
            
            <button class="submit-answers-btn" id="submit-answers-btn" disabled>
                <i class="fas fa-check-circle"></i>
                تسليم الإجابات
            </button>
            
            <div class="results-summary" id="results-summary" style="display: none;">
                <div class="score-container">
                    <div class="score-circle">
                        <div class="score-circle-bg">
                            <div class="score-circle-fill" id="score-fill"></div>
                        </div>
                        <div class="score-circle-inner">
                            <div class="score-percentage" id="score-percentage">0%</div>
                        </div>
                    </div>
                    <div class="score-info">
                        <h3>نتيجتك</h3>
                        <p id="score-details">0 من 0</p>
                    </div>
                </div>
                <div class="encouragement-message" id="encouragement-message">
                    أحسنت! استمر في التعلم
                </div>
            </div>
            
            <div class="essay-results" id="essay-results" style="display: none;">
                <h3 class="essay-results-title">الإجابات النموذجية للأسئلة المقالية</h3>
                <div id="essay-answers-container"></div>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer" id="footer">
            <p class="copyright">جميع الحقوق محفوظة لمنصة عون © 2026</p>
            
            <div class="support-section">
                <div class="support-title">تواصل مع الدعم الفني</div>
                <div class="support-links">
                    <a href="https://wa.me/966583617539" target="_blank" class="support-link">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://t.me/HNHv1" target="_blank" class="support-link">
                        <i class="fab fa-telegram"></i>
                    </a>
                </div>
            </div>
            
            <div class="developer-credit">
                برمجة وتصميم المطور 𝐊𝐈𝐌𝐎
            </div>
        </footer>
    </div>
    
    <script>
        // تهيئة PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // تهيئة Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // المتغيرات العامة
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let fileInfo = {
            name: '',
            size: 0,
            pages: 0,
            words: 0,
            baseCost: 0
        };
        
        let currentSettings = {
            questionsCount: 10,
            questionType: 'اختياري',
            difficulty: 'سهل',
            totalCost: 0,
            extraCost: 0,
            maxQuestions: 80
        };
        
        let questionsData = null;
        let userAnswers = [];
        let answersSubmitted = false;
        
        // إعدادات السيرفر
        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";
        
        // رسائل التحميل
        const loadingMessages = [
            { main: 'عون يحلل إجاباتك...', sub: 'جاري فحص الإجابات بدقة' },
            { main: 'عون يصحح الأسئلة...', sub: 'باستخدام أحدث تقنيات الذكاء الاصطناعي' },
            { main: 'عون يحسب النتائج...', sub: 'تجميع وتحليل الإجابات' },
            { main: 'عون يجهز التقرير...', sub: 'تنسيق النتائج النهائية' },
            { main: 'عون يراجع الأداء...', sub: 'مقارنة بالإجابات النموذجية' }
        ];
        
        // ========== الوظائف الأساسية ==========
        
        function reloadPage() {
            location.reload();
        }
        
        function showNotification(message, type = 'info') {
            try {
                const notification = document.getElementById('notification');
                const notificationIcon = document.getElementById('notification-icon');
                const notificationText = document.getElementById('notification-text');
                
                if (!notification || !notificationIcon || !notificationText) return;
                
                notificationText.textContent = message;
                notification.className = 'notification';
                
                if (type === 'success') {
                    notification.classList.add('success');
                    notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                } else if (type === 'error') {
                    notification.classList.add('error');
                    notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                } else {
                    notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } catch (error) {
                console.error('Error in showNotification:', error);
            }
        }
        
        function showLoading(text = 'جاري التحميل...', subtext = '') {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            const loadingSubtext = document.getElementById('loading-subtext');
            
            if (loadingScreen && loadingText) {
                loadingText.textContent = text;
                if (loadingSubtext) loadingSubtext.textContent = subtext;
                loadingScreen.style.display = 'flex';
                setTimeout(() => {
                    loadingScreen.style.opacity = '1';
                }, 10);
            }
        }
        
        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            }
        }
        
        function hideFooter() {
            const footer = document.getElementById('footer');
            if (footer) {
                footer.classList.add('hidden');
            }
        }
        
        function showFooter() {
            const footer = document.getElementById('footer');
            if (footer) {
                footer.classList.remove('hidden');
            }
        }
        
        // تحديث شريط التقدم
        function updateProgressBar() {
            if (!questionsData) return;
            
            const answeredCount = userAnswers.filter(answer => answer !== null && answer !== undefined).length;
            const totalQuestions = questionsData.length;
            const percentage = (answeredCount / totalQuestions) * 100;
            
            const progressBar = document.getElementById('progress-bar-fill');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            
            // تفعيل/تعطيل زر التسليم
            const submitBtn = document.getElementById('submit-answers-btn');
            if (submitBtn) {
                const allAnswered = userAnswers.every((answer, index) => {
                    const question = questionsData[index];
                    if (question.type === 'مقالي') {
                        return answer && answer.essay && answer.essay.trim() !== '';
                    } else {
                        return answer !== null && answer !== undefined;
                    }
                });
                
                submitBtn.disabled = !allAnswered || answersSubmitted;
                
                if (allAnswered && !answersSubmitted) {
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                } else {
                    submitBtn.style.opacity = '0.6';
                    submitBtn.style.cursor = 'not-allowed';
                }
            }
        }
        
        // ========== إدارة المستخدم ==========
        
        async function loadUserData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    window.location.replace('login.html');
                    return;
                }
                
                const usersRef = database.ref('users_Awn');
                const snapshot = await usersRef.once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    let userFound = false;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userId !== 'noty_publick' && userData.email === user.email) {
                            currentUser = {
                                id: userId,
                                email: userData.email,
                                name: userData.name || '',
                                coin: userData.coin || 0,
                                admin: userData.admin === true || false,
                                banned: userData.banned === true || false
                            };
                            
                            userCoins = userData.coin || 0;
                            const coinsCount = document.getElementById('coins-count');
                            if (coinsCount) {
                                coinsCount.textContent = userCoins;
                            }
                            userFound = true;
                            break;
                        }
                    }
                    
                    if (!userFound) {
                        await auth.signOut();
                        window.location.replace('login.html');
                    }
                } else {
                    await auth.signOut();
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.location.replace('login.html');
            }
        }
        
        async function setupUser() {
            try {
                await loadUserData();
                
                if (currentUser && currentUser.banned !== true) {
                    const navbar = document.getElementById('navbar');
                    const mainContent = document.getElementById('main-content');
                    
                    if (navbar) navbar.style.display = 'flex';
                    if (mainContent) mainContent.style.display = 'block';
                    
                    showFooter();
                } else {
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error setting up user:', error);
                window.location.replace('login.html');
            }
        }
        
        // ========== إدارة الملفات ==========
        
        function setupFileUpload() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadArea = document.getElementById('upload-area');
            const confirmBtn = document.getElementById('confirm-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            if (pdfFile) {
                pdfFile.addEventListener('change', handleFileSelect);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('click', () => pdfFile.click());
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmProcess);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelProcess);
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-primary)';
                uploadArea.style.backgroundColor = 'rgba(212, 165, 116, 0.1)';
            }
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                await handleFile(files[0]);
            }
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            await handleFile(file);
        }
        
        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showNotification('الرجاء رفع ملف PDF فقط', 'error');
                resetFileInput();
                return;
            }
            
            selectedFile = file;
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            
            if (uploadText) uploadText.textContent = file.name;
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-primary)';
                uploadArea.style.backgroundColor = 'rgba(212, 165, 116, 0.1)';
            }
            
            await analyzePDF(file);
        }
        
        async function analyzePDF(file) {
            try {
                const pdfLoadingMessages = [
                    'عون يحلل الملف...',
                    'عون يستخرج النص...',
                    'عون يعد الصفحات...',
                    'عون يحسب التكلفة...'
                ];
                
                let messageIndex = 0;
                const loadingInterval = setInterval(() => {
                    showLoading(pdfLoadingMessages[messageIndex]);
                    messageIndex = (messageIndex + 1) % pdfLoadingMessages.length;
                }, 1500);
                
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }
                
                clearInterval(loadingInterval);
                
                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;
                coins = Math.round(coins * 10) / 10;
                
                fileInfo = {
                    name: file.name,
                    size: file.size,
                    pages: pdf.numPages,
                    words: totalWords,
                    baseCost: coins
                };
                
                hideLoading();
                
                const pageCount = document.getElementById('page-count');
                const costAmount = document.getElementById('cost-amount');
                const costPreview = document.getElementById('cost-preview');
                const baseCostDisplay = document.getElementById('base-cost-display');
                
                if (pageCount) pageCount.textContent = fileInfo.pages;
                if (costAmount) costAmount.textContent = fileInfo.baseCost + ' عملة';
                if (baseCostDisplay) baseCostDisplay.textContent = fileInfo.baseCost + ' عملة';
                if (costPreview) costPreview.classList.add('show');
                
                updateTotalCost();
                
                showNotification('تم تحليل الملف بنجاح', 'success');
                
            } catch (error) {
                console.error('Error analyzing PDF:', error);
                hideLoading();
                showNotification('حدث خطأ أثناء تحليل الملف', 'error');
                resetFileInput();
            }
        }
        
        function resetFileInput() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            const costPreview = document.getElementById('cost-preview');
            
            if (pdfFile) pdfFile.value = '';
            selectedFile = null;
            if (uploadText) uploadText.textContent = 'انقر لرفع ملف PDF';
            if (uploadArea) {
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
            }
            if (costPreview) costPreview.classList.remove('show');
        }
        
        function cancelProcess() {
            resetFileInput();
            const costPreview = document.getElementById('cost-preview');
            if (costPreview) costPreview.classList.remove('show');
            showNotification('تم إلغاء العملية', 'info');
        }
        
        function confirmProcess() {
            const uploadSection = document.getElementById('upload-section');
            const questionsSection = document.getElementById('questions-section');
            const costPreview = document.getElementById('cost-preview');
            
            if (!uploadSection || !questionsSection || !costPreview) {
                showNotification('حدث خطأ في تحميل العناصر', 'error');
                return;
            }
            
            if (!fileInfo || !fileInfo.baseCost || fileInfo.baseCost === 0) {
                showNotification('الرجاء تحليل الملف أولاً', 'error');
                return;
            }
            
            if (userCoins < fileInfo.baseCost) {
                showNotification(`رصيدك غير كافي. تحتاج ${fileInfo.baseCost} عملة بينما رصيدك ${userCoins}`, 'error');
                return;
            }
            
            uploadSection.style.display = 'none';
            questionsSection.classList.add('show');
            costPreview.classList.remove('show');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('الرجاء تحديد نوع الأسئلة وعددها', 'success');
        }
        
        // ========== إعدادات الأسئلة ==========
        
        function setupQuestionsEvents() {
            // أزرار نوع الأسئلة
            const typeBtns = document.querySelectorAll('#question-type .type-btn');
            typeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.questionType = this.getAttribute('data-value');
                    updateMaxQuestions();
                    updateQuestionsCount();
                });
            });
            
            // إعداد السلايدر
            const questionsSlider = document.getElementById('questions-slider');
            if (questionsSlider) {
                questionsSlider.addEventListener('input', function() {
                    updateQuestionsCount();
                });
            }
            
            // أزرار الصعوبة
            const difficultyBtns = document.querySelectorAll('#difficulty-level .option-btn');
            difficultyBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    difficultyBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.difficulty = this.getAttribute('data-value');
                });
            });
            
            // زر إنشاء الأسئلة
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateQuestions);
            }
            
            updateMaxQuestions();
            updateQuestionsCount();
        }
        
        function updateMaxQuestions() {
            const maxLabel = document.getElementById('max-label');
            const maxQuestionsValue = document.getElementById('max-questions-value');
            const questionsSlider = document.getElementById('questions-slider');
            
            let maxQuestions = 80; // افتراضي للاختياري وصح وخطأ
            
            if (currentSettings.questionType === 'مقالي') {
                maxQuestions = 50;
            }
            
            currentSettings.maxQuestions = maxQuestions;
            
            if (maxLabel) maxLabel.textContent = maxQuestions;
            if (maxQuestionsValue) maxQuestionsValue.textContent = maxQuestions;
            if (questionsSlider) {
                questionsSlider.max = maxQuestions;
                if (parseInt(questionsSlider.value) > maxQuestions) {
                    questionsSlider.value = maxQuestions;
                }
            }
        }
        
        function updateQuestionsCount() {
            const slider = document.getElementById('questions-slider');
            const countDisplay = document.getElementById('questions-count');
            const extraCostDisplay = document.getElementById('extra-cost');
            
            if (!slider || !countDisplay) return;
            
            const count = parseInt(slider.value);
            countDisplay.textContent = count;
            currentSettings.questionsCount = count;
            
            // حساب التكلفة الإضافية حسب نوع الأسئلة
            let extraCost = 0;
            
            if (currentSettings.questionType === 'مقالي') {
                // أسئلة مقالية
                if (count >= 1 && count <= 10) {
                    extraCost = 0;
                } else if (count >= 11 && count <= 20) {
                    extraCost = 8;
                } else if (count >= 21 && count <= 30) {
                    extraCost = 8;
                } else if (count >= 31 && count <= 40) {
                    extraCost = 12;
                } else if (count >= 41 && count <= 50) {
                    extraCost = 12;
                }
            } else {
                // اختياري أو صح وخطأ
                if (count >= 1 && count <= 10) {
                    extraCost = 0;
                } else if (count >= 11 && count <= 20) {
                    extraCost = 0;
                } else if (count >= 21 && count <= 40) {
                    extraCost = 5;
                } else if (count >= 41 && count <= 60) {
                    extraCost = 8;
                } else if (count >= 61 && count <= 80) {
                    extraCost = 11;
                }
            }
            
            currentSettings.extraCost = extraCost;
            
            if (extraCostDisplay) {
                extraCostDisplay.textContent = extraCost;
            }
            
            updateTotalCost();
        }
        
        function updateTotalCost() {
            const totalExtraCostDisplay = document.getElementById('total-extra-cost');
            const totalCostDisplay = document.getElementById('total-cost-display');
            
            if (totalExtraCostDisplay && totalCostDisplay) {
                const baseCost = fileInfo.baseCost || 0;
                const extraCost = currentSettings.extraCost || 0;
                const totalCost = baseCost + extraCost;
                
                currentSettings.totalCost = totalCost;
                
                totalExtraCostDisplay.textContent = `+${extraCost} عملة`;
                totalCostDisplay.textContent = `${totalCost} عملة`;
            }
        }
        
        function createPrompt() {
            return `ROLE:
You are an AI specialized in strict PDF-based question generation following Google Gemini Flash 2.5 Lite standards.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES (IN ARABIC):
========================
عدد_الاسئلة = ${currentSettings.questionsCount}
درجة_الصعوبة = ${currentSettings.difficulty}
نوع_الاسئلة = ${currentSettings.questionType}

========================
TASK:
========================

1. Analyze the provided PDF from the first word to the last word only.
2. Do NOT use any external knowledge.
3. Do NOT infer, guess, paraphrase, or generate any content that does not explicitly exist inside the PDF.
4. Every word used in:
   - The question
   - The answer choices
   - The correct answer
   MUST exist verbatim inside the PDF text.
5. You must strictly generate exactly عدد_الاسئلة questions — no more, no less.
6. You must strictly follow the selected نوع_الاسئلة format.
7. You must strictly follow the selected درجة_الصعوبة definition:

   • سهل:
     - Questions must be direct and explicitly stated in the PDF.
     - Answers must be clearly found word-for-word in the text.

   • متوسط:
     - Questions must be logically derived only from the PDF content.
     - Still fully based on the PDF only.
     - No external additions allowed.

   • صعب:
     - Questions must require deep understanding of the entire PDF.
     - May combine multiple parts of the PDF.
     - Still 100% restricted to PDF content only.

8. The AI must read the entire PDF from beginning to end before generating questions.
9. If the PDF is empty, corrupted, unreadable, or contains no meaningful content, return exactly:

INVALID_PDF

========================
OUTPUT FORMAT RULES (STRICT):
========================

- Output MUST be plain text only.
- No JSON.
- No Markdown.
- No explanations.
- No commentary.
- No additional text before or after questions.
- No deviation from the required structure.

========================
FORMAT RULES PER QUESTION TYPE:
========================

If نوع_الاسئلة = اختياري

Return exactly in this format:

Type : اختياري
Q1 : السؤال
R : اختيار
R : اختيار
R : اختيار
R : اختيار
Correct : الاختيار الصحيح

(Repeat the same structure until reaching exactly عدد_الاسئلة)

All answer choices must exist inside the PDF.
All incorrect choices must also exist inside the PDF.
No fabricated text is allowed.

--------------------------------------------------

If نوع_الاسئلة = صح وخطأ

Return exactly in this format:

Type : صح وخطأ
Q1 : السؤال
R : صح
R : خطأ
Correct : الإجابة الصحيحة

(Repeat the same structure until reaching exactly عدد_الاسئلة)

The statement must be constructed strictly from PDF text only.

--------------------------------------------------

If نوع_الاسئلة = مقالي

Return exactly in this format:

Type : مقالي
Q1 : السؤال؟
R : إجابة
R : إجابة
R : إجابة
R : إجابة
Correct : الإجابة الصحيحة

(Repeat the same structure until reaching exactly عدد_الاسئلة)

All answer options must exist word-for-word inside the PDF.
The correct answer must be one of the listed answers.
No external wording allowed.

========================
ABSOLUTE CONSTRAINTS:
========================

- The number of questions must exactly equal عدد_الاسئلة.
- All generated content must come strictly from the PDF.
- No hallucination.
- No paraphrasing outside the PDF wording.
- No external knowledge.
- Deterministic behavior only.
- If any constraint cannot be satisfied, return exactly:

CONSTRAINT_VIOLATION`;
        }
        
        async function generateQuestions() {
            if (!selectedFile) {
                showNotification('الرجاء اختيار ملف PDF أولاً', 'error');
                return;
            }
            
            if (userCoins < currentSettings.totalCost) {
                showNotification(`رصيدك غير كافي. تحتاج ${currentSettings.totalCost} عملة بينما رصيدك ${userCoins}`, 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...';
            }
            
            try {
                const genLoadingMessages = [
                    'عون يحلل المحتوى...',
                    'عون يجهز الأسئلة...',
                    'عون ينسق الإجابات...',
                    'عون يكمل العملية...'
                ];
                
                let messageIndex = 0;
                const loadingInterval = setInterval(() => {
                    showLoading(genLoadingMessages[messageIndex]);
                    messageIndex = (messageIndex + 1) % genLoadingMessages.length;
                }, 2000);
                
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const result = reader.result;
                        const base64Data = result.split(',')[1];
                        resolve(base64Data);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });
                
                const prompt = createPrompt();
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: prompt,
                        PDF_BASE64: base64
                    })
                });
                
                clearInterval(loadingInterval);
                
                if (!response.ok) {
                    throw new Error(`خطأ في السيرفر: ${response.status}`);
                }
                
                const text = await response.text();
                
                if (text === "INVALID_PDF" || text === "CONSTRAINT_VIOLATION") {
                    throw new Error('الملف غير صالح أو لا يمكن قراءته');
                }
                
                questionsData = parseQuestions(text);
                
                if (!questionsData || questionsData.length === 0) {
                    throw new Error('لم يتم إنشاء أسئلة صالحة');
                }
                
                await deductCoins(currentSettings.totalCost);
                await saveResultToDatabase(text);
                
                const questionsSection = document.getElementById('questions-section');
                const questionsDisplaySection = document.getElementById('questions-display-section');
                
                if (questionsSection) questionsSection.classList.remove('show');
                if (questionsDisplaySection) questionsDisplaySection.classList.add('show');
                
                hideFooter();
                
                displayQuestions();
                
                showNotification('تم إنشاء الأسئلة بنجاح', 'success');
                
            } catch (error) {
                console.error('Error generating questions:', error);
                showNotification('حدث خطأ أثناء إنشاء الأسئلة: ' + error.message, 'error');
            } finally {
                hideLoading();
                const generateBtn = document.getElementById('generate-btn');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-robot"></i> إنشاء الأسئلة';
                }
            }
        }
        
        function parseQuestions(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const questions = [];
            let currentQuestion = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('Type :')) {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    currentQuestion = {
                        type: line.replace('Type :', '').trim(),
                        question: '',
                        options: [],
                        correct: ''
                    };
                } else if (line.startsWith('Q') && currentQuestion) {
                    currentQuestion.question = line.substring(line.indexOf(':') + 1).trim();
                } else if (line.startsWith('R :') && currentQuestion) {
                    currentQuestion.options.push(line.replace('R :', '').trim());
                } else if (line.startsWith('Correct :') && currentQuestion) {
                    currentQuestion.correct = line.replace('Correct :', '').trim();
                }
            }
            
            if (currentQuestion) {
                questions.push(currentQuestion);
            }
            
            return questions;
        }
        
        async function deductCoins(amount) {
            try {
                const newCoins = userCoins - amount;
                userCoins = newCoins;
                
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(newCoins);
                const coinsCount = document.getElementById('coins-count');
                if (coinsCount) {
                    coinsCount.textContent = newCoins;
                }
            } catch (error) {
                console.error('Error deducting coins:', error);
                throw error;
            }
        }
        
        async function saveResultToDatabase(result) {
            try {
                const recordId = 'questions_' + Date.now();
                const recordData = {
                    id: currentUser.id,
                    process: 'توليد أسئلة',
                    data: result,
                    timestamp: Date.now(),
                    fileName: fileInfo.name,
                    baseCost: fileInfo.baseCost,
                    extraCost: currentSettings.extraCost,
                    totalCost: currentSettings.totalCost,
                    pages: fileInfo.pages,
                    questionsCount: currentSettings.questionsCount,
                    questionType: currentSettings.questionType,
                    difficulty: currentSettings.difficulty
                };
                
                await database.ref(`records/${recordId}`).set(recordData);
            } catch (error) {
                console.error('Error saving result to database:', error);
            }
        }
        
        // ========== عرض الأسئلة ==========
        
        function displayQuestions() {
            if (!questionsData) return;
            
            const container = document.getElementById('questions-container');
            const displayInfo = document.getElementById('display-info');
            const questionTypeDisplay = document.getElementById('question-type-display');
            const questionCountDisplay = document.getElementById('question-count-display');
            const questionDifficultyDisplay = document.getElementById('question-difficulty-display');
            
            if (displayInfo) {
                if (questionTypeDisplay) questionTypeDisplay.textContent = currentSettings.questionType;
                if (questionCountDisplay) questionCountDisplay.textContent = questionsData.length;
                if (questionDifficultyDisplay) questionDifficultyDisplay.textContent = currentSettings.difficulty;
            }
            
            let html = '';
            
            questionsData.forEach((q, index) => {
                const questionNumber = index + 1;
                
                html += `
                    <div class="question-card" id="question-${index}" data-type="${q.type}">
                        <div class="question-header">
                            <div class="question-number-badge">${questionNumber}</div>
                            <div class="question-type-badge">${q.type}</div>
                        </div>
                        
                        <div class="question-text">${q.question}</div>
                `;
                
                if (q.type === 'مقالي') {
                    // عرض أسئلة مقالية
                    html += `
                        <div class="essay-answer-input">
                            <textarea id="essay-answer-${index}" placeholder="اكتب إجابتك هنا..." oninput="checkEssayAnswer(${index})" ${answersSubmitted ? 'disabled' : ''}></textarea>
                        </div>
                    `;
                } else {
                    // عرض اختيارات للأسئلة الاختيارية أو صح/خطأ
                    html += `<div class="options-container" id="options-${index}">`;
                    
                    q.options.forEach((option, optIndex) => {
                        const optionLetter = String.fromCharCode(65 + optIndex); // A, B, C, D
                        html += `
                            <div class="option-item" data-question="${index}" data-option="${option}" data-index="${optIndex}" onclick="selectOption(${index}, ${optIndex})">
                                <div class="option-marker">${optionLetter}</div>
                                <div>${option}</div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                    
                    // مكان لعرض نتيجة الإجابة
                    html += `
                        <div class="result-indicator" id="result-${index}" style="display: none;"></div>
                    `;
                }
                
                // مكان عرض الإجابة النموذجية للمقالي بعد التسليم
                if (q.type === 'مقالي') {
                    html += `
                        <div class="model-answer" id="model-answer-${index}" style="display: none;">
                            <div class="model-answer-title">
                                <i class="fas fa-book-open"></i>
                                الإجابة النموذجية:
                            </div>
                            <div class="model-answer-text">${q.correct}</div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
            
            // إعادة تعيين المتغيرات
            userAnswers = new Array(questionsData.length).fill(null);
            answersSubmitted = false;
            
            // إخفاء نتائج المقالي
            document.getElementById('results-summary').style.display = 'none';
            document.getElementById('essay-results').style.display = 'none';
            
            // إظهار زر التسليم
            document.getElementById('submit-answers-btn').style.display = 'flex';
            
            // تحديث شريط التقدم
            updateProgressBar();
        }
        
        // دالة اختيار خيار (للأسئلة غير المقالية)
        window.selectOption = function(questionIndex, optionIndex) {
            if (answersSubmitted) return; // منع التغيير بعد التسليم
            
            const question = questionsData[questionIndex];
            if (question.type === 'مقالي') return; // المقالي لا يحتوي على خيارات
            
            const optionItems = document.querySelectorAll(`#options-${questionIndex} .option-item`);
            
            // إزالة التحديد من جميع الخيارات
            optionItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            // تحديد الخيار المختار
            optionItems[optionIndex].classList.add('selected');
            
            // حفظ الإجابة
            userAnswers[questionIndex] = {
                selected: optionIndex,
                selectedText: question.options[optionIndex],
                isCorrect: question.options[optionIndex] === question.correct
            };
            
            // تحديث شريط التقدم
            updateProgressBar();
        };
        
        // دالة التحقق من إجابة المقالي
        window.checkEssayAnswer = function(questionIndex) {
            if (answersSubmitted) return;
            
            const essayAnswer = document.getElementById(`essay-answer-${questionIndex}`).value;
            
            userAnswers[questionIndex] = {
                essay: essayAnswer
            };
            
            // تحديث شريط التقدم
            updateProgressBar();
        };
        
        // دالة تسليم الإجابات
        document.getElementById('submit-answers-btn').addEventListener('click', function() {
            if (answersSubmitted) return;
            
            const submitBtn = document.getElementById('submit-answers-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التصحيح...';
            
            // إظهار شاشة التحميل
            let messageIndex = 0;
            const loadingInterval = setInterval(() => {
                const msg = loadingMessages[messageIndex];
                showLoading(msg.main, msg.sub);
                messageIndex = (messageIndex + 1) % loadingMessages.length;
            }, 2000);
            
            // محاكاة وقت التحميل (3 ثواني)
            setTimeout(() => {
                clearInterval(loadingInterval);
                hideLoading();
                
                submitAnswers();
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> تسليم الإجابات';
            }, 3000);
        });
        
        function submitAnswers() {
            answersSubmitted = true;
            
            // تجميع الإجابات المقالية
            for (let i = 0; i < questionsData.length; i++) {
                const question = questionsData[i];
                
                if (question.type === 'مقالي') {
                    // تعطيل حقل الإدخال
                    const textarea = document.getElementById(`essay-answer-${i}`);
                    if (textarea) textarea.disabled = true;
                    
                    // إظهار الإجابة النموذجية
                    document.getElementById(`model-answer-${i}`).style.display = 'block';
                } else {
                    // عرض النتيجة للأسئلة غير المقالية
                    const userAnswer = userAnswers[i];
                    
                    if (userAnswer) {
                        const resultDiv = document.getElementById(`result-${i}`);
                        const questionBox = document.getElementById(`question-${i}`);
                        const optionItems = document.querySelectorAll(`#options-${i} .option-item`);
                        
                        if (userAnswer.isCorrect) {
                            resultDiv.innerHTML = `
                                <i class="fas fa-check-circle" style="font-size: 1.3rem;"></i>
                                <span>إجابة صحيحة ✓</span>
                            `;
                            resultDiv.className = 'result-indicator correct';
                            questionBox.classList.add('correct');
                        } else {
                            resultDiv.innerHTML = `
                                <i class="fas fa-times-circle" style="font-size: 1.3rem;"></i>
                                <span>إجابة خاطئة ✗</span>
                            `;
                            resultDiv.className = 'result-indicator incorrect';
                            questionBox.classList.add('incorrect');
                        }
                        
                        resultDiv.style.display = 'flex';
                        
                        // تلوين الخيارات
                        optionItems.forEach((item, idx) => {
                            const optionText = question.options[idx];
                            
                            if (optionText === question.correct) {
                                item.classList.add('correct-answer');
                            }
                            
                            if (idx === userAnswer.selected) {
                                if (!userAnswer.isCorrect) {
                                    item.classList.add('wrong-answer');
                                }
                            }
                        });
                    } else {
                        // إذا لم يختر المستخدم إجابة
                        const resultDiv = document.getElementById(`result-${i}`);
                        resultDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle" style="font-size: 1.3rem;"></i>
                            <span>لم تقم باختيار إجابة</span>
                        `;
                        resultDiv.className = 'result-indicator incorrect';
                        resultDiv.style.display = 'flex';
                        
                        // عرض الإجابة الصحيحة
                        const optionItems = document.querySelectorAll(`#options-${i} .option-item`);
                        optionItems.forEach((item, idx) => {
                            if (questionsData[i].options[idx] === questionsData[i].correct) {
                                item.classList.add('correct-answer');
                            }
                        });
                    }
                    
                    // تعطيل جميع الخيارات
                    document.querySelectorAll(`#options-${i} .option-item`).forEach(item => {
                        item.style.pointerEvents = 'none';
                    });
                }
            }
            
            // حساب الدرجة للأسئلة غير المقالية فقط
            const nonEssayQuestions = questionsData.filter(q => q.type !== 'مقالي');
            const correctAnswers = userAnswers.filter((ans, idx) => 
                ans && questionsData[idx].type !== 'مقالي' && ans.isCorrect === true
            ).length;
            
            const totalNonEssay = nonEssayQuestions.length;
            const scorePercentage = totalNonEssay > 0 ? Math.round((correctAnswers / totalNonEssay) * 100) : 0;
            
            // إظهار النتائج إذا كان هناك أسئلة غير مقالية
            if (totalNonEssay > 0) {
                const resultsSummary = document.getElementById('results-summary');
                const scoreFill = document.getElementById('score-fill');
                const scorePercentageElem = document.getElementById('score-percentage');
                const scoreDetails = document.getElementById('score-details');
                const encouragementMessage = document.getElementById('encouragement-message');
                
                // تحديث الدائرة
                const rotation = (scorePercentage / 100) * 360;
                scoreFill.style.background = `conic-gradient(var(--success-color) 0deg, var(--success-color) ${rotation}deg, transparent ${rotation}deg)`;
                
                scorePercentageElem.textContent = scorePercentage + '%';
                scoreDetails.textContent = `${correctAnswers} من ${totalNonEssay}`;
                
                // رسالة تشجيعية
                if (scorePercentage >= 90) {
                    encouragementMessage.textContent = '🌟 أداء استثنائي! لقد أظهرت فهماً ممتازاً للمادة';
                } else if (scorePercentage >= 70) {
                    encouragementMessage.textContent = '💪 عمل ممتاز! استمر في التقدم بهذا المستوى';
                } else if (scorePercentage >= 50) {
                    encouragementMessage.textContent = '📚 عمل جيد! يمكنك التحسن بالممارسة والمراجعة';
                } else {
                    encouragementMessage.textContent = '🌱 لا تستسلم! التعلم رحلة تحتاج صبراً ومثابرة';
                }
                
                resultsSummary.style.display = 'block';
            }
            
            // إظهار نتائج المقالي بشكل منفصل
            const essayQuestions = questionsData.filter(q => q.type === 'مقالي');
            if (essayQuestions.length > 0) {
                const essayResults = document.getElementById('essay-results');
                const essayContainer = document.getElementById('essay-answers-container');
                
                let essayHtml = '';
                
                essayQuestions.forEach((q, idx) => {
                    const originalIndex = questionsData.findIndex(question => question === q);
                    const userAnswer = userAnswers[originalIndex];
                    
                    essayHtml += `
                        <div class="essay-answer-box">
                            <div class="essay-answer-header">
                                <div class="essay-answer-number">سؤال ${idx + 1}</div>
                            </div>
                            <div class="essay-question-text">${q.question}</div>
                            <div class="essay-user-answer">
                                <div class="essay-user-answer-title">
                                    <i class="fas fa-pen"></i>
                                    إجابتك:
                                </div>
                                <div>${userAnswer ? userAnswer.essay || 'لم تكتب إجابة' : 'لم تكتب إجابة'}</div>
                            </div>
                            <div class="essay-model-answer">
                                <div class="essay-model-answer-title">
                                    <i class="fas fa-check-circle"></i>
                                    الإجابة النموذجية:
                                </div>
                                <div>${q.correct}</div>
                            </div>
                        </div>
                    `;
                });
                
                essayContainer.innerHTML = essayHtml;
                essayResults.style.display = 'block';
            }
            
            // تعطيل زر التسليم نهائياً
            const submitBtn = document.getElementById('submit-answers-btn');
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
            
            // حفظ النتائج في Firebase
            saveAnswersToDatabase();
            
            showNotification('تم تصحيح الإجابات بنجاح', 'success');
        }
        
        async function saveAnswersToDatabase() {
            try {
                const resultId = 'answers_' + Date.now();
                const resultData = {
                    userId: currentUser.id,
                    fileName: fileInfo.name,
                    questionType: currentSettings.questionType,
                    questionsCount: currentSettings.questionsCount,
                    difficulty: currentSettings.difficulty,
                    timestamp: Date.now(),
                    questions: questionsData,
                    userAnswers: userAnswers
                };
                
                await database.ref(`answers_results/${resultId}`).set(resultData);
                
            } catch (error) {
                console.error('Error saving answers to database:', error);
            }
        }
        
        // ========== تهيئة التطبيق ==========
        
        async function initApp() {
            showLoading('جاري تحميل البيانات...');
            
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    hideLoading();
                    window.location.replace('login.html');
                    return;
                }
                
                try {
                    await setupUser();
                    setupFileUpload();
                    setupQuestionsEvents();
                    
                    const logo = document.getElementById('home-logo');
                    if (logo) {
                        logo.addEventListener('click', reloadPage);
                    }
                    
                    hideLoading();
                    
                } catch (error) {
                    console.error('Error initializing app:', error);
                    hideLoading();
                    showNotification('حدث خطأ في تحميل التطبيق', 'error');
                } finally {
                    setTimeout(() => {
                        unsubscribe();
                    }, 100);
                }
            });
        }
        
        // منع العودة للخلف
        history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function(event) {
            history.pushState(null, null, window.location.href);
        });
        
        document.addEventListener('DOMContentLoaded', initApp);
        
        // إيقاف أي أصوات عند مغادرة الصفحة
        window.addEventListener('beforeunload', function() {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>
