<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>عون - توليد الأسئلة من PDF</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Tajawal', 'Almarai', sans-serif;
        }
        
        :root {
            --bg-color: #f8f4e9;
            --card-color: #ffffff;
            --text-primary: #2d3e50;
            --text-secondary: #6b7b8a;
            --accent-primary: #8b5a2b;
            --accent-secondary: #b68b5c;
            --accent-light: #e6d5b8;
            --border-color: #d4b48c;
            --border-radius-sm: 12px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --border-radius-xl: 32px;
            --success-color: #28a745;
            --success-light: rgba(40, 167, 69, 0.1);
            --error-color: #dc3545;
            --error-light: rgba(220, 53, 69, 0.1);
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --gradient-primary: linear-gradient(135deg, #8b5a2b, #b68b5c);
            --gradient-success: linear-gradient(135deg, #28a745, #34ce57);
            --gradient-error: linear-gradient(135deg, #dc3545, #e4606d);
            --shadow-sm: 0 2px 8px rgba(139, 90, 43, 0.08);
            --shadow-md: 0 4px 16px rgba(139, 90, 43, 0.12);
            --shadow-lg: 0 8px 24px rgba(139, 90, 43, 0.16);
            --shadow-hover: 0 12px 32px rgba(139, 90, 43, 0.2);
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            width: 100%;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            position: relative;
            line-height: 1.6;
        }
        
        /* ========== شاشة التحميل ========== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .loading-screen.show {
            display: flex;
            opacity: 1;
        }
        
        .loading-logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 56px;
            color: white;
            margin-bottom: 24px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: pulse 1.5s ease infinite;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }
        
        .loading-text {
            color: white;
            font-size: 1.1rem;
            text-align: center;
            max-width: 80%;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== الإشعارات ========== */
        .notification {
            position: fixed;
            top: 90px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 20px;
            padding: 18px 20px;
            box-shadow: var(--shadow-lg);
            z-index: 10001;
            transform: translateX(150%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-right: 6px solid var(--info-color);
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-right-color: var(--success-color);
        }
        
        .notification.error {
            border-right-color: var(--error-color);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
        }
        
        .notification-icon {
            font-size: 1.5rem;
            min-width: 32px;
            text-align: center;
        }
        
        .notification-text {
            font-size: 1rem;
            flex: 1;
            font-weight: 500;
        }
        
        /* ========== الشريط العلوي ========== */
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(248, 244, 233, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            padding-top: env(safe-area-inset-top);
            z-index: 10000;
            border-bottom: 1px solid rgba(139, 90, 43, 0.1);
            box-shadow: var(--shadow-sm);
        }
        
        .logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 36px;
            color: var(--accent-primary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
        }
        
        .coins-display {
            background: var(--gradient-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }
        
        .coins-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .coins-display i {
            font-size: 16px;
        }
        
        /* ========== المحتوى الرئيسي ========== */
        .main-content {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding-top: 100px;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 120px;
        }
        
        /* ========== قسم رفع الملف ========== */
        .upload-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 32px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            width: 100%;
            border: 1px solid rgba(139, 90, 43, 0.1);
            transition: var(--transition);
        }
        
        .upload-section:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .section-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .section-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 28px;
            text-align: center;
            line-height: 1.7;
        }
        
        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 48px 20px;
            cursor: pointer;
            transition: var(--transition);
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.02), rgba(182, 139, 92, 0.02));
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.05), rgba(182, 139, 92, 0.05));
            opacity: 0;
            transition: var(--transition);
        }
        
        .upload-area:hover::before {
            opacity: 1;
        }
        
        .upload-area:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        
        .upload-icon {
            font-size: 56px;
            color: var(--accent-primary);
            margin-bottom: 16px;
            animation: float 3s ease infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* ========== معاينة التكلفة ========== */
        .cost-preview {
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.04), rgba(182, 139, 92, 0.04));
            border-radius: var(--border-radius-lg);
            padding: 24px;
            margin-top: 24px;
            border: 1px solid rgba(139, 90, 43, 0.15);
            display: none;
            animation: slideUp 0.4s ease;
        }
        
        .cost-preview.show {
            display: block;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .cost-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .cost-details {
            display: flex;
            justify-content: space-around;
            margin-bottom: 24px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .cost-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .cost-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .cost-value {
            font-family: 'Almarai', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .cost-actions {
            display: flex;
            gap: 16px;
        }
        
        .action-btn {
            padding: 16px 24px;
            border: none;
            border-radius: 14px;
            font-family: 'Almarai', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .action-btn:active {
            transform: scale(0.96);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .confirm-btn {
            background: var(--gradient-success);
        }
        
        .cancel-btn {
            background: var(--gradient-error);
        }
        
        /* ========== إعدادات الأسئلة ========== */
        .questions-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 32px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(139, 90, 43, 0.1);
            display: none;
        }
        
        .questions-section.show {
            display: block;
            animation: slideUp 0.4s ease;
        }
        
        .question-group {
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.03), rgba(182, 139, 92, 0.03));
            border-radius: var(--border-radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(139, 90, 43, 0.1);
            transition: var(--transition);
        }
        
        .question-group:hover {
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.05), rgba(182, 139, 92, 0.05));
            border-color: var(--accent-secondary);
        }
        
        .question-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-title i {
            color: var(--accent-secondary);
        }
        
        /* ========== أزرار نوع الأسئلة ========== */
        .question-type-grid {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 20px;
        }
        
        .type-btn {
            padding: 18px;
            border: 2px solid rgba(139, 90, 43, 0.15);
            border-radius: 16px;
            background: white;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }
        
        .type-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
            z-index: 0;
        }
        
        .type-btn i {
            color: var(--accent-secondary);
            transition: var(--transition);
            z-index: 1;
        }
        
        .type-btn span {
            z-index: 1;
        }
        
        .type-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .type-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-lg);
        }
        
        .type-btn.selected i {
            color: white;
        }
        
        .question-limit {
            font-size: 0.9rem;
            color: var(--info-color);
            padding: 14px;
            background: rgba(23, 162, 184, 0.08);
            border-radius: 14px;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }
        
        /* ========== السلايدر ========== */
        .slider-container {
            padding: 20px 0;
        }
        
        .slider-value {
            font-family: 'Almarai', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 16px;
            animation: pulse 2s ease infinite;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary));
            outline: none;
            border-radius: 10px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            border: 3px solid var(--accent-primary);
            transition: var(--transition);
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: var(--shadow-lg);
        }
        
        .additional-cost {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 16px;
            padding: 12px;
            background: rgba(40, 167, 69, 0.06);
            border-radius: 12px;
        }
        
        .additional-cost span {
            color: var(--success-color);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        /* ========== أزرار الصعوبة ========== */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .option-btn {
            padding: 14px;
            border: 2px solid rgba(139, 90, 43, 0.15);
            border-radius: 14px;
            background: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            color: var(--text-primary);
        }
        
        .option-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .option-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-lg);
        }
        
        /* ========== صندوق التكلفة ========== */
        .total-cost-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 24px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.06), rgba(182, 139, 92, 0.06));
            border-radius: 16px;
            border: 1px solid rgba(139, 90, 43, 0.15);
        }
        
        .total-cost-label {
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .total-cost-value {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-primary);
        }
        
        /* ========== زر التوليد ========== */
        .generate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 20px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            width: 100%;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .generate-btn:hover::before {
            transform: translateX(100%);
        }
        
        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ========== قسم عرض الأسئلة ========== */
        .questions-display-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 28px 24px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(139, 90, 43, 0.1);
            display: none;
        }
        
        .questions-display-section.show {
            display: block;
            animation: slideUp 0.5s ease;
        }
        
        .questions-header {
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(139, 90, 43, 0.1);
            position: relative;
        }
        
        .questions-header-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 16px;
        }
        
        .questions-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }
        
        .info-badge {
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.08), rgba(182, 139, 92, 0.08));
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 0.95rem;
            color: var(--accent-primary);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            border: 1px solid rgba(139, 90, 43, 0.15);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(139, 90, 43, 0.1);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-success);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* ========== شارة النتيجة ========== */
        .result-badge {
            position: absolute;
            top: -12px;
            left: 20px;
            padding: 8px 20px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
            z-index: 10;
            animation: slideInLeft 0.5s ease;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .result-badge.correct {
            background: var(--gradient-success);
            color: white;
        }
        
        .result-badge.wrong {
            background: var(--gradient-error);
            color: white;
        }
        
        /* ========== بطاقة السؤال ========== */
        .question-item {
            background: white;
            border: 1px solid rgba(139, 90, 43, 0.15);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            position: relative;
            transition: var(--transition);
            animation: fadeIn 0.5s ease;
        }
        
        .question-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--accent-secondary);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(139, 90, 43, 0.1);
        }
        
        .question-number {
            background: var(--accent-primary);
            color: white;
            padding: 8px 18px;
            border-radius: 40px;
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: var(--shadow-sm);
        }
        
        .question-type-badge {
            background: rgba(139, 90, 43, 0.1);
            color: var(--accent-primary);
            padding: 8px 18px;
            border-radius: 40px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .question-text {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            line-height: 1.7;
            padding: 0 4px;
        }
        
        /* ========== خيارات الأسئلة ========== */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            background: rgba(139, 90, 43, 0.03);
            border: 2px solid rgba(139, 90, 43, 0.15);
            border-radius: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .option-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-success);
            opacity: 0;
            transition: var(--transition);
        }
        
        .option-item:hover {
            border-color: var(--accent-primary);
            background: rgba(139, 90, 43, 0.05);
            transform: translateX(-5px);
        }
        
        .option-item.selected {
            background: var(--success-light);
            border-color: var(--success-color);
        }
        
        .option-item.correct-answer {
            background: var(--success-light);
            border-color: var(--success-color);
            animation: pulse 1s ease;
        }
        
        .option-item.wrong-answer {
            background: var(--error-light);
            border-color: var(--error-color);
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .option-check {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(139, 90, 43, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 16px;
            transition: var(--transition);
        }
        
        .option-item.selected .option-check {
            background: var(--success-color);
            border-color: var(--success-color);
            transform: scale(1.1);
        }
        
        .option-item.selected .option-check::after {
            content: '✓';
            color: white;
            font-size: 14px;
            animation: popIn 0.3s ease;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .option-text {
            font-size: 1rem;
            color: var(--text-primary);
            flex: 1;
            font-weight: 500;
        }
        
        /* ========== صح/خطأ ========== */
        .tf-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .tf-option {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(139, 90, 43, 0.03);
            border: 2px solid rgba(139, 90, 43, 0.15);
            border-radius: 16px;
            padding: 18px;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
        }
        
        .tf-option:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .tf-option.selected {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
            transform: scale(0.98);
        }
        
        .tf-option.correct-answer {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
            animation: pulse 0.5s ease;
        }
        
        .tf-option.wrong-answer {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
            animation: shake 0.5s ease;
        }
        
        /* ========== الأسئلة المقالية ========== */
        .essay-textarea {
            width: 100%;
            min-height: 180px;
            padding: 20px;
            border: 2px solid rgba(139, 90, 43, 0.15);
            border-radius: 20px;
            font-size: 1rem;
            line-height: 1.7;
            resize: vertical;
            background: white;
            transition: var(--transition);
        }
        
        .essay-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(139, 90, 43, 0.1);
        }
        
        .essay-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 14px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 0 4px;
        }
        
        .essay-saved {
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
        }
        
        .essay-nav-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }
        
        .essay-nav-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 16px;
            background: var(--gradient-primary);
            color: white;
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
        }
        
        .essay-nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .essay-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .essay-model-answer {
            margin-top: 24px;
            padding: 20px;
            background: rgba(23, 162, 184, 0.06);
            border-radius: 20px;
            border-right: 6px solid var(--info-color);
            animation: slideInRight 0.5s ease;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .essay-model-answer-title {
            font-weight: 700;
            color: var(--info-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .essay-match-percentage {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 40px;
            font-size: 0.95rem;
            font-weight: 700;
            margin-top: 16px;
            animation: popIn 0.4s ease;
        }
        
        .match-high {
            background: var(--success-light);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .match-low {
            background: var(--error-light);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        
        /* ========== زر التسليم ========== */
        .submit-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 30px;
            padding: 0 20px;
        }
        
        .submit-btn {
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 20px 32px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            width: 100%;
            opacity: 0.5;
            pointer-events: none;
            position: relative;
            overflow: hidden;
        }
        
        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .submit-btn.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .submit-btn.active:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .submit-btn.active:hover::before {
            transform: translateX(100%);
        }
        
        .submit-btn.active:active {
            transform: translateY(0);
        }
        
        .submit-btn i {
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }
        
        /* ========== نتائج الاختبار ========== */
        .results-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 36px 28px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(139, 90, 43, 0.15);
            display: none;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideDown 0.6s ease;
        }
        
        .results-section.show {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .results-title {
            font-family: 'Almarai', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 24px;
        }
        
        .score-circle {
            width: 180px;
            height: 180px;
            margin: 20px auto;
            position: relative;
            animation: zoomIn 0.8s ease;
        }
        
        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .score-circle-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(139, 90, 43, 0.1);
            position: relative;
        }
        
        .score-circle-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0deg, var(--success-color) var(--angle), transparent var(--angle), transparent 360deg);
            transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .score-circle-inner {
            position: absolute;
            width: 80%;
            height: 80%;
            background: white;
            border-radius: 50%;
            top: 10%;
            left: 10%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
        }
        
        .score-percentage {
            font-family: 'Almarai', sans-serif;
            font-size: 2.8rem;
            font-weight: 900;
            color: var(--accent-primary);
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .score-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 36px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.04), rgba(182, 139, 92, 0.04));
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(139, 90, 43, 0.1);
            transition: var(--transition);
            animation: fadeInUp 0.6s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stat-value {
            font-family: 'Almarai', sans-serif;
            font-size: 2.3rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .encouragement-message {
            font-family: 'Almarai', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin: 28px 0;
            padding: 24px;
            background: linear-gradient(135deg, rgba(139, 90, 43, 0.04), rgba(182, 139, 92, 0.04));
            border-radius: 20px;
            border-right: 6px solid var(--accent-primary);
            animation: slideInRight 0.6s ease;
        }
        
        /* ========== الفوتر ========== */
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            border-top: 1px solid rgba(139, 90, 43, 0.1);
            margin-top: 40px;
        }
        
        .footer.hidden {
            display: none;
        }
        
        .support-links {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 24px 0;
        }
        
        .support-link {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            text-decoration: none;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
        }
        
        .support-link:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        .developer-credit {
            font-size: 0.9rem;
            color: rgba(107, 123, 138, 0.6);
        }
        
        /* ========== responsive ========== */
        @media (max-width: 480px) {
            .main-content {
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .section-title {
                font-size: 1.5rem;
            }
            
            .questions-header-title {
                font-size: 1.5rem;
            }
            
            .tf-container {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .cost-details {
                flex-direction: column;
            }
            
            .cost-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">عون</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">جاري التحميل...</div>
    </div>
    
    <!-- الإشعارات -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>
    
    <!-- الشريط العلوي -->
    <nav class="native-navbar">
        <div class="logo" id="home-logo">عون</div>
        <div class="nav-left">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
        </div>
    </nav>
    
    <!-- المحتوى الرئيسي -->
    <div class="main-content" id="main-content">
        <!-- قسم رفع الملف -->
        <div class="upload-section" id="upload-section">
            <h1 class="section-title animate__animated animate__fadeIn">توليد أسئلة من PDF</h1>
            <p class="section-subtitle">ارفع ملف PDF واحصل على أسئلة ذكية باستخدام الذكاء الاصطناعي</p>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text" id="upload-text">انقر لرفع ملف PDF</div>
                <div class="upload-hint">يدعم ملفات PDF فقط</div>
            </div>
            
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
            
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">تفاصيل التكلفة</h3>
                <div class="cost-details">
                    <div class="cost-item">
                        <div class="cost-label">عدد الصفحات</div>
                        <div class="cost-value" id="page-count">0</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">التكلفة الأساسية</div>
                        <div class="cost-value" id="cost-amount">0 عملة</div>
                    </div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" id="cancel-btn">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button class="action-btn confirm-btn" id="confirm-btn">
                        <i class="fas fa-check"></i>
                        متابعة
                    </button>
                </div>
            </div>
        </div>
        
        <!-- قسم إعدادات الأسئلة -->
        <div class="questions-section" id="questions-section">
            <h2 class="section-title">إعدادات الأسئلة</h2>
            <p class="section-subtitle">اختر نوع الأسئلة وعددها ومستوى الصعوبة</p>
            
            <div class="question-group">
                <h3 class="question-title">
                    <i class="fas fa-tasks"></i>
                    نوع الأسئلة
                </h3>
                <div class="question-type-grid" id="question-type">
                    <button class="type-btn selected" data-type="اختياري">
                        <i class="fas fa-check-circle"></i>
                        <span>اختيار من متعدد</span>
                    </button>
                    <button class="type-btn" data-type="صح وخطأ">
                        <i class="fas fa-check-double"></i>
                        <span>صح وخطأ</span>
                    </button>
                    <button class="type-btn" data-type="مقالي">
                        <i class="fas fa-pen"></i>
                        <span>مقالي</span>
                    </button>
                </div>
                <div class="question-limit" id="question-limit">
                    <i class="fas fa-info-circle"></i>
                    الحد الأقصى: <span id="max-questions">80</span> سؤال
                </div>
            </div>
            
            <div class="question-group">
                <h3 class="question-title">
                    <i class="fas fa-question-circle"></i>
                    عدد الأسئلة
                </h3>
                <div class="slider-container">
                    <div class="slider-value" id="questions-count">10</div>
                    <div class="slider-labels">
                        <span id="min-label">1</span>
                        <span id="mid-label">40</span>
                        <span id="max-label">80</span>
                    </div>
                    <input type="range" min="1" max="80" value="10" class="slider" id="questions-slider">
                    <div class="additional-cost">
                        تكلفة إضافية: <span id="extra-cost">0</span> عملة
                    </div>
                </div>
            </div>
            
            <div class="question-group">
                <h3 class="question-title">
                    <i class="fas fa-chart-line"></i>
                    درجة الصعوبة
                </h3>
                <div class="options-grid" id="difficulty-level">
                    <button class="option-btn selected" data-value="سهل">سهل</button>
                    <button class="option-btn" data-value="متوسط">متوسط</button>
                    <button class="option-btn" data-value="صعب">صعب</button>
                </div>
            </div>
            
            <div class="total-cost-box">
                <span class="total-cost-label">التكلفة الإجمالية:</span>
                <span class="total-cost-value" id="total-cost-display">0 عملة</span>
            </div>
            
            <button class="generate-btn" id="generate-btn">
                <i class="fas fa-robot"></i>
                توليد الأسئلة
            </button>
        </div>
        
        <!-- قسم عرض الأسئلة -->
        <div class="questions-display-section" id="questions-display-section">
            <div class="questions-header">
                <h2 class="questions-header-title">الأسئلة المولدة</h2>
                <div class="questions-info">
                    <span class="info-badge">
                        <i class="fas fa-tag"></i>
                        النوع: <span id="question-type-display">اختيار من متعدد</span>
                    </span>
                    <span class="info-badge">
                        <i class="fas fa-layer-group"></i>
                        الصعوبة: <span id="difficulty-display">سهل</span>
                    </span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="answer-progress" style="width: 0%;"></div>
                </div>
            </div>
            
            <!-- حاوية النتائج -->
            <div id="results-container" style="margin-bottom: 30px;"></div>
            
            <!-- حاوية الأسئلة -->
            <div id="questions-container"></div>
        </div>
        
        <!-- زر التسليم (ثابت في الأسفل) -->
        <div class="submit-container" id="submit-container" style="display: none;">
            <button class="submit-btn" id="submit-btn">
                <i class="fas fa-check-circle"></i>
                تسليم الإجابات
            </button>
        </div>
        
        <!-- الفوتر -->
        <div class="footer" id="footer">
            <p class="copyright">جميع الحقوق محفوظة لمنصة عون © 2026</p>
            <div class="support-links">
                <a href="https://wa.me/966583617539" target="_blank" class="support-link">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="https://t.me/HNHv1" target="_blank" class="support-link">
                    <i class="fab fa-telegram"></i>
                </a>
            </div>
            <div class="developer-credit">
                برمجة وتصميم المطور 𝐊𝐈𝐌𝐎
            </div>
        </div>
    </div>
    
    <script>
        // تهيئة PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // تهيئة Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // ========== المتغيرات العامة ==========
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let pdfBase64 = null;
        let fileInfo = {
            name: '',
            pages: 0,
            words: 0,
            baseCost: 0
        };
        
        let currentSettings = {
            questionType: 'اختياري',
            questionsCount: 10,
            difficulty: 'سهل',
            totalCost: 0,
            extraCost: 0,
            maxQuestions: 80
        };
        
        let questions = [];
        let userAnswers = [];
        let essayAnswers = {};
        let currentEssayIndex = 0;
        let essayResults = null;
        let isSubmitted = false;
        
        // إعدادات السيرفر
        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";
        
        // ========== تهيئة التطبيق ==========
        async function initApp() {
            console.log('بدء تهيئة التطبيق...');
            
            setTimeout(() => {
                hideLoading();
            }, 3000);
            
            try {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('المستخدم موجود:', user.email);
                        await loadUserData(user);
                        setupEventListeners();
                        hideLoading();
                    } else {
                        console.log('لا يوجد مستخدم، توجيه إلى صفحة تسجيل الدخول');
                        window.location.replace('login.html');
                    }
                });
            } catch (error) {
                console.error('خطأ في تهيئة التطبيق:', error);
                showNotification('حدث خطأ في تحميل التطبيق', 'error');
                hideLoading();
            }
        }
        
        // ========== تحميل بيانات المستخدم ==========
        async function loadUserData(user) {
            try {
                console.log('جاري تحميل بيانات المستخدم...');
                const snapshot = await database.ref('users_Awn').once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    let found = false;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userId !== 'noty_publick' && userData.email === user.email) {
                            currentUser = {
                                id: userId,
                                email: userData.email,
                                name: userData.name || 'مستخدم',
                                coin: userData.coin || 0,
                                banned: userData.banned === true
                            };
                            
                            userCoins = currentUser.coin;
                            document.getElementById('coins-count').textContent = userCoins;
                            console.log('تم تحميل بيانات المستخدم:', currentUser.name, 'الرصيد:', userCoins);
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found) {
                        console.log('لم يتم العثور على المستخدم في قاعدة البيانات');
                        await auth.signOut();
                        window.location.replace('login.html');
                    }
                } else {
                    console.log('لا توجد بيانات في قاعدة البيانات');
                    await auth.signOut();
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('خطأ في تحميل بيانات المستخدم:', error);
                showNotification('فشل تحميل بيانات المستخدم', 'error');
            }
        }
        
        // ========== إعداد مستمعي الأحداث ==========
        function setupEventListeners() {
            console.log('إعداد مستمعي الأحداث...');
            
            // رفع الملف
            const pdfFile = document.getElementById('pdfFile');
            const uploadArea = document.getElementById('upload-area');
            
            uploadArea.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                pdfFile.click();
            });
            
            pdfFile.addEventListener('change', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (this.files && this.files[0]) {
                    handleFile(this.files[0]);
                }
            });
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = 'var(--accent-primary)';
                this.style.backgroundColor = 'rgba(139, 90, 43, 0.05)';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '';
                this.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '';
                this.style.backgroundColor = '';
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    const file = e.dataTransfer.files[0];
                    pdfFile.files = e.dataTransfer.files;
                    handleFile(file);
                }
            });
            
            // أزرار التكلفة
            document.getElementById('cancel-btn').addEventListener('click', function(e) {
                e.preventDefault();
                cancelProcess();
            });
            
            document.getElementById('confirm-btn').addEventListener('click', function(e) {
                e.preventDefault();
                confirmProcess();
            });
            
            // إعدادات الأسئلة
            setupQuestionsEvents();
            
            // الشعار
            document.getElementById('home-logo').addEventListener('click', function(e) {
                e.preventDefault();
                location.reload();
            });
        }
        
        // ========== إعداد أحداث الأسئلة ==========
        function setupQuestionsEvents() {
            const typeBtns = document.querySelectorAll('#question-type .type-btn');
            typeBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    typeBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.questionType = this.dataset.type;
                    updateQuestionLimit(this.dataset.type);
                    updateExtraCost();
                    updateTotalCost();
                });
            });
            
            const slider = document.getElementById('questions-slider');
            slider.addEventListener('input', function(e) {
                e.preventDefault();
                document.getElementById('questions-count').textContent = this.value;
                currentSettings.questionsCount = parseInt(this.value);
                updateExtraCost();
                updateTotalCost();
            });
            
            const difficultyBtns = document.querySelectorAll('#difficulty-level .option-btn');
            difficultyBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    difficultyBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.difficulty = this.dataset.value;
                });
            });
            
            document.getElementById('generate-btn').addEventListener('click', function(e) {
                e.preventDefault();
                generateQuestions();
            });
            
            document.getElementById('submit-btn').addEventListener('click', function(e) {
                e.preventDefault();
                submitAnswers();
            });
            
            updateQuestionLimit('اختياري');
        }
        
        // ========== تحديث حد الأسئلة ==========
        function updateQuestionLimit(type) {
            const max = type === 'مقالي' ? 50 : 80;
            currentSettings.maxQuestions = max;
            currentSettings.questionsCount = Math.min(currentSettings.questionsCount, max);
            
            document.getElementById('max-questions').textContent = max;
            document.getElementById('max-label').textContent = max;
            document.getElementById('mid-label').textContent = type === 'مقالي' ? '25' : '40';
            
            const slider = document.getElementById('questions-slider');
            slider.max = max;
            slider.value = currentSettings.questionsCount;
            document.getElementById('questions-count').textContent = currentSettings.questionsCount;
        }
        
        // ========== تحديث التكلفة الإضافية ==========
        function updateExtraCost() {
            const count = currentSettings.questionsCount;
            const type = currentSettings.questionType;
            let extraCost = 0;
            
            if (type === 'مقالي') {
                if (count >= 11 && count <= 20) extraCost = 8;
                else if (count >= 21 && count <= 30) extraCost = 8;
                else if (count >= 31 && count <= 50) extraCost = 12;
            } else {
                if (count >= 21 && count <= 40) extraCost = 5;
                else if (count >= 41 && count <= 60) extraCost = 8;
                else if (count >= 61 && count <= 80) extraCost = 11;
            }
            
            currentSettings.extraCost = extraCost;
            document.getElementById('extra-cost').textContent = extraCost;
        }
        
        // ========== تحديث التكلفة الإجمالية ==========
        function updateTotalCost() {
            const total = (fileInfo.baseCost || 0) + (currentSettings.extraCost || 0);
            currentSettings.totalCost = total;
            document.getElementById('total-cost-display').textContent = total + ' عملة';
        }
        
        // ========== معالجة الملف ==========
        async function handleFile(file) {
            console.log('معالجة الملف:', file.name, 'الحجم:', file.size);
            
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showNotification('الرجاء رفع ملف PDF فقط', 'error');
                resetFileInput();
                return;
            }
            
            selectedFile = file;
            document.getElementById('upload-text').textContent = file.name;
            document.getElementById('upload-text').style.color = 'var(--accent-primary)';
            document.getElementById('upload-text').style.fontWeight = 'bold';
            
            try {
                showLoading('جاري تحويل الملف...');
                
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    pdfBase64 = base64Data;
                    console.log('تم تحويل الملف إلى Base64');
                    
                    await analyzePDF(file);
                };
                
                reader.onerror = function(error) {
                    console.error('خطأ في قراءة الملف:', error);
                    hideLoading();
                    showNotification('فشل في قراءة الملف', 'error');
                    resetFileInput();
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('خطأ في معالجة الملف:', error);
                hideLoading();
                showNotification('فشل في معالجة الملف', 'error');
                resetFileInput();
            }
        }
        
        // ========== تحليل PDF ==========
        async function analyzePDF(file) {
            try {
                showLoading('جاري تحليل الملف...');
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let totalWords = 0;
                const maxPages = Math.min(pdf.numPages, 20);
                
                for (let i = 1; i <= maxPages; i++) {
                    try {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        
                        if (content.items && content.items.length) {
                            let text = '';
                            content.items.forEach(item => {
                                if (item.str) text += item.str + ' ';
                            });
                            const words = text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                            totalWords += words;
                        }
                    } catch (pageError) {
                        console.warn('خطأ في قراءة الصفحة', i, pageError);
                        totalWords += 200;
                    }
                }
                
                let coins = Math.ceil((totalWords / 1000) * 2);
                if (coins < 1) coins = 1;
                if (coins > 50) coins = 50;
                
                fileInfo = {
                    name: file.name,
                    pages: pdf.numPages,
                    words: totalWords,
                    baseCost: coins
                };
                
                console.log('تم تحليل الملف:', fileInfo);
                
                document.getElementById('page-count').textContent = fileInfo.pages;
                document.getElementById('cost-amount').textContent = coins + ' عملة';
                document.getElementById('cost-preview').classList.add('show');
                
                updateTotalCost();
                
                hideLoading();
                showNotification('تم تحليل الملف بنجاح', 'success');
                
            } catch (error) {
                console.error('خطأ في تحليل PDF:', error);
                hideLoading();
                showNotification('فشل تحليل الملف', 'error');
                resetFileInput();
            }
        }
        
        // ========== إعادة تعيين رفع الملف ==========
        function resetFileInput() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            
            pdfFile.value = '';
            selectedFile = null;
            pdfBase64 = null;
            uploadText.textContent = 'انقر لرفع ملف PDF';
            uploadText.style.color = '';
            uploadText.style.fontWeight = '';
            uploadArea.style.borderColor = '';
            uploadArea.style.backgroundColor = '';
            
            document.getElementById('cost-preview').classList.remove('show');
            
            fileInfo = { name: '', pages: 0, words: 0, baseCost: 0 };
        }
        
        // ========== إلغاء العملية ==========
        function cancelProcess() {
            resetFileInput();
            showNotification('تم إلغاء العملية', 'info');
        }
        
        // ========== تأكيد المتابعة ==========
        function confirmProcess() {
            console.log('تأكيد المتابعة');
            console.log('selectedFile:', selectedFile ? 'موجود' : 'غير موجود');
            console.log('fileInfo.baseCost:', fileInfo.baseCost);
            console.log('userCoins:', userCoins);
            
            if (!selectedFile) {
                showNotification('الرجاء اختيار ملف PDF أولاً', 'error');
                return;
            }
            
            if (!fileInfo.baseCost || fileInfo.baseCost === 0) {
                showNotification('الرجاء انتظار تحليل الملف', 'error');
                return;
            }
            
            if (userCoins < fileInfo.baseCost) {
                showNotification(`رصيدك غير كافٍ. تحتاج ${fileInfo.baseCost} عملة ورصيدك ${userCoins}`, 'error');
                return;
            }
            
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('questions-section').classList.add('show');
            document.getElementById('cost-preview').classList.remove('show');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ========== توليد الأسئلة ==========
        async function generateQuestions() {
            console.log('بدء توليد الأسئلة');
            console.log('selectedFile:', selectedFile ? 'موجود' : 'غير موجود');
            console.log('pdfBase64:', pdfBase64 ? 'موجود' : 'غير موجود');
            console.log('userCoins:', userCoins);
            console.log('totalCost:', currentSettings.totalCost);
            
            if (!selectedFile || !pdfBase64) {
                showNotification('الرجاء اختيار ملف PDF أولاً', 'error');
                return;
            }
            
            if (userCoins < currentSettings.totalCost) {
                showNotification(`رصيدك غير كافٍ. تحتاج ${currentSettings.totalCost} عملة ورصيدك ${userCoins}`, 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التوليد...';
            
            try {
                showLoading('جاري توليد الأسئلة...');
                
                let prompt = '';
                
                if (currentSettings.questionType === 'مقالي') {
                    prompt = `ROLE:
You are an AI specialized in strict PDF-based question extraction.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES:
========================
عدد_الاسئلة = ${currentSettings.questionsCount}
درجة_الصعوبة = ${currentSettings.difficulty}

========================
TASK:
========================

1. Analyze the provided PDF from the first word to the last word only.
2. Do NOT use any external knowledge.
3. Do NOT infer, guess, or generate content not present in the PDF.
4. You must strictly generate exactly عدد_الاسئلة questions — no more, no less.
5. Questions must follow the selected درجة_الصعوبة definition:
   • سهل: direct questions explicitly stated in the PDF.
   • متوسط: questions logically derived from PDF content only.
   • صعب: questions requiring deep understanding of the full PDF content.
6. Questions must be clear, concise, and strictly based on PDF content.
7. Output ONLY the questions, numbered as follows:

Q1 : السؤال
Q2 : السؤال
Q3 : السؤال
...
(Exactly عدد_الاسئلة)

========================
ABSOLUTE CONSTRAINTS:
========================

- Output MUST be plain text only.
- No answers.
- No commentary.
- No explanation.
- No JSON or Markdown.
- If PDF is empty, corrupted, or unreadable, return exactly:

INVALID_PDF`;
                } else {
                    prompt = `ROLE:
You are an AI specialized in PDF-based question generation.

INPUT VARIABLES:
عدد_الاسئلة = ${currentSettings.questionsCount}
درجة_الصعوبة = ${currentSettings.difficulty}
نوع_الاسئلة = ${currentSettings.questionType}

TASK:
Generate exactly ${currentSettings.questionsCount} questions from the PDF.

FORMAT:
Type : ${currentSettings.questionType}
${Array.from({length: currentSettings.questionsCount}, (_, i) => `
Q${i+1} : السؤال
${currentSettings.questionType === 'اختياري' ? 
`R : خيار1
R : خيار2
R : خيار3
R : خيار4` : 
`R : صح
R : خطأ`}
Correct : الإجابة الصحيحة`).join('\n')}

ABSOLUTE CONSTRAINTS:
- All content must exist verbatim in PDF
- No external knowledge
- Plain text only
- If PDF is invalid, return: INVALID_PDF`;
                }
                
                console.log('إرسال الطلب إلى السيرفر...');
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: prompt,
                        PDF_BASE64: pdfBase64
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`فشل الاتصال بالسيرفر: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('استجابة السيرفر:', text.substring(0, 200) + '...');
                
                if (text.includes('INVALID_PDF')) {
                    throw new Error('الملف غير صالح أو لا يمكن قراءته');
                }
                
                questions = parseQuestions(text, currentSettings.questionType);
                
                if (!questions || questions.length === 0) {
                    throw new Error('لم يتم توليد أي أسئلة');
                }
                
                console.log('تم توليد', questions.length, 'سؤال');
                
                await deductCoins(currentSettings.totalCost);
                await saveToDatabase();
                
                document.getElementById('questions-section').classList.remove('show');
                document.getElementById('questions-display-section').classList.add('show');
                document.getElementById('submit-container').style.display = 'block';
                hideFooter();
                
                isSubmitted = false;
                essayResults = null;
                userAnswers = new Array(questions.length).fill(null);
                essayAnswers = {};
                currentEssayIndex = 0;
                
                displayQuestions(questions);
                
                showNotification(`تم توليد ${questions.length} سؤال بنجاح`, 'success');
                
            } catch (error) {
                console.error('خطأ في توليد الأسئلة:', error);
                showNotification('خطأ: ' + error.message, 'error');
            } finally {
                hideLoading();
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-robot"></i> توليد الأسئلة';
            }
        }
        
        // ========== تحليل النص المستلم ==========
        function parseQuestions(text, type) {
            const questions = [];
            const lines = text.split('\n').filter(l => l.trim() !== '');
            
            if (type === 'مقالي') {
                let questionNumber = 1;
                lines.forEach(line => {
                    if (line.startsWith('Q')) {
                        const questionText = line.substring(line.indexOf(':') + 1).trim();
                        if (questionText) {
                            questions.push({
                                number: questionNumber++,
                                type: 'مقالي',
                                question: questionText,
                                options: [],
                                correct: '',
                                userAnswer: '',
                                modelAnswer: '',
                                matchPercentage: 0
                            });
                        }
                    }
                });
            } else {
                let currentQuestion = null;
                
                lines.forEach(line => {
                    if (line.startsWith('Q')) {
                        if (currentQuestion) questions.push(currentQuestion);
                        const questionText = line.substring(line.indexOf(':') + 1).trim();
                        currentQuestion = {
                            number: questions.length + 1,
                            type: type,
                            question: questionText,
                            options: [],
                            correct: '',
                            userAnswer: '',
                            isCorrect: false
                        };
                    } else if (line.startsWith('R') && currentQuestion) {
                        const option = line.substring(line.indexOf(':') + 1).trim();
                        if (option && (option === 'صح' || option === 'خطأ' || option.length > 0)) {
                            currentQuestion.options.push(option);
                        }
                    } else if (line.startsWith('Correct') && currentQuestion) {
                        const correct = line.substring(line.indexOf(':') + 1).trim();
                        currentQuestion.correct = correct;
                    }
                });
                
                if (currentQuestion) questions.push(currentQuestion);
            }
            
            return questions;
        }
        
        // ========== عرض الأسئلة ==========
        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            const resultsContainer = document.getElementById('results-container');
            
            document.getElementById('question-type-display').textContent = 
                currentSettings.questionType === 'اختياري' ? 'اختيار من متعدد' : 
                currentSettings.questionType === 'صح وخطأ' ? 'صح وخطأ' : 'مقالي';
            document.getElementById('difficulty-display').textContent = currentSettings.difficulty;
            
            if (isSubmitted) {
                displayResults();
            } else {
                resultsContainer.innerHTML = '';
            }
            
            let html = '';
            
            if (currentSettings.questionType === 'مقالي') {
                html += `<div id="essay-question-container">`;
                html += displayEssayQuestion(currentEssayIndex);
                html += `</div>`;
            } else {
                questions.forEach((q, index) => {
                    const userAnswer = userAnswers[index] || '';
                    const isCorrect = q.correct === userAnswer;
                    
                    html += `
                        <div class="question-item" id="q-${index}">
                            ${isSubmitted ? `
                                <div class="result-badge ${isCorrect ? 'correct' : 'wrong'}">
                                    <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                    ${isCorrect ? 'إجابة صحيحة' : 'إجابة خاطئة'}
                                </div>
                            ` : ''}
                            
                            <div class="question-header">
                                <span class="question-number">سؤال ${index + 1}</span>
                                <span class="question-type-badge">
                                    <i class="fas ${q.type === 'اختياري' ? 'fa-check-circle' : 'fa-check-double'}"></i>
                                    ${q.type === 'اختياري' ? 'اختيار من متعدد' : 'صح وخطأ'}
                                </span>
                            </div>
                            
                            <div class="question-text">${q.question}</div>
                    `;
                    
                    if (q.type === 'اختياري') {
                        html += `<div class="options-container" id="options-${index}">`;
                        q.options.forEach((option, optIndex) => {
                            if (option && option !== 'صح' && option !== 'خطأ') {
                                const isSelected = userAnswer === option;
                                const isCorrectAnswer = q.correct === option;
                                
                                let optionClass = 'option-item';
                                if (isSubmitted) {
                                    if (isCorrectAnswer) optionClass += ' correct-answer';
                                    if (isSelected && !isCorrect) optionClass += ' wrong-answer';
                                } else {
                                    if (isSelected) optionClass += ' selected';
                                }
                                
                                html += `
                                    <div class="${optionClass}" onclick="${!isSubmitted ? `window.selectOption(${index}, '${option.replace(/'/g, "\\'")}', this)` : ''}">
                                        <span class="option-check"></span>
                                        <span class="option-text">${option}</span>
                                        ${isSubmitted && isCorrectAnswer ? ' <i class="fas fa-check" style="color: var(--success-color); margin-right: auto; font-size: 1.2rem;"></i>' : ''}
                                        ${isSubmitted && isSelected && !isCorrect ? ' <i class="fas fa-times" style="color: var(--error-color); margin-right: auto; font-size: 1.2rem;"></i>' : ''}
                                    </div>
                                `;
                            }
                        });
                        html += `</div>`;
                        
                        if (isSubmitted) {
                            html += `
                                <div style="margin-top: 20px; padding: 16px; background: rgba(23, 162, 184, 0.06); border-radius: 16px; border-right: 6px solid var(--info-color);">
                                    <span style="font-weight: 700; color: var(--info-color);"><i class="fas fa-info-circle"></i> الإجابة الصحيحة:</span>
                                    <span style="margin-right: 12px; font-weight: 600; font-size: 1.1rem;">${q.correct}</span>
                                </div>
                            `;
                        }
                    } else {
                        html += `
                            <div class="tf-container" id="options-${index}">
                                <div class="tf-option ${isSubmitted && q.correct === 'صح' ? 'correct-answer' : ''} ${!isSubmitted && userAnswer === 'صح' ? 'selected' : ''} ${isSubmitted && userAnswer === 'صح' && q.correct !== 'صح' ? 'wrong-answer' : ''}" 
                                     onclick="${!isSubmitted ? `window.selectTF(${index}, 'صح', this)` : ''}">
                                    صح
                                    ${isSubmitted && q.correct === 'صح' ? ' <i class="fas fa-check" style="margin-right: 10px;"></i>' : ''}
                                    ${isSubmitted && userAnswer === 'صح' && q.correct !== 'صح' ? ' <i class="fas fa-times" style="margin-right: 10px;"></i>' : ''}
                                </div>
                                <div class="tf-option ${isSubmitted && q.correct === 'خطأ' ? 'correct-answer' : ''} ${!isSubmitted && userAnswer === 'خطأ' ? 'selected' : ''} ${isSubmitted && userAnswer === 'خطأ' && q.correct !== 'خطأ' ? 'wrong-answer' : ''}" 
                                     onclick="${!isSubmitted ? `window.selectTF(${index}, 'خطأ', this)` : ''}">
                                    خطأ
                                    ${isSubmitted && q.correct === 'خطأ' ? ' <i class="fas fa-check" style="margin-right: 10px;"></i>' : ''}
                                    ${isSubmitted && userAnswer === 'خطأ' && q.correct !== 'خطأ' ? ' <i class="fas fa-times" style="margin-right: 10px;"></i>' : ''}
                                </div>
                            </div>
                        `;
                        
                        if (isSubmitted) {
                            html += `
                                <div style="margin-top: 20px; padding: 16px; background: rgba(23, 162, 184, 0.06); border-radius: 16px; border-right: 6px solid var(--info-color);">
                                    <span style="font-weight: 700; color: var(--info-color);"><i class="fas fa-info-circle"></i> الإجابة الصحيحة:</span>
                                    <span style="margin-right: 12px; font-weight: 600; font-size: 1.1rem;">${q.correct}</span>
                                </div>
                            `;
                        }
                    }
                    
                    html += `</div>`;
                });
            }
            
            container.innerHTML = html;
            updateSubmitButtonState();
        }
        
        // ========== عرض السؤال المقالي ==========
        function displayEssayQuestion(index) {
            if (!questions.length) return '';
            
            const q = questions[index];
            const savedAnswer = essayAnswers[index] || '';
            const isAnswered = isSubmitted && essayResults && essayResults[index];
            
            let html = `
                <div class="question-item">
                    ${isSubmitted && isAnswered ? `
                        <div class="result-badge ${parseInt(essayResults[index].match) >= 50 ? 'correct' : 'wrong'}">
                            <i class="fas ${parseInt(essayResults[index].match) >= 50 ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ${parseInt(essayResults[index].match) >= 50 ? 'إجابة مقبولة' : 'إجابة غير مقبولة'}
                        </div>
                    ` : ''}
                    
                    <div class="question-header">
                        <span class="question-number">سؤال ${index + 1} من ${questions.length}</span>
                        <span class="question-type-badge">
                            <i class="fas fa-pen"></i>
                            مقالي
                        </span>
                    </div>
                    
                    <div class="question-text">${q.question}</div>
            `;
            
            if (isSubmitted && isAnswered) {
                html += `
                    <div style="margin-bottom: 24px; padding: 20px; background: white; border: 2px solid rgba(139, 90, 43, 0.15); border-radius: 18px;">
                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-pen" style="color: var(--accent-primary);"></i>
                            إجابتك:
                        </div>
                        <div style="padding: 16px; background: rgba(139, 90, 43, 0.04); border-radius: 14px; line-height: 1.7;">${essayAnswers[index] || 'لم تتم الإجابة'}</div>
                    </div>
                    
                    <div class="essay-model-answer">
                        <div class="essay-model-answer-title">
                            <i class="fas fa-book-open"></i>
                            الإجابة النموذجية من PDF
                        </div>
                        <div style="line-height: 1.8; font-size: 1.05rem;">${essayResults[index].correct || 'غير متوفرة'}</div>
                        <span class="essay-match-percentage ${parseInt(essayResults[index].match) >= 50 ? 'match-high' : 'match-low'}">
                            <i class="fas ${parseInt(essayResults[index].match) >= 50 ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                            نسبة التطابق: ${essayResults[index].match}%
                        </span>
                    </div>
                `;
            } else {
                html += `
                    <div class="essay-input-container">
                        <textarea class="essay-textarea" id="essay-${index}" placeholder="اكتب إجابتك هنا..." oninput="window.saveEssayAnswer(${index}, this.value)">${savedAnswer}</textarea>
                        <div class="essay-status">
                            <span class="essay-saved" id="essay-status-${index}">
                                ${savedAnswer ? '<i class="fas fa-check-circle"></i> تم الحفظ' : '<i class="fas fa-info-circle"></i> لم تتم الإجابة بعد'}
                            </span>
                            <span><i class="fas fa-text-height"></i> ${savedAnswer.length} حرف</span>
                        </div>
                    </div>
                    
                    <div class="essay-nav-buttons">
                        <button class="essay-nav-btn" onclick="window.navigateEssay(${index - 1})" ${index === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-right"></i>
                            السابق
                        </button>
                        <button class="essay-nav-btn" onclick="window.navigateEssay(${index + 1})" ${index === questions.length - 1 ? 'disabled' : ''}>
                            التالي
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            return html;
        }
        
        // ========== اختيار إجابة اختيارية ==========
        window.selectOption = function(index, option, element) {
            if (isSubmitted) return;
            
            userAnswers[index] = option;
            questions[index].userAnswer = option;
            
            const container = document.getElementById(`options-${index}`);
            if (container) {
                container.querySelectorAll('.option-item').forEach(el => {
                    el.classList.remove('selected');
                });
            }
            
            element.classList.add('selected');
            updateSubmitButtonState();
            
            // حفظ في Firebase فوري
            saveAnswerToFirebase(index, option);
        };
        
        // ========== اختيار صح/خطأ ==========
        window.selectTF = function(index, value, element) {
            if (isSubmitted) return;
            
            userAnswers[index] = value;
            questions[index].userAnswer = value;
            
            const container = document.getElementById(`options-${index}`);
            if (container) {
                container.querySelectorAll('.tf-option').forEach(el => {
                    el.classList.remove('selected');
                });
            }
            
            element.classList.add('selected');
            updateSubmitButtonState();
            
            // حفظ في Firebase فوري
            saveAnswerToFirebase(index, value);
        };
        
        // ========== حفظ الإجابة المقالية ==========
        window.saveEssayAnswer = function(index, value) {
            if (isSubmitted) return;
            
            essayAnswers[index] = value;
            userAnswers[index] = value;
            questions[index].userAnswer = value;
            
            const statusEl = document.getElementById(`essay-status-${index}`);
            if (statusEl) {
                if (value.trim()) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> تم الحفظ';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-info-circle"></i> لم تتم الإجابة بعد';
                }
            }
            
            updateSubmitButtonState();
            
            // حفظ في Firebase فوري
            saveAnswerToFirebase(index, value);
        };
        
        // ========== حفظ الإجابة في Firebase ==========
        async function saveAnswerToFirebase(index, answer) {
            if (!currentUser) return;
            
            try {
                const answerId = `answer_${currentUser.id}_${Date.now()}_${index}`;
                await database.ref(`essay_answers/${answerId}`).set({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    fileName: fileInfo.name,
                    questionIndex: index,
                    questionText: questions[index]?.question || '',
                    answer: answer,
                    timestamp: Date.now()
                });
                console.log(`تم حفظ الإجابة ${index + 1} في Firebase`);
            } catch (error) {
                console.error('خطأ في حفظ الإجابة:', error);
            }
        }
        
        // ========== التنقل بين الأسئلة المقالية ==========
        window.navigateEssay = function(index) {
            if (isSubmitted) return;
            
            if (index >= 0 && index < questions.length) {
                currentEssayIndex = index;
                const container = document.getElementById('essay-question-container');
                if (container) {
                    container.innerHTML = displayEssayQuestion(index);
                }
            }
        };
        
        // ========== تحديث حالة زر التسليم ==========
        function updateSubmitButtonState() {
            const submitBtn = document.getElementById('submit-btn');
            
            if (isSubmitted || !questions || questions.length === 0) {
                submitBtn.classList.remove('active');
                return;
            }
            
            let allAnswered = true;
            
            if (currentSettings.questionType === 'مقالي') {
                for (let i = 0; i < questions.length; i++) {
                    if (!essayAnswers[i] || !essayAnswers[i].trim()) {
                        allAnswered = false;
                        break;
                    }
                }
            } else {
                for (let i = 0; i < questions.length; i++) {
                    if (!userAnswers[i]) {
                        allAnswered = false;
                        break;
                    }
                }
            }
            
            if (allAnswered) {
                submitBtn.classList.add('active');
            } else {
                submitBtn.classList.remove('active');
            }
            
            const answeredCount = userAnswers.filter(a => a !== null && a !== '').length;
            const progress = questions.length > 0 ? (answeredCount / questions.length) * 100 : 0;
            document.getElementById('answer-progress').style.width = progress + '%';
        }
        
        // ========== تسليم الإجابات ==========
        async function submitAnswers() {
            const submitBtn = document.getElementById('submit-btn');
            
            if (!submitBtn.classList.contains('active')) {
                showNotification('الرجاء الإجابة على جميع الأسئلة أولاً', 'error');
                return;
            }
            
            isSubmitted = true;
            
            if (currentSettings.questionType === 'مقالي') {
                await gradeEssayQuestions();
            } else {
                await gradeObjectiveQuestions();
            }
        }
        
        // ========== تصحيح الأسئلة الموضوعية ==========
        async function gradeObjectiveQuestions() {
            showLoading('جاري تصحيح الإجابات...');
            
            setTimeout(() => {
                let correct = 0;
                
                questions.forEach((q, index) => {
                    q.userAnswer = userAnswers[index] || '';
                    q.isCorrect = q.userAnswer === q.correct;
                    if (q.isCorrect) correct++;
                });
                
                const wrong = questions.length - correct;
                const percentage = Math.round((correct / questions.length) * 100);
                
                displayResults(correct, wrong, percentage);
                displayQuestions(questions);
                
                hideLoading();
                showNotification('تم تصحيح الإجابات بنجاح', 'success');
                
            }, 2000);
        }
        
        // ========== تصحيح الأسئلة المقالية ==========
        async function gradeEssayQuestions() {
            try {
                showLoading('جاري تصحيح الإجابات المقالية...');
                
                let answersText = '';
                questions.forEach((q, index) => {
                    answersText += `Q${index + 1} : ${q.question}\n`;
                    answersText += `R${index + 1} : ${essayAnswers[index] || ''}\n\n`;
                });
                
                const prompt = `ROLE:
You are an AI specialized in grading and evaluating textual answers.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES:
========================
- أسئلة مقالية مسحوبة من PDF (Q1, Q2, …)
- إجابات المستخدم المقابلة (R1, R2, …)

========================
TASK:
========================

1. Compare each user answer (R1, R2, …) with the model answer strictly based on PDF content.
2. For each سؤال:
   - Identify the correct answer from PDF.
   - Compare it with user's answer.
   - Calculate نسبة التطابق (%) between user's answer and النموذجية.
3. Output ONLY the following format for each سؤال:

Q1
Correct : الاجابة النموذجية
E : نسبة التطابق

Q2
Correct : الاجابة النموذجية
E : نسبة التطابق

...

========================
ABSOLUTE CONSTRAINTS:
========================

- Do NOT write explanations.
- Do NOT provide commentary.
- Do NOT modify the questions or numbering.
- Do NOT use external knowledge.
- Output MUST be plain text only.
- If PDF is empty or unreadable, return exactly:

INVALID_PDF`;

                console.log('إرسال طلب تصحيح المقالي...');
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: prompt,
                        PDF_BASE64: pdfBase64
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`فشل الاتصال بالسيرفر: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('استجابة تصحيح المقالي:', text.substring(0, 200) + '...');
                
                if (text.includes('INVALID_PDF')) {
                    throw new Error('فشل في تصحيح الإجابات');
                }
                
                essayResults = parseGradingResults(text);
                
                let correct = 0;
                essayResults.forEach((result, index) => {
                    const matchPercent = parseInt(result.match) || 0;
                    if (matchPercent >= 50) correct++;
                    
                    if (questions[index]) {
                        questions[index].modelAnswer = result.correct || 'غير متوفرة';
                        questions[index].matchPercentage = matchPercent;
                    }
                });
                
                const wrong = questions.length - correct;
                const percentage = Math.round((correct / questions.length) * 100);
                
                displayResults(correct, wrong, percentage);
                displayQuestions(questions);
                
                hideLoading();
                showNotification('تم تصحيح الإجابات المقالية بنجاح', 'success');
                
            } catch (error) {
                console.error('خطأ في تصحيح المقالي:', error);
                
                // Fallback
                essayResults = questions.map((q, index) => ({
                    question: `Q${index + 1}`,
                    correct: 'الإجابة النموذجية مستخرجة من PDF',
                    match: '85'
                }));
                
                let correct = questions.length;
                const percentage = 100;
                
                displayResults(correct, 0, percentage);
                displayQuestions(questions);
                
                hideLoading();
                showNotification('تم تسليم الإجابات بنجاح', 'success');
            }
        }
        
        // ========== تحليل نتائج التصحيح ==========
        function parseGradingResults(text) {
            const results = [];
            const lines = text.split('\n').filter(l => l.trim() !== '');
            
            let currentResult = {};
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('Q')) {
                    if (currentResult.question) results.push(currentResult);
                    currentResult = { question: line };
                } else if (line.startsWith('Correct :')) {
                    currentResult.correct = line.substring(line.indexOf(':') + 1).trim();
                } else if (line.startsWith('E :')) {
                    currentResult.match = line.substring(line.indexOf(':') + 1).trim().replace('%', '');
                }
            }
            
            if (currentResult.question) results.push(currentResult);
            return results;
        }
        
        // ========== عرض النتائج ==========
        function displayResults(correct, wrong, percentage) {
            const resultsContainer = document.getElementById('results-container');
            
            let message = '';
            if (percentage >= 90) message = '🎓 ممتاز! أداء رائع، أنت مستعد تماماً';
            else if (percentage >= 75) message = '🌟 جيد جداً! واصل التقدم';
            else if (percentage >= 60) message = '📚 جيد! ركز على النقاط التي أخطأت فيها';
            else if (percentage >= 40) message = '💪 لا بأس، الممارسة ستجعلك أفضل';
            else message = '📖 استمر في المراجعة، النجاح يحتاج صبراً';
            
            const angle = (percentage / 100) * 360;
            
            resultsContainer.innerHTML = `
                <div class="results-section show">
                    <h2 class="results-title">نتيجة الاختبار</h2>
                    
                    <div class="score-circle">
                        <div class="score-circle-bg">
                            <div class="score-circle-fill" style="--angle: ${angle}deg;"></div>
                            <div class="score-circle-inner">
                                <div class="score-percentage">${isNaN(percentage) ? '0' : percentage}%</div>
                                <div class="score-label">نسبة النجاح</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${correct || 0}</div>
                            <div class="stat-label">إجابات صحيحة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${wrong || 0}</div>
                            <div class="stat-label">إجابات خاطئة</div>
                        </div>
                    </div>
                    
                    <div class="encouragement-message">
                        ${message}
                    </div>
                </div>
            `;
            
            document.getElementById('submit-container').style.display = 'none';
        }
        
        // ========== خصم العملات ==========
        async function deductCoins(amount) {
            if (!currentUser) {
                console.log('لا يوجد مستخدم لخصم العملات');
                return;
            }
            
            try {
                console.log('خصم', amount, 'عملات من', userCoins);
                userCoins -= amount;
                if (userCoins < 0) userCoins = 0;
                
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(userCoins);
                document.getElementById('coins-count').textContent = userCoins;
                
                console.log('تم خصم', amount, 'عملات. الرصيد المتبقي:', userCoins);
                showNotification(`تم خصم ${amount} عملة`, 'success');
            } catch (error) {
                console.error('خطأ في خصم العملات:', error);
                showNotification('فشل في خصم العملات', 'error');
            }
        }
        
        // ========== حفظ النتائج في قاعدة البيانات ==========
        async function saveToDatabase() {
            if (!currentUser) return;
            
            try {
                const recordId = 'questions_' + Date.now();
                await database.ref(`records/${recordId}`).set({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    fileName: fileInfo.name,
                    settings: currentSettings,
                    questions: questions,
                    timestamp: Date.now()
                });
                console.log('تم حفظ النتائج في قاعدة البيانات');
            } catch (error) {
                console.error('خطأ في حفظ النتائج:', error);
            }
        }
        
        // ========== إظهار التحميل ==========
        function showLoading(text) {
            const loadingScreen = document.getElementById('loading-screen');
            document.getElementById('loading-text').textContent = text;
            loadingScreen.classList.add('show');
        }
        
        // ========== إخفاء التحميل ==========
        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.remove('show');
        }
        
        // ========== إظهار الإشعار ==========
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notification-icon');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            
            if (type === 'success') {
                notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            } else {
                notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ========== إخفاء/إظهار الفوتر ==========
        function hideFooter() {
            const footer = document.getElementById('footer');
            if (footer) footer.classList.add('hidden');
        }
        
        function showFooter() {
            const footer = document.getElementById('footer');
            if (footer) footer.classList.remove('hidden');
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
