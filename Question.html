<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ÿπŸàŸÜ - ŸÅŸÑÿßÿ¥ ŸÉÿßÿ±ÿØ ŸÖŸÜ PDF</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ŸÜŸÅÿ≥ ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ÿµŸÑŸä */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        :root {
            --bg-color: #F5F1E8;
            --card-color: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-primary: #8B7355;
            --accent-secondary: #A9927D;
            --accent-dark: #5D4037;
            --border-color: #D4A574;
            --border-radius: 16px;
            --border-radius-lg: 20px;
            --border-radius-xl: 24px;
            --navbar-height: 70px;
            --transition-smooth: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-card: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --info-color: #2196F3;
            --gradient-primary: linear-gradient(145deg, #8B7355 0%, #A9927D 100%);
            --gradient-success: linear-gradient(145deg, #4CAF50 0%, #45a049 100%);
            --gradient-error: linear-gradient(145deg, #F44336 0%, #d32f2f 100%);
            --gradient-info: linear-gradient(145deg, #2196F3 0%, #1976D2 100%);
            --gradient-warning: linear-gradient(145deg, #FF9800 0%, #F57C00 100%);
            --shadow-light: 0 4px 12px rgba(139, 115, 85, 0.1);
            --shadow-medium: 0 8px 24px rgba(139, 115, 85, 0.15);
            --shadow-heavy: 0 12px 36px rgba(139, 115, 85, 0.2);
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
            --shadow-button: 0 4px 15px rgba(139, 115, 85, 0.2);
            --shadow-button-hover: 0 8px 25px rgba(139, 115, 85, 0.3);
        }
        
        body {
            font-family: 'Almarai', 'Tajawal', -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            -webkit-font-smoothing: antialiased;
            width: 100vw;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 800;
            font-size: 56px;
            color: var(--accent-primary);
            margin-bottom: 25px;
            letter-spacing: -1px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 115, 85, 0.1);
            border-left-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1.1rem;
            text-align: center;
            max-width: 80%;
            line-height: 1.6;
        }
        
        /* Navbar */
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: var(--bg-color);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 max(25px, env(safe-area-inset-right));
            z-index: 10000;
            border-bottom: 1px solid rgba(139, 115, 85, 0.12);
            box-shadow: var(--shadow-light);
            padding-top: env(safe-area-inset-top);
        }
        
        .logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 42px;
            color: var(--accent-primary);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        
        .coins-display {
            background: var(--gradient-primary);
            color: white;
            padding: 12px 25px;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-light);
            transition: var(--transition-smooth);
        }
        
        .coins-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .coins-display i {
            font-size: 18px;
        }
        
        /* Main Content */
        .main-content {
            padding-top: calc(var(--navbar-height) + 20px);
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            padding-bottom: 50px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - var(--navbar-height) - 70px);
        }
        
        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: var(--shadow-medium);
            text-align: center;
            border: 1px solid rgba(139, 115, 85, 0.12);
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .section-title {
            font-family: 'Almarai', sans-serif;
            font-size: clamp(1.8rem, 4vw, 2.2rem);
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .section-subtitle {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: clamp(1rem, 2vw, 1.1rem);
            margin-bottom: 30px;
            font-weight: 400;
            line-height: 1.6;
            text-align: center;
        }
        
        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: min(50px, 8vh) 25px;
            margin-bottom: 30px;
            cursor: pointer;
            transition: var(--transition-smooth);
            background: rgba(212, 165, 116, 0.05);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(212, 165, 116, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .upload-icon {
            font-size: clamp(48px, 8vw, 56px);
            color: var(--accent-primary);
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-family: 'Tajawal', sans-serif;
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .upload-hint {
            font-family: 'Tajawal', sans-serif;
            font-size: clamp(0.9rem, 2vw, 0.95rem);
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Cost Preview */
        .cost-preview {
            background: rgba(139, 115, 85, 0.06);
            border-radius: var(--border-radius-xl);
            padding: 25px;
            margin-top: 30px;
            border: 1px solid rgba(139, 115, 85, 0.12);
            display: none;
            animation: slideUp 0.4s ease-out;
            width: 100%;
        }
        
        .cost-preview.show {
            display: block;
        }
        
        .cost-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .cost-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .cost-item {
            text-align: center;
            flex: 1;
            min-width: 160px;
        }
        
        .cost-label {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .cost-value {
            font-family: 'Almarai', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .cost-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Button Styles */
        .action-btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            min-width: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-button);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .action-btn:active {
            transform: scale(0.98);
        }
        
        .confirm-btn {
            background: var(--gradient-success);
            color: white;
        }
        
        .cancel-btn {
            background: var(--gradient-error);
            color: white;
        }
        
        /* Questions Settings Section - ŸÖÿπÿØŸÑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ */
        .questions-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(139, 115, 85, 0.12);
            display: none;
            animation: slideUp 0.4s ease-out;
            width: 100%;
            max-width: 900px;
        }
        
        .questions-section.show {
            display: block;
        }
        
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(300px, 100%), 1fr));
            gap: 30px;
            margin-bottom: 35px;
        }
        
        .question-group {
            background: rgba(139, 115, 85, 0.04);
            border-radius: var(--border-radius-xl);
            padding: 25px;
            border: 1px solid rgba(139, 115, 85, 0.12);
        }
        
        .question-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-title i {
            color: var(--accent-secondary);
        }
        
        /* ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© */
        .question-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .type-btn {
            padding: 16px 12px;
            border: 2px solid rgba(139, 115, 85, 0.25);
            border-radius: var(--border-radius);
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .type-btn i {
            font-size: 1.1rem;
            color: var(--accent-secondary);
        }
        
        .type-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }
        
        .type-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-medium);
        }
        
        .type-btn.selected i {
            color: white;
        }
        
        /* ÿ≠ÿØŸàÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© */
        .question-limit {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            color: var(--info-color);
            margin-top: 12px;
            padding: 12px;
            background: rgba(33, 150, 243, 0.08);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .question-limit i {
            font-size: 1rem;
        }
        
        /* Slider Styling */
        .slider-container {
            padding: 25px 0;
        }
        
        .slider-value {
            font-family: 'Almarai', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 15px;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .slider {
            width: 100%;
            height: 25px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary));
            outline: none;
            border-radius: 12px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 38px;
            height: 38px;
            border-radius: var(--border-radius);
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            border: 4px solid white;
            transition: var(--transition-smooth);
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-heavy);
        }
        
        .additional-cost {
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: 15px;
        }
        
        .additional-cost span {
            color: var(--success-color);
            font-weight: 700;
        }
        
        /* Difficulty Options */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .option-btn {
            padding: 14px 16px;
            border: 2px solid rgba(139, 115, 85, 0.25);
            border-radius: var(--border-radius);
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            min-height: 48px;
        }
        
        .option-btn:active {
            transform: scale(0.98);
        }
        
        .option-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }
        
        .option-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-medium);
        }
        
        .generate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 18px 45px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: block;
            margin: 0 auto;
            min-width: min(280px, 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-button);
            touch-action: manipulation;
        }
        
        .generate-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: var(--shadow-button-hover);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Questions Display Section - ÿ¨ÿØŸäÿØ */
        .questions-display-section {
            background: white;
            border-radius: var(--border-radius-xl);
            padding: 35px;
            margin-bottom: 35px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.12);
            display: none;
            animation: slideUp 0.4s ease-out;
            width: 100%;
            max-width: 1200px;
        }
        
        .questions-display-section.show {
            display: block;
        }
        
        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(139, 115, 85, 0.12);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .questions-header-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .questions-header-info {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            background: rgba(139, 115, 85, 0.06);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px 5px;
        }
        
        .question-item {
            background: rgba(139, 115, 85, 0.04);
            border-radius: var(--border-radius-xl);
            padding: 25px;
            border: 1px solid rgba(139, 115, 85, 0.12);
            transition: var(--transition-smooth);
        }
        
        .question-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 115, 85, 0.12);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .question-number-badge {
            background: var(--accent-primary);
            color: white;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .question-type-badge {
            background: rgba(139, 115, 85, 0.1);
            color: var(--accent-primary);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .question-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            line-height: 1.8;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .option-item {
            background: white;
            border: 2px solid rgba(139, 115, 85, 0.15);
            border-radius: var(--border-radius);
            padding: 15px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            transition: var(--transition-smooth);
        }
        
        .option-item.correct {
            background: rgba(76, 175, 80, 0.1);
            border-color: var(--success-color);
            position: relative;
        }
        
        .option-item.correct::after {
            content: '‚úì';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--success-color);
            font-weight: 900;
            font-size: 1.3rem;
        }
        
        .correct-answer-label {
            display: inline-block;
            background: var(--success-color);
            color: white;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .question-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed rgba(139, 115, 85, 0.2);
            color: var(--text-secondary);
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            font-style: italic;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 35px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Almarai', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            min-width: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow-button);
        }
        
        .export-btn:active {
            transform: scale(0.98);
        }
        
        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-button-hover);
        }
        
        .export-pdf-btn {
            background: var(--gradient-error);
            color: white;
        }
        
        .export-txt-btn {
            background: var(--gradient-info);
            color: white;
        }
        
        .new-questions-btn {
            background: var(--gradient-primary);
            color: white;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 45px 20px;
            color: var(--text-secondary);
            border-top: 1px solid rgba(139, 115, 85, 0.12);
            margin-top: 45px;
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 900px;
            display: block;
        }
        
        .footer.hidden {
            display: none;
        }
        
        .copyright {
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 35px;
            font-weight: 400;
        }
        
        .support-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 35px;
        }
        
        .support-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 12px;
        }
        
        .support-links {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .support-link {
            width: 56px;
            height: 56px;
            border-radius: var(--border-radius);
            background: var(--gradient-primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-button);
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        .support-link:active {
            transform: scale(0.95);
        }
        
        .support-link:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-button-hover);
        }
        
        .support-link i {
            font-size: 26px;
            color: white;
        }
        
        .developer-credit {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            color: rgba(100, 116, 139, 0.6);
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(139, 115, 85, 0.06);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .developer-credit:hover {
            color: var(--accent-primary);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: calc(var(--navbar-height) + 20px);
            right: max(20px, env(safe-area-inset-right));
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-heavy);
            border: 1px solid rgba(139, 115, 85, 0.12);
            z-index: 10001;
            min-width: min(320px, 90vw);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-right: 5px solid var(--success-color);
        }
        
        .notification.error {
            border-right: 5px solid var(--error-color);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-icon {
            font-size: 24px;
        }
        
        .notification.success .notification-icon {
            color: var(--success-color);
        }
        
        .notification.error .notification-icon {
            color: var(--error-color);
        }
        
        .notification-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.05rem;
        }
        
        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .native-navbar {
                padding: 0 20px;
                padding-top: env(safe-area-inset-top);
                height: calc(65px + env(safe-area-inset-top));
            }
            
            .logo {
                font-size: 32px;
            }
            
            .coins-display {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .main-content {
                padding-top: calc(65px + env(safe-area-inset-top) + 20px);
                padding-left: 20px;
                padding-right: 20px;
                padding-bottom: 40px;
                min-height: calc(100vh - 65px - env(safe-area-inset-top) - 60px);
                justify-content: flex-start;
            }
            
            .upload-section, .questions-section, .questions-display-section, .results-section {
                padding: 25px 20px;
            }
            
            .upload-area {
                padding: 35px 20px;
            }
            
            .cost-details {
                flex-direction: column;
                gap: 20px;
            }
            
            .cost-item {
                min-width: 100%;
            }
            
            .cost-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-btn {
                min-width: 100%;
                padding: 14px 20px;
            }
            
            .questions-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .question-type-grid {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .generate-btn {
                min-width: 100%;
                padding: 16px 30px;
            }
            
            .questions-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .questions-header-info {
                justify-content: center;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-btn {
                min-width: 100%;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                min-width: auto;
                top: calc(65px + env(safe-area-inset-top) + 15px);
            }
        }
        
        @media (max-width: 480px) {
            .logo {
                font-size: 28px;
            }
            
            .coins-display {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .upload-icon {
                font-size: 42px;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Prevent Copy */
        .question-text, .option-item, .question-content, .answer-content {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .action-btn:hover,
            .option-btn:hover,
            .type-btn:hover,
            .generate-btn:hover,
            .export-btn:hover,
            .support-link:hover {
                transform: none !important;
            }
            
            .action-btn:active,
            .option-btn:active,
            .type-btn:active,
            .generate-btn:active,
            .export-btn:active,
            .support-link:active {
                transform: scale(0.98) !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen" style="display: none;">
        <div class="loading-logo">ÿπŸàŸÜ</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="native-navbar" id="navbar">
        <div class="logo" id="home-logo">ÿπŸàŸÜ</div>
        <div class="nav-left">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <h1 class="section-title">ÿÆÿØŸÖÿ© ŸÅŸÑÿßÿ¥ ŸÉÿßÿ±ÿØ ŸÖŸÜ PDF</h1>
            <p class="section-subtitle">ÿßÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ Ÿàÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ∞ŸÉŸäÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</p>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="upload-text" id="upload-text">ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF</div>
                <div class="upload-hint">ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ÿßŸÑŸÖŸÑŸÅ ŸáŸÜÿß</div>
            </div>
            
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
            
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©</h3>
                <div class="cost-details">
                    <div class="cost-item">
                        <div class="cost-label">ÿπÿØÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™</div>
                        <div class="cost-value" id="page-count">0</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©</div>
                        <div class="cost-value" id="cost-amount">0 ÿπŸÖŸÑÿ©</div>
                    </div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" id="cancel-btn">
                        <i class="fas fa-times"></i>
                        ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                    <button class="action-btn confirm-btn" id="confirm-btn">
                        <i class="fas fa-check"></i>
                        ŸÖÿ™ÿßÿ®ÿπÿ©
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Questions Settings Section - ŸÖÿπÿØŸÑ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ -->
        <section class="questions-section" id="questions-section">
            <h2 class="section-title">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©</h2>
            <p class="section-subtitle">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸàÿπÿØÿØŸáÿß ŸàŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµÿπŸàÿ®ÿ©</p>
            
            <div class="questions-grid">
                <!-- ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-tasks"></i>
                        ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©
                    </h3>
                    <div class="question-type-grid" id="question-type">
                        <button class="type-btn selected" data-type="ÿßÿÆÿ™Ÿäÿßÿ±Ÿä">
                            <i class="fas fa-check-circle"></i>
                            ÿßÿÆÿ™Ÿäÿßÿ±Ÿä
                        </button>
                        <button class="type-btn" data-type="ÿµÿ≠ ŸàÿÆÿ∑ÿ£">
                            <i class="fas fa-check-double"></i>
                            ÿµÿ≠ ŸàÿÆÿ∑ÿ£
                        </button>
                        <button class="type-btn" data-type="ŸÖŸÇÿßŸÑŸä">
                            <i class="fas fa-pen"></i>
                            ŸÖŸÇÿßŸÑŸä
                        </button>
                    </div>
                    <div class="question-limit" id="question-limit">
                        <i class="fas fa-info-circle"></i>
                        ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ: <span id="max-questions">80</span> ÿ≥ÿ§ÿßŸÑ
                    </div>
                </div>
                
                <!-- ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-question-circle"></i>
                        ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©
                    </h3>
                    <div class="slider-container">
                        <div class="slider-value" id="questions-count">10</div>
                        <div class="slider-labels">
                            <span id="min-label">1</span>
                            <span id="mid-label">40</span>
                            <span id="max-label">80</span>
                        </div>
                        <input type="range" min="1" max="80" value="10" class="slider" id="questions-slider">
                        <div class="additional-cost" id="additional-cost">
                            ÿ™ŸÉŸÑŸÅÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©: <span id="extra-cost">0</span> ÿπŸÖŸÑÿ©
                        </div>
                    </div>
                </div>
                
                <!-- ÿØÿ±ÿ¨ÿ© ÿßŸÑÿµÿπŸàÿ®ÿ© -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-chart-line"></i>
                        ÿØÿ±ÿ¨ÿ© ÿßŸÑÿµÿπŸàÿ®ÿ©
                    </h3>
                    <div class="options-grid" id="difficulty-level">
                        <button class="option-btn selected" data-value="ÿ≥ŸáŸÑ">ÿ≥ŸáŸÑ</button>
                        <button class="option-btn" data-value="ŸÖÿ™Ÿàÿ≥ÿ∑">ŸÖÿ™Ÿàÿ≥ÿ∑</button>
                        <button class="option-btn" data-value="ÿµÿπÿ®">ÿµÿπÿ®</button>
                    </div>
                </div>
                
                <!-- ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© -->
                <div class="question-group">
                    <h3 class="question-title">
                        <i class="fas fa-calculator"></i>
                        ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©
                    </h3>
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-family: 'Almarai', sans-serif; color: var(--text-secondary); font-size: 1rem; margin-bottom: 8px;">
                            ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
                        </div>
                        <div style="font-family: 'Almarai', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--accent-primary); margin-bottom: 12px;" id="base-cost-display">
                            0 ÿπŸÖŸÑÿ©
                        </div>
                        <div style="height: 2px; background: rgba(139, 115, 85, 0.2); margin: 15px 0;"></div>
                        <div style="font-family: 'Almarai', sans-serif; color: var(--text-secondary); font-size: 1rem; margin-bottom: 8px;">
                            ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©
                        </div>
                        <div style="font-family: 'Almarai', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--success-color); margin-bottom: 12px;" id="total-extra-cost">
                            +0 ÿπŸÖŸÑÿ©
                        </div>
                        <div style="height: 2px; background: rgba(139, 115, 85, 0.2); margin: 15px 0;"></div>
                        <div style="font-family: 'Almarai', sans-serif; color: var(--accent-primary); font-size: 1rem; margin-bottom: 8px;">
                            ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©
                        </div>
                        <div style="font-family: 'Almarai', sans-serif; font-size: 2.5rem; font-weight: 900; color: var(--accent-primary);" id="total-cost-display">
                            0 ÿπŸÖŸÑÿ©
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="generate-btn" id="generate-btn">
                <i class="fas fa-robot"></i>
                ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©
            </button>
        </section>
        
        <!-- Questions Display Section - ÿ¨ÿØŸäÿØ -->
        <section class="questions-display-section" id="questions-display-section">
            <div class="questions-header">
                <h2 class="questions-header-title">ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ÿ©</h2>
                <div class="questions-header-info">
                    <span><i class="fas fa-file-pdf"></i> <span id="file-name-display"></span></span>
                    <span><i class="fas fa-list"></i> <span id="questions-type-display"></span></span>
                    <span><i class="fas fa-layer-group"></i> <span id="questions-difficulty-display"></span></span>
                </div>
            </div>
            
            <div class="questions-container" id="questions-container">
                <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸáŸÜÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
            </div>
            
            <div class="export-buttons">
                <button class="export-btn export-pdf-btn" id="export-pdf-btn">
                    <i class="fas fa-file-pdf"></i>
                    ÿ™ÿµÿØŸäÿ± PDF
                </button>
                <button class="export-btn export-txt-btn" id="export-txt-btn">
                    <i class="fas fa-file-alt"></i>
                    ÿ™ÿµÿØŸäÿ± TXT
                </button>
                <button class="export-btn new-questions-btn" id="new-questions-btn">
                    <i class="fas fa-plus-circle"></i>
                    ÿ•ŸÜÿ¥ÿßÿ° ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ¨ÿØŸäÿØÿ©
                </button>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer" id="footer">
            <p class="copyright">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÖŸÜÿµÿ© ÿπŸàŸÜ¬© 2026</p>
            
            <div class="support-section">
                <div class="support-title">ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä</div>
                <div class="support-links">
                    <a href="https://wa.me/966583617539" target="_blank" class="support-link">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="https://t.me/HNHv1" target="_blank" class="support-link">
                        <i class="fab fa-telegram"></i>
                    </a>
                </div>
            </div>
            
            <div class="developer-credit">
                ÿ®ÿ±ŸÖÿ¨ÿ© Ÿàÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± ùêäùêàùêåùêé
            </div>
        </footer>
    </div>
    
    <script>
        // ÿ™ŸáŸäÿ¶ÿ© PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let fileInfo = {
            name: '',
            size: 0,
            pages: 0,
            words: 0,
            baseCost: 0
        };
        
        let currentSettings = {
            questionType: 'ÿßÿÆÿ™Ÿäÿßÿ±Ÿä',
            questionsCount: 10,
            difficulty: 'ÿ≥ŸáŸÑ',
            totalCost: 0,
            extraCost: 0,
            maxQuestions: 80
        };
        
        let generatedQuestions = null;
        
        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";
        
        // ========== ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ==========
        
        function reloadPage() {
            location.reload();
        }
        
        function showNotification(message, type = 'info') {
            try {
                const notification = document.getElementById('notification');
                const notificationIcon = document.getElementById('notification-icon');
                const notificationText = document.getElementById('notification-text');
                
                if (!notification || !notificationIcon || !notificationText) {
                    console.error('Notification elements not found');
                    return;
                }
                
                notificationText.textContent = message;
                notification.className = 'notification';
                
                if (type === 'success') {
                    notification.classList.add('success');
                    notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                } else if (type === 'error') {
                    notification.classList.add('error');
                    notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                } else {
                    notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } catch (error) {
                console.error('Error in showNotification:', error);
            }
        }
        
        function showLoading(text = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...') {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            
            if (loadingScreen && loadingText) {
                loadingText.textContent = text;
                loadingScreen.style.display = 'flex';
                setTimeout(() => {
                    loadingScreen.style.opacity = '1';
                }, 10);
            }
        }
        
        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            }
        }
        
        function hideFooter() {
            const footer = document.getElementById('footer');
            if (footer) {
                footer.classList.add('hidden');
            }
        }
        
        function showFooter() {
            const footer = document.getElementById('footer');
            if (footer) {
                footer.classList.remove('hidden');
            }
        }
        
        // ========== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ==========
        
        async function loadUserData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    window.location.replace('login.html');
                    return;
                }
                
                const usersRef = database.ref('users_Awn');
                const snapshot = await usersRef.once('value');
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    let userFound = false;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userId !== 'noty_publick' && userData.email === user.email) {
                            currentUser = {
                                id: userId,
                                email: userData.email,
                                name: userData.name || '',
                                coin: userData.coin || 0,
                                admin: userData.admin === true || false,
                                banned: userData.banned === true || false
                            };
                            
                            userCoins = userData.coin || 0;
                            const coinsCount = document.getElementById('coins-count');
                            if (coinsCount) {
                                coinsCount.textContent = userCoins;
                            }
                            userFound = true;
                            break;
                        }
                    }
                    
                    if (!userFound) {
                        await auth.signOut();
                        window.location.replace('login.html');
                    }
                } else {
                    await auth.signOut();
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.location.replace('login.html');
            }
        }
        
        async function setupUser() {
            try {
                await loadUserData();
                
                if (currentUser && currentUser.banned !== true) {
                    const navbar = document.getElementById('navbar');
                    const mainContent = document.getElementById('main-content');
                    
                    if (navbar) navbar.style.display = 'flex';
                    if (mainContent) mainContent.style.display = 'block';
                    
                    showFooter();
                } else {
                    window.location.replace('login.html');
                }
            } catch (error) {
                console.error('Error setting up user:', error);
                window.location.replace('login.html');
            }
        }
        
        // ========== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ==========
        
        function setupFileUpload() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadArea = document.getElementById('upload-area');
            const confirmBtn = document.getElementById('confirm-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            if (pdfFile) {
                pdfFile.addEventListener('change', handleFileSelect);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('click', () => pdfFile.click());
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmProcess);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelProcess);
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-primary)';
                uploadArea.style.backgroundColor = 'rgba(212, 165, 116, 0.1)';
            }
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                await handleFile(files[0]);
            }
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            await handleFile(file);
        }
        
        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF ŸÅŸÇÿ∑', 'error');
                resetFileInput();
                return;
            }
            
            selectedFile = file;
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            
            if (uploadText) uploadText.textContent = file.name;
            if (uploadArea) {
                uploadArea.style.borderColor = 'var(--accent-primary)';
                uploadArea.style.backgroundColor = 'rgba(212, 165, 116, 0.1)';
            }
            
            await analyzePDF(file);
        }
        
        async function analyzePDF(file) {
            try {
                const loadingMessages = [
                    'ÿπŸàŸÜ Ÿäÿ≠ŸÑŸÑ ÿßŸÑŸÖŸÑŸÅ...',
                    'ÿπŸàŸÜ Ÿäÿ≥ÿ™ÿÆÿ±ÿ¨ ÿßŸÑŸÜÿµ...',
                    'ÿπŸàŸÜ ŸäÿπÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™...',
                    'ÿπŸàŸÜ Ÿäÿ≠ÿ≥ÿ® ÿßŸÑÿ™ŸÉŸÑŸÅÿ©...'
                ];
                
                let messageIndex = 0;
                const loadingInterval = setInterval(() => {
                    showLoading(loadingMessages[messageIndex]);
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                }, 1500);
                
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    if (content.items.length > 0) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else {
                        totalWords += 250;
                    }
                }
                
                clearInterval(loadingInterval);
                
                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;
                coins = Math.round(coins * 10) / 10;
                
                fileInfo = {
                    name: file.name,
                    size: file.size,
                    pages: pdf.numPages,
                    words: totalWords,
                    baseCost: coins
                };
                
                hideLoading();
                
                const pageCount = document.getElementById('page-count');
                const costAmount = document.getElementById('cost-amount');
                const costPreview = document.getElementById('cost-preview');
                const baseCostDisplay = document.getElementById('base-cost-display');
                
                if (pageCount) pageCount.textContent = fileInfo.pages;
                if (costAmount) costAmount.textContent = fileInfo.baseCost + ' ÿπŸÖŸÑÿ©';
                if (baseCostDisplay) baseCostDisplay.textContent = fileInfo.baseCost + ' ÿπŸÖŸÑÿ©';
                if (costPreview) costPreview.classList.add('show');
                
                updateTotalCost();
                
                showNotification('ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                
            } catch (error) {
                console.error('Error analyzing PDF:', error);
                hideLoading();
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error');
                resetFileInput();
            }
        }
        
        function resetFileInput() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadText = document.getElementById('upload-text');
            const uploadArea = document.getElementById('upload-area');
            const costPreview = document.getElementById('cost-preview');
            
            if (pdfFile) pdfFile.value = '';
            selectedFile = null;
            if (uploadText) uploadText.textContent = 'ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ PDF';
            if (uploadArea) {
                uploadArea.style.borderColor = '';
                uploadArea.style.backgroundColor = '';
            }
            if (costPreview) costPreview.classList.remove('show');
        }
        
        function cancelProcess() {
            resetFileInput();
            const costPreview = document.getElementById('cost-preview');
            if (costPreview) costPreview.classList.remove('show');
            showNotification('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©', 'info');
        }
        
        function confirmProcess() {
            const uploadSection = document.getElementById('upload-section');
            const questionsSection = document.getElementById('questions-section');
            const costPreview = document.getElementById('cost-preview');
            
            if (!uploadSection || !questionsSection || !costPreview) {
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÜÿßÿµÿ±', 'error');
                return;
            }
            
            if (!fileInfo || !fileInfo.baseCost || fileInfo.baseCost === 0) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }
            
            if (userCoins < fileInfo.baseCost) {
                showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä. ÿ™ÿ≠ÿ™ÿßÿ¨ ${fileInfo.baseCost} ÿπŸÖŸÑÿ© ÿ®ŸäŸÜŸÖÿß ÿ±ÿµŸäÿØŸÉ ${userCoins}`, 'error');
                return;
            }
            
            uploadSection.style.display = 'none';
            questionsSection.classList.add('show');
            costPreview.classList.remove('show');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸàÿπÿØÿØŸáÿß ŸàÿØÿ±ÿ¨ÿ© ÿßŸÑÿµÿπŸàÿ®ÿ©', 'success');
        }
        
        // ========== ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ==========
        
        function setupQuestionsEvents() {
            // ÿ•ÿπÿØÿßÿØ ÿ£ÿ≤ÿ±ÿßÿ± ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©
            const typeBtns = document.querySelectorAll('#question-type .type-btn');
            typeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    const type = this.getAttribute('data-type');
                    currentSettings.questionType = type;
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÜŸàÿπ
                    updateQuestionLimit(type);
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ŸÑÿßŸäÿØÿ±
                    updateSliderRange();
                    
                    // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÉŸÑŸÅÿ©
                    updateExtraCost();
                });
            });
            
            // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ≥ŸÑÿßŸäÿØÿ± ŸÑÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©
            const questionsSlider = document.getElementById('questions-slider');
            if (questionsSlider) {
                questionsSlider.addEventListener('input', function() {
                    updateQuestionsCount();
                });
            }
            
            // ÿ•ÿπÿØÿßÿØ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿµÿπŸàÿ®ÿ©
            const difficultyBtns = document.querySelectorAll('#difficulty-level .option-btn');
            difficultyBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    difficultyBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.difficulty = this.getAttribute('data-value');
                });
            });
            
            // ÿ≤ÿ± ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateQuestions);
            }
            
            // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿµÿØŸäÿ±
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', exportToPDF);
            }
            
            const exportTxtBtn = document.getElementById('export-txt-btn');
            if (exportTxtBtn) {
                exportTxtBtn.addEventListener('click', exportToTXT);
            }
            
            const newQuestionsBtn = document.getElementById('new-questions-btn');
            if (newQuestionsBtn) {
                newQuestionsBtn.addEventListener('click', resetToUpload);
            }
            
            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ
            updateQuestionLimit('ÿßÿÆÿ™Ÿäÿßÿ±Ÿä');
            updateQuestionsCount();
        }
        
        function updateQuestionLimit(type) {
            const maxQuestionsElement = document.getElementById('max-questions');
            const minLabel = document.getElementById('min-label');
            const midLabel = document.getElementById('mid-label');
            const maxLabel = document.getElementById('max-label');
            
            let maxQuestions;
            
            if (type === 'ŸÖŸÇÿßŸÑŸä') {
                maxQuestions = 50;
            } else {
                maxQuestions = 80;
            }
            
            currentSettings.maxQuestions = maxQuestions;
            
            if (maxQuestionsElement) {
                maxQuestionsElement.textContent = maxQuestions;
            }
            
            if (minLabel) minLabel.textContent = '1';
            if (maxLabel) maxLabel.textContent = maxQuestions;
            
            if (type === 'ŸÖŸÇÿßŸÑŸä') {
                if (midLabel) midLabel.textContent = '25';
            } else {
                if (midLabel) midLabel.textContent = '40';
            }
            
            // ÿßŸÑÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑÿß ÿ™ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ
            if (currentSettings.questionsCount > maxQuestions) {
                currentSettings.questionsCount = maxQuestions;
                const countDisplay = document.getElementById('questions-count');
                const slider = document.getElementById('questions-slider');
                if (countDisplay) countDisplay.textContent = maxQuestions;
                if (slider) {
                    slider.value = maxQuestions;
                    slider.max = maxQuestions;
                }
            } else {
                const slider = document.getElementById('questions-slider');
                if (slider) slider.max = maxQuestions;
            }
            
            updateExtraCost();
        }
        
        function updateSliderRange() {
            const slider = document.getElementById('questions-slider');
            if (slider) {
                slider.max = currentSettings.maxQuestions;
                if (currentSettings.questionsCount > currentSettings.maxQuestions) {
                    currentSettings.questionsCount = currentSettings.maxQuestions;
                    slider.value = currentSettings.maxQuestions;
                    const countDisplay = document.getElementById('questions-count');
                    if (countDisplay) countDisplay.textContent = currentSettings.maxQuestions;
                }
            }
        }
        
        function updateQuestionsCount() {
            const slider = document.getElementById('questions-slider');
            const countDisplay = document.getElementById('questions-count');
            
            if (!slider || !countDisplay) return;
            
            const count = parseInt(slider.value);
            countDisplay.textContent = count;
            currentSettings.questionsCount = count;
            
            updateExtraCost();
            updateTotalCost();
        }
        
        function updateExtraCost() {
            const extraCostDisplay = document.getElementById('extra-cost');
            if (!extraCostDisplay) return;
            
            const count = currentSettings.questionsCount;
            const type = currentSettings.questionType;
            
            let extraCost = 0;
            
            if (type === 'ŸÖŸÇÿßŸÑŸä') {
                if (count >= 1 && count <= 10) {
                    extraCost = 0;
                } else if (count >= 11 && count <= 20) {
                    extraCost = 8;
                } else if (count >= 21 && count <= 30) {
                    extraCost = 8;
                } else if (count >= 31 && count <= 50) {
                    extraCost = 12;
                }
            } else { // ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ÿ£Ÿà ÿµÿ≠ ŸàÿÆÿ∑ÿ£
                if (count >= 1 && count <= 10) {
                    extraCost = 0;
                } else if (count >= 11 && count <= 20) {
                    extraCost = 0;
                } else if (count >= 21 && count <= 40) {
                    extraCost = 5;
                } else if (count >= 41 && count <= 60) {
                    extraCost = 8;
                } else if (count >= 61 && count <= 80) {
                    extraCost = 11;
                }
            }
            
            currentSettings.extraCost = extraCost;
            extraCostDisplay.textContent = extraCost;
            
            updateTotalCost();
        }
        
        function updateTotalCost() {
            const totalExtraCostDisplay = document.getElementById('total-extra-cost');
            const totalCostDisplay = document.getElementById('total-cost-display');
            
            if (totalExtraCostDisplay && totalCostDisplay) {
                const baseCost = fileInfo.baseCost || 0;
                const extraCost = currentSettings.extraCost || 0;
                const totalCost = baseCost + extraCost;
                
                currentSettings.totalCost = totalCost;
                
                totalExtraCostDisplay.textContent = `+${extraCost} ÿπŸÖŸÑÿ©`;
                totalCostDisplay.textContent = `${totalCost} ÿπŸÖŸÑÿ©`;
            }
        }
        
        function createPrompt() {
            return `ROLE:
You are an AI specialized in strict PDF-based question generation following Google Gemini Flash 2.5 Lite standards.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES (IN ARABIC):
========================
ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© = ${currentSettings.questionsCount}
ÿØÿ±ÿ¨ÿ©_ÿßŸÑÿµÿπŸàÿ®ÿ© = ${currentSettings.difficulty}
ŸÜŸàÿπ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© = ${currentSettings.questionType}

========================
TASK:
========================

1. Analyze the provided PDF from the first word to the last word only.
2. Do NOT use any external knowledge.
3. Do NOT infer, guess, paraphrase, or generate any content that does not explicitly exist inside the PDF.
4. Every word used in:
   - The question
   - The answer choices
   - The correct answer
   MUST exist verbatim inside the PDF text.
5. You must strictly generate exactly ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© questions ‚Äî no more, no less.
6. You must strictly follow the selected ŸÜŸàÿπ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© format.
7. You must strictly follow the selected ÿØÿ±ÿ¨ÿ©_ÿßŸÑÿµÿπŸàÿ®ÿ© definition:

   ‚Ä¢ ÿ≥ŸáŸÑ:
     - Questions must be direct and explicitly stated in the PDF.
     - Answers must be clearly found word-for-word in the text.

   ‚Ä¢ ŸÖÿ™Ÿàÿ≥ÿ∑:
     - Questions must be logically derived only from the PDF content.
     - Still fully based on the PDF only.
     - No external additions allowed.

   ‚Ä¢ ÿµÿπÿ®:
     - Questions must require deep understanding of the entire PDF.
     - May combine multiple parts of the PDF.
     - Still 100% restricted to PDF content only.

8. The AI must read the entire PDF from beginning to end before generating questions.
9. If the PDF is empty, corrupted, unreadable, or contains no meaningful content, return exactly:

INVALID_PDF

========================
OUTPUT FORMAT RULES (STRICT):
========================

- Output MUST be plain text only.
- No JSON.
- No Markdown.
- No explanations.
- No commentary.
- No additional text before or after questions.
- No deviation from the required structure.

========================
FORMAT RULES PER QUESTION TYPE:
========================

If ŸÜŸàÿπ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© = ÿßÿÆÿ™Ÿäÿßÿ±Ÿä

Return exactly in this format:

Type : ÿßÿÆÿ™Ÿäÿßÿ±Ÿä
Q1 : ÿßŸÑÿ≥ÿ§ÿßŸÑ
R : ÿßÿÆÿ™Ÿäÿßÿ±
R : ÿßÿÆÿ™Ÿäÿßÿ±
R : ÿßÿÆÿ™Ÿäÿßÿ±
R : ÿßÿÆÿ™Ÿäÿßÿ±
Correct : ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµÿ≠Ÿäÿ≠

(Repeat the same structure until reaching exactly ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ©)

All answer choices must exist inside the PDF.
All incorrect choices must also exist inside the PDF.
No fabricated text is allowed.

--------------------------------------------------

If ŸÜŸàÿπ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© = ÿµÿ≠ ŸàÿÆÿ∑ÿ£

Return exactly in this format:

Type : ÿµÿ≠ ŸàÿÆÿ∑ÿ£
Q1 : ÿßŸÑÿ≥ÿ§ÿßŸÑ
R : ÿµÿ≠
R : ÿÆÿ∑ÿ£
Correct : ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©

(Repeat the same structure until reaching exactly ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ©)

The statement must be constructed strictly from PDF text only.

--------------------------------------------------

If ŸÜŸàÿπ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ© = ŸÖŸÇÿßŸÑŸä

Return exactly in this format:

Type : ŸÖŸÇÿßŸÑŸä
Q1 : ÿßŸÑÿ≥ÿ§ÿßŸÑÿü
R : ÿ•ÿ¨ÿßÿ®ÿ©
R : ÿ•ÿ¨ÿßÿ®ÿ©
R : ÿ•ÿ¨ÿßÿ®ÿ©
R : ÿ•ÿ¨ÿßÿ®ÿ©
Correct : ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©

(Repeat the same structure until reaching exactly ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ©)

All answer options must exist word-for-word inside the PDF.
The correct answer must be one of the listed answers.
No external wording allowed.

========================
ABSOLUTE CONSTRAINTS:
========================

- The number of questions must exactly equal ÿπÿØÿØ_ÿßŸÑÿßÿ≥ÿ¶ŸÑÿ©.
- All generated content must come strictly from the PDF.
- No hallucination.
- No paraphrasing outside the PDF wording.
- No external knowledge.
- Deterministic behavior only.
- If any constraint cannot be satisfied, return exactly:

CONSTRAINT_VIOLATION`;
        }
        
        async function generateQuestions() {
            if (!selectedFile) {
                showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ PDF ÿ£ŸàŸÑÿßŸã', 'error');
                return;
            }
            
            if (userCoins < currentSettings.totalCost) {
                showNotification(`ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä. ÿ™ÿ≠ÿ™ÿßÿ¨ ${currentSettings.totalCost} ÿπŸÖŸÑÿ© ÿ®ŸäŸÜŸÖÿß ÿ±ÿµŸäÿØŸÉ ${userCoins}`, 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°...';
            }
            
            try {
                const loadingMessages = [
                    'ÿπŸàŸÜ Ÿäÿ≠ŸÑŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ...',
                    'ÿπŸàŸÜ ŸäŸÇÿ±ÿ£ ÿßŸÑŸÖŸÑŸÅ...',
                    'ÿπŸàŸÜ Ÿäÿ¨Ÿáÿ≤ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©...',
                    'ÿπŸàŸÜ ŸäŸÜÿ≥ŸÇ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™...',
                    'ÿπŸàŸÜ ŸäŸÉŸÖŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©...'
                ];
                
                let messageIndex = 0;
                const loadingInterval = setInterval(() => {
                    showLoading(loadingMessages[messageIndex]);
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                }, 2000);
                
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const result = reader.result;
                        const base64Data = result.split(',')[1];
                        resolve(base64Data);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });
                
                const prompt = createPrompt();
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        id: ID,
                        pass: PASS,
                        data: prompt,
                        PDF_BASE64: base64
                    })
                });
                
                clearInterval(loadingInterval);
                
                if (!response.ok) {
                    throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±: ${response.status}`);
                }
                
                const text = await response.text();
                
                if (text.includes('INVALID_PDF') || text.includes('CONSTRAINT_VIOLATION')) {
                    throw new Error('ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÑÿß ŸäŸÖŸÉŸÜ ŸÇÿ±ÿßÿ°ÿ™Ÿá ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠');
                }
                
                generatedQuestions = parseQuestionsFromText(text);
                
                if (!generatedQuestions || generatedQuestions.length === 0) {
                    throw new Error('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ£Ÿä ÿ£ÿ≥ÿ¶ŸÑÿ©');
                }
                
                await deductCoins(currentSettings.totalCost);
                await saveResultToDatabase(generatedQuestions);
                
                const questionsSection = document.getElementById('questions-section');
                const questionsDisplaySection = document.getElementById('questions-display-section');
                
                if (questionsSection) questionsSection.classList.remove('show');
                if (questionsDisplaySection) questionsDisplaySection.classList.add('show');
                
                hideFooter();
                
                displayQuestions(generatedQuestions);
                
                showNotification(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ${generatedQuestions.length} ÿ≥ÿ§ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠`, 'success');
                
            } catch (error) {
                console.error('Error generating questions:', error);
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©: ' + error.message, 'error');
            } finally {
                hideLoading();
                const generateBtn = document.getElementById('generate-btn');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-robot"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©';
                }
            }
        }
        
        function parseQuestionsFromText(text) {
            const questions = [];
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            let currentQuestion = null;
            let type = '';
            
            // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿ£ŸàŸÑ ÿ≥ÿ∑ÿ±
            if (lines[0] && lines[0].includes('Type :')) {
                type = lines[0].replace('Type :', '').trim();
            }
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('Q')) {
                    if (currentQuestion) {
                        questions.push(currentQuestion);
                    }
                    
                    const questionNumber = parseInt(line.match(/Q(\d+)/)?.[1] || questions.length + 1);
                    const questionText = line.substring(line.indexOf(':') + 1).trim();
                    
                    currentQuestion = {
                        number: questionNumber,
                        type: type,
                        question: questionText,
                        options: [],
                        correct: ''
                    };
                } else if (line.startsWith('R')) {
                    if (currentQuestion) {
                        const option = line.substring(line.indexOf(':') + 1).trim();
                        currentQuestion.options.push(option);
                    }
                } else if (line.startsWith('Correct :')) {
                    if (currentQuestion) {
                        const correct = line.substring(line.indexOf(':') + 1).trim();
                        currentQuestion.correct = correct;
                    }
                }
            }
            
            if (currentQuestion) {
                questions.push(currentQuestion);
            }
            
            return questions;
        }
        
        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            const fileNameDisplay = document.getElementById('file-name-display');
            const questionsTypeDisplay = document.getElementById('questions-type-display');
            const questionsDifficultyDisplay = document.getElementById('questions-difficulty-display');
            
            if (!container) return;
            
            if (fileNameDisplay) fileNameDisplay.textContent = fileInfo.name || 'ŸÖŸÑŸÅ PDF';
            if (questionsTypeDisplay) questionsTypeDisplay.textContent = currentSettings.questionType;
            if (questionsDifficultyDisplay) questionsDifficultyDisplay.textContent = currentSettings.difficulty;
            
            let html = '';
            
            questions.forEach((q, index) => {
                html += `
                    <div class="question-item">
                        <div class="question-header">
                            <span class="question-number-badge">ÿ≥ÿ§ÿßŸÑ ${index + 1}</span>
                            <span class="question-type-badge">
                                <i class="fas ${getTypeIcon(q.type)}"></i>
                                ${q.type}
                            </span>
                        </div>
                        <div class="question-text">${q.question}</div>
                        <div class="options-container">
                `;
                
                q.options.forEach((option, optIndex) => {
                    const isCorrect = option === q.correct;
                    html += `
                        <div class="option-item ${isCorrect ? 'correct' : ''}">
                            ${option}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="correct-answer-label">
                            <i class="fas fa-check-circle"></i>
                            ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ${q.correct}
                        </div>
                        <div class="question-footer">
                            <i class="fas fa-info-circle"></i>
                            ŸÖÿ≥ÿ™ÿÆÿ±ÿ¨ ŸÖŸÜ PDF ŸÅŸÇÿ∑
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getTypeIcon(type) {
            if (type.includes('ÿßÿÆÿ™Ÿäÿßÿ±Ÿä')) return 'fa-check-circle';
            if (type.includes('ÿµÿ≠')) return 'fa-check-double';
            if (type.includes('ŸÖŸÇÿßŸÑŸä')) return 'fa-pen';
            return 'fa-question-circle';
        }
        
        function exportToPDF() {
            if (!generatedQuestions || generatedQuestions.length === 0) {
                showNotification('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±', 'error');
                return;
            }
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≠ÿ™ŸàŸâ PDF
            let content = `
                ========================================
                        ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ÿ© ŸÖŸÜ PDF
                ========================================
                
                ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ: ${fileInfo.name}
                ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©: ${currentSettings.questionType}
                ÿØÿ±ÿ¨ÿ© ÿßŸÑÿµÿπŸàÿ®ÿ©: ${currentSettings.difficulty}
                ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©: ${generatedQuestions.length}
                ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°: ${new Date().toLocaleDateString('ar-EG')}
                
                ========================================
                
            `;
            
            generatedQuestions.forEach((q, index) => {
                content += `
                    ÿßŸÑÿ≥ÿ§ÿßŸÑ ${index + 1}: ${q.question}
                    --------------------------------------------------
                `;
                
                q.options.forEach((option, optIndex) => {
                    const marker = option === q.correct ? '‚úì' : '‚óã';
                    content += `                    ${marker} ${option}\n`;
                });
                
                content += `\n                    ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ${q.correct}\n`;
                content += `                    ==========================================\n\n`;
            });
            
            // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ∑ÿ®ÿßÿπÿ©
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ÿ© - ÿπŸàŸÜ</title>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            padding: 40px;
                            line-height: 1.8;
                            direction: rtl;
                        }
                        pre {
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            font-size: 14px;
                        }
                    </style>
                </head>
                <body>
                    <pre>${content}</pre>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showNotification('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿ•ŸÑŸâ PDF', 'success');
        }
        
        function exportToTXT() {
            if (!generatedQuestions || generatedQuestions.length === 0) {
                showNotification('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±', 'error');
                return;
            }
            
            let content = `ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ÿ© ŸÖŸÜ PDF
========================================
ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ: ${fileInfo.name}
ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©: ${currentSettings.questionType}
ÿØÿ±ÿ¨ÿ© ÿßŸÑÿµÿπŸàÿ®ÿ©: ${currentSettings.difficulty}
ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©: ${generatedQuestions.length}
ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°: ${new Date().toLocaleDateString('ar-EG')}
========================================

`;
            
            generatedQuestions.forEach((q, index) => {
                content += `ÿßŸÑÿ≥ÿ§ÿßŸÑ ${index + 1}: ${q.question}\n`;
                content += `--------------------------------------------------\n`;
                
                q.options.forEach((option, optIndex) => {
                    const marker = option === q.correct ? '‚úì' : '‚óã';
                    content += `${marker} ${option}\n`;
                });
                
                content += `\nÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ${q.correct}\n`;
                content += `=========================================\n\n`;
            });
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ TXT
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ÿßÿ≥ÿ¶ŸÑÿ©_ÿπŸàŸÜ_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿ•ŸÑŸâ TXT', 'success');
        }
        
        function resetToUpload() {
            const questionsDisplaySection = document.getElementById('questions-display-section');
            const uploadSection = document.getElementById('upload-section');
            
            if (questionsDisplaySection) questionsDisplaySection.classList.remove('show');
            if (uploadSection) uploadSection.style.display = 'flex';
            
            showFooter();
            
            resetFileInput();
            
            generatedQuestions = null;
            
            showNotification('ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ', 'info');
        }
        
        async function deductCoins(amount) {
            try {
                const newCoins = userCoins - amount;
                userCoins = newCoins;
                
                await database.ref(`users_Awn/${currentUser.id}/coin`).set(newCoins);
                const coinsCount = document.getElementById('coins-count');
                if (coinsCount) {
                    coinsCount.textContent = newCoins;
                }
                
            } catch (error) {
                console.error('Error deducting coins:', error);
                throw error;
            }
        }
        
        async function saveResultToDatabase(questions) {
            try {
                const recordId = 'questions_' + Date.now();
                const recordData = {
                    id: currentUser.id,
                    process: 'ÿ™ŸàŸÑŸäÿØ ÿ£ÿ≥ÿ¶ŸÑÿ©',
                    questions: questions,
                    timestamp: Date.now(),
                    fileName: fileInfo.name,
                    baseCost: fileInfo.baseCost,
                    extraCost: currentSettings.extraCost,
                    totalCost: currentSettings.totalCost,
                    pages: fileInfo.pages,
                    questionsCount: currentSettings.questionsCount,
                    difficulty: currentSettings.difficulty,
                    questionType: currentSettings.questionType
                };
                
                await database.ref(`records/${recordId}`).set(recordData);
                
            } catch (error) {
                console.error('Error saving result to database:', error);
            }
        }
        
        // ========== ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ==========
        
        async function initApp() {
            showLoading('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
            
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    hideLoading();
                    window.location.replace('login.html');
                    return;
                }
                
                try {
                    await setupUser();
                    setupFileUpload();
                    setupQuestionsEvents();
                    
                    const logo = document.getElementById('home-logo');
                    if (logo) {
                        logo.addEventListener('click', reloadPage);
                    }
                    
                    hideLoading();
                    
                } catch (error) {
                    console.error('Error initializing app:', error);
                    hideLoading();
                    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ', 'error');
                } finally {
                    setTimeout(() => {
                        unsubscribe();
                    }, 100);
                }
            });
        }
        
        history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function(event) {
            history.pushState(null, null, window.location.href);
        });
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
