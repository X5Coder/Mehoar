<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø¹ÙˆÙ† - ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† PDF</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ®ØµØµ Ù„Ù„Ù‡Ø§ØªÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: 'Tajawal', 'Almarai', sans-serif;
        }
        
        :root {
            --bg-color: #F5F1E8;
            --card-color: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-primary: #8B7355;
            --accent-secondary: #A9927D;
            --accent-dark: #5D4037;
            --border-color: #D4A574;
            --border-radius: 16px;
            --border-radius-lg: 20px;
            --border-radius-xl: 24px;
            --navbar-height: 70px;
            --transition-smooth: all 0.3s ease;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --info-color: #2196F3;
            --gradient-primary: linear-gradient(145deg, #8B7355 0%, #A9927D 100%);
            --gradient-success: linear-gradient(145deg, #4CAF50 0%, #45a049 100%);
            --gradient-error: linear-gradient(145deg, #F44336 0%, #d32f2f 100%);
            --shadow-light: 0 2px 8px rgba(139, 115, 85, 0.1);
            --shadow-medium: 0 4px 16px rgba(139, 115, 85, 0.15);
            --shadow-heavy: 0 8px 24px rgba(139, 115, 85, 0.2);
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            width: 100vw;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.3s ease;
        }
        
        .loading-logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 48px;
            color: var(--accent-primary);
            margin-bottom: 20px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(139, 115, 85, 0.1);
            border-left-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            max-width: 80%;
        }
        
        /* Navbar - Ù†Ø³Ø®Ø© Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .native-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(60px + env(safe-area-inset-top));
            background: var(--bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            padding-top: env(safe-area-inset-top);
            z-index: 10000;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
            box-shadow: var(--shadow-light);
        }
        
        .logo {
            font-family: 'Almarai', sans-serif;
            font-weight: 900;
            font-size: 32px;
            color: var(--accent-primary);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
        }
        
        .coins-display {
            background: var(--gradient-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-light);
        }
        
        /* Main Content - Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ù„Ù„Ù‡Ø§ØªÙ */
        .main-content {
            width: 100%;
            max-width: 100%;
            padding-top: calc(60px + env(safe-area-inset-top) + 16px);
            padding-left: 16px;
            padding-right: 16px;
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 24px;
            padding: 24px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .section-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .section-subtitle {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 24px;
            text-align: center;
            line-height: 1.6;
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            padding: 30px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: var(--transition-smooth);
            background: rgba(212, 165, 116, 0.05);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--accent-primary);
            margin-bottom: 16px;
        }
        
        .upload-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 500;
            text-align: center;
        }
        
        .upload-hint {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Cost Preview */
        .cost-preview {
            background: rgba(139, 115, 85, 0.06);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(139, 115, 85, 0.12);
            display: none;
            width: 100%;
        }
        
        .cost-preview.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .cost-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 16px;
            text-align: center;
        }
        
        .cost-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .cost-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .cost-label {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .cost-value {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-primary);
        }
        
        .cost-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-family: 'Almarai', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            box-shadow: var(--shadow-light);
        }
        
        .action-btn:active {
            transform: scale(0.97);
        }
        
        .confirm-btn {
            background: var(--gradient-success);
            color: white;
        }
        
        .cancel-btn {
            background: var(--gradient-error);
            color: white;
        }
        
        /* Questions Settings Section */
        .questions-section {
            background: white;
            border-radius: 24px;
            padding: 24px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
            display: none;
            width: 100%;
        }
        
        .questions-section.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .question-group {
            background: rgba(139, 115, 85, 0.04);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        .question-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© - ØªØµÙ…ÙŠÙ… Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        .question-type-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .type-btn {
            padding: 16px;
            border: 2px solid rgba(139, 115, 85, 0.2);
            border-radius: 16px;
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 56px;
        }
        
        .type-btn i {
            font-size: 1.1rem;
            color: var(--accent-secondary);
        }
        
        .type-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .type-btn.selected i {
            color: white;
        }
        
        .question-limit {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.85rem;
            color: var(--info-color);
            padding: 12px;
            background: rgba(33, 150, 243, 0.08);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Slider */
        .slider-container {
            padding: 16px 0;
        }
        
        .slider-value {
            font-family: 'Almarai', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 6px;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--accent-secondary), var(--accent-primary));
            outline: none;
            border-radius: 10px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            border: 2px solid white;
        }
        
        .additional-cost {
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 12px;
        }
        
        .additional-cost span {
            color: var(--success-color);
            font-weight: 700;
        }
        
        /* Difficulty Options */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .option-btn {
            padding: 12px;
            border: 2px solid rgba(139, 115, 85, 0.2);
            border-radius: 12px;
            background: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: center;
        }
        
        .option-btn.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        /* Generate Button */
        .generate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 18px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            box-shadow: var(--shadow-medium);
            margin-top: 10px;
        }
        
        .generate-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Questions Display Section - ØªØµÙ…ÙŠÙ… Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙƒØ§Ù…Ù„ */
        .questions-display-section {
            background: white;
            border-radius: 24px;
            padding: 20px 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
            display: none;
            width: 100%;
        }
        
        .questions-display-section.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .questions-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(139, 115, 85, 0.1);
        }
        
        .questions-header-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .questions-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .info-badge {
            background: rgba(139, 115, 85, 0.08);
            padding: 10px 16px;
            border-radius: 30px;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-primary);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        /* Question Item - Ù…Ø³ØªØ·ÙŠÙ„ Ø¹Ø±ÙŠØ¶ */
        .question-item {
            background: white;
            border: 1px solid rgba(139, 115, 85, 0.15);
            border-radius: 20px;
            padding: 20px 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            width: 100%;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        .question-number {
            background: var(--accent-primary);
            color: white;
            padding: 6px 14px;
            border-radius: 30px;
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .question-type {
            background: rgba(139, 115, 85, 0.1);
            color: var(--accent-primary);
            padding: 6px 14px;
            border-radius: 30px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .question-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.6;
            padding: 0 4px;
        }
        
        /* Options Grid - Ø§Ø®ØªÙŠØ§Ø±ÙŠ */
        .options-grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .option-label {
            display: flex;
            align-items: center;
            background: rgba(139, 115, 85, 0.04);
            border: 2px solid rgba(139, 115, 85, 0.15);
            border-radius: 14px;
            padding: 14px 16px;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
        }
        
        .option-label:hover {
            background: rgba(139, 115, 85, 0.08);
        }
        
        .option-label.selected {
            background: rgba(76, 175, 80, 0.1);
            border-color: var(--success-color);
        }
        
        .option-label.correct-answer {
            background: rgba(76, 175, 80, 0.15);
            border-color: var(--success-color);
        }
        
        .option-label.wrong-answer {
            background: rgba(244, 67, 54, 0.1);
            border-color: var(--error-color);
        }
        
        .option-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .option-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            margin-right: 8px;
            flex: 1;
        }
        
        .option-check {
            width: 22px;
            height: 22px;
            border: 2px solid rgba(139, 115, 85, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }
        
        .option-label.selected .option-check {
            background: var(--success-color);
            border-color: var(--success-color);
        }
        
        .option-label.selected .option-check::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }
        
        /* True/False specific */
        .tf-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .tf-option {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(139, 115, 85, 0.04);
            border: 2px solid rgba(139, 115, 85, 0.15);
            border-radius: 14px;
            padding: 16px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .tf-option.selected {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        
        /* Essay Input */
        .essay-input-container {
            margin-top: 16px;
        }
        
        .essay-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid rgba(139, 115, 85, 0.15);
            border-radius: 16px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            background: white;
            transition: var(--transition-smooth);
        }
        
        .essay-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        .essay-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .essay-saved {
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .essay-nav-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .essay-nav-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 14px;
            background: var(--gradient-primary);
            color: white;
            font-family: 'Almarai', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .essay-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Submit Button - ØºÙŠØ± Ù…ÙØ¹Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        .submit-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: linear-gradient(to top, var(--bg-color) 80%, transparent);
            display: flex;
            justify-content: center;
            z-index: 1000;
        }
        
        .submit-btn {
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: 40px;
            padding: 18px 32px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: var(--shadow-heavy);
            width: 100%;
            max-width: 400px;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .submit-btn.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .submit-btn:active {
            transform: scale(0.98);
        }
        
        /* Results Section */
        .results-section {
            background: white;
            border-radius: 24px;
            padding: 30px 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
            display: none;
            width: 100%;
            text-align: center;
        }
        
        .results-section.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .results-title {
            font-family: 'Almarai', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 20px;
        }
        
        .score-circle {
            width: 160px;
            height: 160px;
            margin: 20px auto;
            position: relative;
        }
        
        .score-circle-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(139, 115, 85, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .score-circle-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--success-color) 0deg, var(--success-color) var(--angle), transparent var(--angle), transparent 360deg);
            transition: all 1s ease;
        }
        
        .score-circle-inner {
            position: absolute;
            width: 80%;
            height: 80%;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
        }
        
        .score-percentage {
            font-family: 'Almarai', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent-primary);
        }
        
        .score-label {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: rgba(139, 115, 85, 0.06);
            border-radius: 16px;
            padding: 20px;
        }
        
        .stat-value {
            font-family: 'Almarai', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 6px;
        }
        
        .stat-label {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .encouragement-message {
            font-family: 'Almarai', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin: 25px 0;
            padding: 20px;
            background: rgba(139, 115, 85, 0.06);
            border-radius: 16px;
            border-right: 4px solid var(--accent-primary);
        }
        
        .new-test-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 18px;
            font-family: 'Almarai', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            margin-top: 20px;
        }
        
        /* Essay Results */
        .essay-results-list {
            text-align: right;
            margin: 25px 0;
            padding: 20px;
            background: rgba(139, 115, 85, 0.04);
            border-radius: 16px;
        }
        
        .essay-result-item {
            padding: 15px 0;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        .essay-result-item:last-child {
            border-bottom: none;
        }
        
        .essay-result-question {
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }
        
        .essay-result-correct {
            color: var(--success-color);
            margin-bottom: 4px;
        }
        
        .essay-result-user {
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .essay-result-match {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .match-high {
            background: rgba(76, 175, 80, 0.15);
            color: var(--success-color);
        }
        
        .match-low {
            background: rgba(244, 67, 54, 0.15);
            color: var(--error-color);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            border-top: 1px solid rgba(139, 115, 85, 0.1);
            margin-top: 30px;
            width: 100%;
        }
        
        .footer.hidden {
            display: none;
        }
        
        .support-links {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .support-link {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
        }
        
        .developer-credit {
            font-size: 0.85rem;
            color: rgba(100, 116, 139, 0.5);
            margin-top: 20px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: calc(70px + env(safe-area-inset-top));
            left: 16px;
            right: 16px;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-heavy);
            z-index: 10001;
            transform: translateY(-150%);
            transition: transform 0.3s ease;
            border-right: 4px solid var(--info-color);
        }
        
        .notification.show {
            transform: translateY(0);
        }
        
        .notification.success {
            border-right-color: var(--success-color);
        }
        
        .notification.error {
            border-right-color: var(--error-color);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification-icon {
            font-size: 1.3rem;
        }
        
        .notification-text {
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            flex: 1;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(139, 115, 85, 0.1);
            border-radius: 10px;
            margin: 16px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-success);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        /* Responsive */
        @media (max-width: 380px) {
            .section-title {
                font-size: 1.4rem;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .tf-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen" style="display: none;">
        <div class="loading-logo">Ø¹ÙˆÙ†</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notification-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-text" id="notification-text"></div>
        </div>
    </div>
    
    <!-- Navbar -->
    <nav class="native-navbar" id="navbar">
        <div class="logo" id="home-logo">Ø¹ÙˆÙ†</div>
        <div class="nav-left">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="coins-count">0</span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <h1 class="section-title">ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ù† PDF</h1>
            <p class="section-subtitle">Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø°ÙƒÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text" id="upload-text">Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ Ù…Ù„Ù PDF</div>
                <div class="upload-hint">PDF ÙÙ‚Ø· - Ø­Ø¬Ù… ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</div>
            </div>
            
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
            
            <div class="cost-preview" id="cost-preview">
                <h3 class="cost-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ©</h3>
                <div class="cost-details">
                    <div class="cost-item">
                        <div class="cost-label">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª</div>
                        <div class="cost-value" id="page-count">0</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                        <div class="cost-value" id="cost-amount">0</div>
                    </div>
                </div>
                <div class="cost-actions">
                    <button class="action-btn cancel-btn" id="cancel-btn">
                        <i class="fas fa-times"></i>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button class="action-btn confirm-btn" id="confirm-btn">
                        <i class="fas fa-check"></i>
                        Ù…ØªØ§Ø¨Ø¹Ø©
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Questions Settings Section -->
        <section class="questions-section" id="questions-section">
            <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
            <p class="section-subtitle">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ¹Ø¯Ø¯Ù‡Ø§ ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</p>
            
            <div class="question-group">
                <h3 class="question-title">
                    <i class="fas fa-tasks"></i>
                    Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                </h3>
                <div class="question-type-grid" id="question-type">
                    <button class="type-btn selected" data-type="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
                        <i class="fas fa-check-circle"></i>
                        Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
                    </button>
                    <button class="type-btn" data-type="ØµØ­ ÙˆØ®Ø·Ø£">
                        <i class="fas fa-check-double"></i>
                        ØµØ­ ÙˆØ®Ø·Ø£
                    </button>
                    <button class="type-btn" data-type="Ù…Ù‚Ø§Ù„ÙŠ">
                        <i class="fas fa-pen"></i>
                        Ù…Ù‚Ø§Ù„ÙŠ
                    </button>
                </div>
                <div class="question-limit" id="question-limit">
                    <i class="fas fa-info-circle"></i>
                    Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: <span id="max-questions">80</span> Ø³Ø¤Ø§Ù„
                </div>
            </div>
            
            <div class="question-group">
                <h3 class="question-title">
                    <i class="fas fa-question-circle"></i>
                    Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                </h3>
                <div class="slider-container">
                    <div class="slider-value" id="questions-count">10</div>
                    <div class="slider-labels">
                        <span id="min-label">1</span>
                        <span id="mid-label">40</span>
                        <span id="max-label">80</span>
                    </div>
                    <input type="range" min="1" max="80" value="10" class="slider" id="questions-slider">
                    <div class="additional-cost">
                        ØªÙƒÙ„ÙØ© Ø¥Ø¶Ø§ÙÙŠØ©: <span id="extra-cost">0</span> Ø¹Ù…Ù„Ø©
                    </div>
                </div>
            </div>
            
            <div class="question-group">
                <h3 class="question-title">
                    <i class="fas fa-chart-line"></i>
                    Ø¯Ø±Ø¬Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©
                </h3>
                <div class="options-grid" id="difficulty-level">
                    <button class="option-btn selected" data-value="Ø³Ù‡Ù„">Ø³Ù‡Ù„</button>
                    <button class="option-btn" data-value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</button>
                    <button class="option-btn" data-value="ØµØ¹Ø¨">ØµØ¹Ø¨</button>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 16px; background: rgba(139, 115, 85, 0.06); border-radius: 16px;">
                <span style="font-family: 'Almarai', sans-serif; font-weight: 700;">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span>
                <span style="font-family: 'Almarai', sans-serif; font-size: 1.5rem; font-weight: 900; color: var(--accent-primary);" id="total-cost-display">0</span>
            </div>
            
            <button class="generate-btn" id="generate-btn">
                <i class="fas fa-robot"></i>
                ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            </button>
        </section>
        
        <!-- Questions Display Section -->
        <section class="questions-display-section" id="questions-display-section">
            <div class="questions-header">
                <h2 class="questions-header-title">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©</h2>
                <div class="questions-info">
                    <span class="info-badge" id="display-question-type">
                        <i class="fas fa-tag"></i>
                        Ø§Ù„Ù†ÙˆØ¹: <span id="question-type-display">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</span>
                    </span>
                    <span class="info-badge">
                        <i class="fas fa-layer-group"></i>
                        Ø§Ù„ØµØ¹ÙˆØ¨Ø©: <span id="difficulty-display">Ø³Ù‡Ù„</span>
                    </span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="answer-progress" style="width: 0%;"></div>
                </div>
            </div>
            
            <div id="questions-container">
                <!-- ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </section>
        
        <!-- Submit Button -->
        <div class="submit-container" id="submit-container" style="display: none;">
            <button class="submit-btn" id="submit-btn">
                <i class="fas fa-check-circle"></i>
                ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
            </button>
        </div>
        
        <!-- Results Section -->
        <section class="results-section" id="results-section">
            <div id="results-loading" style="display: none;">
                <div class="loading-spinner" style="margin: 30px auto;"></div>
                <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...</div>
            </div>
            
            <div id="results-content" style="display: none;">
                <h2 class="results-title">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                
                <div class="score-circle">
                    <div class="score-circle-bg">
                        <div class="score-circle-fill" id="score-fill"></div>
                        <div class="score-circle-inner">
                            <div class="score-percentage" id="score-percentage">0%</div>
                            <div class="score-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrong-count">0</div>
                        <div class="stat-label">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                    </div>
                </div>
                
                <div class="encouragement-message" id="encouragement-message">
                    Ø£Ø­Ø³Ù†Øª! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ‚Ø¯Ù… ğŸ‰
                </div>
                
                <div id="essay-results-container" style="display: none;">
                    <h3 style="font-family: 'Almarai', sans-serif; margin: 20px 0; color: var(--accent-primary);">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©</h3>
                    <div id="essay-results-list" class="essay-results-list"></div>
                </div>
                
                <button class="new-test-btn" id="new-test-btn">
                    <i class="fas fa-plus-circle"></i>
                    Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer" id="footer">
            <p class="copyright">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…Ù†ØµØ© Ø¹ÙˆÙ† Â© 2026</p>
            <div class="support-links">
                <a href="https://wa.me/966583617539" target="_blank" class="support-link">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="https://t.me/HNHv1" target="_blank" class="support-link">
                    <i class="fab fa-telegram"></i>
                </a>
            </div>
            <div class="developer-credit">
                Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø·ÙˆØ± ğŠğˆğŒğ
            </div>
        </footer>
    </div>
    
    <script>
        // ØªÙ‡ÙŠØ¦Ø© PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyBmPMRk4pvowUnqQb3fCSTZqLRNiU6-ouo",
            authDomain: "marvel1-654dd.firebaseapp.com",
            databaseURL: "https://marvel1-654dd-default-rtdb.firebaseio.com",
            projectId: "marvel1-654dd",
            storageBucket: "marvel1-654dd.appspot.com",
            messagingSenderId: "189921979866",
            appId: "1:189921979866:android:95f48de58a69756be924e3"
        });

        const auth = firebase.auth();
        const database = firebase.database();
        
        // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
        let currentUser = null;
        let userCoins = 0;
        let selectedFile = null;
        let fileInfo = { name: '', pages: 0, words: 0, baseCost: 0 };
        
        let currentSettings = {
            questionType: 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ',
            questionsCount: 10,
            difficulty: 'Ø³Ù‡Ù„',
            totalCost: 0,
            extraCost: 0,
            maxQuestions: 80
        };
        
        let questions = []; // Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
        let userAnswers = []; // Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let essayAnswers = {}; // Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ
        let currentEssayIndex = 0; // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
        let gradedResults = null; // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµØ­ÙŠØ­
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
        const SERVER = "https://wet-aidan-kimon-66eadaf6.koyeb.app";
        const ID = "12345";
        const PASS = "12345abcde57";
        
        // ========== Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ==========
        function reloadPage() { location.reload(); }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notification-icon');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            
            if (type === 'success') notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            else if (type === 'error') notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            else notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }
        
        function showLoading(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            const loadingScreen = document.getElementById('loading-screen');
            document.getElementById('loading-text').textContent = text;
            loadingScreen.style.display = 'flex';
            setTimeout(() => loadingScreen.style.opacity = '1', 10);
        }
        
        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.style.display = 'none', 300);
        }
        
        function hideFooter() { document.getElementById('footer').classList.add('hidden'); }
        function showFooter() { document.getElementById('footer').classList.remove('hidden'); }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
        async function loadUserData() {
            const user = auth.currentUser;
            if (!user) { window.location.replace('login.html'); return; }
            
            const usersRef = database.ref('users_Awn');
            const snapshot = await usersRef.once('value');
            
            if (snapshot.exists()) {
                const users = snapshot.val();
                for (const [userId, userData] of Object.entries(users)) {
                    if (userId !== 'noty_publick' && userData.email === user.email) {
                        currentUser = {
                            id: userId,
                            email: userData.email,
                            name: userData.name || '',
                            coin: userData.coin || 0,
                            banned: userData.banned === true
                        };
                        userCoins = userData.coin || 0;
                        document.getElementById('coins-count').textContent = userCoins;
                        return;
                    }
                }
            }
            await auth.signOut();
            window.location.replace('login.html');
        }
        
        async function setupUser() {
            await loadUserData();
            if (!currentUser || currentUser.banned) window.location.replace('login.html');
        }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ==========
        function setupFileUpload() {
            const pdfFile = document.getElementById('pdfFile');
            const uploadArea = document.getElementById('upload-area');
            const confirmBtn = document.getElementById('confirm-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            pdfFile.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('click', () => pdfFile.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = 'var(--accent-primary)'; });
            uploadArea.addEventListener('drop', handleDrop);
            confirmBtn.addEventListener('click', confirmProcess);
            cancelBtn.addEventListener('click', cancelProcess);
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            if (e.dataTransfer.files.length) await handleFile(e.dataTransfer.files[0]);
        }
        
        async function handleFileSelect(e) {
            if (e.target.files[0]) await handleFile(e.target.files[0]);
        }
        
        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù PDF ÙÙ‚Ø·', 'error');
                resetFileInput();
                return;
            }
            
            selectedFile = file;
            document.getElementById('upload-text').textContent = file.name;
            await analyzePDF(file);
        }
        
        async function analyzePDF(file) {
            try {
                showLoading('Ø¹ÙˆÙ† ÙŠØ­Ù„Ù„ Ø§Ù„Ù…Ù„Ù...');
                
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                
                let totalWords = 0;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    if (content.items.length) {
                        let text = '';
                        content.items.forEach(t => text += t.str + ' ');
                        totalWords += text.trim().split(/\s+/).filter(w => w.length >= 2).length;
                    } else totalWords += 250;
                }
                
                let coins = Math.ceil((totalWords / 1000) * 2) / 2;
                if (coins < 1) coins = 1;
                coins = Math.round(coins * 10) / 10;
                
                fileInfo = { name: file.name, pages: pdf.numPages, words: totalWords, baseCost: coins };
                
                hideLoading();
                
                document.getElementById('page-count').textContent = fileInfo.pages;
                document.getElementById('cost-amount').textContent = coins + ' Ø¹Ù…Ù„Ø©';
                document.getElementById('base-cost-display')?.textContent = coins + ' Ø¹Ù…Ù„Ø©';
                document.getElementById('cost-preview').classList.add('show');
                
                updateTotalCost();
                showNotification('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                hideLoading();
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù', 'error');
                resetFileInput();
            }
        }
        
        function resetFileInput() {
            document.getElementById('pdfFile').value = '';
            selectedFile = null;
            document.getElementById('upload-text').textContent = 'Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ Ù…Ù„Ù PDF';
            document.getElementById('cost-preview').classList.remove('show');
        }
        
        function cancelProcess() {
            resetFileInput();
            document.getElementById('cost-preview').classList.remove('show');
            showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'info');
        }
        
        function confirmProcess() {
            if (!fileInfo.baseCost) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            if (userCoins < fileInfo.baseCost) {
                showNotification(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ. ØªØ­ØªØ§Ø¬ ${fileInfo.baseCost} Ø¹Ù…Ù„Ø©`, 'error');
                return;
            }
            
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('questions-section').classList.add('show');
            document.getElementById('cost-preview').classList.remove('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ==========
        function setupQuestionsEvents() {
            // Ø£Ø²Ø±Ø§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            document.querySelectorAll('#question-type .type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#question-type .type-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.questionType = this.dataset.type;
                    updateQuestionLimit(this.dataset.type);
                    updateSliderRange();
                    updateExtraCost();
                });
            });
            
            // Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
            document.getElementById('questions-slider').addEventListener('input', function() {
                document.getElementById('questions-count').textContent = this.value;
                currentSettings.questionsCount = parseInt(this.value);
                updateExtraCost();
                updateTotalCost();
            });
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµØ¹ÙˆØ¨Ø©
            document.querySelectorAll('#difficulty-level .option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#difficulty-level .option-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentSettings.difficulty = this.dataset.value;
                });
            });
            
            // Ø²Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯
            document.getElementById('generate-btn').addEventListener('click', generateQuestions);
            
            // Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            document.getElementById('new-test-btn').addEventListener('click', resetToUpload);
            
            // Ø²Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…
            document.getElementById('submit-btn').addEventListener('click', submitAnswers);
            
            updateQuestionLimit('Ø§Ø®ØªÙŠØ§Ø±ÙŠ');
            updateQuestionsCount();
        }
        
        function updateQuestionLimit(type) {
            const max = type === 'Ù…Ù‚Ø§Ù„ÙŠ' ? 50 : 80;
            currentSettings.maxQuestions = max;
            document.getElementById('max-questions').textContent = max;
            document.getElementById('max-label').textContent = max;
            document.getElementById('mid-label').textContent = type === 'Ù…Ù‚Ø§Ù„ÙŠ' ? '25' : '40';
            
            const slider = document.getElementById('questions-slider');
            slider.max = max;
            if (currentSettings.questionsCount > max) {
                slider.value = max;
                document.getElementById('questions-count').textContent = max;
                currentSettings.questionsCount = max;
            }
        }
        
        function updateSliderRange() {
            const slider = document.getElementById('questions-slider');
            slider.max = currentSettings.maxQuestions;
            if (currentSettings.questionsCount > currentSettings.maxQuestions) {
                slider.value = currentSettings.maxQuestions;
                document.getElementById('questions-count').textContent = currentSettings.maxQuestions;
                currentSettings.questionsCount = currentSettings.maxQuestions;
            }
        }
        
        function updateQuestionsCount() {
            const count = parseInt(document.getElementById('questions-slider').value);
            document.getElementById('questions-count').textContent = count;
            currentSettings.questionsCount = count;
            updateExtraCost();
        }
        
        function updateExtraCost() {
            const count = currentSettings.questionsCount;
            const type = currentSettings.questionType;
            let extraCost = 0;
            
            if (type === 'Ù…Ù‚Ø§Ù„ÙŠ') {
                if (count >= 11 && count <= 20) extraCost = 8;
                else if (count >= 21 && count <= 30) extraCost = 8;
                else if (count >= 31 && count <= 50) extraCost = 12;
            } else {
                if (count >= 21 && count <= 40) extraCost = 5;
                else if (count >= 41 && count <= 60) extraCost = 8;
                else if (count >= 61 && count <= 80) extraCost = 11;
            }
            
            currentSettings.extraCost = extraCost;
            document.getElementById('extra-cost').textContent = extraCost;
            updateTotalCost();
        }
        
        function updateTotalCost() {
            const total = (fileInfo.baseCost || 0) + (currentSettings.extraCost || 0);
            currentSettings.totalCost = total;
            document.getElementById('total-cost-display').textContent = total + ' Ø¹Ù…Ù„Ø©';
        }
        
        // ========== ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ==========
        async function generateQuestions() {
            if (!selectedFile) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            if (userCoins < currentSettings.totalCost) {
                showNotification(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ. ØªØ­ØªØ§Ø¬ ${currentSettings.totalCost} Ø¹Ù…Ù„Ø©`, 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...';
            
            try {
                showLoading('Ø¹ÙˆÙ† ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù…Ù„Ù ÙˆÙŠØ­Ù„Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...');
                
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });
                
                let prompt;
                if (currentSettings.questionType === 'Ù…Ù‚Ø§Ù„ÙŠ') {
                    prompt = `ROLE:
You are an AI specialized in strict PDF-based question extraction.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES:
========================
Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© = ${currentSettings.questionsCount}
Ø¯Ø±Ø¬Ø©_Ø§Ù„ØµØ¹ÙˆØ¨Ø© = ${currentSettings.difficulty}

========================
TASK:
========================

1. Analyze the provided PDF from the first word to the last word only.
2. Do NOT use any external knowledge.
3. Do NOT infer, guess, or generate content not present in the PDF.
4. You must strictly generate exactly Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© questions â€” no more, no less.
5. Questions must follow the selected Ø¯Ø±Ø¬Ø©_Ø§Ù„ØµØ¹ÙˆØ¨Ø© definition:
   â€¢ Ø³Ù‡Ù„: direct questions explicitly stated in the PDF.
   â€¢ Ù…ØªÙˆØ³Ø·: questions logically derived from PDF content only.
   â€¢ ØµØ¹Ø¨: questions requiring deep understanding of the full PDF content.
6. Questions must be clear, concise, and strictly based on PDF content.
7. Output ONLY the questions, numbered as follows:

Q1 : Ø§Ù„Ø³Ø¤Ø§Ù„
Q2 : Ø§Ù„Ø³Ø¤Ø§Ù„
Q3 : Ø§Ù„Ø³Ø¤Ø§Ù„
...
(Exactly Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø©)

========================
ABSOLUTE CONSTRAINTS:
========================

- Output MUST be plain text only.
- No answers.
- No commentary.
- No explanation.
- No JSON or Markdown.
- If PDF is empty, corrupted, or unreadable, return exactly:

INVALID_PDF`;
                } else {
                    prompt = `ROLE:
You are an AI specialized in strict PDF-based question generation following Google Gemini Flash 2.5 Lite standards.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES (IN ARABIC):
========================
Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© = ${currentSettings.questionsCount}
Ø¯Ø±Ø¬Ø©_Ø§Ù„ØµØ¹ÙˆØ¨Ø© = ${currentSettings.difficulty}
Ù†ÙˆØ¹_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© = ${currentSettings.questionType}

========================
TASK:
========================

1. Analyze the provided PDF from the first word to the last word only.
2. Do NOT use any external knowledge.
3. Do NOT infer, guess, paraphrase, or generate any content that does not explicitly exist inside the PDF.
4. Every word used in:
   - The question
   - The answer choices
   - The correct answer
   MUST exist verbatim inside the PDF text.
5. You must strictly generate exactly Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© questions â€” no more, no less.
6. You must strictly follow the selected Ù†ÙˆØ¹_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© format.
7. You must strictly follow the selected Ø¯Ø±Ø¬Ø©_Ø§Ù„ØµØ¹ÙˆØ¨Ø© definition.

   â€¢ Ø³Ù‡Ù„: Questions must be direct and explicitly stated in the PDF. Answers must be clearly found word-for-word in the text.
   â€¢ Ù…ØªÙˆØ³Ø·: Questions must be logically derived only from the PDF content. Still fully based on the PDF only.
   â€¢ ØµØ¹Ø¨: Questions must require deep understanding of the entire PDF. May combine multiple parts of the PDF. Still 100% restricted to PDF content only.

8. The AI must read the entire PDF from beginning to end before generating questions.
9. If the PDF is empty, corrupted, unreadable, or contains no meaningful content, return exactly: INVALID_PDF

========================
OUTPUT FORMAT RULES (STRICT):
========================

- Output MUST be plain text only.
- No JSON. No Markdown. No explanations. No commentary.
- No additional text before or after questions.
- No deviation from the required structure.

========================
FORMAT RULES PER QUESTION TYPE:
========================

If Ù†ÙˆØ¹_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© = Ø§Ø®ØªÙŠØ§Ø±ÙŠ

Return exactly in this format:

Type : Ø§Ø®ØªÙŠØ§Ø±ÙŠ
Q1 : Ø§Ù„Ø³Ø¤Ø§Ù„
R : Ø§Ø®ØªÙŠØ§Ø±
R : Ø§Ø®ØªÙŠØ§Ø±
R : Ø§Ø®ØªÙŠØ§Ø±
R : Ø§Ø®ØªÙŠØ§Ø±
Correct : Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµØ­ÙŠØ­

(Repeat the same structure until reaching exactly Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø©)

All answer choices must exist inside the PDF. All incorrect choices must also exist inside the PDF. No fabricated text is allowed.

--------------------------------------------------

If Ù†ÙˆØ¹_Ø§Ù„Ø§Ø³Ø¦Ù„Ø© = ØµØ­ ÙˆØ®Ø·Ø£

Return exactly in this format:

Type : ØµØ­ ÙˆØ®Ø·Ø£
Q1 : Ø§Ù„Ø³Ø¤Ø§Ù„
R : ØµØ­
R : Ø®Ø·Ø£
Correct : Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©

(Repeat the same structure until reaching exactly Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø©)

The statement must be constructed strictly from PDF text only.

========================
ABSOLUTE CONSTRAINTS:
========================

- The number of questions must exactly equal Ø¹Ø¯Ø¯_Ø§Ù„Ø§Ø³Ø¦Ù„Ø©.
- All generated content must come strictly from the PDF.
- No hallucination. No paraphrasing outside the PDF wording. No external knowledge.
- Deterministic behavior only.
- If any constraint cannot be satisfied, return exactly: CONSTRAINT_VIOLATION`;
                }
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: ID, pass: PASS, data: prompt, PDF_BASE64: base64 })
                });
                
                if (!response.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: ${response.status}`);
                
                const text = await response.text();
                
                if (text.includes('INVALID_PDF') || text.includes('CONSTRAINT_VIOLATION')) {
                    throw new Error('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡ØªÙ‡');
                }
                
                questions = parseQuestionsFromText(text, currentSettings.questionType);
                
                if (!questions.length) throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø©');
                
                await deductCoins(currentSettings.totalCost);
                await saveResultToDatabase();
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                document.getElementById('questions-section').classList.remove('show');
                document.getElementById('questions-display-section').classList.add('show');
                document.getElementById('submit-container').style.display = 'flex';
                hideFooter();
                
                displayQuestions(questions);
                
                showNotification(`ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${questions.length} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
            } catch (error) {
                showNotification('Ø®Ø·Ø£: ' + error.message, 'error');
            } finally {
                hideLoading();
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-robot"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©';
            }
        }
        
        function parseQuestionsFromText(text, type) {
            const questions = [];
            const lines = text.split('\n').filter(l => l.trim() !== '');
            
            if (type === 'Ù…Ù‚Ø§Ù„ÙŠ') {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ© ÙÙ‚Ø·
                lines.forEach(line => {
                    if (line.startsWith('Q')) {
                        const questionText = line.substring(line.indexOf(':') + 1).trim();
                        questions.push({
                            number: questions.length + 1,
                            type: 'Ù…Ù‚Ø§Ù„ÙŠ',
                            question: questionText,
                            options: [],
                            correct: ''
                        });
                    }
                });
            } else {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
                let currentQuestion = null;
                let extractedType = '';
                
                if (lines[0] && lines[0].includes('Type :')) {
                    extractedType = lines[0].replace('Type :', '').trim();
                }
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line.startsWith('Q')) {
                        if (currentQuestion) questions.push(currentQuestion);
                        
                        const questionText = line.substring(line.indexOf(':') + 1).trim();
                        currentQuestion = {
                            number: questions.length + 1,
                            type: extractedType || type,
                            question: questionText,
                            options: [],
                            correct: ''
                        };
                    } else if (line.startsWith('R')) {
                        if (currentQuestion) {
                            const option = line.substring(line.indexOf(':') + 1).trim();
                            currentQuestion.options.push(option);
                        }
                    } else if (line.startsWith('Correct :')) {
                        if (currentQuestion) {
                            const correct = line.substring(line.indexOf(':') + 1).trim();
                            currentQuestion.correct = correct;
                        }
                    }
                }
                if (currentQuestion) questions.push(currentQuestion);
            }
            
            return questions;
        }
        
        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            document.getElementById('question-type-display').textContent = 
                currentSettings.questionType === 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 
                currentSettings.questionType === 'ØµØ­ ÙˆØ®Ø·Ø£' ? 'ØµØ­ ÙˆØ®Ø·Ø£' : 'Ù…Ù‚Ø§Ù„ÙŠ';
            document.getElementById('difficulty-display').textContent = currentSettings.difficulty;
            
            let html = '';
            userAnswers = new Array(questions.length).fill(null);
            essayAnswers = {};
            currentEssayIndex = 0;
            
            if (currentSettings.questionType === 'Ù…Ù‚Ø§Ù„ÙŠ') {
                // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªÙ†Ù‚Ù„
                html += `<div id="essay-question-container">`;
                html += displayEssayQuestion(0);
                html += `</div>`;
            } else {
                // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªØ­Øª Ø¨Ø¹Ø¶Ù‡Ø§
                questions.forEach((q, index) => {
                    html += `
                        <div class="question-item" id="q-${index}">
                            <div class="question-header">
                                <span class="question-number">Ø³Ø¤Ø§Ù„ ${index + 1}</span>
                                <span class="question-type">
                                    <i class="fas ${q.type === 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ' ? 'fa-check-circle' : 'fa-check-double'}"></i>
                                    ${q.type === 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 'ØµØ­ ÙˆØ®Ø·Ø£'}
                                </span>
                            </div>
                            <div class="question-text">${q.question}</div>
                    `;
                    
                    if (q.type === 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ') {
                        html += `<div class="options-grid-container" id="options-${index}">`;
                        q.options.forEach((option, optIndex) => {
                            html += `
                                <label class="option-label" onclick="selectOption(${index}, '${option.replace(/'/g, "\\'")}')">
                                    <span class="option-check"></span>
                                    <span class="option-text">${option}</span>
                                    <input type="radio" name="q${index}" value="${option.replace(/'/g, "&quot;")}" class="option-input">
                                </label>
                            `;
                        });
                        html += `</div>`;
                    } else if (q.type === 'ØµØ­ ÙˆØ®Ø·Ø£') {
                        html += `
                            <div class="tf-container" id="options-${index}">
                                <div class="tf-option" onclick="selectTF(${index}, 'ØµØ­')">ØµØ­</div>
                                <div class="tf-option" onclick="selectTF(${index}, 'Ø®Ø·Ø£')">Ø®Ø·Ø£</div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
            }
            
            container.innerHTML = html;
            updateSubmitButtonState();
        }
        
        function displayEssayQuestion(index) {
            if (!questions.length) return '';
            
            const q = questions[index];
            const savedAnswer = essayAnswers[index] || '';
            
            return `
                <div class="question-item">
                    <div class="question-header">
                        <span class="question-number">Ø³Ø¤Ø§Ù„ ${index + 1} Ù…Ù† ${questions.length}</span>
                        <span class="question-type">
                            <i class="fas fa-pen"></i>
                            Ù…Ù‚Ø§Ù„ÙŠ
                        </span>
                    </div>
                    <div class="question-text">${q.question}</div>
                    
                    <div class="essay-input-container">
                        <textarea class="essay-textarea" id="essay-${index}" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." oninput="saveEssayAnswer(${index}, this.value)">${savedAnswer}</textarea>
                        <div class="essay-status">
                            <span class="essay-saved" id="essay-status-${index}">
                                ${savedAnswer ? '<i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸' : '<i class="fas fa-info-circle"></i> Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯'}
                            </span>
                            <span>${savedAnswer.length} Ø­Ø±Ù</span>
                        </div>
                    </div>
                    
                    <div class="essay-nav-buttons">
                        <button class="essay-nav-btn" onclick="navigateEssay(${index - 1})" ${index === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-right"></i>
                            Ø§Ù„Ø³Ø§Ø¨Ù‚
                        </button>
                        <button class="essay-nav-btn" onclick="navigateEssay(${index + 1})" ${index === questions.length - 1 ? 'disabled' : ''}>
                            Ø§Ù„ØªØ§Ù„ÙŠ
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ==========
        window.selectOption = function(questionIndex, option) {
            userAnswers[questionIndex] = option;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.querySelectorAll(`#options-${questionIndex} .option-label`).forEach(label => {
                label.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateSubmitButtonState();
        };
        
        window.selectTF = function(questionIndex, value) {
            userAnswers[questionIndex] = value;
            
            document.querySelectorAll(`#options-${questionIndex} .tf-option`).forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            updateSubmitButtonState();
        };
        
        window.saveEssayAnswer = function(index, value) {
            essayAnswers[index] = value;
            userAnswers[index] = value;
            
            const statusEl = document.getElementById(`essay-status-${index}`);
            if (statusEl) {
                if (value.trim()) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-info-circle"></i> Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯';
                }
            }
            
            updateSubmitButtonState();
        };
        
        window.navigateEssay = function(index) {
            if (index >= 0 && index < questions.length) {
                currentEssayIndex = index;
                document.getElementById('essay-question-container').innerHTML = displayEssayQuestion(index);
            }
        };
        
        function updateSubmitButtonState() {
            const submitBtn = document.getElementById('submit-btn');
            let allAnswered = true;
            
            if (currentSettings.questionType === 'Ù…Ù‚Ø§Ù„ÙŠ') {
                // Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©: ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…ÙƒØªÙˆØ¨Ø©
                for (let i = 0; i < questions.length; i++) {
                    if (!essayAnswers[i] || !essayAnswers[i].trim()) {
                        allAnswered = false;
                        break;
                    }
                }
            } else {
                // Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©: ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
                for (let i = 0; i < questions.length; i++) {
                    if (!userAnswers[i]) {
                        allAnswered = false;
                        break;
                    }
                }
            }
            
            if (allAnswered) {
                submitBtn.classList.add('active');
            } else {
                submitBtn.classList.remove('active');
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            const answeredCount = userAnswers.filter(a => a !== null && a !== '').length;
            const progress = (answeredCount / questions.length) * 100;
            document.getElementById('answer-progress').style.width = progress + '%';
        }
        
        // ========== ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ==========
        async function submitAnswers() {
            if (!submitBtn.classList.contains('active')) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            document.getElementById('submit-container').style.display = 'none';
            document.getElementById('questions-display-section').classList.remove('show');
            document.getElementById('results-section').classList.add('show');
            document.getElementById('results-loading').style.display = 'block';
            document.getElementById('results-content').style.display = 'none';
            
            if (currentSettings.questionType === 'Ù…Ù‚Ø§Ù„ÙŠ') {
                await gradeEssayQuestions();
            } else {
                // ØªÙ‚ÙŠÙŠÙ… Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
                await gradeObjectiveQuestions();
            }
        }
        
        async function gradeObjectiveQuestions() {
            setTimeout(() => {
                let correct = 0;
                
                questions.forEach((q, index) => {
                    if (userAnswers[index] === q.correct) {
                        correct++;
                    }
                });
                
                const wrong = questions.length - correct;
                const percentage = Math.round((correct / questions.length) * 100);
                
                displayResults(correct, wrong, percentage);
                
                showNotification('ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }, 2000);
        }
        
        async function gradeEssayQuestions() {
            try {
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                let answersText = '';
                questions.forEach((q, index) => {
                    answersText += `Q${index + 1} : ${q.question}\n`;
                    answersText += `R${index + 1} : ${essayAnswers[index] || ''}\n\n`;
                });
                
                const prompt = `ROLE:
You are an AI specialized in grading and evaluating textual answers.
You must strictly follow the instructions below with ZERO deviation.

========================
INPUT VARIABLES:
========================
- Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚Ø§Ù„ÙŠØ© Ù…Ø³Ø­ÙˆØ¨Ø© Ù…Ù† PDF (Q1, Q2, â€¦)
- Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© (R1, R2, â€¦)

========================
TASK:
========================

1. Compare each user answer (R1, R2, â€¦) with the model answer strictly based on PDF content.
2. For each Ø³Ø¤Ø§Ù„:
   - Identify the correct answer from PDF.
   - Compare it with user's answer.
   - Calculate Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ (%) between user's answer and Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©.
3. Output ONLY the following format for each Ø³Ø¤Ø§Ù„:

Q1
Correct : Ø§Ù„Ø§Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©
E : Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚

Q2
Correct : Ø§Ù„Ø§Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©
E : Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚

...

========================
ABSOLUTE CONSTRAINTS:
========================

- Do NOT write explanations.
- Do NOT provide commentary.
- Do NOT modify the questions or numbering.
- Do NOT use external knowledge.
- Output MUST be plain text only.
- If PDF is empty or unreadable, return exactly: INVALID_PDF`;

                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(selectedFile);
                });
                
                const response = await fetch(SERVER + "/api/KIMO_DEV", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: ID, pass: PASS, data: prompt, PDF_BASE64: base64 })
                });
                
                const text = await response.text();
                gradedResults = parseGradingResults(text);
                
                let correct = 0;
                gradedResults.forEach(result => {
                    if (parseInt(result.match) >= 50) correct++;
                });
                
                const wrong = questions.length - correct;
                const percentage = Math.round((correct / questions.length) * 100);
                
                displayEssayResults(gradedResults);
                displayResults(correct, wrong, percentage);
                
            } catch (error) {
                console.error('Error grading essays:', error);
                // Fallback: Ø§Ø¹ØªØ¨Ø§Ø± ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„ØªØ¬Ø±Ø¨Ø©
                const correct = questions.length;
                const percentage = 100;
                displayResults(correct, 0, percentage);
            }
        }
        
        function parseGradingResults(text) {
            const results = [];
            const lines = text.split('\n').filter(l => l.trim() !== '');
            
            let currentResult = {};
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('Q')) {
                    if (currentResult.question) results.push(currentResult);
                    currentResult = { question: line };
                } else if (line.startsWith('Correct :')) {
                    currentResult.correct = line.substring(line.indexOf(':') + 1).trim();
                } else if (line.startsWith('E :')) {
                    currentResult.match = line.substring(line.indexOf(':') + 1).trim().replace('%', '');
                }
            }
            
            if (currentResult.question) results.push(currentResult);
            return results;
        }
        
        function displayEssayResults(results) {
            const container = document.getElementById('essay-results-list');
            document.getElementById('essay-results-container').style.display = 'block';
            
            let html = '';
            
            results.forEach((result, index) => {
                const matchPercent = parseInt(result.match) || 0;
                const matchClass = matchPercent >= 50 ? 'match-high' : 'match-low';
                const statusText = matchPercent >= 50 ? 'âœ… Ù†Ø§Ø¬Ø­' : 'âŒ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©';
                
                html += `
                    <div class="essay-result-item">
                        <div class="essay-result-question">Ø³Ø¤Ø§Ù„ ${index + 1}</div>
                        <div class="essay-result-correct"><i class="fas fa-check-circle"></i> Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©: ${result.correct || 'ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©'}</div>
                        <div class="essay-result-user"><i class="fas fa-pen"></i> Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${essayAnswers[index] || 'Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©'}</div>
                        <span class="essay-result-match ${matchClass}">
                            Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚: ${matchPercent}% - ${statusText}
                        </span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function displayResults(correct, wrong, percentage) {
            document.getElementById('results-loading').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';
            
            document.getElementById('correct-count').textContent = correct;
            document.getElementById('wrong-count').textContent = wrong;
            document.getElementById('score-percentage').textContent = percentage + '%';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
            const angle = (percentage / 100) * 360;
            document.getElementById('score-fill').style.setProperty('--angle', angle + 'deg');
            
            // Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹ÙŠØ©
            let message = '';
            if (percentage >= 90) message = 'ğŸ“ Ù…Ù…ØªØ§Ø²! Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹ØŒ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ ØªÙ…Ø§Ù…Ø§Ù‹';
            else if (percentage >= 75) message = 'ğŸŒŸ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…';
            else if (percentage >= 60) message = 'ğŸ“š Ø¬ÙŠØ¯! Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙŠ Ø£Ø®Ø·Ø£Øª ÙÙŠÙ‡Ø§';
            else if (percentage >= 40) message = 'ğŸ’ª Ù„Ø§ Ø¨Ø£Ø³ØŒ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø© Ø³ØªØ¬Ø¹Ù„Ùƒ Ø£ÙØ¶Ù„';
            else message = 'ğŸ“– Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙŠØ­ØªØ§Ø¬ ØµØ¨Ø±Ø§Ù‹';
            
            document.getElementById('encouragement-message').textContent = message;
            
            showNotification('ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        // ========== Ø®ØµÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
        async function deductCoins(amount) {
            userCoins -= amount;
            await database.ref(`users_Awn/${currentUser.id}/coin`).set(userCoins);
            document.getElementById('coins-count').textContent = userCoins;
        }
        
        async function saveResultToDatabase() {
            try {
                const recordId = 'questions_' + Date.now();
                await database.ref(`records/${recordId}`).set({
                    userId: currentUser.id,
                    fileName: fileInfo.name,
                    settings: currentSettings,
                    questions: questions,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('Error saving to database:', error);
            }
        }
        
        function resetToUpload() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡
            questions = [];
            userAnswers = [];
            essayAnswers = {};
            gradedResults = null;
            
            document.getElementById('results-section').classList.remove('show');
            document.getElementById('questions-display-section').classList.remove('show');
            document.getElementById('submit-container').style.display = 'none';
            document.getElementById('upload-section').style.display = 'flex';
            
            showFooter();
            resetFileInput();
        }
        
        // ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ==========
        async function initApp() {
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
            
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.replace('login.html');
                    return;
                }
                
                try {
                    await setupUser();
                    setupFileUpload();
                    setupQuestionsEvents();
                    
                    document.getElementById('home-logo').addEventListener('click', reloadPage);
                    
                    hideLoading();
                } catch (error) {
                    console.error('Error initializing app:', error);
                    hideLoading();
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'error');
                }
            });
        }
        
        // Ù…Ù†Ø¹ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', () => history.pushState(null, null, location.href));
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
